<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Iniciar Sesi√≥n - Callej√≥n 9</title>

	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<script src="https://cdn.tailwindcss.com"></script>

	<style>
		@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
		* { box-sizing: border-box; }

		body {
			margin: 0;
			padding: 0;
			min-height: 100vh;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			font-family: 'Inter', sans-serif;
			display: flex;
			justify-content: center;
			align-items: center;
			position: relative;
		}

		.container {
			background: rgba(255, 255, 255, 0.95);
			border-radius: 20px;
			overflow: hidden;
			box-shadow: 0 20px 60px rgba(0,0,0,0.3);
			animation: fadeIn 0.6s ease-out;
			max-width: 450px;
			width: 100%;
			margin: 20px;
		}

		@keyframes fadeIn { 
			from { opacity: 0; transform: scale(0.95) translateY(20px); } 
			to { opacity: 1; transform: scale(1) translateY(0); } 
		}

		.login-header {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			padding: 40px 35px;
			text-align: center;
			color: white;
		}

		.login-container {
			padding: 40px 35px;
		}

		.logo { 
			width: 120px; 
			margin: 0 auto 15px; 
			filter: brightness(0) invert(1);
		}

		h2 { 
			text-align: center; 
			margin-bottom: 10px; 
			font-weight: 600; 
			font-size: 28px; 
			color: white;
		}

		.subtitle {
			text-align: center;
			color: rgba(255, 255, 255, 0.9);
			font-size: 14px;
			margin-bottom: 0;
		}

		form { display: flex; flex-direction: column; gap: 20px; }

		.input-group { position: relative; }

		input {
			width: 100%;
			padding: 14px 16px;
			border: 2px solid #e5e7eb;
			border-radius: 12px;
			background-color: #f9fafb;
			font-size: 15px;
			transition: all 0.3s ease;
		}
		
		input:focus { 
			border-color: #667eea; 
			background-color: #ffffff; 
			outline: none; 
			box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); 
		}

		button {
			position: relative;
			display: flex;
			justify-content: center;
			align-items: center;
			padding: 14px 0;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: #fff;
			font-weight: 600;
			border: none;
			border-radius: 12px;
			font-size: 16px;
			cursor: pointer;
			transition: all 0.3s ease;
		}
		
		button:disabled {
			background: #a0a0a0;
			cursor: not-allowed;
		}
		
		button:hover:enabled { 
			transform: translateY(-2px); 
			box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4); 
		}

		.spinner {
			border: 3px solid #f3f3f3;
			border-top: 3px solid #fff;
			border-radius: 50%;
			width: 18px;
			height: 18px;
			margin-left: 10px;
			display: none;
			animation: spin 0.8s linear infinite;
		}
		
		@keyframes spin { 
			0% { transform: rotate(0deg); } 
			100% { transform: rotate(360deg); } 
		}

		.alert-error {
			background-color: #fee2e2;
			color: #991b1b;
			border: 1px solid #fecaca;
			padding: 14px 18px;
			border-radius: 10px;
			margin-bottom: 20px;
			font-size: 14px;
			display: none;
			align-items: center;
			gap: 10px;
		}
		
		.alert-error.show { 
			display: flex; 
		}

		.role-badge {
			display: inline-block;
			padding: 6px 12px;
			border-radius: 8px;
			font-size: 12px;
			font-weight: 600;
			margin-top: 10px;
		}

		.role-admin { background: #dbeafe; color: #1e40af; }
		.role-mesero { background: #dcfce7; color: #166534; }
		.role-cocina { background: #fed7aa; color: #9a3412; }
	</style>
</head>
<body>
	<div class="container">
		<!-- Header con Logo y T√≠tulo -->
		<div class="login-header">
			<img src="https://tse4.mm.bing.net/th/id/OIP.ZY7EMAqB-T3d6FTXGJKtTwAAAA?cb=iwp2&rs=1&pid=ImgDetMain" alt="Logo" class="logo" />
			<h2>Callej√≥n 9</h2>
			<p class="subtitle">Sistema de Gesti√≥n de Restaurante</p>
		</div>

		<!-- Formulario de Login -->
		<div class="login-container">
			<div id="error-msg" class="alert-error"></div>

			<form id="loginForm" method="post" novalidate>
				<div class="input-group">
					<input type="email" name="email" placeholder="Correo electr√≥nico" required id="emailInput" autocomplete="email" />
				</div>
				<div class="input-group">
					<input type="password" name="password" placeholder="Contrase√±a" required id="passwordInput" autocomplete="current-password" />
				</div>
				<button type="submit" id="loginButton">
					<span class="btn-text">Iniciar Sesi√≥n</span>
					<span class="spinner"></span>
				</button>
			</form>

			<!-- Info de usuarios de prueba (solo desarrollo) -->
			<div class="mt-6 p-4 bg-gray-50 rounded-lg text-xs text-gray-600">
				<p class="font-semibold mb-2">üë• Usuarios de prueba:</p>
				<div class="space-y-1">
					<p>‚Ä¢ <strong>Admin:</strong> edwinfloresvargas.dev@gmail.com <span class="role-badge role-admin">Administraci√≥n</span></p>
					<p>‚Ä¢ <strong>Mesero:</strong> octavio@admin.com <span class="role-badge role-mesero">Mesero</span></p>
					<p>‚Ä¢ <strong>Cocina:</strong> regi@admin.com <span class="role-badge role-cocina">Cocina</span></p>
				</div>
			</div>
		</div>
	</div>

	<script>
		const form = document.getElementById("loginForm");
		const button = document.getElementById("loginButton");
		const btnText = button.querySelector(".btn-text");
		const spinner = button.querySelector(".spinner");
		const errorMsgDiv = document.getElementById("error-msg");

		const LOGIN_URL = "{{ url_for('routes.login') }}";

		function showErrorMessage(message) {
			errorMsgDiv.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg> <div>${message}</div>`;
			errorMsgDiv.classList.add('show');
			setTimeout(() => {
				errorMsgDiv.classList.remove('show');
			}, 5000);
		}

		function setFormLoading(isLoading) {
			if (isLoading) {
				btnText.textContent = "Verificando...";
				spinner.style.display = "inline-block";
				button.disabled = true;
				errorMsgDiv.classList.remove('show');
			} else {
				btnText.textContent = "Iniciar Sesi√≥n";
				spinner.style.display = "none";
				button.disabled = false;
			}
		}

		form.addEventListener("submit", async function(e) {
			e.preventDefault();
			setFormLoading(true);

			const email = document.getElementById("emailInput").value;
			const password = document.getElementById("passwordInput").value;

			if (!email || !password) {
				showErrorMessage("Por favor completa todos los campos");
				setFormLoading(false);
				return;
			}

			const data = {
				email: email,
				password: password
			};

			try {
				const response = await fetch(LOGIN_URL, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					credentials: 'include',
					body: JSON.stringify(data)
				});

				const result = await response.json();
				console.log("Respuesta del servidor:", result);

				if (result.status === 'success') {
					// Verificar si requiere 2FA
					if (result.user && result.user.requires_2fa === true) {
						setFormLoading(false);
						await show2FAModal(result.user.tipo, result.user.secret, result.dashboard);
					} else {
						// Login exitoso sin 2FA
						await Swal.fire({
							icon: "success",
							title: "¬°Bienvenido!",
							text: "Accediendo al sistema...",
							timer: 1500,
							showConfirmButton: false
						});
						window.location.href = result.dashboard;
					}
				} else {
					showErrorMessage(result.message || "Credenciales incorrectas");
					setFormLoading(false);
				}
			} catch (error) {
				console.error('Error de red:', error);
				showErrorMessage("Error de conexi√≥n. Verifica tu red.");
				setFormLoading(false);
			}
		});

		async function show2FAModal(tipo, secret, dashboardUrl) {
			const { value: otpCode } = await Swal.fire({
				title: 'Verificaci√≥n 2FA',
				html: `
					<p class="mb-4">Introduce el c√≥digo de 6 d√≠gitos de tu aplicaci√≥n autenticadora</p>
					<input id="swal-input-otp" class="swal2-input" type="text" maxlength="6" placeholder="123456" style="font-size: 24px; letter-spacing: 10px; text-align: center;">
				`,
				icon: 'info',
				showCancelButton: true,
				confirmButtonText: 'Verificar',
				cancelButtonText: 'Cancelar',
				preConfirm: () => {
					const code = document.getElementById('swal-input-otp').value;
					if (!code || code.length !== 6) {
						Swal.showValidationMessage('El c√≥digo debe tener 6 d√≠gitos');
						return false;
					}
					return code;
				}
			});

			if (otpCode) {
				await verify2FA(otpCode, secret, dashboardUrl);
			} else {
				setFormLoading(false);
			}
		}

		async function verify2FA(otpCode, secret, dashboardUrl) {
			try {
				const response = await fetch("{{ url_for('routes.verify_2fa') }}", {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					credentials: 'include',
					body: JSON.stringify({ 
						otp_code: otpCode,
						temp_2fa_secret: secret 
					})
				});

				const data = await response.json();

				if (data.status === 'success') {
					await Swal.fire({
						icon: "success",
						title: "¬°Verificaci√≥n Exitosa!",
						timer: 1500,
						showConfirmButton: false
					});
					window.location.href = dashboardUrl;
				} else {
					await Swal.fire({
						icon: "error",
						title: "C√≥digo Incorrecto",
						text: data.message || "El c√≥digo 2FA no es v√°lido"
					});
					setFormLoading(false);
				}
			} catch (error) {
				console.error('Error en 2FA:', error);
				await Swal.fire({
					icon: "error",
					title: "Error",
					text: "No se pudo verificar el c√≥digo"
				});
				setFormLoading(false);
			}
		}
	</script>
</body>
</html>