{% extends "layout/layout_financieras.html" %}
{% block title %}Gesti√≥n de Cat√°logos{% endblock %}

{% block content %}
<style>
    .badge-activo {
        background-color: #d4edda;
        color: #155724;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
    }
    .badge-inactivo {
        background-color: #f8d7da;
        color: #721c24;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
    }
</style>

<div class="bg-white rounded-xl shadow-lg p-8">
    <div class="flex justify-between items-center mb-8">
        <div>
            <h2 class="text-3xl font-bold mb-2">üìö Gesti√≥n de Cat√°logos</h2>
            <p class="text-gray-600">Administra los cat√°logos del sistema: m√©todos de pago, estados, tipos, etc.</p>
        </div>
        <div class="flex gap-3">
            <a href="{{ url_for('routes.dashboard_configuracion') }}" class="bg-gray-100 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-200 transition font-semibold">
                ‚Üê Volver
            </a>
            <button onclick="abrirModalCrear()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition shadow-md font-semibold">
                ‚ûï Nuevo Cat√°logo
            </button>
        </div>
    </div>

    <!-- Filtros -->
    <div class="mb-6 grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
            <label class="block mb-2 font-semibold text-gray-700">Filtrar por Tipo</label>
            <select id="filtroTipo" class="w-full p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Todos los tipos</option>
                <option value="metodo_pago">M√©todos de Pago</option>
                <option value="estado_credito">Estados de Cr√©dito</option>
                <option value="tipo_garantia">Tipos de Garant√≠a</option>
                <option value="tipo_documento">Tipos de Documento</option>
                <option value="ocupacion">Ocupaciones</option>
                <option value="destino_credito">Destino del Cr√©dito</option>
            </select>
        </div>
    </div>

    <!-- Tabla con DataTables -->
    <div class="overflow-x-auto shadow-md rounded-lg">
        <table id="catalogosTable" class="w-full border-collapse">
            <thead class="bg-gradient-to-r from-green-600 to-green-700 text-white">
                <tr>
                    <th class="px-6 py-4 text-left">Tipo</th>
                    <th class="px-6 py-4 text-left">Nombre</th>
                    <th class="px-6 py-4 text-left">Descripci√≥n</th>
                    <th class="px-6 py-4 text-center">Valor</th>
                    <th class="px-6 py-4 text-center">Orden</th>
                    <th class="px-6 py-4 text-center">Estado</th>
                    <th class="px-6 py-4 text-center">Acciones</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200"></tbody>
        </table>
    </div>
</div>

<!-- Modal para crear/editar -->
<div id="catalogoModal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full max-h-screen overflow-y-auto">
        <div class="sticky top-0 bg-gradient-to-r from-green-600 to-green-700 text-white p-6 flex justify-between items-center">
            <h3 class="text-2xl font-bold" id="modalTitle">üìö Nuevo Cat√°logo</h3>
            <button onclick="cerrarModal()" class="text-white hover:text-gray-200 text-3xl">‚úï</button>
        </div>

        <form id="catalogoForm" class="p-8">
            <input type="hidden" id="catalogoId" name="catalogoId">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label class="block mb-2 font-semibold text-gray-700">Tipo de Cat√°logo *</label>
                    <select name="tipo" id="tipo" required class="w-full p-3 border rounded focus:outline-none focus:ring-2 focus:ring-green-500">
                        <option value="">Seleccione un tipo</option>
                        <option value="metodo_pago">M√©todo de Pago</option>
                        <option value="estado_credito">Estado de Cr√©dito</option>
                        <option value="tipo_garantia">Tipo de Garant√≠a</option>
                        <option value="tipo_documento">Tipo de Documento</option>
                        <option value="ocupacion">Ocupaci√≥n</option>
                        <option value="destino_credito">Destino del Cr√©dito</option>
                    </select>
                </div>

                <div>
                    <label class="block mb-2 font-semibold text-gray-700">Nombre *</label>
                    <input type="text" name="nombre" id="nombre" required class="w-full p-3 border rounded focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Ej: Transferencia Bancaria">
                </div>

                <div class="md:col-span-2">
                    <label class="block mb-2 font-semibold text-gray-700">Descripci√≥n</label>
                    <textarea name="descripcion" id="descripcion" rows="3" class="w-full p-3 border rounded focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Descripci√≥n opcional del cat√°logo"></textarea>
                </div>

                <div>
                    <label class="block mb-2 font-semibold text-gray-700">Valor</label>
                    <input type="text" name="valor" id="valor" class="w-full p-3 border rounded focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Valor asociado (opcional)">
                </div>

                <div>
                    <label class="block mb-2 font-semibold text-gray-700">Orden</label>
                    <input type="number" name="orden" id="orden" value="0" class="w-full p-3 border rounded focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="0">
                    <p class="text-sm text-gray-500 mt-1">Define el orden de aparici√≥n</p>
                </div>

                <div>
                    <label class="block mb-2 font-semibold text-gray-700">Icono (Emoji)</label>
                    <input type="text" name="icono" id="icono" maxlength="5" class="w-full p-3 border rounded focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="üíµ">
                </div>

                <div>
                    <label class="block mb-2 font-semibold text-gray-700">Color</label>
                    <input type="color" name="color" id="color" value="#3b82f6" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>

                <div class="md:col-span-2">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" name="activo" id="activo" checked class="mr-3 w-5 h-5">
                        <span class="font-semibold text-gray-700">Activo</span>
                    </label>
                    <p class="text-sm text-gray-500 mt-1 ml-8">Los cat√°logos inactivos no aparecer√°n en los formularios</p>
                </div>
            </div>

            <div class="flex justify-end gap-3 pt-6 border-t">
                <button type="button" onclick="cerrarModal()" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 font-semibold">
                    Cancelar
                </button>
                <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">
                    üíæ Guardar
                </button>
            </div>
        </form>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">

<script>
let table = null;
let catalogoActual = null;

$(document).ready(function() {
    cargarTabla();
    
    // Filtro por tipo
    $('#filtroTipo').on('change', function() {
        table.ajax.reload();
    });
});

function cargarTabla() {
    table = $('#catalogosTable').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: '{{ url_for("routes.get_catalogos_data") }}',
            type: 'GET',
            data: function(d) {
                d.tipo = $('#filtroTipo').val();
            }
        },
        columns: [
            { 
                data: 'tipo',
                render: (data) => {
                    const tipos = {
                        'metodo_pago': 'üí≥ M√©todo de Pago',
                        'estado_credito': 'üìä Estado de Cr√©dito',
                        'tipo_garantia': 'üè† Tipo de Garant√≠a',
                        'tipo_documento': 'üìÑ Tipo de Documento',
                        'ocupacion': 'üíº Ocupaci√≥n',
                        'destino_credito': 'üéØ Destino del Cr√©dito'
                    };
                    return tipos[data] || data;
                },
                width: '15%'
            },
            { 
                data: 'nombre',
                render: (data, type, row) => {
                    const icono = row.icono ? row.icono + ' ' : '';
                    return icono + data;
                },
                width: '20%'
            },
            { 
                data: 'descripcion',
                render: (data) => data || '<span class="text-gray-400">Sin descripci√≥n</span>',
                width: '25%'
            },
            { 
                data: 'valor',
                render: (data) => data || '-',
                className: 'text-center',
                width: '10%'
            },
            { 
                data: 'orden',
                className: 'text-center font-semibold',
                width: '8%'
            },
            { 
                data: 'activo',
                render: (data) => {
                    return data ? 
                        '<span class="badge-activo">‚úì Activo</span>' : 
                        '<span class="badge-inactivo">‚úï Inactivo</span>';
                },
                className: 'text-center',
                width: '10%'
            },
            { 
                data: '_id',
                render: (data, type, row) => `
                    <div class="flex justify-center gap-2">
                        <button onclick="verDetalle('${data}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition" title="Ver detalles">üëÅÔ∏è</button>
                        <button onclick="editarCatalogo('${data}')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-sm transition" title="Editar">‚úèÔ∏è</button>
                        <button onclick="eliminarCatalogo('${data}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition" title="Eliminar">üóëÔ∏è</button>
                    </div>
                `,
                className: 'text-center',
                orderable: false,
                width: '12%'
            }
        ],
        order: [[4, 'asc']], // Ordenar por "orden"
        language: {
            lengthMenu: 'Mostrar _MENU_ registros',
            search: 'Buscar:',
            info: 'Mostrando _START_ a _END_ de _TOTAL_ registros',
            infoEmpty: 'No hay registros',
            infoFiltered: '(filtrado de _MAX_ registros totales)',
            processing: 'Procesando...',
            paginate: {
                first: '‚èÆ Primero',
                last: '√öltimo ‚è≠',
                next: 'Siguiente ‚Üí',
                previous: '‚Üê Anterior'
            }
        },
        pageLength: 10,
        lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]]
    });
}

function abrirModalCrear() {
    catalogoActual = null;
    document.getElementById('modalTitle').textContent = 'üìö Nuevo Cat√°logo';
    document.getElementById('catalogoForm').reset();
    document.getElementById('catalogoId').value = '';
    document.getElementById('activo').checked = true;
    document.getElementById('catalogoModal').classList.remove('hidden');
}

function cerrarModal() {
    document.getElementById('catalogoModal').classList.add('hidden');
    catalogoActual = null;
}

function verDetalle(id) {
    fetch(`/financiera/catalogos/view/${id}`)
        .then(r => r.json())
        .then(data => {
            const icono = data.icono || '';
            const color = data.color || '#000000';
            
            Swal.fire({
                title: `${icono} ${data.nombre}`,
                html: `
                    <div class="text-left space-y-3">
                        <div>
                            <p class="text-sm text-gray-600">Tipo</p>
                            <p class="font-semibold">${data.tipo}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Descripci√≥n</p>
                            <p class="font-semibold">${data.descripcion || 'Sin descripci√≥n'}</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">Valor</p>
                                <p class="font-semibold">${data.valor || '-'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Orden</p>
                                <p class="font-semibold">${data.orden}</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">Color</p>
                                <div class="flex items-center gap-2">
                                    <div style="width: 30px; height: 30px; background-color: ${color}; border-radius: 4px; border: 1px solid #ccc;"></div>
                                    <span class="font-semibold">${color}</span>
                                </div>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Estado</p>
                                <p class="font-semibold ${data.activo ? 'text-green-600' : 'text-red-600'}">
                                    ${data.activo ? '‚úì Activo' : '‚úï Inactivo'}
                                </p>
                            </div>
                        </div>
                    </div>
                `,
                confirmButtonColor: '#3b82f6'
            });
        })
        .catch(err => {
            Swal.fire('Error', 'No se pudieron cargar los detalles', 'error');
        });
}

function editarCatalogo(id) {
    fetch(`/financiera/catalogos/view/${id}`)
        .then(r => r.json())
        .then(data => {
            catalogoActual = data;
            document.getElementById('modalTitle').textContent = '‚úèÔ∏è Editar Cat√°logo';
            document.getElementById('catalogoId').value = data._id;
            document.getElementById('tipo').value = data.tipo || '';
            document.getElementById('nombre').value = data.nombre || '';
            document.getElementById('descripcion').value = data.descripcion || '';
            document.getElementById('valor').value = data.valor || '';
            document.getElementById('orden').value = data.orden || 0;
            document.getElementById('icono').value = data.icono || '';
            document.getElementById('color').value = data.color || '#3b82f6';
            document.getElementById('activo').checked = data.activo !== false;
            document.getElementById('catalogoModal').classList.remove('hidden');
        })
        .catch(err => {
            Swal.fire('Error', 'No se pudieron cargar los datos', 'error');
        });
}

function eliminarCatalogo(id) {
    Swal.fire({
        title: '¬øEliminar cat√°logo?',
        text: 'Esta acci√≥n no se puede deshacer',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'S√≠, eliminar',
        cancelButtonText: 'Cancelar'
    }).then(result => {
        if (result.isConfirmed) {
            fetch(`/financiera/catalogos/delete/${id}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('Eliminado', 'El cat√°logo fue eliminado exitosamente', 'success');
                    table.ajax.reload();
                } else {
                    Swal.fire('Error', 'No se pudo eliminar', 'error');
                }
            });
        }
    });
}

// Enviar formulario
document.getElementById('catalogoForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
        tipo: formData.get('tipo'),
        nombre: formData.get('nombre'),
        descripcion: formData.get('descripcion'),
        valor: formData.get('valor'),
        orden: parseInt(formData.get('orden')) || 0,
        icono: formData.get('icono'),
        color: formData.get('color'),
        activo: formData.get('activo') === 'on'
    };
    
    const catalogoId = document.getElementById('catalogoId').value;
    const url = catalogoId ? 
        `/financiera/catalogos/edit/${catalogoId}` : 
        '/financiera/catalogos/create';
    
    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success || response.status === 201) {
            Swal.fire({
                icon: 'success',
                title: catalogoId ? '¬°Actualizado!' : '¬°Creado!',
                text: `El cat√°logo se ha ${catalogoId ? 'actualizado' : 'creado'} correctamente`,
                confirmButtonColor: '#10b981'
            });
            cerrarModal();
            table.ajax.reload();
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: result.error || 'No se pudo guardar el cat√°logo',
                confirmButtonColor: '#d33'
            });
        }
    } catch (error) {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Error en la petici√≥n: ' + error,
            confirmButtonColor: '#d33'
        });
    }
});
</script>
{% endblock %}