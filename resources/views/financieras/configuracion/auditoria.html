{% extends "layout/layout_financieras.html" %}
{% block title %}Auditor√≠a del Sistema{% endblock %}

{% block content %}
<style>
    .modulo-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
    }
    .modulo-configuracion { background-color: #dbeafe; color: #1e40af; }
    .modulo-catalogos { background-color: #d1fae5; color: #065f46; }
    .modulo-clientes { background-color: #fef3c7; color: #92400e; }
    .modulo-evaluaciones { background-color: #e9d5ff; color: #6b21a8; }
    .modulo-pagos { background-color: #fce7f3; color: #9f1239; }
</style>

<div class="bg-white rounded-xl shadow-lg p-8">
    <div class="flex justify-between items-center mb-8">
        <div>
            <h2 class="text-3xl font-bold mb-2">üìä Auditor√≠a del Sistema</h2>
            <p class="text-gray-600">Registro completo de todas las acciones realizadas en el sistema</p>
        </div>
        <a href="{{ url_for('routes.dashboard_configuracion') }}" class="bg-gray-100 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-200 transition font-semibold">
            ‚Üê Volver
        </a>
    </div>

    <!-- Estad√≠sticas r√°pidas -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border-l-4 border-blue-500">
            <p class="text-sm text-gray-600 mb-1">Total de Registros</p>
            <p class="text-2xl font-bold text-blue-700" id="total_registros">0</p>
        </div>
        <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg border-l-4 border-green-500">
            <p class="text-sm text-gray-600 mb-1">Hoy</p>
            <p class="text-2xl font-bold text-green-700" id="registros_hoy">0</p>
        </div>
        <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg border-l-4 border-purple-500">
            <p class="text-sm text-gray-600 mb-1">Esta Semana</p>
            <p class="text-2xl font-bold text-purple-700" id="registros_semana">0</p>
        </div>
        <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-lg border-l-4 border-orange-500">
            <p class="text-sm text-gray-600 mb-1">Este Mes</p>
            <p class="text-2xl font-bold text-orange-700" id="registros_mes">0</p>
        </div>
    </div>

    <!-- Filtros -->
    <div class="mb-6 p-4 bg-gray-50 rounded-lg border">
        <h3 class="font-bold mb-3 text-gray-700">üîç Filtros</h3>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block mb-1 text-sm font-semibold text-gray-600">M√≥dulo</label>
                <select id="filtroModulo" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Todos los m√≥dulos</option>
                    <option value="configuracion">Configuraci√≥n</option>
                    <option value="catalogos">Cat√°logos</option>
                    <option value="clientes">Clientes</option>
                    <option value="evaluaciones">Evaluaciones</option>
                    <option value="pagos">Pagos</option>
                </select>
            </div>
            <div>
                <label class="block mb-1 text-sm font-semibold text-gray-600">Desde</label>
                <input type="date" id="filtroFechaDesde" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label class="block mb-1 text-sm font-semibold text-gray-600">Hasta</label>
                <input type="date" id="filtroFechaHasta" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex items-end">
                <button onclick="aplicarFiltros()" class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition font-semibold">
                    Aplicar Filtros
                </button>
            </div>
        </div>
    </div>

    <!-- Tabla con DataTables -->
    <div class="overflow-x-auto shadow-md rounded-lg">
        <table id="auditoriaTable" class="w-full border-collapse">
            <thead class="bg-gradient-to-r from-blue-600 to-blue-700 text-white">
                <tr>
                    <th class="px-6 py-4 text-left">Fecha y Hora</th>
                    <th class="px-6 py-4 text-left">Usuario</th>
                    <th class="px-6 py-4 text-center">M√≥dulo</th>
                    <th class="px-6 py-4 text-left">Acci√≥n</th>
                    <th class="px-6 py-4 text-center">Detalles</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200"></tbody>
        </table>
    </div>
</div>

<!-- Modal para ver detalles -->
<div id="detallesModal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-2xl max-w-3xl w-full max-h-screen overflow-y-auto">
        <div class="sticky top-0 bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6 flex justify-between items-center">
            <h3 class="text-2xl font-bold">üìã Detalles de la Auditor√≠a</h3>
            <button onclick="cerrarModal()" class="text-white hover:text-gray-200 text-3xl">‚úï</button>
        </div>

        <div class="p-8" id="detallesContent">
            <!-- Se carga din√°micamente -->
        </div>

        <div class="bg-gray-100 p-6 flex justify-end border-t">
            <button onclick="cerrarModal()" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 font-semibold">
                Cerrar
            </button>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">

<script>
let table = null;

$(document).ready(function() {
    cargarEstadisticas();
    cargarTabla();
});

function cargarEstadisticas() {
    fetch('{{ url_for("routes.get_auditoria_data") }}?length=999999')
        .then(r => r.json())
        .then(response => {
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            
            const inicioSemana = new Date(hoy);
            inicioSemana.setDate(hoy.getDate() - hoy.getDay());
            
            const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
            
            let registrosHoy = 0;
            let registrosSemana = 0;
            let registrosMes = 0;
            
            response.data.forEach(item => {
                const fechaItem = new Date(item.fecha);
                fechaItem.setHours(0, 0, 0, 0);
                
                if (fechaItem.getTime() === hoy.getTime()) registrosHoy++;
                if (fechaItem >= inicioSemana) registrosSemana++;
                if (fechaItem >= inicioMes) registrosMes++;
            });
            
            document.getElementById('total_registros').textContent = response.recordsTotal;
            document.getElementById('registros_hoy').textContent = registrosHoy;
            document.getElementById('registros_semana').textContent = registrosSemana;
            document.getElementById('registros_mes').textContent = registrosMes;
        })
        .catch(err => console.error('Error cargando estad√≠sticas:', err));
}

function cargarTabla() {
    table = $('#auditoriaTable').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: '{{ url_for("routes.get_auditoria_data") }}',
            type: 'GET'
        },
        columns: [
            { 
                data: 'fecha',
                render: (data) => {
                    if (!data) return 'N/A';
                    const fecha = new Date(data);
                    return fecha.toLocaleString('es-MX', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                },
                width: '18%'
            },
            { 
                data: 'usuario_nombre',
                render: (data, type, row) => {
                    return `
                        <div>
                            <p class="font-semibold">${data || 'N/A'}</p>
                            <p class="text-xs text-gray-500">${row.usuario_id ? row.usuario_id.substring(0, 8) + '...' : ''}</p>
                        </div>
                    `;
                },
                width: '20%'
            },
            { 
                data: 'modulo',
                render: (data) => {
                    const modulos = {
                        'configuracion': '‚öôÔ∏è Configuraci√≥n',
                        'catalogos': 'üìö Cat√°logos',
                        'clientes': 'üë• Clientes',
                        'evaluaciones': 'üìã Evaluaciones',
                        'pagos': 'üí∞ Pagos'
                    };
                    const texto = modulos[data] || data || 'N/A';
                    const clase = data ? `modulo-${data}` : '';
                    return `<span class="modulo-badge ${clase}">${texto}</span>`;
                },
                className: 'text-center',
                width: '15%'
            },
            { 
                data: 'accion',
                render: (data) => data || 'N/A',
                width: '30%'
            },
            { 
                data: '_id',
                render: (data, type, row) => `
                    <button onclick="verDetalles('${data}')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm transition font-semibold">
                        üëÅÔ∏è Ver
                    </button>
                `,
                className: 'text-center',
                orderable: false,
                width: '12%'
            }
        ],
        order: [[0, 'desc']], // Ordenar por fecha descendente
        language: {
            lengthMenu: 'Mostrar _MENU_ registros',
            search: 'Buscar:',
            info: 'Mostrando _START_ a _END_ de _TOTAL_ registros',
            infoEmpty: 'No hay registros',
            infoFiltered: '(filtrado de _MAX_ registros totales)',
            processing: 'Procesando...',
            paginate: {
                first: '‚èÆ Primero',
                last: '√öltimo ‚è≠',
                next: 'Siguiente ‚Üí',
                previous: '‚Üê Anterior'
            }
        },
        pageLength: 25,
        lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]]
    });
}

function aplicarFiltros() {
    // Esta funcionalidad se puede implementar mejorando el endpoint en el backend
    Swal.fire({
        icon: 'info',
        title: 'Filtros',
        text: 'Los filtros avanzados se implementar√°n en una versi√≥n futura',
        confirmButtonColor: '#3b82f6'
    });
}

function verDetalles(id) {
    fetch(`/financiera/auditoria/view/${id}`)
        .then(r => r.json())
        .then(data => {
            let detallesHTML = '';
            
            if (data.detalles && typeof data.detalles === 'object') {
                detallesHTML = '<div class="bg-gray-50 p-4 rounded border"><pre class="text-sm overflow-x-auto">' + 
                    JSON.stringify(data.detalles, null, 2) + 
                    '</pre></div>';
            } else {
                detallesHTML = '<p class="text-gray-500">Sin detalles adicionales</p>';
            }
            
            const html = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-50 p-4 rounded">
                            <p class="text-sm text-gray-600 mb-1">Usuario</p>
                            <p class="font-bold text-lg">${data.usuario_nombre || 'N/A'}</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded">
                            <p class="text-sm text-gray-600 mb-1">Fecha y Hora</p>
                            <p class="font-semibold">${new Date(data.fecha).toLocaleString('es-MX')}</p>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded">
                        <p class="text-sm text-gray-600 mb-1">M√≥dulo</p>
                        <p class="font-semibold">${data.modulo || 'N/A'}</p>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded">
                        <p class="text-sm text-gray-600 mb-2">Acci√≥n Realizada</p>
                        <p class="font-semibold text-blue-700">${data.accion || 'N/A'}</p>
                    </div>
                    
                    <div>
                        <p class="text-sm text-gray-600 mb-2 font-semibold">Detalles:</p>
                        ${detallesHTML}
                    </div>
                </div>
            `;
            
            document.getElementById('detallesContent').innerHTML = html;
            document.getElementById('detallesModal').classList.remove('hidden');
        })
        .catch(err => {
            Swal.fire('Error', 'No se pudieron cargar los detalles', 'error');
        });
}

function cerrarModal() {
    document.getElementById('detallesModal').classList.add('hidden');
}
</script>
{% endblock %}