{% extends "layout/layout_financieras.html" %}
{% block title %}Crear Evaluaci贸n de Cr茅dito{% endblock %}

{% block content %}
<style>
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    .animate-spin {
        animation: spin 1s linear infinite;
    }
    .risk-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
    }
    .risk-low { background-color: #d4edda; color: #155724; }
    .risk-medium { background-color: #fff3cd; color: #856404; }
    .risk-high { background-color: #f8d7da; color: #721c24; }
</style>

<div class="bg-white max-w-6xl mx-auto p-8 rounded-xl shadow-xl">
    <h2 class="text-3xl font-bold mb-6">馃挸 Evaluaciones de Cr茅dito <span class="text-sm text-gray-500">> Nueva evaluaci贸n</span></h2>

    <!-- Overlay Preloader -->
    <div id="preloader" class="fixed inset-0 bg-black bg-opacity-60 flex flex-col items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow p-6 text-center w-80">
            <h2 class="text-lg font-bold mb-4">Procesando...</h2>
            <div class="w-full bg-gray-200 rounded-full h-4">
                <div id="progress-bar" class="bg-blue-600 h-4 rounded-full" style="width: 0%"></div>
            </div>
            <p id="progress-text" class="mt-2 text-sm font-semibold text-gray-700">0%</p>
        </div>
    </div>

    <!-- Formulario -->
    <form id="evaluacionForm" method="POST" action="{{ url_for('routes.create_evaluacion_post') }}">
        
        <!-- DATOS DEL CLIENTE -->
        <fieldset class="border border-gray-300 rounded-lg p-6 mb-6">
            <legend class="text-lg font-bold px-2">馃搵 Datos del Cliente</legend>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Cliente -->
                <div class="md:col-span-2">
                    <label class="block mb-1 font-semibold">Cliente *</label>
                    <select name="cliente_id" id="cliente_select" required class="w-full p-2 border rounded">
                        <option value="">Seleccione un cliente</option>
                        {% for cliente in clientes %}
                        <option value="{{ cliente.cliente_id }}">{{ cliente.nombre_completo }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </fieldset>

        <!-- SOLICITUD DE CR脡DITO -->
        <fieldset class="border border-gray-300 rounded-lg p-6 mb-6">
            <legend class="text-lg font-bold px-2">馃挵 Solicitud de Cr茅dito</legend>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Monto Solicitado -->
                <div>
                    <label class="block mb-1 font-semibold">Monto Solicitado ($) *</label>
                    <input type="number" name="monto_solicitado" step="0.01" required class="w-full p-2 border rounded" placeholder="0.00">
                </div>
                <!-- Plazo en Meses -->
                <div>
                    <label class="block mb-1 font-semibold">Plazo (meses) *</label>
                    <input type="number" name="plazo_meses" step="1" min="1" required class="w-full p-2 border rounded" placeholder="12">
                </div>
                <!-- Tasa de Inter茅s -->
                <div>
                    <label class="block mb-1 font-semibold">Tasa de Inter茅s (%) *</label>
                    <input type="number" name="tasa_interes" step="0.01" min="0" required class="w-full p-2 border rounded" placeholder="10.5">
                </div>
                <!-- Prop贸sito del Cr茅dito -->
                <div>
                    <label class="block mb-1 font-semibold">Prop贸sito del Cr茅dito *</label>
                    <select name="proposito_credito" required class="w-full p-2 border rounded">
                        <option value="">Seleccione un prop贸sito</option>
                        <option value="Consumo">Consumo</option>
                        <option value="Vivienda">Vivienda</option>
                        <option value="Educaci贸n">Educaci贸n</option>
                        <option value="Negocio">Negocio</option>
                        <option value="Refinanciamiento">Refinanciamiento</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
            </div>
        </fieldset>

        <!-- SITUACI脫N FINANCIERA -->
        <fieldset class="border border-gray-300 rounded-lg p-6 mb-6">
            <legend class="text-lg font-bold px-2">馃搳 Situaci贸n Financiera</legend>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Score de Cr茅dito -->
                <div>
                    <label class="block mb-1 font-semibold">Score de Cr茅dito (0-850)</label>
                    <input type="number" name="score_credito" step="1" min="0" max="850" class="w-full p-2 border rounded" placeholder="750" value="750">
                </div>
                <!-- Ingresos Mensuales -->
                <div>
                    <label class="block mb-1 font-semibold">Ingresos Mensuales ($)</label>
                    <input type="number" name="ingresos_mensuales" step="0.01" min="0" class="w-full p-2 border rounded" placeholder="0.00" value="0">
                </div>
                <!-- Deudas Existentes -->
                <div>
                    <label class="block mb-1 font-semibold">Deudas Existentes ($)</label>
                    <input type="number" name="deudas_existentes" step="0.01" min="0" class="w-full p-2 border rounded" placeholder="0.00" value="0">
                </div>
                <!-- Fecha de Evaluaci贸n -->
                <div>
                    <label class="block mb-1 font-semibold">Fecha de Evaluaci贸n</label>
                    <input type="date" name="fecha_evaluacion" class="w-full p-2 border rounded" value="{{ current_date }}" readonly>
                </div>
            </div>
        </fieldset>

        <!-- RESUMEN DE AN脕LISIS -->
        <fieldset class="border border-blue-300 rounded-lg p-6 mb-6 bg-blue-50">
            <legend class="text-lg font-bold px-2 text-blue-700">馃搱 Resumen del An谩lisis (Autom谩tico)</legend>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Cuota Mensual -->
                <div class="bg-white p-3 rounded border">
                    <p class="text-sm text-gray-600">Cuota Mensual Estimada</p>
                    <p class="text-2xl font-bold text-blue-600">$<span id="cuota_mensual">0.00</span></p>
                </div>
                <!-- Relaci贸n Deuda-Ingreso -->
                <div class="bg-white p-3 rounded border">
                    <p class="text-sm text-gray-600">Relaci贸n Deuda-Ingreso</p>
                    <p class="text-2xl font-bold text-blue-600"><span id="relacion_deuda">0.00</span>%</p>
                </div>
                <!-- Calificaci贸n de Riesgo -->
                <div class="bg-white p-3 rounded border">
                    <p class="text-sm text-gray-600">Calificaci贸n de Riesgo</p>
                    <p class="text-lg"><span id="riesgo_badge" class="risk-badge risk-low">Bajo</span></p>
                </div>
                <!-- Recomendaci贸n -->
                <div class="bg-white p-3 rounded border">
                    <p class="text-sm text-gray-600">Recomendaci贸n</p>
                    <p class="text-2xl font-bold" id="recomendacion" style="color: #28a745;">鉁?Aprobado</p>
                </div>
            </div>
        </fieldset>

        <div class="flex justify-between mt-6">
            <button type="reset" class="px-6 py-2 bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200">
                馃Ч Limpiar
            </button>
            <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                馃捑 Guardar Evaluaci贸n
            </button>
        </div>
    </form>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
function calcularIndicadores() {
    const monto = parseFloat(document.querySelector('[name="monto_solicitado"]').value) || 0;
    const plazo = parseInt(document.querySelector('[name="plazo_meses"]').value) || 1;
    const tasa = parseFloat(document.querySelector('[name="tasa_interes"]').value) || 0;
    const score = parseInt(document.querySelector('[name="score_credito"]').value) || 0;
    const ingresos = parseFloat(document.querySelector('[name="ingresos_mensuales"]').value) || 0;
    const deudas = parseFloat(document.querySelector('[name="deudas_existentes"]').value) || 0;

    // Calcular cuota mensual
    let cuotaMensual = 0;
    if (monto > 0 && plazo > 0) {
        const tasaMensual = tasa / 100 / 12;
        if (tasaMensual === 0) {
            cuotaMensual = monto / plazo;
        } else {
            const factor = Math.pow(1 + tasaMensual, plazo);
            cuotaMensual = (monto * tasaMensual * factor) / (factor - 1);
        }
    }

    // Calcular relaci贸n deuda-ingreso
    let relacionDeuda = 0;
    if (ingresos > 0) {
        const deudaTotal = deudas + cuotaMensual;
        relacionDeuda = (deudaTotal / ingresos) * 100;
    }

    // Determinar calificaci贸n de riesgo
    let riesgo = "Bajo";
    if (score >= 750 && relacionDeuda <= 30) {
        riesgo = "Bajo";
    } else if (score >= 650 && relacionDeuda <= 50) {
        riesgo = "Medio";
    } else {
        riesgo = "Alto";
    }

    // Determinar recomendaci贸n
    const montoMaximo = ingresos > 0 ? ingresos * plazo * 0.5 : monto;
    let recomendacion = "Aprobado";
    let colorRec = "#28a745";
    if (monto > montoMaximo || riesgo === "Alto") {
        recomendacion = "Rechazado";
        colorRec = "#dc3545";
    }

    // Actualizar UI
    document.getElementById('cuota_mensual').textContent = cuotaMensual.toFixed(2);
    document.getElementById('relacion_deuda').textContent = relacionDeuda.toFixed(2);
    
    const badge = document.getElementById('riesgo_badge');
    badge.textContent = riesgo;
    badge.className = `risk-badge risk-${riesgo.toLowerCase()}`;
    
    const recEl = document.getElementById('recomendacion');
    recEl.textContent = recomendacion === "Aprobado" ? "鉁?Aprobado" : "鉁?Rechazado";
    recEl.style.color = colorRec;
}

// Escuchar cambios en campos num茅ricos
document.querySelectorAll('input[type="number"], input[type="date"]').forEach(el => {
    el.addEventListener('change', calcularIndicadores);
    el.addEventListener('input', calcularIndicadores);
});

// Calcular al cargar
document.addEventListener('DOMContentLoaded', function() {
    calcularIndicadores();
});

// Enviar formulario
document.getElementById("evaluacionForm").addEventListener("submit", async function(e) {
    e.preventDefault();

    const preloader = document.getElementById("preloader");
    const progressBar = document.getElementById("progress-bar");
    const progressText = document.getElementById("progress-text");

    preloader.classList.remove("hidden");

    const formData = new FormData(this);

    let progress = 0;
    const interval = setInterval(() => {
        if (progress < 90) {
            progress += 10;
            progressBar.style.width = progress + "%";
            progressText.textContent = progress + "%";
        }
    }, 300);

    try {
        const response = await fetch(this.action, {
            method: "POST",
            body: formData
        });

        const result = await response.json();

        clearInterval(interval);
        progressBar.style.width = "100%";
        progressText.textContent = "100%";

        setTimeout(() => {
            preloader.classList.add("hidden");
            if (result.success) {
                Swal.fire({
                    icon: 'success',
                    title: '隆脡xito!',
                    text: 'Evaluaci贸n de cr茅dito creada correctamente',
                    confirmButtonColor: '#3085d6'
                }).then(() => {
                    window.location.href = "{{ url_for('routes.dashboard_views_evaluaciones') }}";
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: result.error || 'No se pudo crear la evaluaci贸n',
                    confirmButtonColor: '#d33'
                });
            }
        }, 800);

    } catch (error) {
        clearInterval(interval);
        preloader.classList.add("hidden");
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Error en la petici贸n: ' + error,
            confirmButtonColor: '#d33'
        });
    }
});
</script>
{% endblock %}