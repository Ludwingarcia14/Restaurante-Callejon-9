{% extends "layout/layout_financieras.html" %}
{% block title %}Evaluaciones de Cr√©dito{% endblock %}

{% block content %}
<style>
    .risk-badge {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: bold;
        text-align: center;
    }
    .risk-bajo { 
        background-color: #d4edda; 
        color: #155724; 
    }
    .risk-medio { 
        background-color: #fff3cd; 
        color: #856404; 
    }
    .risk-alto { 
        background-color: #f8d7da; 
        color: #721c24; 
    }
    .recomendacion-aprobado { 
        color: #28a745; 
        font-weight: bold; 
    }
    .recomendacion-rechazado { 
        color: #dc3545; 
        font-weight: bold; 
    }
    .dt-search {
        margin-bottom: 1rem;
    }
    .dt-search input {
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
</style>

<div class="bg-white rounded-xl shadow-lg p-8">
    <div class="flex justify-between items-center mb-8">
        <div>
            <h2 class="text-3xl font-bold mb-2">üí≥ Evaluaciones de Cr√©dito</h2>
            <p class="text-gray-600">Gestiona y visualiza todas las evaluaciones de cr√©dito de tus clientes</p>
        </div>
        <a href="{{ url_for('routes.dashboard_create_evaluacion') }}" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition shadow-md font-semibold">
            ‚ûï Nueva Evaluaci√≥n
        </a>
    </div>

    <!-- Tabla con DataTables -->
    <div class="overflow-x-auto shadow-md rounded-lg">
        <table id="evaluacionesTable" class="w-full border-collapse">
            <thead class="bg-gradient-to-r from-blue-600 to-blue-700 text-white">
                <tr>
                    <th class="px-6 py-4 text-left">ID</th>
                    <th class="px-6 py-4 text-left">Cliente</th>
                    <th class="px-6 py-4 text-left">Email</th>
                    <th class="px-6 py-4 text-right">Monto</th>
                    <th class="px-6 py-4 text-center">Plazo</th>
                    <th class="px-6 py-4 text-center">Riesgo</th>
                    <th class="px-6 py-4 text-center">Recomendaci√≥n</th>
                    <th class="px-6 py-4 text-left">Fecha</th>
                    <th class="px-6 py-4 text-center">Acciones</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200"></tbody>
        </table>
    </div>
</div>

<!-- Modal para ver detalles -->
<div id="detallesModal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-2xl max-w-5xl w-full max-h-screen overflow-y-auto">
        <!-- Header Modal -->
        <div class="sticky top-0 bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6 flex justify-between items-center">
            <h3 class="text-2xl font-bold">üìä Detalles de la Evaluaci√≥n</h3>
            <button onclick="cerrarModal()" class="text-white hover:text-gray-200 text-3xl">‚úï</button>
        </div>

        <!-- Contenido Modal -->
        <div class="p-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8" id="detallesContent">
                <!-- Se carga din√°micamente -->
            </div>
        </div>

        <!-- Footer Modal -->
        <div class="bg-gray-100 p-6 flex justify-end gap-3 border-t">
            <button onclick="cerrarModal()" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 font-semibold">Cerrar</button>
            <button onclick="editarEvaluacion()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">‚úèÔ∏è Editar</button>
            <button onclick="eliminarEvaluacion()" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold">üóëÔ∏è Eliminar</button>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">

<script>
let evaluacionActual = null;
let table = null;

$(document).ready(function() {
    table = $('#evaluacionesTable').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: '{{ url_for("routes.get_evaluaciones_data") }}',
            type: 'GET'
        },
        columns: [
            { 
                data: 'evaluacion_id', 
                render: (data) => data ? data.substring(0, 8) + '...' : 'N/A',
                width: '10%'
            },
            { 
                data: 'cliente_nombre',
                width: '15%'
            },
            { 
                data: 'cliente_email',
                width: '20%'
            },
            { 
                data: 'evaluacion_monto_solicitado',
                render: (data) => '$' + parseFloat(data).toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2}),
                className: 'text-right',
                width: '12%'
            },
            { 
                data: 'evaluacion_plazo_meses',
                render: (data) => data + ' meses',
                className: 'text-center',
                width: '10%'
            },
            { 
                data: 'evaluacion_calificacion_riesgo',
                render: (data) => {
                    const riesgo = data ? data.toLowerCase() : 'desconocido';
                    return `<span class="risk-badge risk-${riesgo}">${data || 'N/A'}</span>`;
                },
                className: 'text-center',
                width: '12%'
            },
            { 
                data: 'evaluacion_recomendacion',
                render: (data) => {
                    if (!data) return 'N/A';
                    const clase = 'recomendacion-' + data.toLowerCase();
                    return `<span class="${clase}">${data === 'Aprobado' ? '‚úì ' + data : '‚úó ' + data}</span>`;
                },
                className: 'text-center',
                width: '12%'
            },
            { 
                data: 'created_at',
                render: (data) => {
                    if (!data) return 'N/A';
                    return new Date(data).toLocaleDateString('es-MX', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });
                },
                width: '12%'
            },
            { 
                data: '_id',
                render: (data, type, row) => `
                    <div class="flex justify-center gap-2">
                        <button onclick="verDetalles('${row._id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm transition font-semibold" title="Ver detalles">üëÅÔ∏è</button>
                        <button onclick="eliminarEvaluacionDirecta('${row._id}')" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded text-sm transition font-semibold" title="Eliminar">üóëÔ∏è</button>
                    </div>
                `,
                className: 'text-center',
                orderable: false,
                width: '15%'
            }
        ],
        order: [[7, 'desc']],
        language: {
            lengthMenu: 'Mostrar _MENU_ registros',
            search: 'Buscar:',
            info: 'Mostrando _START_ a _END_ de _TOTAL_ registros',
            infoEmpty: 'No hay registros',
            infoFiltered: '(filtrado de _MAX_ registros totales)',
            processing: 'Procesando...',
            paginate: {
                first: '‚èÆ Primero',
                last: '√öltimo ‚è≠',
                next: 'Siguiente ‚Üí',
                previous: '‚Üê Anterior'
            }
        },
        pageLength: 10,
        lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]],
        responsive: true
    });
});

function verDetalles(id) {
    fetch(`/financiera/evaluaciones/view/${id}`)
        .then(r => r.json())
        .then(data => {
            evaluacionActual = data;
            let html = `
                <!-- DATOS DEL CLIENTE -->
                <div class="col-span-2 border-b-2 pb-4 mb-6">
                    <h4 class="text-xl font-bold text-blue-700">üìã Datos del Cliente</h4>
                </div>
                <div class="bg-gray-50 p-4 rounded">
                    <p class="text-sm text-gray-600 mb-1">Nombre del Cliente</p>
                    <p class="font-bold text-lg">${data.cliente_nombre || 'N/A'}</p>
                </div>
                <div class="bg-gray-50 p-4 rounded">
                    <p class="text-sm text-gray-600 mb-1">Email</p>
                    <p class="font-semibold text-blue-600">${data.cliente_email || 'N/A'}</p>
                </div>

                <!-- SOLICITUD DE CR√âDITO -->
                <div class="col-span-2 border-b-2 pb-4 mb-6 mt-6">
                    <h4 class="text-xl font-bold text-blue-700">üí∞ Solicitud de Cr√©dito</h4>
                </div>
                <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded border-l-4 border-green-500">
                    <p class="text-sm text-gray-600 mb-1">Monto Solicitado</p>
                    <p class="font-bold text-2xl text-green-700">$${parseFloat(data.evaluacion_monto_solicitado || 0).toLocaleString('es-MX', {minimumFractionDigits: 2})}</p>
                </div>
                <div class="bg-gray-50 p-4 rounded">
                    <p class="text-sm text-gray-600 mb-1">Plazo</p>
                    <p class="font-semibold">${data.evaluacion_plazo_meses || 'N/A'} meses</p>
                </div>
                <div class="bg-gray-50 p-4 rounded">
                    <p class="text-sm text-gray-600 mb-1">Tasa de Inter√©s</p>
                    <p class="font-semibold">${parseFloat(data.evaluacion_tasa_interes || 0).toFixed(2)}%</p>
                </div>
                <div class="bg-gray-50 p-4 rounded">
                    <p class="text-sm text-gray-600 mb-1">Prop√≥sito</p>
                    <p class="font-semibold">${data.evaluacion_proposito || 'N/A'}</p>
                </div>

                <!-- SITUACI√ìN FINANCIERA -->
                <div class="col-span-2 border-b-2 pb-4 mb-6 mt-6">
                    <h4 class="text-xl font-bold text-blue-700">üìä Situaci√≥n Financiera</h4>
                </div>
                <div class="bg-gray-50 p-4 rounded">
                    <p class="text-sm text-gray-600 mb-1">Score de Cr√©dito</p>
                    <p class="font-bold text-lg">${data.evaluacion_score_credito || 0} / 850</p>
                </div>
                <div class="bg-gray-50 p-4 rounded">
                    <p class="text-sm text-gray-600 mb-1">Ingresos Mensuales</p>
                    <p class="font-semibold">$${parseFloat(data.evaluacion_ingresos_mensuales || 0).toLocaleString('es-MX', {minimumFractionDigits: 2})}</p>
                </div>
                <div class="bg-gray-50 p-4 rounded">
                    <p class="text-sm text-gray-600 mb-1">Deudas Existentes</p>
                    <p class="font-semibold text-red-600">$${parseFloat(data.evaluacion_deudas_existentes || 0).toLocaleString('es-MX', {minimumFractionDigits: 2})}</p>
                </div>
                <div class="bg-gray-50 p-4 rounded">
                    <p class="text-sm text-gray-600 mb-1">Cuota Mensual Estimada</p>
                    <p class="font-bold">$${parseFloat(data.evaluacion_cuota_mensual || 0).toLocaleString('es-MX', {minimumFractionDigits: 2})}</p>
                </div>

                <!-- AN√ÅLISIS Y RESULTADO -->
                <div class="col-span-2 border-b-2 pb-4 mb-6 mt-6">
                    <h4 class="text-xl font-bold text-blue-700">üìà An√°lisis de Riesgo</h4>
                </div>
                <div class="bg-gray-50 p-4 rounded">
                    <p class="text-sm text-gray-600 mb-2">Relaci√≥n Deuda-Ingreso</p>
                    <div class="flex items-center gap-3">
                        <p class="font-bold text-lg">${parseFloat(data.evaluacion_relacion_deuda_ingreso || 0).toFixed(2)}%</p>
                        <div class="w-32 bg-gray-300 rounded-full h-2">
                            <div class="bg-blue-600 h-2 rounded-full" style="width: ${Math.min(parseFloat(data.evaluacion_relacion_deuda_ingreso || 0), 100)}%"></div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 p-4 rounded">
                    <p class="text-sm text-gray-600 mb-1">Monto M√°ximo Permitido</p>
                    <p class="font-semibold">$${parseFloat(data.evaluacion_monto_maximo || 0).toLocaleString('es-MX', {minimumFractionDigits: 2})}</p>
                </div>

                <!-- RESULTADO FINAL -->
                <div class="col-span-2 bg-gradient-to-r from-blue-50 to-blue-100 p-6 rounded-lg border-2 border-blue-300 mt-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="text-center">
                            <p class="text-sm text-gray-600 mb-2">Calificaci√≥n de Riesgo</p>
                            <p class="risk-badge risk-${(data.evaluacion_calificacion_riesgo || 'desconocido').toLowerCase()} text-base px-4 py-2">${data.evaluacion_calificacion_riesgo || 'N/A'}</p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-600 mb-2">Recomendaci√≥n</p>
                            <p class="recomendacion-${(data.evaluacion_recomendacion || 'rechazado').toLowerCase()} text-base">${data.evaluacion_recomendacion === 'Aprobado' ? '‚úì Aprobado' : '‚úó Rechazado'}</p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-600 mb-2">Fecha de Evaluaci√≥n</p>
                            <p class="font-semibold">${data.created_at ? new Date(data.created_at).toLocaleDateString('es-MX') : 'N/A'}</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('detallesContent').innerHTML = html;
            document.getElementById('detallesModal').classList.remove('hidden');
        })
        .catch(err => {
            Swal.fire('Error', 'No se pudieron cargar los detalles', 'error');
            console.error(err);
        });
}

function cerrarModal() {
    document.getElementById('detallesModal').classList.add('hidden');
    evaluacionActual = null;
}

function editarEvaluacion() {
    if (!evaluacionActual) return;
    
    Swal.fire({
        title: '‚úèÔ∏è Editar Evaluaci√≥n',
        html: `
            <div class="text-left">
                <label class="block mb-4">
                    <span class="font-semibold text-gray-700">Score de Cr√©dito (0-850):</span>
                    <input type="number" id="score" min="0" max="850" value="${evaluacionActual.evaluacion_score_credito}" class="w-full p-3 border border-gray-300 rounded mt-2 focus:outline-none focus:border-blue-500">
                </label>
                <label class="block mb-4">
                    <span class="font-semibold text-gray-700">Estado de Evaluaci√≥n:</span>
                    <select id="status" class="w-full p-3 border border-gray-300 rounded mt-2 focus:outline-none focus:border-blue-500">
                        <option value="0" ${evaluacionActual.evaluacion_status === '0' ? 'selected' : ''}>‚è≥ Pendiente</option>
                        <option value="1" ${evaluacionActual.evaluacion_status === '1' ? 'selected' : ''}>‚úì Aprobada</option>
                        <option value="2" ${evaluacionActual.evaluacion_status === '2' ? 'selected' : ''}>‚úó Rechazada</option>
                    </select>
                </label>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Guardar',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        preConfirm: () => {
            return {
                evaluacion_score_credito: parseFloat(document.getElementById('score').value),
                evaluacion_status: document.getElementById('status').value
            };
        }
    }).then(result => {
        if (result.isConfirmed) {
            fetch(`/financiera/evaluaciones/edit/${evaluacionActual._id}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(result.value)
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('¬°√âxito!', 'Evaluaci√≥n actualizada correctamente', 'success');
                    table.ajax.reload();
                    cerrarModal();
                } else {
                    Swal.fire('Error', data.error || 'No se pudo actualizar', 'error');
                }
            });
        }
    });
}

function eliminarEvaluacionDirecta(id) {
    Swal.fire({
        title: '¬øEliminar evaluaci√≥n?',
        text: 'Esta acci√≥n no se puede deshacer',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'S√≠, eliminar',
        cancelButtonText: 'Cancelar'
    }).then(result => {
        if (result.isConfirmed) {
            fetch(`/financiera/evaluaciones/delete/${id}`, { 
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire('Eliminado', 'La evaluaci√≥n fue eliminada exitosamente', 'success');
                        table.ajax.reload();
                    } else {
                        Swal.fire('Error', 'No se pudo eliminar', 'error');
                    }
                });
        }
    });
}

function eliminarEvaluacion() {
    if (!evaluacionActual) return;
    eliminarEvaluacionDirecta(evaluacionActual._id);
}
</script>
{% endblock %}