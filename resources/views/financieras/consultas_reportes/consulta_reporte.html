{% extends "layout/layout_financieras.html" %}
{% block page_title %}Dashboard Financieras{% endblock %}
{% block header_title %}Panel Financiero{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<div class="container">
    <h1 class="text-xl font-medium mb-6 fade-up fade-delay-2"
        id="welcome-message"></h1>

    <h2 class="text-2xl font-semibold mb-4 text-gray-800 fade-up fade-delay-3">üìà Resumen Financiero</h2>
    
    <div id="skeleton-summary-grid" 
         class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
        
        {# Generamos 4 esqueletos para las 4 m√©tricas #}
        {% for _ in range(4) %}
        <div class="bg-white p-5 rounded-2xl shadow-md" aria-hidden="true">
            <div class='text-4xl mb-3'>
                <span class="placeholder col-4 placeholder-lg bg-gray-300 rounded"></span>
            </div>
            <div class='text-2xl font-bold placeholder-glow'>
                <span class="placeholder col-8"></span>
            </div>
            <div class='text-gray-500 text-sm placeholder-glow'>
                <span class="placeholder col-6"></span>
            </div>
        </div>
        {% endfor %}
    </div>

    <div id="summary-grid"
        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10 hidden"> 
        {# Contenido cargado por JavaScript #}
    </div>

    <h2 class="text-2xl font-semibold mb-4 text-gray-800 fade-up fade-delay-3">üìä An√°lisis de Datos</h2>
        <div id="charts-container" 
            class="grid grid-cols-1 lg:grid-cols-2 gap-6 hidden">
            
            <div class="bg-white p-6 rounded-2xl shadow-md fade-up fade-delay-4">
                <h3 class="text-lg font-medium mb-4">Clientes vs. Cr√©ditos Activos</h3>
                <canvas id="clientesCreditosChart"></canvas>
            </div>

            <div class="bg-white p-4 rounded-2xl shadow-md fade-up fade-delay-5">
                <h3 class="text-lg font-medium mb-2">Distribuci√≥n de Pagos</h3>
                <div style="max-height: 350px;">
                    <canvas id="pagosChart"></canvas>
                </div>
            </div>

    </div>

</div>

{# Scripts de Saludo se mantienen igual #}
<script>
    // L√≥gica del saludo (Se mantiene igual)
    document.addEventListener('DOMContentLoaded', function() {
        const welcomeElement = document.getElementById('welcome-message');
        
        const myDate = new Date();
        const hrs = myDate.getHours();
        const nombre = "{{ session.get('usuario_nombre', 'Usuario') }} {{ session.get('usuario_apellidos', '') }}";
        let saludar;
        if (hrs < 12) {
            saludar = 'Buenos d√≠as ‚òÄÔ∏è';
        } else if (hrs >= 12 && hrs <= 18) {
            saludar = 'Buenas tardes ‚õÖ';
        } else {
            saludar = 'Buenas noches üåô';
        }
        if (welcomeElement) {
            welcomeElement.textContent = `${saludar}, ${nombre}`;
        }
    });
</script>

<script>
// --- L√ìGICA DEL SKELETON SCREEN, RESUMEN Y GR√ÅFICAS ---
document.addEventListener('DOMContentLoaded', function() {
    
    const skeletonSummaryContainer = document.getElementById('skeleton-summary-grid');
    const summaryContainer = document.getElementById('summary-grid');
    const chartsContainer = document.getElementById('charts-container');
    
    fetch("{{ url_for('routes.api_conteo_clientes') }}")
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            // Aseguramos que data.stats tenga los 4 campos esperados de MongoDB
            // Supongamos que tu API devuelve: 
            // { total_clientes: N, total_creditos: N, pagos_pendientes: N, pagos_vencidos: N }
            
            // 1. RENDERIZAR EL RESUMEN DE M√âTRICAS
            const items = [
                ['üë•', 'Total Clientes', data.total_clientes || 0],
                ['üí∞', 'Cr√©ditos Activos', data.total_creditos || 0],
                ['‚è≥', 'Pagos Pendientes', data.pagos_pendientes || 0],
                ['üö®', 'Pagos Vencidos', data.pagos_vencidos || 0]
            ];

            summaryContainer.innerHTML = '';
            let delay = 3;
            items.forEach(([icon, label, count]) => {
                const formattedCount = new Intl.NumberFormat('es-MX').format(count); // Formato de n√∫meros
                const card = document.createElement('div');
                card.className = `bg-white p-5 rounded-2xl shadow-md hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 fade-up fade-delay-${delay}`;
                card.innerHTML = `
                    <div class='text-4xl mb-3'>${icon}</div>
                    <div class='text-2xl font-bold'>${formattedCount}</div>
                    <div class='text-gray-500 text-sm'>${label}</div>
                `;
                summaryContainer.appendChild(card);
                delay++;
            });

            // Ocultar el esqueleto y mostrar el resumen
            setTimeout(() => {
                skeletonSummaryContainer.classList.add('hidden'); 
                summaryContainer.classList.remove('hidden');    
            }, 300);


            // 2. RENDERIZAR LAS GR√ÅFICAS
            
            // Gr√°fica 1: Clientes vs. Cr√©ditos Activos (Gr√°fica de Barras)
            const ctxClientesCreditos = document.getElementById('clientesCreditosChart').getContext('2d');
            new Chart(ctxClientesCreditos, {
                type: 'bar',
                data: {
                    labels: ['Clientes', 'Cr√©ditos Activos'],
                    datasets: [{
                        label: 'Conteo',
                        data: [data.total_clientes || 0, data.total_creditos || 0],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.7)', // blue-500
                            'rgba(16, 185, 129, 0.7)' // emerald-500
                        ],
                        borderColor: [
                            'rgba(59, 130, 246, 1)',
                            'rgba(16, 185, 129, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Gr√°fica 2: Estado de Pagos (Gr√°fica de Pastel)
            const ctxPagos = document.getElementById('pagosChart').getContext('2d');
            new Chart(ctxPagos, {
                type: 'doughnut',
                data: {
                    labels: ['Pendientes', 'Vencidos'],
                    datasets: [{
                        label: 'N√∫mero de Pagos',
                        data: [data.pagos_pendientes || 0, data.pagos_vencidos || 0],
                        backgroundColor: [
                            'rgba(245, 158, 11, 0.7)', // amber-500 (Pendientes)
                            'rgba(239, 68, 68, 0.7)'  // red-500 (Vencidos)
                        ],
                        borderColor: [
                            'rgba(245, 158, 11, 1)',
                            'rgba(239, 68, 68, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });

            // Mostrar el contenedor de gr√°ficas
            chartsContainer.classList.remove('hidden');

        })
        .catch(err => {
            console.error('Error al cargar stats:', err);
            // Mostrar un mensaje de error
            skeletonSummaryContainer.innerHTML = '<p class="text-red-600">‚ö†Ô∏è Error al conectar con el servidor de estad√≠sticas.</p>';
            chartsContainer.classList.add('hidden');
        });
});
</script>

{% endblock %}