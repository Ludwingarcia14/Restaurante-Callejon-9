{% extends "layout/layout_financieras.html" %}
{% block title %}Reporte de Liquidaciones{% endblock %}

{% block content %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="p-6 md:p-10 space-y-6 font-sans bg-gray-50 min-h-full">

    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Reporte de Liquidaciones</h1>
            <p class="text-gray-600 mt-1">An√°lisis de pr√©stamos completados por rango de fecha.</p>
        </div>

        <div class="flex items-center gap-3 p-2 bg-white rounded-lg shadow-sm border border-gray-200">
            <div>
                <label for="fecha_inicio" class="block text-xs font-medium text-gray-500 px-1">Desde</label>
                <input type="date" id="fecha_inicio" name="fecha_inicio"
                       class="p-2 border-none rounded-md bg-white text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
            </div>
            <div class="text-gray-400">-</div>
            <div>
                <label for="fecha_fin" class="block text-xs font-medium text-gray-500 px-1">Hasta</label>
                <input type="date" id="fecha_fin" name="fecha_fin"
                       class="p-2 border-none rounded-md bg-white text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
            </div>
            <button id="btn_generar" class="px-5 py-2 bg-sky-600 text-white rounded-lg font-semibold shadow-md hover:bg-sky-700 transition h-full">
                Generar Reporte
            </button>
        </div>
    </div>

    <div id="resultados_reporte" class="space-y-6 opacity-100 transition-opacity duration-500">
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            
            <div class="relative bg-white p-6 rounded-2xl shadow-lg border border-gray-100">
                <div class="absolute top-4 right-4 w-12 h-12 flex items-center justify-center bg-green-100 rounded-full">
                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2-1.343-2-3-2zM12 14c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2-1.343-2-3-2zM12 4c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2-1.343-2-3-2z"></path></svg>
                </div>
                <p class="text-sm font-medium text-gray-500">Total Liquidado en Periodo</p>
                <p id="kpi_total_liquidado" class="text-4xl font-bold text-green-600 mt-2">$0.00</p>
            </div>

            <div class="relative bg-white p-6 rounded-2xl shadow-lg border border-gray-100">
                 <div class="absolute top-4 right-4 w-12 h-12 flex items-center justify-center bg-sky-100 rounded-full">
                    <svg class="w-6 h-6 text-sky-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <p class="text-sm font-medium text-gray-500">Pr√©stamos Liquidados</p>
                <p id="kpi_prestamos_count" class="text-4xl font-bold text-gray-900 mt-2">0</p>
            </div>

            <div class="relative bg-white p-6 rounded-2xl shadow-lg border border-gray-100">
                <div class="absolute top-4 right-4 w-12 h-12 flex items-center justify-center bg-gray-100 rounded-full">
                    <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 8h6m-4 4h4m2 6H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                </div>
                <p class="text-sm font-medium text-gray-500">Monto Promedio</p>
                <p id="kpi_monto_promedio" class="text-4xl font-bold text-gray-900 mt-2">$0.00</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
            
            <div class="lg:col-span-3 bg-white p-6 rounded-2xl shadow-lg border border-gray-100">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xl font-semibold text-gray-900">Tendencia de Liquidaciones</h3>
                    
                    <!-- Nuevo control de rango -->
                    <div class="flex items-center gap-3">
                        <label for="rango_regresion" class="text-sm text-gray-600">Mostrar puntos:</label>
                        <input type="range" id="rango_regresion" min="5" max="100" value="100" class="accent-sky-600 cursor-pointer w-32">
                        <span id="valor_rango" class="text-sm font-semibold text-gray-800">100%</span>
                    </div>
                </div>
                
                <div class="mt-4 h-96">
                    <canvas id="liquidacionesChart"></canvas>
                </div>
            </div>

            <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg border border-gray-100">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">Detalle de Pr√©stamos</h3>
                <div class="overflow-y-auto max-h-96">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 text-gray-600 sticky top-0">
                            <tr>
                                <th class="p-3 font-semibold">Cliente</th>
                                <th class="p-3 font-semibold text-right">Monto</th>
                                <th class="p-3 font-semibold">Fecha Liq.</th>
                            </tr>
                        </thead>
                        <tbody id="tabla_liquidaciones_body" class="divide-y divide-gray-200">
                            <tr>
                                <td colspan="3" class="p-4 text-center text-gray-500">
                                    A√∫n no se han generado datos.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let chartInstance = null;
    let currentChartData = { labels: [], data: [] };

    const currencyFormatter = new Intl.NumberFormat('es-MX', {
        style: 'currency',
        currency: 'MXN'
    });

    // üìà C√°lculo de regresi√≥n lineal
    function calcularRegresionLineal(xVals, yVals) {
        const n = xVals.length;
        const sumX = xVals.reduce((a, b) => a + b, 0);
        const sumY = yVals.reduce((a, b) => a + b, 0);
        const sumXY = xVals.reduce((a, b, i) => a + b * yVals[i], 0);
        const sumXX = xVals.reduce((a, b) => a + b * b, 0);
        const m = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
        const b = (sumY - m * sumX) / n;
        const yPred = xVals.map(x => m * x + b);
        return { m, b, yPred };
    }

    function actualizarKPIs(stats) {
        document.getElementById('kpi_total_liquidado').textContent = currencyFormatter.format(stats.total_liquidado || 0);
        document.getElementById('kpi_prestamos_count').textContent = stats.prestamos_count || '0';
        document.getElementById('kpi_monto_promedio').textContent = currencyFormatter.format(stats.monto_promedio || 0);
    }

    function actualizarTabla(liquidaciones) {
        const tbody = document.getElementById('tabla_liquidaciones_body');
        tbody.innerHTML = '';

        if (!liquidaciones || liquidaciones.length === 0) {
            tbody.innerHTML = `<tr><td colspan="3" class="p-4 text-center text-gray-500">
                No se encontraron liquidaciones en este periodo.</td></tr>`;
            return;
        }

        liquidaciones.forEach(liq => {
            tbody.innerHTML += `
                <tr class="hover:bg-gray-50 transition">
                    <td class="p-3">${liq.cliente_nombre}</td>
                    <td class="p-3 font-medium text-right">${currencyFormatter.format(liq.monto_pagado)}</td>
                    <td class="p-3 text-gray-600">${liq.fecha_liquidacion}</td>
                </tr>`;
        });
    }

    // üìä Actualizar gr√°fico
    function actualizarGrafico(chartData, porcentaje = 100) {
        const ctx = document.getElementById('liquidacionesChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();

        currentChartData = chartData;
        if (!chartData.data || chartData.data.length === 0) {
            chartData = { labels: [], data: [] };
        }

        // Filtrar seg√∫n porcentaje
        const limite = Math.floor(chartData.data.length * (porcentaje / 100));
        const datosLimitados = chartData.data.slice(0, limite);
        const etiquetasLimitadas = chartData.labels.slice(0, limite);

        const xVals = datosLimitados.map((_, i) => i + 1);
        const { yPred } = calcularRegresionLineal(xVals, datosLimitados);

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: etiquetasLimitadas,
                datasets: [
                    {
                        label: 'Monto Liquidado',
                        data: datosLimitados,
                        backgroundColor: 'rgba(59,130,246,0.1)',
                        borderColor: 'rgba(59,130,246,1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.2
                    },
                    {
                        label: 'Tendencia (Regresi√≥n Lineal)',
                        data: yPred,
                        borderColor: 'rgba(239,68,68,1)',
                        borderDash: [5, 5],
                        borderWidth: 2,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: ctx => `${ctx.dataset.label}: ${currencyFormatter.format(ctx.raw)}`
                        }
                    }
                }
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        const btnGenerar = document.getElementById('btn_generar');
        const resultadosDiv = document.getElementById('resultados_reporte');
        const rangoInput = document.getElementById('rango_regresion');
        const valorRango = document.getElementById('valor_rango');

        actualizarGrafico({ labels: [], data: [] });

        // üìâ Evento para ajustar rango visible
        rangoInput.addEventListener('input', () => {
            valorRango.textContent = `${rangoInput.value}%`;
            actualizarGrafico(currentChartData, parseInt(rangoInput.value));
        });

        btnGenerar.addEventListener('click', async () => {
            const inicio = document.getElementById('fecha_inicio').value;
            const fin = document.getElementById('fecha_fin').value;
            if (!inicio || !fin) return alert("Selecciona un rango de fechas.");

            btnGenerar.disabled = true;
            btnGenerar.textContent = "Generando...";
            resultadosDiv.style.opacity = "0.6";

            try {
                const url = `{{ url_for('routes.api_reporte_liquidaciones') }}?inicio=${inicio}&fin=${fin}`;
                const res = await fetch(url);
                const data = await res.json();

                actualizarKPIs(data.stats);
                actualizarTabla(data.tabla_liquidaciones);
                actualizarGrafico(data.chart_data, parseInt(rangoInput.value));

            } catch (err) {
                console.error(err);
                alert("Error al cargar el reporte.");
            } finally {
                btnGenerar.disabled = false;
                btnGenerar.textContent = "Generar Reporte";
                resultadosDiv.style.opacity = "1";
            }
        });
    });
</script>
<a href="http://localhost:8501" target="_blank">
    <span>An√°lisis de Regresi√≥n</span>
</a>
{% endblock %}
