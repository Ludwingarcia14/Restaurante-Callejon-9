{% extends "layout/layout_financieras.html" %}

{% block title %}Editar Perfil Asesor{% endblock %}

{% block content %}

<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


<style>
    /* --- Inputs Modernos --- */
    .form-group label {
        font-size: 0.85rem;
        font-weight: 600;
        color: #4b5563; /* Gray 600 */
        margin-bottom: 0.5rem;
        display: block;
    }
    
    .modern-input {
        width: 100%;
        background-color: #f9fafb; /* Gray 50 */
        border: 1px solid #e5e7eb; /* Gray 200 */
        border-radius: 0.75rem;
        padding: 0.75rem 1rem;
        padding-left: 2.75rem; /* Espacio para el icono a la izquierda */
        font-size: 0.95rem;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        outline: none;
        color: #1f2937;
    }

    .modern-input:focus {
        background-color: #ffffff;
        border-color: #6366f1; /* Indigo 500 */
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
    }

    .modern-input:disabled {
        background-color: #f3f4f6;
        color: #9ca3af;
        cursor: not-allowed;
    }

    /* Iconos dentro de los inputs */
    .input-icon {
        position: absolute;
        left: 1rem;
        top: 2.35rem; /* Ajuste vertical basado en la etiqueta */
        color: #9ca3af;
        font-size: 1.1rem;
        pointer-events: none;
        transition: color 0.2s;
    }
    .form-group:focus-within .input-icon {
        color: #6366f1;
    }

    /* --- Personalización de Select2 para que coincida con el diseño --- */
    .select2-container { width: 100% !important; }
    .select2-container .select2-selection--single {
        height: 48px !important;
        background-color: #f9fafb !important;
        border: 1px solid #e5e7eb !important;
        border-radius: 0.75rem !important;
        padding-top: 9px !important;
        padding-left: 10px !important;
    }
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        top: 10px !important;
        right: 10px !important;
    }
    .select2-container--default .select2-selection--single .select2-selection__rendered {
        color: #1f2937 !important;
        font-size: 0.95rem;
    }
    .select2-container--open .select2-selection--single {
        border-color: #6366f1 !important;
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
    }

    /* --- Tarjeta de Perfil (Izquierda) --- */
    .profile-card {
        background: white;
        border-radius: 1.5rem;
        border: 1px solid #e5e7eb;
        overflow: hidden;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
    }
    
    .cover-gradient {
        height: 110px;
        background: linear-gradient(135deg, #4f46e5 0%, #06b6d4 100%);
    }

    .avatar-wrapper {
        width: 100px;
        height: 100px;
        background: white;
        border-radius: 50%;
        padding: 5px;
        margin: -50px auto 12px;
        position: relative;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    
    .avatar-content {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: #e0e7ff;
        color: #4338ca;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.2rem;
        font-weight: 800;
        text-transform: uppercase;
    }

    /* --- Animaciones --- */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-enter { animation: fadeIn 0.5s ease-out forwards; }
</style>


<div class="max-w-7xl mx-auto px-4 py-8 animate-enter">
    
    <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
                <i class="ri-edit-2-fill text-indigo-600"></i> Editar Perfil de Asesor
            </h1>
            <p class="text-sm text-gray-500 mt-1">Actualiza la información personal, ubicación y credenciales de acceso.</p>
        </div>
        <div class="flex gap-3">
            <a href="/dashboard/financiera/lista/asesor" class="px-5 py-2.5 bg-white border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 text-sm font-medium transition shadow-sm">
                Cancelar
            </a>
            <button form="editForm" type="submit" class="px-6 py-2.5 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 text-sm font-bold shadow-md hover:shadow-lg transition flex items-center gap-2">
                <i class="ri-save-line text-lg"></i> Guardar Cambios
            </button>
        </div>
    </div>

    <form id="editForm" method="POST" action="/financiera/asesor/update/{{ asesor._id }}">
        
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <div class="lg:col-span-4 space-y-6">
                
                <div class="profile-card text-center pb-8">
                    <div class="cover-gradient"></div>
                    <div class="avatar-wrapper">
                        <div class="avatar-content">
                            {{ asesor.usuario_nombre[0] }}{{ asesor.usuario_apellidos[0] }}
                        </div>
                    </div>
                    
                    <h2 class="text-xl font-bold text-gray-800">{{ asesor.usuario_nombre }} {{ asesor.usuario_apellidos }}</h2>
                    <p class="text-sm text-gray-500 mb-4 font-mono bg-gray-100 inline-block px-2 py-1 rounded mt-1 text-xs">ID: {{ asesor._id }}</p>
                    
                    <div class="flex justify-center gap-2 mb-6">
                        <span class="px-3 py-1 bg-emerald-100 text-emerald-700 text-xs font-bold rounded-full border border-emerald-200 flex items-center gap-1">
                            <span class="w-2 h-2 bg-emerald-500 rounded-full"></span> Activo
                        </span>
                        <span class="px-3 py-1 bg-blue-50 text-blue-700 text-xs font-bold rounded-full border border-blue-100">
                            {{ roles | selectattr("Rol_id", "equalto", asesor.rol) | map(attribute="Rol_nombre") | first or "Rol Asignado" }}
                        </span>
                    </div>

                    <div class="border-t border-gray-100 pt-5 px-6 text-left space-y-4">
                        <div class="flex items-center gap-3 text-sm text-gray-600 group">
                            <div class="w-8 h-8 rounded-lg bg-indigo-50 flex items-center justify-center text-indigo-600 group-hover:bg-indigo-600 group-hover:text-white transition">
                                <i class="ri-calendar-line"></i>
                            </div>
                            <div>
                                <p class="text-xs text-gray-400 font-bold uppercase">Fecha de Alta</p>
                                <p class="font-medium">{{ asesor.created_at }}</p>
                                <input type="hidden" name="fecha_alta" value="{{ asesor.created_at }}">
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-3 text-sm text-gray-600 group">
                            <div class="w-8 h-8 rounded-lg bg-indigo-50 flex items-center justify-center text-indigo-600 group-hover:bg-indigo-600 group-hover:text-white transition">
                                <i class="ri-map-pin-line"></i>
                            </div>
                            <div>
                                <p class="text-xs text-gray-400 font-bold uppercase">Ubicación Actual</p>
                                <p class="font-medium truncate max-w-[200px]">{{ asesor.usuario_cp or 'Sin CP definido' }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-indigo-50 rounded-2xl p-5 border border-indigo-100 flex gap-4 items-start">
                    <i class="ri-lightbulb-flash-line text-xl text-indigo-600 mt-1"></i>
                    <div>
                        <h4 class="text-sm font-bold text-indigo-900 mb-1">Tip de Edición</h4>
                        <p class="text-xs text-indigo-800 leading-relaxed">
                            Al ingresar un <strong>Código Postal</strong> válido, el sistema autocompletará Estado y Municipio. Solo tendrás que elegir la colonia.
                        </p>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-8 space-y-6">
                
                <div class="bg-white rounded-2xl p-8 border border-gray-200 shadow-sm">
                    <h3 class="text-lg font-bold text-gray-800 mb-6 pb-3 border-b border-gray-100 flex items-center gap-2">
                        <i class="ri-user-settings-line text-indigo-600 bg-indigo-50 p-1.5 rounded-lg"></i> 
                        Datos Personales
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-group relative">
                            <label>Nombre(s) <span class="text-red-500">*</span></label>
                            <i class="ri-user-line input-icon"></i>
                            <input type="text" name="nombre" class="modern-input" value="{{ asesor.usuario_nombre or '' }}" required placeholder="Ej. Juan Carlos">
                        </div>
                        <div class="form-group relative">
                            <label>Apellidos <span class="text-red-500">*</span></label>
                            <i class="ri-user-shared-line input-icon"></i>
                            <input type="text" name="apellido" class="modern-input" value="{{ asesor.usuario_apellidos or '' }}" required placeholder="Ej. Pérez López">
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl p-8 border border-gray-200 shadow-sm">
                    <h3 class="text-lg font-bold text-gray-800 mb-6 pb-3 border-b border-gray-100 flex items-center gap-2">
                        <i class="ri-map-2-line text-indigo-600 bg-indigo-50 p-1.5 rounded-lg"></i> 
                        Dirección y Ubicación
                    </h3>

                    <input type="hidden" id="saved_estado" value="{{ asesor.usuario_idEstado | trim }}">
                    <input type="hidden" id="saved_municipio" value="{{ asesor.usuario_idMunicipio | trim }}">
                    <input type="hidden" id="saved_colonia" value="{{ asesor.usuario_idColonia | trim }}">

                    <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                        <div class="md:col-span-3 form-group relative">
                            <label>Código Postal</label>
                            <i class="ri-hashtag input-icon"></i>
                            <input type="text" name="cp" id="cp_input" class="modern-input" value="{{ asesor.usuario_cp or '' }}" maxlength="5" placeholder="00000">
                            <div id="cp-loader" class="absolute right-3 top-[2.4rem] hidden">
                                <i class="ri-loader-4-line animate-spin text-indigo-600 text-xl"></i>
                            </div>
                        </div>

                        <div class="md:col-span-5 form-group">
                            <label>Estado <span class="text-red-500">*</span></label>
                            <select name="estado_id" id="estado_select" class="modern-input pl-3 h-[48px]" required>
                                <option value="">Cargando lista...</option>
                            </select>
                        </div>

                        <div class="md:col-span-4 form-group">
                            <label>Municipio <span class="text-red-500">*</span></label>
                            <select name="municipio_id" id="municipio_select" class="modern-input pl-3 h-[48px]" required disabled>
                                <option value="">---</option>
                            </select>
                        </div>

                        <div class="md:col-span-12 form-group">
                            <label>Colonia <span class="text-red-500">*</span></label>
                            <select name="colonia_id" id="colonia_select" class="w-full" required disabled>
                                <option value="">---</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl p-8 border border-gray-200 shadow-sm">
                    <h3 class="text-lg font-bold text-gray-800 mb-6 pb-3 border-b border-gray-100 flex items-center gap-2">
                        <i class="ri-shield-keyhole-line text-indigo-600 bg-indigo-50 p-1.5 rounded-lg"></i> 
                        Credenciales y Acceso
                    </h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        
                        <div class="form-group relative">
                            <label>Email Corporativo <span class="text-red-500">*</span></label>
                            <i class="ri-mail-line input-icon"></i>
                            <input type="email" name="correo" class="modern-input" value="{{ asesor.usuario_email or '' }}" required>
                        </div>

                        <div class="form-group relative">
                            <label>Teléfono de Contacto</label>
                            <i class="ri-phone-line input-icon"></i>
                            <input type="text" name="telefono" class="modern-input" value="{{ asesor.usuario_telefono or '' }}" placeholder="(00) 0000 0000">
                        </div>

                        <div class="form-group">
                            <label>Rol en el Sistema <span class="text-red-500">*</span></label>
                            <select name="tipo_persona" class="modern-input pl-3 h-[48px]" required>
                                <option value="">Seleccione un rol...</option>
                                {% for rol in roles %}
                                <option value="{{ rol.Rol_id }}" {% if rol.Rol_id|string == asesor.rol|string %}selected{% endif %}>
                                    {{ rol.Rol_nombre }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group relative">
                            <label>Contraseña</label>
                            <i class="ri-lock-password-line input-icon"></i>
                            <input type="password" name="contrasena" id="input_password" class="modern-input pr-10" placeholder="•••••••">
                            <button type="button" id="togglePassword" class="absolute right-3 top-[2.4rem] text-gray-400 hover:text-indigo-600 p-1 rounded transition">
                                <i class="ri-eye-off-line text-lg"></i>
                            </button>
                            <p class="text-xs text-gray-400 mt-1.5 ml-1">Déjalo en blanco para mantener la contraseña actual.</p>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
$(document).ready(function() {
    // 1. Referencias a elementos del DOM
    const $estado = $('#estado_select');
    const $municipio = $('#municipio_select');
    const $colonia = $('#colonia_select');
    const $cpInput = $('#cp_input');
    const $cpLoader = $('#cp-loader');
    const $togglePass = $('#togglePassword');
    const $passInput = $('#input_password');

    // 2. Recuperar valores guardados (Renderizados por Jinja)
    const savedIds = {
        estado: $('#saved_estado').val(),
        municipio: $('#saved_municipio').val(),
        colonia: $('#saved_colonia').val()
    };

    // 3. Inicializar Select2 en Colonias para búsqueda mejorada
    $colonia.select2({
        width: '100%',
        placeholder: 'Seleccione una colonia',
        language: { noResults: () => "No se encontraron resultados" }
    });

    // 4. Funcionalidad Mostrar/Ocultar Contraseña
    $togglePass.on('click', function() {
        const icon = $(this).find('i');
        if ($passInput.attr('type') === 'password') {
            $passInput.attr('type', 'text');
            icon.removeClass('ri-eye-off-line').addClass('ri-eye-line');
        } else {
            $passInput.attr('type', 'password');
            icon.removeClass('ri-eye-line').addClass('ri-eye-off-line');
        }
    });

    // ==========================================
    // LÓGICA ASÍNCRONA (Async/Await)
    // ==========================================

    // Helper para llenar selects estándar
    function fillSelect($el, data, placeholder = "Seleccione...") {
        $el.empty().append(`<option value="">${placeholder}</option>`);
        data.forEach(item => {
            // Manejo de display text con CP si está disponible
            const text = item.codigo_postal ? `${item.nombre} [CP: ${item.codigo_postal}]` : item.nombre;
            const option = new Option(text, item.id, false, false);
            // Guardamos metadatos útiles
            $(option).data('cp', item.codigo_postal || '');
            $el.append(option);
        });
    }

    // Cargar Municipios por Estado
    async function loadMunicipios(estadoId) {
        if (!estadoId) {
            $municipio.prop('disabled', true).empty();
            $colonia.prop('disabled', true).empty();
            return;
        }
        $municipio.prop('disabled', true).html('<option>Cargando...</option>');
        $colonia.prop('disabled', true).empty();
        
        try {
            const res = await fetch(`/api/sepomex/municipios/${estadoId}`);
            if(!res.ok) throw new Error("Error API");
            const data = await res.json();
            
            fillSelect($municipio, data, "Seleccione Municipio");
            $municipio.prop('disabled', false);
        } catch (e) { 
            console.error(e);
            $municipio.html('<option>Error al cargar</option>');
        }
    }

    // Cargar Colonias por Municipio
    async function loadColonias(municipioId) {
        if (!municipioId) {
            $colonia.prop('disabled', true).empty();
            return;
        }
        $colonia.prop('disabled', true).empty().append('<option>Cargando...</option>');
        
        try {
            const res = await fetch(`/api/sepomex/colonias/${municipioId}`);
            if(!res.ok) throw new Error("Error API");
            const data = await res.json();
            
            $colonia.empty().append('<option value="">Seleccione Colonia</option>');
            data.forEach(item => {
                const text = item.codigo_postal ? `${item.nombre} (${item.codigo_postal})` : item.nombre;
                const opt = new Option(text, item.id, false, false);
                $(opt).data('cp', item.codigo_postal);
                $colonia.append(opt);
            });
            // Guardamos data cruda para búsquedas locales
            $colonia.data('raw', data);
            $colonia.prop('disabled', false).trigger('change');
        } catch (e) { console.error(e); }
    }

    // Función de Inicialización en Cascada (Carga inicial al abrir editar)
    async function initCascade() {
        try {
            // 1. Cargar Estados
            const resEstados = await fetch('/api/sepomex/estados');
            const estados = await resEstados.json();
            fillSelect($estado, estados, "Seleccione Estado");

            // 2. Si hay valores guardados, simular la selección en cascada
            if (savedIds.estado) {
                $estado.val(savedIds.estado);
                await loadMunicipios(savedIds.estado);
                
                if (savedIds.municipio) {
                    $municipio.val(savedIds.municipio);
                    await loadColonias(savedIds.municipio);
                    
                    if (savedIds.colonia) {
                        $colonia.val(savedIds.colonia).trigger('change');
                        
                        // Si el CP input está vacío, intentar llenarlo desde la colonia seleccionada
                        const selected = $colonia.find(':selected');
                        if (!$cpInput.val() && selected.length) {
                            $cpInput.val(selected.data('cp'));
                        }
                    }
                }
            }
        } catch (err) { console.error("Error en inicialización", err); }
    }

    // Ejecutar inicialización
    initCascade();

    // ==========================================
    // LISTENERS DE EVENTOS
    // ==========================================

    // Cambio de Estado
    $estado.on('change', async function() {
        $cpInput.val(''); // Limpiar CP para evitar inconsistencias
        await loadMunicipios($(this).val());
    });

    // Cambio de Municipio
    $municipio.on('change', async function() {
        $cpInput.val('');
        await loadColonias($(this).val());
    });

    // Selección de Colonia (Actualiza CP)
    $colonia.on('select2:select', function(e) {
        const cp = $(this).find(':selected').data('cp');
        if (cp) $cpInput.val(cp);
    });

    // Autocompletado inteligente por CP
    $cpInput.on('input', async function() {
        const cp = $(this).val();
        if (cp.length === 5) {
            $cpLoader.removeClass('hidden'); // Mostrar spinner
            
            try {
                const res = await fetch(`/api/sepomex/cp/${cp}`);
                if (!res.ok) throw new Error("CP no encontrado");
                const data = await res.json();

                // Cascada inversa automática
                $estado.val(data.estado.id);
                await loadMunicipios(data.estado.id);
                
                $municipio.val(data.municipio.id);
                await loadColonias(data.municipio.id);

                // Buscar la colonia exacta por CP en la lista cargada
                const raw = $colonia.data('raw') || [];
                const match = raw.find(c => c.codigo_postal === cp);
                if (match) {
                    $colonia.val(match.id).trigger('change');
                }

                // Notificación discreta
                const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true });
                Toast.fire({ icon: 'success', title: 'Ubicación localizada' });

            } catch (e) { 
                console.log("CP no resuelto automáticamente"); 
            } finally { 
                $cpLoader.addClass('hidden'); 
            }
        }
    });

    // Envío del Formulario con SweetAlert
    $('#editForm').on('submit', function(e) {
        e.preventDefault();
        
        Swal.fire({
            title: '¿Guardar cambios?',
            text: "Se actualizará la información del asesor.",
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#4f46e5', // Indigo
            cancelButtonColor: '#9ca3af',
            confirmButtonText: 'Sí, guardar',
            cancelButtonText: 'Cancelar',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                // Mostrar loading antes de enviar
                Swal.fire({
                    title: 'Guardando...',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });
                
                // Retraso minúsculo para permitir que la UI renderice
                setTimeout(() => {
                    this.submit();
                }, 300);
            }
        });
    });
});
</script>

{% endblock %}