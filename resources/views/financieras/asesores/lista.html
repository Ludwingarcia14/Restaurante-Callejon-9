{% extends "layout/layout_financieras.html" %}
{% block page_title %}Gestión de Asesores{% endblock %}
{% block header_title %}Equipo de Asesores{% endblock %}

{% block content %}

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">

<style>
    /* Estilos personalizados para pulir la tabla */
    .avatar-initials {
        width: 35px;
        height: 35px;
        background-color: #e9ecef;
        color: #495057;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 14px;
        margin-right: 10px;
    }
    
    .table-card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.05);
    }

    .dataTables_wrapper .dataTables_length select {
        padding-right: 30px; /* Fix para select en BS5 */
    }
    
    /* Ajuste de botones de acción */
    .btn-action {
        padding: 4px 8px;
        border-radius: 6px;
    }
</style>

<div class="container-fluid px-4">
    
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm text-primary h-100 border-start border-4 border-primary">
                <div class="card-body">
                    <h6 class="text-uppercase text-muted small">Total Asesores</h6>
                    <h3 class="mb-0 fw-bold" id="kpi_total">--</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm text-success h-100 border-start border-4 border-success">
                <div class="card-body">
                    <h6 class="text-uppercase text-muted small">Activos</h6>
                    <h3 class="mb-0 fw-bold" id="kpi_activos">--</h3>
                </div>
            </div>
        </div>
        </div>

    <div class="card table-card mb-4">
        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
            <h5 class="mb-0 text-gray-800">Listado de Asesores</h5>
            <button id="delete_selected" class="btn btn-outline-danger btn-sm" disabled>
                <i class="bi bi-trash"></i> Eliminar Selección
            </button>
        </div>
        <div class="card-body">
            <table id="usuarios_table" class="table table-hover align-middle w-100">
                <thead class="table-light">
                    <tr>
                        <th style="width: 20px;"><input type="checkbox" class="form-check-input" id="select_all"></th>
                        <th>Asesor</th>
                        <th>Ubicación</th>
                        <th>Contacto</th>
                        <th>Rol</th>
                        <th>Fecha Alta</th>
                        <th class="text-end">Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="viewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0 bg-light">
                <h5 class="modal-title fw-bold">Perfil del Asesor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0" id="viewModalBody">
                </div>
            <div class="modal-footer border-0 bg-light justify-content-center">
                <button type="button" class="btn btn-primary px-4" data-bs-dismiss="modal">Aceptar</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.5/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    $(document).ready(function () {
        
        // Helpers de formato
        const truncate = (str, n = 20) => (str && str.length > n) ? str.substr(0, n-1) + '&hellip;' : str || '';
        const formatDate = (dateString) => dateString ? new Date(dateString).toLocaleDateString('es-MX') : 'N/A';
        const getInitials = (name, surname) => (name.charAt(0) + (surname || '').charAt(0)).toUpperCase();

        // Inicialización DataTables
        var table = $('#usuarios_table').DataTable({
            processing: true,
            serverSide: true,
            responsive: true, // Hace la tabla responsive en móbiles
            ajax: {
                url: "/dashboard/financiera/data",
                // Esta función se ejecuta cuando vuelven los datos, ideal para actualizar los KPIs de arriba
                dataSrc: function (json) {
                    $('#kpi_total').text(json.recordsTotal || 0);
                    // Si tu backend enviara "activos", lo pondrías aquí. Por ahora pongo un ejemplo:
                    $('#kpi_activos').text(json.recordsTotal || 0); 
                    return json.data;
                }
            },
            columns: [
                {
                    data: "_id",
                    orderable: false,
                    className: 'text-center',
                    render: data => `<input type="checkbox" class="form-check-input row_checkbox" value="${data}">`
                },
                {
                    // Combinamos Nombre y Apellido en una sola columna con un "Avatar" de iniciales
                    data: null,
                    render: function (data, type, row) {
                        return `
                            <div class="d-flex align-items-center">
                                <div class="avatar-initials">${getInitials(row.usuario_nombre, row.usuario_apellidos)}</div>
                                <div>
                                    <div class="fw-bold text-dark">${row.usuario_nombre} ${row.usuario_apellidos}</div>
                                    <div class="small text-muted">ID: ${truncate(row._id, 8)}</div>
                                </div>
                            </div>
                        `;
                    }
                },
                {
                    // Combinamos Estado y Municipio
                    data: null,
                    render: row => `
                        <div class="d-flex flex-col">
                            <span>${row.usuario_idMunicipio || 'Sin municipio'}</span>
                            <small class="text-muted">${row.usuario_idEstado || ''}</small>
                        </div>
                    `
                },
                {
                    data: "usuario_correo",
                    render: (data, type, row) => `
                        <div class="small">
                            <div><i class="bi bi-envelope me-1"></i> ${truncate(data, 22)}</div>
                            <div><i class="bi bi-telephone me-1"></i> ${row.usuario_telefono || 'S/N'}</div>
                        </div>
                    `
                },
                {
                    data: "usuario_rol",
                    render: data => `<span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-10 rounded-pill">${data || 'Asesor'}</span>`
                },
                {
                    data: "created_at",
                    render: data => `<span class="small text-muted">${formatDate(data)}</span>`
                },
                {
                    data: "_id",
                    orderable: false,
                    className: "text-end",
                    render: d => `
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-light text-primary view-btn btn-action" data-id="${d}" title="Ver ficha">
                                <i class="bi bi-person-badge"></i>
                            </button>
                            <button class="btn btn-sm btn-light text-warning edit-btn btn-action" data-id="${d}" title="Editar">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-light text-danger delete-btn btn-action" data-id="${d}" title="Eliminar">
                                <i class="bi bi-trash3"></i>
                            </button>
                        </div>
                    `
                }
            ],
            language: {
                url: '//cdn.datatables.net/plug-ins/1.13.5/i18n/es-MX.json'
            },
            dom: '<"d-flex justify-content-between align-items-center mb-3"f l>rt<"d-flex justify-content-between align-items-center mt-3"ip>',
        });

        // Manejo de Checkboxes
        $('#select_all').on('click', function () {
            $('.row_checkbox').prop('checked', this.checked);
            toggleDeleteButton();
        });

        $('#usuarios_table tbody').on('change', '.row_checkbox', function() {
            toggleDeleteButton();
        });

        function toggleDeleteButton() {
            let count = $('.row_checkbox:checked').length;
            $('#delete_selected').prop('disabled', count === 0).html(`<i class="bi bi-trash"></i> Eliminar (${count})`);
        }

        // --- Acciones AJAX ---

        // Eliminar por lote
        $('#delete_selected').on('click', function () {
            let ids = $('.row_checkbox:checked').map(function () { return $(this).val(); }).get();
            if (ids.length > 0 && confirm(`¿Confirma eliminar ${ids.length} asesores? Esta acción afecta su cartera de clientes.`)) {
                $.ajax({
                    url: `/admin/usuarios/delete_batch`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ ids: ids }),
                    success: () => {
                        table.ajax.reload();
                        $('#select_all').prop('checked', false);
                        toggleDeleteButton();
                        // Toast o alerta mejorada aquí
                    },
                    error: () => alert('Error al procesar la solicitud.')
                });
            }
        });

        // Ver Detalles (Modal mejorado)
        $('#usuarios_table').on('click', '.view-btn', function () {
            let id = $(this).data('id');
            // Spinner mientras carga
            $('#viewModalBody').html('<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div></div>');
            new bootstrap.Modal(document.getElementById('viewModal')).show();

            $.get(`/admin/usuarios/view/${id}`, function (data) {
                // Simulación de "Total Clientes" (Si el backend no lo trae, mostramos 0 o un placeholder)
                let totalClientes = data.total_clientes || Math.floor(Math.random() * 50); // Random solo para demo visual

                let html = `
                    <div class="text-center bg-primary bg-gradient text-white py-4 position-relative">
                        <div class="avatar-initials mx-auto bg-white text-primary shadow" style="width: 80px; height: 80px; font-size: 30px;">
                            ${getInitials(data.nombre, data.apellido)}
                        </div>
                        <h4 class="mt-2 mb-0">${data.nombre} ${data.apellido}</h4>
                        <p class="mb-0 opacity-75">${data.rol_nombre || 'Asesor Financiero'}</p>
                    </div>
                    
                    <div class="p-4">
                        <div class="row text-center mb-4">
                            <div class="col-6 border-end">
                                <h5 class="fw-bold mb-0 text-primary">${totalClientes}</h5>
                                <small class="text-muted">Clientes</small>
                            </div>
                            <div class="col-6">
                                <h5 class="fw-bold mb-0 text-success">$0.00</h5>
                                <small class="text-muted">Cartera (Demo)</small>
                            </div>
                        </div>

                        <h6 class="text-uppercase text-muted small fw-bold mb-3 border-bottom pb-2">Información de Contacto</h6>
                        
                        <div class="row g-3">
                            <div class="col-6">
                                <label class="small text-muted">Teléfono</label>
                                <div class="fw-medium">${data.telefono || 'N/A'}</div>
                            </div>
                            <div class="col-6">
                                <label class="small text-muted">Email</label>
                                <div class="fw-medium text-break">${data.correo || 'N/A'}</div>
                            </div>
                            <div class="col-12">
                                <label class="small text-muted">Dirección</label>
                                <div class="fw-medium">
                                    ${data.colonia_nombre ? data.colonia_nombre + ',' : ''} 
                                    ${data.municipio_nombre || ''}, ${data.estado_nombre || ''}
                                    <br><small class="text-muted">CP: ${data.cp || 'N/A'}</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <label class="small text-muted">Fecha de Alta</label>
                                <div>${formatDate(data.fecha_alta)}</div>
                            </div>
                        </div>
                    </div>
                `;
                $('#viewModalBody').html(html);
            }).fail(() => {
                $('#viewModalBody').html('<div class="text-center py-4 text-danger">No se pudo cargar la información.</div>');
            });
        });

        // Redirección Editar
        $('#usuarios_table').on('click', '.edit-btn', function () {
            window.location.href = `/dashboard/financiera/editar/asesor?id=${$(this).data('id')}`;
        });

        // Eliminar individual
        $('#usuarios_table').on('click', '.delete-btn', function () {
            if (confirm("¿Eliminar este asesor?")) {
                $.post(`/admin/usuarios/delete/${$(this).data('id')}`, function () { 
                    table.ajax.reload(); 
                });
            }
        });
    });
</script>

{% endblock %}