{% extends "layout/layout_financieras.html" %}
{% block title %}Dashboard Ejecutivo{% endblock %}

{% block content %}
<style>
    /* --- Estilos Modernos Personalizados --- */
    
    /* Fondo base ligeramente tintado para que las cards resalten */
    .bg-fintech-base { background-color: #f8fafc; }

    /* Sombras suaves y difusas (estilo moderno) */
    .shadow-soft-xl { box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.05), 0 8px 10px -6px rgb(0 0 0 / 0.01); }
    .shadow-soft-md { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.01); }

    /* Transiciones ultra suaves */
    .hover-lift { transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease; }
    .hover-lift:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); }

    /* Gráfico de anillo */
    .progress-ring { transform: rotate(-90deg); }
    .progress-ring-circle { transition: stroke-dashoffset 1.2s ease-in-out; transform-origin: 50% 50%; }

    /* Indicadores de Bolsa (Pills) */
    .stock-pill { padding: 4px 10px; border-radius: 9999px; font-weight: 600; font-size: 0.85rem; display: inline-flex; items-center; gap: 4px; }
    .stock-pill.positive { background-color: #dcfce7; color: #166534; }
    .stock-pill.positive::before { content: '↑'; }
    .stock-pill.negative { background-color: #fee2e2; color: #991b1b; }
    .stock-pill.negative::before { content: '↓'; }
    
    /* Barras de progreso más elegantes */
    .slim-progress-bar { height: 8px; border-radius: 4px; background-color: #f1f5f9; overflow: hidden; }
    .slim-progress-fill { height: 100%; border-radius: 4px; transition: width 1s ease-in-out; }

</style>

<div class="min-h-screen bg-fintech-base p-6 lg:p-10">
    <div class="max-w-7xl mx-auto">
        
        <div class="mb-10">
            <h1 class="text-3xl font-extrabold text-slate-800 tracking-tight">Resumen Financiero</h1>
            <p class="text-slate-500 mt-2">Bienvenido de nuevo. Aquí está el estado de tu cartera hoy.</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 mb-10">
            
            <div class="lg:col-span-7 bg-white rounded-3xl shadow-soft-xl p-8 flex flex-col md:flex-row items-center justify-between relative overflow-hidden">
                <div class="absolute top-0 right-0 -mt-10 -mr-10 text-slate-50 opacity-50">
                    <i class="bi bi-wallet2 text-[15rem]"></i>
                </div>

                <div class="z-10 mb-8 md:mb-0 md:mr-8">
                    <h2 class="text-slate-500 font-medium mb-2 uppercase tracking-wider text-sm">Total Cobrado este Mes</h2>
                    <div class="text-5xl lg:text-6xl font-black text-slate-800 tracking-tight">
                        ${{ "%.2f"|format(stats.total_cobrado) }}
                    </div>
                    <div class="flex items-center gap-2 mt-4 text-emerald-600 bg-emerald-50 w-fit px-3 py-1.5 rounded-full font-medium text-sm">
                        <i class="bi bi-arrow-up-circle-fill"></i>
                        <span>{{ stats.total_pagos }} transacciones exitosas</span>
                    </div>
                </div>

                <div class="relative w-56 h-56 z-10 flex-shrink-0">
                     {% set total_cartera = stats.total_cobrado + stats.saldo_pendiente %}
                     {% set tasa = (stats.total_cobrado / total_cartera * 100) if total_cartera > 0 else 0 %}
                    <svg class="w-full h-full progress-ring" viewBox="0 0 200 200">
                        <circle cx="100" cy="100" r="80" fill="none" stroke="#f1f5f9" stroke-width="16" />
                        <circle class="progress-ring-circle drop-shadow-lg" cx="100" cy="100" r="80" fill="none" stroke="#059669"
                            stroke-width="16" stroke-linecap="round"
                            stroke-dasharray="{{ (tasa / 100 * 502.65)|round(2) }} 502.65" />
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                        <span class="text-4xl font-black text-slate-800">{{ "%.0f"|format(tasa) }}%</span>
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-widest mt-1">Recuperado</span>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-5 flex flex-col gap-6">
                <div class="bg-white rounded-2xl shadow-soft-md p-6 flex items-center hover-lift border-l-[6px] border-orange-400">
                    <div class="bg-orange-100 text-orange-500 w-14 h-14 rounded-xl flex items-center justify-center text-2xl mr-5 flex-shrink-0">
                        <i class="bi bi-hourglass-split"></i>
                    </div>
                    <div>
                        <p class="text-slate-400 text-xs font-bold uppercase tracking-wider">Saldo por Cobrar</p>
                        <h3 class="text-2xl font-bold text-slate-800">${{ "%.2f"|format(stats.saldo_pendiente) }}</h3>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-soft-md p-6 flex items-center hover-lift border-l-[6px] border-red-500">
                     <div class="bg-red-100 text-red-500 w-14 h-14 rounded-xl flex items-center justify-center text-2xl mr-5 flex-shrink-0">
                        <i class="bi bi-bell-fill animate-pulse"></i>
                    </div>
                    <div>
                        <p class="text-slate-400 text-xs font-bold uppercase tracking-wider">Créditos en Mora</p>
                        <h3 class="text-2xl font-bold text-red-600">{{ stats.pagos_mora }} Casos</h3>
                    </div>
                </div>

                <div class="bg-slate-800 rounded-2xl shadow-soft-md p-6 flex items-center text-white relative overflow-hidden">
                     <div class="absolute right-0 bottom-0 opacity-10 text-8xl -mr-6 -mb-6">
                         <i class="bi bi-database"></i>
                     </div>
                     <div class="bg-slate-700/50 text-blue-300 w-14 h-14 rounded-xl flex items-center justify-center text-2xl mr-5 flex-shrink-0 backdrop-blur-sm">
                        <i class="bi bi-pie-chart-fill"></i>
                    </div>
                    <div class="z-10">
                        <p class="text-slate-300 text-xs font-bold uppercase tracking-wider">Valor Cartera Total</p>
                        <h3 class="text-2xl font-bold">${{ "%.2f"|format(total_cartera) }}</h3>
                    </div>
                </div>
            </div>
        </div>


        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <div class="lg:col-span-1 space-y-6">
                 <h3 class="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">
                    <i class="bi bi-grid-fill text-slate-400"></i> Acciones
                </h3>
                <div class="grid grid-cols-2 gap-4">
                    <a href="" class="bg-white p-6 rounded-2xl shadow-soft-md hover-lift flex flex-col items-center justify-center text-center group border-2 border-transparent hover:border-emerald-200">
                        <i class="bi bi-plus-circle-dotted text-4xl text-emerald-500 mb-3 group-hover:scale-110 transition-transform"></i>
                        <span class="font-bold text-slate-700 group-hover:text-emerald-700">Registrar Pago</span>
                    </a>
                    <a href="" class="bg-white p-6 rounded-2xl shadow-soft-md hover-lift flex flex-col items-center justify-center text-center group border-2 border-transparent hover:border-blue-200">
                        <i class="bi bi-receipt text-4xl text-blue-500 mb-3 group-hover:scale-110 transition-transform"></i>
                        <span class="font-bold text-slate-700 group-hover:text-blue-700">Ver Pagos</span>
                    </a>
                    <a href="" class="bg-white p-6 rounded-2xl shadow-soft-md hover-lift flex flex-col items-center justify-center text-center group border-2 border-transparent hover:border-purple-200 lg:col-span-2">
                        <i class="bi bi-clipboard-data text-4xl text-purple-500 mb-3 group-hover:scale-110 transition-transform"></i>
                        <span class="font-bold text-slate-700 group-hover:text-purple-700">Gestión de Evaluaciones</span>
                    </a>
                </div>
            </div>

            <div class="lg:col-span-1 bg-white rounded-3xl shadow-soft-xl p-8">
                <h3 class="text-lg font-bold text-slate-700 mb-8 flex items-center gap-2">
                    <i class="bi bi-bar-chart-steps text-slate-400"></i> Estado de Créditos
                </h3>
                
                <div class="space-y-8">
                    <div>
                        <div class="flex justify-between mb-2">
                            <span class="text-sm font-bold text-slate-600 flex items-center gap-2">
                                <i class="bi bi-check-circle-fill text-emerald-500"></i> Liquidados
                            </span>
                            <span class="font-black text-slate-800" id="liquidados_count">0</span>
                        </div>
                        <div class="slim-progress-bar">
                            <div class="slim-progress-fill bg-emerald-500" style="width: 0%" id="liquidados_bar"></div>
                        </div>
                    </div>
                     <div>
                        <div class="flex justify-between mb-2">
                            <span class="text-sm font-bold text-slate-600 flex items-center gap-2">
                                <i class="bi bi-play-circle-fill text-blue-500"></i> En Pago
                            </span>
                            <span class="font-black text-slate-800" id="enpago_count">0</span>
                        </div>
                        <div class="slim-progress-bar">
                            <div class="slim-progress-fill bg-blue-500" style="width: 0%" id="enpago_bar"></div>
                        </div>
                    </div>
                     <div>
                        <div class="flex justify-between mb-2">
                            <span class="text-sm font-bold text-slate-600 flex items-center gap-2">
                                <i class="bi bi-pause-circle-fill text-orange-400"></i> Pendientes
                            </span>
                            <span class="font-black text-slate-800" id="pendientes_count">0</span>
                        </div>
                        <div class="slim-progress-bar">
                            <div class="slim-progress-fill bg-orange-400" style="width: 0%" id="pendientes_bar"></div>
                        </div>
                    </div>
                     <div>
                        <div class="flex justify-between mb-2">
                            <span class="text-sm font-bold text-slate-600 flex items-center gap-2">
                                <i class="bi bi-x-circle-fill text-red-500"></i> En Mora
                            </span>
                            <span class="font-black text-red-600" id="enmora_count">0</span>
                        </div>
                        <div class="slim-progress-bar">
                            <div class="slim-progress-fill bg-red-500" style="width: 0%" id="enmora_bar"></div>
                        </div>
                    </div>
                </div>
            </div>

             <div class="lg:col-span-1 bg-white rounded-3xl shadow-soft-xl p-8">
                 <h3 class="text-lg font-bold text-slate-700 mb-8 flex items-center gap-2">
                    <i class="bi bi-globe-americas text-slate-400"></i> Mercado en Vivo
                </h3>

                <div class="bg-slate-50 rounded-2xl p-5 mb-8 flex items-center justify-between border border-slate-100">
                    <div class="flex items-center gap-3">
                         <img src="https://flagcdn.com/w40/us.png" alt="USD" class="w-8 h-8 rounded-full shadow-sm object-cover">
                         <i class="bi bi-arrow-left-right text-slate-300"></i>
                         <img src="https://flagcdn.com/w40/mx.png" alt="MXN" class="w-8 h-8 rounded-full shadow-sm object-cover">
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-slate-400 font-bold uppercase tracking-wider">USD a MXN</p>
                        <p class="text-2xl font-black text-slate-800" id="rate-mxn">--.--</p>
                    </div>
                </div>

                <ul class="space-y-4">
                    <li class="flex justify-between items-center py-2 border-b border-slate-50 last:border-0">
                        <span class="font-semibold text-slate-600">S&P 500</span>
                        <span class="stock-pill gray" id="stock-sp500">Cargando...</span>
                    </li>
                    <li class="flex justify-between items-center py-2 border-b border-slate-50 last:border-0">
                        <span class="font-semibold text-slate-600">NASDAQ</span>
                        <span class="stock-pill gray" id="stock-nasdaq">Cargando...</span>
                    </li>
                    <li class="flex justify-between items-center py-2 border-b border-slate-50 last:border-0">
                        <span class="font-semibold text-slate-600">Dow Jones</span>
                        <span class="stock-pill gray" id="stock-dow">Cargando...</span>
                    </li>
                </ul>

                <div class="mt-6 text-xs text-center text-slate-400 flex items-center justify-center gap-2">
                    <span class="relative flex h-2 w-2">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                    </span>
                    Actualizado: <span id="rate-date">...</span>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // Función para actualizar las "pills" de la bolsa
    function updateStockPill(elementId, data) {
        const el = document.getElementById(elementId);
        if(!el) return;
        
        const change = data.changesPercentage;
        const priceStr = data.price.toFixed(2);
        const changeStr = change.toFixed(2) + '%';
        
        el.textContent = `${priceStr} (${changeStr})`;
        el.className = 'stock-pill ' + (change >= 0 ? 'positive' : 'negative');
    }

    // --- Divisas ---
    function cargarDivisas() {
        // Simulamos carga visual
        const el = document.getElementById('rate-mxn');
        el.classList.add('opacity-50');

        fetch("{{ url_for('routes.divisas_data') }}")
            .then(r => r.json())
            .then(data => {
                el.textContent = `$${data.rates.MXN.toFixed(2)}`;
                document.getElementById('rate-date').textContent = data.date;
            })
            .catch(err => {
                console.error("Error Divisas:", err);
                el.textContent = 'Error';
            })
            .finally(() => {
                el.classList.remove('opacity-50');
            });
    }

    // --- Bolsa ---
    function cargarBolsa() {
        fetch("{{ url_for('routes.bolsa_data') }}")
            .then(r => r.json())
            .then(data => {
                const map = { "^GSPC": "stock-sp500", "^IXIC": "stock-nasdaq", "^DJI": "stock-dow" };
                data.forEach(item => updateStockPill(map[item.symbol], item));
            })
            .catch(err => console.error("Error Bolsa:", err));
    }

    document.addEventListener('DOMContentLoaded', function() {
        cargarDivisas();
        cargarBolsa();
        setInterval(cargarDivisas, 3600 * 1000); 
        setInterval(cargarBolsa, 900 * 1000);
    });
</script>
{% endblock %}