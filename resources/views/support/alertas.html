{% extends "layout/layout_support.html" %}
{% block title %}Alertas de Soporte{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto p-6">
    <!-- Header -->
    <div class="mb-8">
        <h2 class="text-3xl font-bold text-gray-800 mb-2">üîî Centro de Alertas</h2>
        <p class="text-gray-600">Tickets que requieren atenci√≥n inmediata</p>
    </div>

    <!-- Estad√≠sticas de Alertas -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-gradient-to-br from-red-500 to-red-600 p-6 rounded-xl shadow-lg text-white">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm opacity-90">Cr√≠ticas</p>
                    <p class="text-3xl font-bold" id="stat-criticas">0</p>
                </div>
                <div class="bg-white bg-opacity-20 p-3 rounded-lg">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                </div>
            </div>
        </div>

        <div class="bg-gradient-to-br from-orange-500 to-orange-600 p-6 rounded-xl shadow-lg text-white">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm opacity-90">Pendientes</p>
                    <p class="text-3xl font-bold" id="stat-pendientes">0</p>
                </div>
                <div class="bg-white bg-opacity-20 p-3 rounded-lg">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
            </div>
        </div>

        <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-xl shadow-lg text-white">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm opacity-90">En Revisi√≥n</p>
                    <p class="text-3xl font-bold" id="stat-revision">0</p>
                </div>
                <div class="bg-white bg-opacity-20 p-3 rounded-lg">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    </svg>
                </div>
            </div>
        </div>

        <div class="bg-gradient-to-br from-purple-500 to-purple-600 p-6 rounded-xl shadow-lg text-white">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm opacity-90">Total Alertas</p>
                    <p class="text-3xl font-bold" id="stat-total">{{ alertas|length }}</p>
                </div>
                <div class="bg-white bg-opacity-20 p-3 rounded-lg">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="bg-white p-6 rounded-xl shadow-md mb-6">
        <div class="flex items-center gap-2 mb-4">
            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
            </svg>
            <h3 class="text-lg font-semibold text-gray-700">Filtrar Alertas</h3>
        </div>

        <div class="flex flex-wrap gap-3">
            <button onclick="filtrarPor('todos')" class="filter-btn active px-4 py-2 rounded-lg font-medium transition">
                Todas las alertas
            </button>
            <button onclick="filtrarPor('pendiente')" class="filter-btn px-4 py-2 bg-orange-100 text-orange-700 rounded-lg hover:bg-orange-200 font-medium transition">
                üü† Solo Pendientes
            </button>
            <button onclick="filtrarPor('en_revision')" class="filter-btn px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 font-medium transition">
                üîµ En Revisi√≥n
            </button>
            <button onclick="filtrarPor('sin_asignar')" class="filter-btn px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 font-medium transition">
                ‚ö†Ô∏è Sin Asignar
            </button>
        </div>
    </div>

    <!-- Lista de Alertas -->
    <div class="space-y-4" id="alertas-container">
        {% if alertas %}
            {% for alerta in alertas %}
            <div class="alerta-card bg-white rounded-xl shadow-md hover:shadow-lg transition-all duration-300 overflow-hidden border-l-4 
                {% if alerta.prioridad == 'alta' or alerta.estado == 'pendiente' %}border-red-500
                {% elif alerta.estado == 'en_revision' %}border-blue-500
                {% else %}border-orange-500{% endif %}"
                data-estado="{{ alerta.estado }}"
                data-prioridad="{{ alerta.prioridad or 'media' }}">
                
                <div class="p-6">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-start gap-4 flex-1">
                            <!-- Icono de prioridad -->
                            <div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center
                                {% if alerta.prioridad == 'alta' %}bg-red-100 text-red-600
                                {% elif alerta.estado == 'en_revision' %}bg-blue-100 text-blue-600
                                {% else %}bg-orange-100 text-orange-600{% endif %}">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                            </div>

                            <!-- Informaci√≥n -->
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-xs font-mono font-semibold">
                                        #{{ alerta._id[:8] }}
                                    </span>
                                    <span class="px-3 py-1 rounded-full text-xs font-semibold
                                        {% if alerta.estado == 'pendiente' %}bg-orange-100 text-orange-800
                                        {% elif alerta.estado == 'en_revision' %}bg-blue-100 text-blue-800
                                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                                        {{ alerta.estado|replace('_', ' ')|title }}
                                    </span>
                                    {% if alerta.prioridad == 'alta' %}
                                    <span class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-xs font-semibold">
                                        üî¥ ALTA PRIORIDAD
                                    </span>
                                    {% endif %}
                                </div>

                                <h3 class="text-xl font-bold text-gray-800 mb-2">
                                    {{ alerta.titulo or alerta.tipo or "Ticket sin t√≠tulo" }}
                                </h3>

                                <div class="space-y-2 text-sm text-gray-600">
                                    {% if alerta.cliente or alerta.cliente_nombre %}
                                    <div class="flex items-center gap-2">
                                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                        </svg>
                                        <span>Cliente: <strong>{{ alerta.cliente or alerta.cliente_nombre }}</strong></span>
                                    </div>
                                    {% endif %}

                                    <div class="flex items-center gap-2">
                                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <span>Creado: {{ alerta.fecha_creacion or 'N/A' }}</span>
                                    </div>

                                    {% if alerta.asesor or alerta.asignado_a %}
                                    <div class="flex items-center gap-2">
                                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                                        </svg>
                                        <span>Asignado a: <strong>{{ alerta.asesor or alerta.asignado_a }}</strong></span>
                                    </div>
                                    {% else %}
                                    <div class="flex items-center gap-2 text-red-600">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                        </svg>
                                        <span class="font-semibold">‚ö†Ô∏è Sin asignar</span>
                                    </div>
                                    {% endif %}

                                    {% if alerta.descripcion %}
                                    <div class="mt-3 p-3 bg-gray-50 rounded-lg">
                                        <p class="text-gray-700 text-sm">{{ alerta.descripcion[:150] }}{% if alerta.descripcion|length > 150 %}...{% endif %}</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Acciones -->
                        <div class="flex flex-col gap-2 ml-4">
                            <button onclick="verDetalles('{{ alerta._id }}')" 
                                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm font-medium whitespace-nowrap">
                                Ver detalles
                            </button>
                            <button onclick="resolverAlerta('{{ alerta._id }}')" 
                                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm font-medium whitespace-nowrap">
                                ‚úì Resolver
                            </button>
                        </div>
                    </div>

                    <!-- Barra de tiempo transcurrido -->
                    <div class="mt-4 pt-4 border-t border-gray-100">
                        <div class="flex items-center justify-between text-xs text-gray-500">
                            <span>Tiempo transcurrido</span>
                            <span class="font-semibold tiempo-transcurrido" data-fecha="{{ alerta.fecha_creacion }}">
                                Calculando...
                            </span>
                        </div>
                        <div class="mt-2 h-2 bg-gray-200 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r 
                                {% if alerta.prioridad == 'alta' %}from-red-500 to-red-600
                                {% else %}from-orange-500 to-orange-600{% endif %} 
                                transition-all duration-500 tiempo-barra" 
                                data-fecha="{{ alerta.fecha_creacion }}" style="width: 0%">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}

        {% else %}
            <div class="bg-white rounded-xl shadow-md p-12 text-center">
                <svg class="w-24 h-24 mx-auto mb-6 text-green-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <h3 class="text-2xl font-bold text-gray-800 mb-2">¬°Todo bajo control!</h3>
                <p class="text-gray-600 text-lg">No hay alertas pendientes en este momento</p>
            </div>
        {% endif %}
    </div>

    <!-- Mensaje cuando no hay resultados en filtros -->
    <div id="no-results" class="hidden bg-white rounded-xl shadow-md p-12 text-center">
        <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        <p class="text-gray-500 text-lg">No se encontraron alertas con este filtro</p>
        <button onclick="filtrarPor('todos')" class="mt-4 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
            Ver todas las alertas
        </button>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    console.log("üîî Inicializando Centro de Alertas");
    
    actualizarEstadisticas();
    actualizarTiempos();
    
    // Actualizar tiempos cada minuto
    setInterval(actualizarTiempos, 60000);
    
    function actualizarEstadisticas() {
        const alertas = document.querySelectorAll('.alerta-card');
        
        let criticas = 0;
        let pendientes = 0;
        let revision = 0;
        
        alertas.forEach(alerta => {
            const estado = alerta.dataset.estado;
            const prioridad = alerta.dataset.prioridad;
            
            if (prioridad === 'alta') criticas++;
            if (estado === 'pendiente') pendientes++;
            if (estado === 'en_revision') revision++;
        });
        
        document.getElementById('stat-criticas').textContent = criticas;
        document.getElementById('stat-pendientes').textContent = pendientes;
        document.getElementById('stat-revision').textContent = revision;
    }
    
    function actualizarTiempos() {
        document.querySelectorAll('.tiempo-transcurrido').forEach(el => {
            const fecha = el.dataset.fecha;
            if (!fecha || fecha === 'N/A') {
                el.textContent = 'Fecha no disponible';
                return;
            }
            
            try {
                const fechaCreacion = new Date(fecha.replace(' ', 'T'));
                const ahora = new Date();
                const diff = ahora - fechaCreacion;
                
                const minutos = Math.floor(diff / 60000);
                const horas = Math.floor(minutos / 60);
                const dias = Math.floor(horas / 24);
                
                let texto = '';
                if (dias > 0) texto = `${dias} d√≠a${dias > 1 ? 's' : ''}`;
                else if (horas > 0) texto = `${horas} hora${horas > 1 ? 's' : ''}`;
                else texto = `${minutos} minuto${minutos > 1 ? 's' : ''}`;
                
                el.textContent = texto;
                
                // Actualizar barra de progreso (m√°ximo 48 horas)
                const barra = el.closest('.alerta-card').querySelector('.tiempo-barra');
                if (barra) {
                    const porcentaje = Math.min((horas / 48) * 100, 100);
                    barra.style.width = porcentaje + '%';
                }
            } catch (e) {
                el.textContent = 'Error al calcular';
            }
        });
    }
    
    window.filtrarPor = function(tipo) {
        const alertas = document.querySelectorAll('.alerta-card');
        const noResults = document.getElementById('no-results');
        let visibleCount = 0;
        
        // Actualizar botones activos
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active', 'bg-blue-600', 'text-white');
            btn.classList.add('bg-gray-100', 'text-gray-700');
        });
        event.target.classList.add('active', 'bg-blue-600', 'text-white');
        event.target.classList.remove('bg-gray-100', 'text-gray-700');
        
        alertas.forEach(alerta => {
            const estado = alerta.dataset.estado;
            const sinAsignar = !alerta.querySelector('[data-estado]')?.textContent.includes('Asignado a:');
            
            let mostrar = false;
            
            if (tipo === 'todos') {
                mostrar = true;
            } else if (tipo === 'sin_asignar') {
                mostrar = alerta.textContent.includes('Sin asignar');
            } else {
                mostrar = estado === tipo;
            }
            
            if (mostrar) {
                alerta.style.display = '';
                visibleCount++;
            } else {
                alerta.style.display = 'none';
            }
        });
        
        // Mostrar/ocultar mensaje de sin resultados
        if (visibleCount === 0) {
            noResults.classList.remove('hidden');
        } else {
            noResults.classList.add('hidden');
        }
    };
    
    window.verDetalles = function(alertaId) {
        alert(`Ver detalles de alerta: ${alertaId}\n\nAqu√≠ puedes implementar un modal con informaci√≥n completa.`);
        // TODO: Implementar modal de detalles
    };
    
    window.resolverAlerta = async function(alertaId) {
        if (!confirm('¬øMarcar esta alerta como resuelta?')) return;
        
        try {
            const res = await fetch('/api/soporte/actualizar-ticket', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id: alertaId,
                    estado: 'resuelto'
                })
            });
            
            const data = await res.json();
            
            if (data.success || data.mensaje) {
                mostrarNotificacion('‚úÖ Alerta resuelta correctamente', 'success');
                
                // Remover visualmente la alerta
                const alertaEl = document.querySelector(`[data-estado][data-prioridad]`);
                if (alertaEl) {
                    alertaEl.style.opacity = '0';
                    alertaEl.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        alertaEl.remove();
                        actualizarEstadisticas();
                    }, 300);
                }
            } else {
                mostrarNotificacion('‚ùå Error al resolver alerta', 'error');
            }
        } catch (err) {
            console.error('Error:', err);
            mostrarNotificacion('‚ùå Error de conexi√≥n', 'error');
        }
    };
    
    function mostrarNotificacion(mensaje, tipo) {
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white font-medium z-50 ${
            tipo === 'success' ? 'bg-green-500' : 'bg-red-500'
        }`;
        toast.textContent = mensaje;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transition = 'opacity 0.3s';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
});
</script>

<style>
.filter-btn.active {
    background-color: #2563eb;
    color: white;
}

.alerta-card {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.alerta-card:hover {
    transform: translateY(-2px);
}
</style>
{% endblock %}