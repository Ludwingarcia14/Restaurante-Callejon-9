{% extends "layout/layout_support.html" %}
{% block title %}Comunicaci√≥n con el Cliente o Asesor{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto p-6">
    <div class="flex justify-center">

        <!-- ========================================== -->
        <!-- CHAT FAQ (PREGUNTAS FRECUENTES) -->
        <div class="bg-white rounded-xl shadow-md">
            <div class="bg-gradient-to-r from-purple-600 to-indigo-700 p-4 rounded-t-xl">
                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                    ü§ñ Asistente Virtual FAQ
                </h2>
                <p class="text-purple-100 text-sm mt-1">
                    Respuestas r√°pidas 24/7
                </p>
            </div>

            <div id="faqChatContainer" class="border-t p-4 h-96 overflow-y-auto bg-gradient-to-br from-purple-50 to-indigo-50">
                <div class="flex flex-col space-y-4" id="faqMessages">
                    <!-- Mensaje inicial del bot -->
                    <div class="flex gap-2">
                        <div class="w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center flex-shrink-0">
                            <span class="text-white text-sm">ü§ñ</span>
                        </div>
                        <div class="bg-white p-3 rounded-xl rounded-tl-none shadow-sm max-w-xs">
                            <p class="text-sm text-gray-800">
                                ¬°Hola! üëã Soy tu asistente virtual.<br><br>
                                Escribe el n√∫mero de lo que necesitas:
                            </p>
                            <ul class="text-sm text-gray-700 mt-2 space-y-1">
                                <li><strong>1.</strong> ‚è∞ Horarios de atenci√≥n</li>
                                <li><strong>2.</strong> üé´ Estado de mi ticket</li>
                                <li><strong>3.</strong> üìù Crear un nuevo ticket</li>
                                <li><strong>4.</strong> üìû Informaci√≥n de contacto</li>
                                <li><strong>5.</strong> ‚ö° Reportar algo urgente</li>
                            </ul>
                            <p class="text-xs text-gray-400 mt-2">
                                Tambi√©n puedes escribir con tus propias palabras.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Indicador de escritura -->
                <div id="faqTyping" class="hidden flex gap-2 mt-3">
                    <div class="w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center">
                        <span class="text-white text-sm">ü§ñ</span>
                    </div>
                    <div class="bg-white p-3 rounded-xl shadow-sm">
                        <div class="flex gap-1">
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                        </div>
                    </div>
                </div>
            </div>

            <form id="faqForm" class="p-4 bg-white border-t rounded-b-xl">
                <div class="flex gap-2">
                    <input type="text" id="faqInput" placeholder="Escribe 1-5 o tu pregunta..." 
                           class="flex-1 p-2 border rounded-lg text-sm">
                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                        Enviar
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-2 text-center">
                    üí° Prueba: "1", "2", "horarios", "contacto"
                </p>
            </form>
        </div>

    </div>
</div>

<style>
@keyframes bounce {
    0%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-8px); }
}
.animate-bounce {
    animation: bounce 1.4s infinite ease-in-out;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const faqMessages = document.getElementById("faqMessages");
    const faqForm = document.getElementById("faqForm");
    const faqInput = document.getElementById("faqInput");
    const faqTyping = document.getElementById("faqTyping");

    const numericOptions = {
        "1": "horarios",
        "2": "ticket",
        "3": "crear",
        "4": "contacto",
        "5": "urgente"
    };

    // Base de conocimiento FAQ
    const faqKnowledge = {
        horarios: {
            keywords: ['horario', 'hora', 'atencion', 'atenci√≥n', 'cuando', 'abren', 'cierran'],
            response: `‚è∞ <strong>Horarios de Atenci√≥n:</strong><br><br>
                ‚Ä¢ Lunes a Viernes: 9:00 AM - 6:00 PM<br>
                ‚Ä¢ S√°bados: 9:00 AM - 2:00 PM<br>
                ‚Ä¢ Domingos: Cerrado<br><br>
                Para urgencias fuera de horario, cont√°ctanos por WhatsApp.`,
            needsHuman: false
        },
        ticket: {
            keywords: ['ticket', 'seguimiento', 'estado', 'consultar', 'numero', 'n√∫mero', 'folio'],
            response: `üé´ <strong>Consulta de Tickets:</strong><br><br>
                Para consultar el estado de tu ticket:<br>
                1. Ingresa a tu panel de cliente<br>
                2. Ve a "Mis Tickets"<br>
                3. Usa tu n√∫mero de ticket<br><br>
                ¬øNecesitas ayuda espec√≠fica con un ticket?`,
            needsHuman: false
        },
        crear: {
            keywords: ['crear', 'nuevo', 'abrir', 'reportar', 'registrar'],
            response: `üìù <strong>Crear Nuevo Ticket:</strong><br><br>
                Para crear un ticket necesitas:<br>
                1. Descripci√≥n del problema<br>
                2. Capturas (opcional)<br>
                3. Tu informaci√≥n de contacto<br><br>
                ¬øQuieres ir al formulario de tickets?`,
            needsHuman: false
        },
        contacto: {
            keywords: ['contacto', 'telefono', 'tel√©fono', 'email', 'whatsapp', 'llamar', 'correo'],
            response: `üìû <strong>Informaci√≥n de Contacto:</strong><br><br>
                ‚Ä¢ WhatsApp: +52 722 123 4567<br>
                ‚Ä¢ Email: soporte@tuempresa.com<br>
                ‚Ä¢ Tel√©fono: (722) 123-4567<br><br>
                ¬øTe gustar√≠a contactarnos ahora?`,
            needsHuman: true
        },
        urgente: {
            keywords: ['urgente', 'prioridad', 'critico', 'cr√≠tico', 'importante', 'rapido', 'r√°pido'],
            response: `‚ö° <strong>Niveles de Prioridad:</strong><br><br>
                üî¥ Alta: Problemas cr√≠ticos (2h)<br>
                üü° Media: Incidencias importantes (24h)<br>
                üü¢ Baja: Consultas generales (48h)<br><br>
                ¬øTu caso es urgente?`,
            needsHuman: true
        }
    };

    // Funci√≥n para encontrar respuesta
    function findResponse(mensaje) {
        const msg = mensaje.toLowerCase().trim();
        
        if (numericOptions[msg]) {
            return faqKnowledge[numericOptions[msg]];
        }
        
        for (const data of Object.values(faqKnowledge)) {
            if (data.keywords.some(kw => msg.includes(kw))) {
                return data;
            }
        }
        
        return {
            response: `ü§î No encontr√© una respuesta clara.<br><br>
                Puedes escribir:<br>
                <strong>1</strong> para horarios<br>
                <strong>2</strong> para tickets<br>
                <strong>3</strong> para crear ticket<br>
                <strong>4</strong> para contacto<br>
                <strong>5</strong> para urgencias`,
            needsHuman: true
        };
    }

    // Agregar mensaje del usuario
    function addUserMessage(text) {
        const msgDiv = document.createElement("div");
        msgDiv.className = "flex justify-end gap-2";
        msgDiv.innerHTML = `
            <div class="bg-purple-600 text-white p-3 rounded-xl rounded-tr-none shadow-sm max-w-xs">
                <p class="text-sm">${text}</p>
                <span class="text-xs text-purple-100 mt-1 block">
                    ${new Date().toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' })}
                </span>
            </div>
            <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center flex-shrink-0">
                <span class="text-white text-sm">üë§</span>
            </div>
        `;
        faqMessages.appendChild(msgDiv);
        scrollToBottom();
    }

    // Agregar mensaje del bot
    function addBotMessage(html, needsHuman = false) {
        const msgDiv = document.createElement("div");
        msgDiv.className = "flex gap-2";
        msgDiv.innerHTML = `
            <div class="w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center flex-shrink-0">
                <span class="text-white text-sm">ü§ñ</span>
            </div>
            <div class="bg-white p-3 rounded-xl rounded-tl-none shadow-sm max-w-xs">
                <p class="text-sm text-gray-800">${html}</p>
                <span class="text-xs text-gray-400 mt-2 block">
                    ${new Date().toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' })}
                </span>
            </div>
        `;
        faqMessages.appendChild(msgDiv);

        if (needsHuman) {
            addActionButtons();
        }

        showMenu();
        scrollToBottom();
    }

    // Mostrar men√∫ de opciones
    function showMenu() {
        const menuDiv = document.createElement("div");
        menuDiv.className = "flex gap-2";
        menuDiv.innerHTML = `
            <div class="w-8 h-8"></div>
            <div class="bg-purple-50 p-3 rounded-xl shadow-sm max-w-xs border border-purple-200">
                <p class="text-xs text-gray-600 mb-2">¬øNecesitas algo m√°s?</p>
                <div class="text-xs text-gray-700 space-y-1">
                    <div><strong>1</strong> Horarios | <strong>2</strong> Tickets</div>
                    <div><strong>3</strong> Crear | <strong>4</strong> Contacto</div>
                </div>
            </div>
        `;
        faqMessages.appendChild(menuDiv);
    }

    // Agregar botones de acci√≥n
    function addActionButtons() {
        const btnDiv = document.createElement("div");
        btnDiv.className = "flex gap-2 justify-center my-3";
        btnDiv.innerHTML = `
            <button onclick="contactWhatsApp()" 
                    class="flex items-center gap-2 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all shadow-md text-sm">
                <span>üí¨</span> WhatsApp
            </button>
            <button onclick="contactPhone()" 
                    class="flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all shadow-md text-sm">
                <span>üìû</span> Llamar
            </button>
        `;
        faqMessages.appendChild(btnDiv);
        scrollToBottom();
    }

    function scrollToBottom() {
        faqMessages.parentElement.scrollTop = faqMessages.parentElement.scrollHeight;
    }

    function showTyping() {
        faqTyping.classList.remove("hidden");
        scrollToBottom();
    }

    function hideTyping() {
        faqTyping.classList.add("hidden");
    }

    faqForm.addEventListener("submit", (e) => {
        e.preventDefault();
        
        const mensaje = faqInput.value.trim();
        if (!mensaje) return;

        addUserMessage(mensaje);
        faqInput.value = "";

        showTyping();

        setTimeout(() => {
            hideTyping();
            const { response, needsHuman } = findResponse(mensaje);
            addBotMessage(response, needsHuman);
        }, 1000);
    });

    // Funciones globales para botones
    window.contactWhatsApp = function() {
        const phone = '5217221234567';
        const message = encodeURIComponent('Hola, necesito ayuda con soporte t√©cnico');
        window.open(`https://wa.me/${phone}?text=${message}`, '_blank');
    };

    window.contactPhone = function() {
        window.location.href = 'tel:+527221234567'; 
    };
});
</script>
{% endblock %}