{% extends "layout/layout_base.html" %}

{% block title %}Reportes de Inventario - Restaurante Callejón 9{% endblock %}

{% block content %}
<div class="reports-container">
    <div class="page-header">
        <a href="{{ url_for('reports.index') }}" class="back-link"><i class="bi bi-arrow-left"></i> Volver a Reportes</a>
        <h1><i class="bi bi-box-seam"></i> Reportes de Inventario</h1>
        <p class="subtitle">Control de stock, mermas y rotación</p>
    </div>

    <!-- Date Filter -->
    <div class="filter-section">
        <form id="dateFilterForm" class="filter-form">
            <div class="filter-group">
                <label for="fecha_inicio">Fecha Inicio:</label>
                <input type="date" id="fecha_inicio" name="fecha_inicio">
            </div>
            <div class="filter-group">
                <label for="fecha_fin">Fecha Fin:</label>
                <input type="date" id="fecha_fin" name="fecha_fin">
            </div>
            <button type="button" onclick="loadAllReports()" class="btn btn-primary">Generar Reporte</button>
            <div class="export-group">
                <label>Exportar:</label>
                <button type="button" onclick="exportReport('csv', 'inventario')" class="btn btn-sm">CSV</button>
                <button type="button" onclick="exportReport('excel', 'inventario')" class="btn btn-sm">Excel</button>
                <button type="button" onclick="exportReport('pdf', 'inventario')" class="btn btn-sm">PDF</button>
            </div>
        </form>
    </div>

    <!-- KPI Cards -->
    <div class="kpi-grid">
        <div class="kpi-card warning">
            <div class="kpi-icon"><i class="bi bi-trash3"></i></div>
            <div class="kpi-content">
                <span class="kpi-label">Merma Total</span>
                <span class="kpi-value" id="kpi-merma">$0.00</span>
            </div>
        </div>
        <div class="kpi-card info">
            <div class="kpi-icon"><i class="bi bi-graph-down"></i></div>
            <div class="kpi-content">
                <span class="kpi-label">Consumo Total</span>
                <span class="kpi-value" id="kpi-consumo">$0.00</span>
            </div>
        </div>
        <div class="kpi-card success">
            <div class="kpi-icon"><i class="bi bi-arrow-repeat"></i></div>
            <div class="kpi-content">
                <span class="kpi-label">Rotación Promedio</span>
                <span class="kpi-value" id="kpi-rotacion">0</span>
            </div>
        </div>
        <div class="kpi-card danger">
            <div class="kpi-icon"><i class="bi bi-currency-dollar"></i></div>
            <div class="kpi-content">
                <span class="kpi-label">Insumos Costosos</span>
                <span class="kpi-value" id="kpi-costosos">$0.00</span>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="charts-row">
        <div class="chart-card">
            <h3><i class="bi bi-bar-chart-line"></i> Consumo por Categoría</h3>
            <canvas id="consumoChart"></canvas>
        </div>
        <div class="chart-card">
            <h3><i class="bi bi-trash3"></i> Merma por Insumo</h3>
            <canvas id="mermaChart"></canvas>
        </div>
    </div>

    <!-- Data Tables -->
    <div class="tables-section">
        <!-- Consumo por Período -->
        <div class="table-card">
            <h3><i class="bi bi-graph-down"></i> Consumo por Insumo</h3>
            <div class="table-container">
                <table class="data-table" id="consumo-table">
                    <thead>
                        <tr>
                            <th>Insumo</th>
                            <th>Categoría</th>
                            <th>Cantidad</th>
                            <th>Costo Total</th>
                            <th>Movimientos</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="5" class="loading">Cargando datos...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Merma Acumulada -->
        <div class="table-card">
            <h3><i class="bi bi-trash3"></i> Merma Acumulada</h3>
            <div class="table-container">
                <table class="data-table" id="merma-table">
                    <thead>
                        <tr>
                            <th>Insumo</th>
                            <th>Categoría</th>
                            <th>Cantidad Perdida</th>
                            <th>Costo Perdido</th>
                            <th>Movimientos</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="5" class="loading">Cargando datos...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Insumos Más Costosos -->
        <div class="table-card">
            <h3><i class="bi bi-currency-exchange"></i> Insumos Más Costosos</h3>
            <div class="table-container">
                <table class="data-table" id="costosos-table">
                    <thead>
                        <tr>
                            <th>Insumo</th>
                            <th>Categoría</th>
                            <th>Costo Total</th>
                            <th>Cantidad Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="4" class="loading">Cargando datos...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Stock Actual -->
        <div class="table-card">
            <h3><i class="bi bi-box"></i> Stock Actual</h3>
            <div class="table-container">
                <table class="data-table" id="stock-table">
                    <thead>
                        <tr>
                            <th>Insumo</th>
                            <th>Categoría</th>
                            <th>Stock Actual</th>
                            <th>Stock Mínimo</th>
                            <th>Costo Unitario</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="5" class="loading">Cargando datos...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Rotación de Inventario -->
        <div class="table-card full-width">
            <h3><i class="bi bi-arrow-repeat"></i> Rotación de Inventario por Categoría</h3>
            <div class="table-container">
                <table class="data-table" id="rotacion-table">
                    <thead>
                        <tr>
                            <th>Categoría</th>
                            <th>Costo Consumido</th>
                            <th>Cantidad Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="3" class="loading">Cargando datos...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const thirtyDaysAgo = new Date(today);
    thirtyDaysAgo.setDate(today.getDate() - 30);
    
    document.getElementById('fecha_inicio').value = thirtyDaysAgo.toISOString().split('T')[0];
    document.getElementById('fecha_fin').value = today.toISOString().split('T')[0];
    
    loadAllReports();
});

function loadAllReports() {
    loadConsumo();
    loadMerma();
    loadInsumosCostosos();
    loadStock();
    loadRotacion();
    loadKPI();
}

function loadKPI() {
    const fecha_inicio = document.getElementById('fecha_inicio').value;
    const fecha_fin = document.getElementById('fecha_fin').value;
    
    // Merma
    fetch(`/reportes/api/merma-acumulada?fecha_inicio=${fecha_inicio}&fecha_fin=${fecha_fin}`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const totalMerma = data.data.reduce((sum, d) => sum + (d.costo_perdido || 0), 0);
                document.getElementById('kpi-merma').textContent = formatCurrency(totalMerma);
            }
        });
    
    // Consumo
    fetch(`/reportes/api/consumo-por-periodo?fecha_inicio=${fecha_inicio}&fecha_fin=${fecha_fin}`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const totalConsumo = data.data.reduce((sum, d) => sum + (d.costo_total || 0), 0);
                document.getElementById('kpi-consumo').textContent = formatCurrency(totalConsumo);
            }
        });
    
    // Costosos
    fetch(`/reportes/api/insumos-costosos?fecha_inicio=${fecha_inicio}&fecha_fin=${fecha_fin}`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const total = data.data.reduce((sum, d) => sum + (d.costo_total || 0), 0);
                document.getElementById('kpi-costosos').textContent = formatCurrency(total);
            }
        });
}

function loadConsumo() {
    const fecha_inicio = document.getElementById('fecha_inicio').value;
    const fecha_fin = document.getElementById('fecha_fin').value;
    
    fetch(`/reportes/api/consumo-por-periodo?fecha_inicio=${fecha_inicio}&fecha_fin=${fecha_fin}`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                renderConsumoTable(data.data);
                renderConsumoChart(data.data);
            }
        });
}

function renderConsumoTable(data) {
    const tbody = document.querySelector('#consumo-table tbody');
    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">No hay datos</td></tr>';
        return;
    }
    
    tbody.innerHTML = data.slice(0, 15).map(d => `
        <tr>
            <td>${d.nombre || d._id}</td>
            <td>${d.categoria || 'N/A'}</td>
            <td>${d.cantidad_total?.toFixed(2) || 0}</td>
            <td>${formatCurrency(d.costo_total)}</td>
            <td>${d.movimientos || 0}</td>
        </tr>
    `).join('');
}

function renderConsumoChart(data) {
    const ctx = document.getElementById('consumoChart').getContext('2d');
    
    if (window.consumoChartInstance) {
        window.consumoChartInstance.destroy();
    }
    
    // Aggregate by category
    const categories = {};
    data.forEach(d => {
        const cat = d.categoria || 'Otro';
        categories[cat] = (categories[cat] || 0) + (d.costo_total || 0);
    });
    
    window.consumoChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(categories),
            datasets: [{
                label: 'Consumo por Categoría',
                data: Object.values(categories),
                backgroundColor: 'rgba(54, 162, 235, 0.6)'
            }]
        },
        options: {
            responsive: true,
            indexAxis: 'y'
        }
    });
}

function loadMerma() {
    const fecha_inicio = document.getElementById('fecha_inicio').value;
    const fecha_fin = document.getElementById('fecha_fin').value;
    
    fetch(`/reportes/api/merma-acumulada?fecha_inicio=${fecha_inicio}&fecha_fin=${fecha_fin}`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                renderMermaTable(data.data);
                renderMermaChart(data.data);
            }
        });
}

function renderMermaTable(data) {
    const tbody = document.querySelector('#merma-table tbody');
    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">No hay mermas registradas</td></tr>';
        return;
    }
    
    tbody.innerHTML = data.slice(0, 15).map(d => `
        <tr>
            <td>${d.nombre || d._id}</td>
            <td>${d.categoria || 'N/A'}</td>
            <td>${d.cantidad_perdida?.toFixed(2) || 0}</td>
            <td class="negative">${formatCurrency(d.costo_perdido)}</td>
            <td>${d.num_movimientos || 0}</td>
        </tr>
    `).join('');
}

function renderMermaChart(data) {
    const ctx = document.getElementById('mermaChart').getContext('2d');
    
    if (window.mermaChartInstance) {
        window.mermaChartInstance.destroy();
    }
    
    window.mermaChartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: data.slice(0, 8).map(d => d.nombre || d._id),
            datasets: [{
                data: data.slice(0, 8).map(d => d.costo_perdido || 0),
                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF', '#7BC225']
            }]
        },
        options: {
            responsive: true
        }
    });
}

function loadInsumosCostosos() {
    const fecha_inicio = document.getElementById('fecha_inicio').value;
    const fecha_fin = document.getElementById('fecha_fin').value;
    
    fetch(`/reportes/api/insumos-costosos?fecha_inicio=${fecha_inicio}&fecha_fin=${fecha_fin}&limite=15`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                renderCostososTable(data.data);
            }
        });
}

function renderCostososTable(data) {
    const tbody = document.querySelector('#costosos-table tbody');
    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4">No hay datos</td></tr>';
        return;
    }
    
    tbody.innerHTML = data.map(d => `
        <tr>
            <td>${d.nombre || d._id}</td>
            <td>${d.categoria || 'N/A'}</td>
            <td class="warning">${formatCurrency(d.costo_total)}</td>
            <td>${d.cantidad_total?.toFixed(2) || 0}</td>
        </tr>
    `).join('');
}

function loadStock() {
    fetch('/reportes/api/stock-actual')
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                renderStockTable(data.data);
            }
        });
}

function renderStockTable(data) {
    const tbody = document.querySelector('#stock-table tbody');
    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">No hay insumos</td></tr>';
        return;
    }
    
    tbody.innerHTML = data.slice(0, 15).map(d => `
        <tr class="${d.stock_actual <= d.stock_minimo ? 'low-stock' : ''}">
            <td>${d.nombre}</td>
            <td>${d.categoria}</td>
            <td>${d.stock_actual?.toFixed(2)} ${d.unidad_medida}</td>
            <td>${d.stock_minimo?.toFixed(2)} ${d.unidad_medida}</td>
            <td>${formatCurrency(d.costo_unitario)}</td>
        </tr>
    `).join('');
}

function loadRotacion() {
    const fecha_inicio = document.getElementById('fecha_inicio').value;
    const fecha_fin = document.getElementById('fecha_fin').value;
    
    fetch(`/reportes/api/rotacion-inventario?fecha_inicio=${fecha_inicio}&fecha_fin=${fecha_fin}`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                renderRotacionTable(data.data);
                const total = data.data.reduce((sum, d) => sum + (d.costo_total_consumido || 0), 0);
                document.getElementById('kpi-rotacion').textContent = data.data.length > 0 ? (total / data.data.length).toFixed(2) : 0;
            }
        });
}

function renderRotacionTable(data) {
    const tbody = document.querySelector('#rotacion-table tbody');
    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3">No hay datos</td></tr>';
        return;
    }
    
    tbody.innerHTML = data.map(d => `
        <tr>
            <td>${d._id || 'N/A'}</td>
            <td>${formatCurrency(d.costo_total_consumido)}</td>
            <td>${d.cantidad_total?.toFixed(2) || 0}</td>
        </tr>
    `).join('');
}

function exportReport(format, type) {
    const fecha_inicio = document.getElementById('fecha_inicio').value;
    const fecha_fin = document.getElementById('fecha_fin').value;
    
    let url = `/reportes/exportar/${format}?reporte=${type}&fecha_inicio=${fecha_inicio}&fecha_fin=${fecha_fin}`;
    window.open(url, '_blank');
}

function formatCurrency(value) {
    return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(value || 0);
}
</script>

<style>
.reports-container { padding: 20px; max-width: 1400px; margin: 0 auto; }
.page-header { margin-bottom: 30px; }
.back-link { color: #3498db; text-decoration: none; font-size: 0.9em; }
.page-header h1 { color: #2c3e50; margin: 10px 0; }
.subtitle { color: #7f8c8d; }

.filter-section {
    background: #fff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.filter-form { display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap; }
.filter-group { display: flex; flex-direction: column; }
.filter-group label { font-weight: 600; margin-bottom: 5px; color: #34495e; }
.filter-group input { padding: 10px; border: 1px solid #ddd; border-radius: 5px; }

.export-group { display: flex; gap: 10px; align-items: center; margin-left: auto; }

.btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; transition: background 0.3s; }
.btn-primary { background: #3498db; color: white; }
.btn-sm { padding: 8px 15px; background: #ecf0f1; color: #34495e; }
.btn:hover { opacity: 0.9; }

.kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 30px;
}

.kpi-card {
    background: #fff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 15px;
}

.kpi-card.warning { border-left: 4px solid #f39c12; }
.kpi-card.info { border-left: 4px solid #3498db; }
.kpi-card.success { border-left: 4px solid #27ae60; }
.kpi-card.danger { border-left: 4px solid #e74c3c; }

.kpi-icon { font-size: 2em; }
.kpi-content { display: flex; flex-direction: column; }
.kpi-label { font-size: 0.85em; color: #7f8c8d; }
.kpi-value { font-size: 1.5em; font-weight: bold; color: #2c3e50; }

.charts-row {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    margin-bottom: 30px;
}

.chart-card {
    background: #fff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.chart-card h3 { color: #2c3e50; margin-bottom: 15px; }

.tables-section {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
}

.table-card {
    background: #fff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.table-card.full-width { grid-column: span 2; }
.table-card h3 { color: #2c3e50; margin-bottom: 15px; }

.table-container { overflow-x: auto; }

.data-table { width: 100%; border-collapse: collapse; }
.data-table th, .data-table td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
.data-table th { background: #f8f9fa; font-weight: 600; color: #34495e; }

.negative { color: #e74c3c; font-weight: 600; }
.warning { color: #f39c12; font-weight: 600; }
.low-stock { background: #fff3cd; }
.loading { text-align: center; color: #7f8c8d; }

@media (max-width: 1024px) {
    .charts-row, .tables-section { grid-template-columns: 1fr; }
    .table-card.full-width { grid-column: span 1; }
}
</style>
{% endblock %}
