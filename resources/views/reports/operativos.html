{% extends "layout/layout_base.html" %}

{% block title %}Reportes Operativos - Restaurante Callejón 9{% endblock %}

{% block content %}
<div class="reports-container">
    <div class="page-header">
        <a href="{{ url_for('reports.index') }}" class="back-link"><i class="bi bi-arrow-left"></i> Volver a Reportes</a>
        <h1><i class="bi bi-gear"></i> Reportes Operativos</h1>
        <p class="subtitle">Rendimiento de empleados y análisis de platillos</p>
    </div>

    <!-- Date Filter -->
    <div class="filter-section">
        <form id="dateFilterForm" class="filter-form">
            <div class="filter-group">
                <label for="fecha_inicio">Fecha Inicio:</label>
                <input type="date" id="fecha_inicio" name="fecha_inicio">
            </div>
            <div class="filter-group">
                <label for="fecha_fin">Fecha Fin:</label>
                <input type="date" id="fecha_fin" name="fecha_fin">
            </div>
            <button type="button" onclick="loadAllReports()" class="btn btn-primary">Generar Reporte</button>
            <div class="export-group">
                <label>Exportar:</label>
                <button type="button" onclick="exportReport('csv', 'empleados')" class="btn btn-sm">CSV</button>
                <button type="button" onclick="exportReport('excel', 'empleados')" class="btn btn-sm">Excel</button>
                <button type="button" onclick="exportReport('pdf', 'empleados')" class="btn btn-sm">PDF</button>
            </div>
        </form>
    </div>

    <!-- KPI Cards -->
    <div class="kpi-grid">
        <div class="kpi-card success">
            <div class="kpi-icon"><i class="bi bi-trophy"></i></div>
            <div class="kpi-content">
                <span class="kpi-label">Mejor Vendedor</span>
                <span class="kpi-value" id="kpi-mejor">-</span>
            </div>
        </div>
        <div class="kpi-card info">
            <div class="kpi-icon"><i class="bi bi-egg-fried"></i></div>
            <div class="kpi-content">
                <span class="kpi-label">Platillo Más Vendido</span>
                <span class="kpi-value" id="kpi-top-platillo">-</span>
            </div>
        </div>
        <div class="kpi-card warning">
            <div class="kpi-icon"><i class="bi bi-clock"></i></div>
            <div class="kpi-content">
                <span class="kpi-label">Tiempo Promedio</span>
                <span class="kpi-value" id="kpi-tiempo">0 min</span>
            </div>
        </div>
        <div class="kpi-card danger">
            <div class="kpi-icon"><i class="bi bi-arrow-down-circle"></i></div>
            <div class="kpi-content">
                <span class="kpi-label">Platillo Menos Rentable</span>
                <span class="kpi-value" id="kpi-peor">-</span>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="charts-row">
        <div class="chart-card">
            <h3><i class="bi bi-people"></i> Ventas por Empleado</h3>
            <canvas id="empleadosChart"></canvas>
        </div>
        <div class="chart-card">
            <h3><i class="bi bi-fire"></i> Platillos Más Vendidos</h3>
            <canvas id="platillosChart"></canvas>
        </div>
    </div>

    <!-- Data Tables -->
    <div class="tables-section">
        <!-- Rendimiento por Empleado -->
        <div class="table-card">
            <h3><i class="bi bi-person-badge"></i> Rendimiento por Empleado</h3>
            <div class="table-container">
                <table class="data-table" id="empleados-table">
                    <thead>
                        <tr>
                            <th>Empleado</th>
                            <th>Total Ventas</th>
                            <th>Número Pedidos</th>
                            <th>Total Propinas</th>
                            <th>Promedio Venta</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="5" class="loading">Cargando datos...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Platillos Más Vendidos -->
        <div class="table-card">
            <h3><i class="bi bi-fire"></i> Platillos Más Vendidos</h3>
            <div class="table-container">
                <table class="data-table" id="platillos-vendidos-table">
                    <thead>
                        <tr>
                            <th>Platillo</th>
                            <th>Categoría</th>
                            <th>Cantidad Vendida</th>
                            <th>Ventas Totales</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="4" class="loading">Cargando datos...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Platillos Menos Rentables -->
        <div class="table-card">
            <h3><i class="bi bi-arrow-down-circle"></i> Platillos Menos Rentables</h3>
            <div class="table-container">
                <table class="data-table" id="platillos-rentables-table">
                    <thead>
                        <tr>
                            <th>Platillo</th>
                            <th>Ventas Totales</th>
                            <th>Costo Total</th>
                            <th>Utilidad</th>
                            <th>Margen (%)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="5" class="loading">Cargando datos...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tiempo de Servicio -->
        <div class="table-card full-width">
            <h3><i class="bi bi-clock-history"></i> Tiempo Promedio de Servicio por Día</h3>
            <div class="table-container">
                <table class="data-table" id="tiempo-table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Tiempo Promedio (minutos)</th>
                            <th>Pedidos Totales</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="3" class="loading">Cargando datos...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const thirtyDaysAgo = new Date(today);
    thirtyDaysAgo.setDate(today.getDate() - 30);
    
    document.getElementById('fecha_inicio').value = thirtyDaysAgo.toISOString().split('T')[0];
    document.getElementById('fecha_fin').value = today.toISOString().split('T')[0];
    
    loadAllReports();
});

function loadAllReports() {
    loadRendimientoEmpleados();
    loadPlatillosVendidos();
    loadPlatillosRentables();
    loadTiempoServicio();
    loadKPI();
}

function loadKPI() {
    const fecha_inicio = document.getElementById('fecha_inicio').value;
    const fecha_fin = document.getElementById('fecha_fin').value;
    
    // Mejor empleado
    fetch(`/reportes/api/rendimiento-empleado?fecha_inicio=${fecha_inicio}&fecha_fin=${fecha_fin}`)
        .then(r => r.json())
        .then(data => {
            if (data.success && data.data.length > 0) {
                const mejor = data.data[0];
                document.getElementById('kpi-mejor').textContent = mejor.nombre_mesero || 'N/A';
            }
        });
    
    // Platillo más vendido
    fetch(`/reportes/api/platillos-mas-vendidos?fecha_inicio=${fecha_inicio}&fecha_fin=${fecha_fin}&limite=1`)
        .then(r => r.json())
        .then(data => {
            if (data.success && data.data.length > 0) {
                document.getElementById('kpi-top-platillo').textContent = data.data[0].nombre;
            }
        });
    
    // Tiempo promedio
    fetch(`/reportes/api/tiempo-servicio?fecha_inicio=${fecha_inicio}&fecha_fin=${fecha_fin}`)
        .then(r => r.json())
        .then(data => {
            if (data.success && data.data.length > 0) {
                const avg = data.data.reduce((sum, d) => sum + (d.tiempo_promedio_minutos || 0), 0) / data.data.length;
                document.getElementById('kpi-tiempo').textContent = avg.toFixed(1) + ' min';
            }
        });
    
    // Platillo menos rentable
    fetch(`/reportes/api/platillos-menos-rentables?fecha_inicio=${fecha_inicio}&fecha_fin=${fecha_fin}&limite=1`)
        .then(r => r.json())
        .then(data => {
            if (data.success && data.data.length > 0) {
                document.getElementById('kpi-peor').textContent = data.data[0].nombre;
            }
        });
}

function loadRendimientoEmpleados() {
    const fecha_inicio = document.getElementById('fecha_inicio').value;
    const fecha_fin = document.getElementById('fecha_fin').value;
    
    fetch(`/reportes/api/rendimiento-empleado?fecha_inicio=${fecha_inicio}&fecha_fin=${fecha_fin}`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                renderEmpleadosTable(data.data);
                renderEmpleadosChart(data.data);
            }
        });
}

function renderEmpleadosTable(data) {
    const tbody = document.querySelector('#empleados-table tbody');
    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">No hay datos de empleados</td></tr>';
        return;
    }
    
    tbody.innerHTML = data.map(d => `
        <tr>
            <td>${d.nombre_mesero || 'N/A'}</td>
            <td>${formatCurrency(d.total_ventas)}</td>
            <td>${d.num_pedidos}</td>
            <td>${formatCurrency(d.total_propinas)}</td>
            <td>${formatCurrency(d.promedio_venta)}</td>
        </tr>
    `).join('');
}

function renderEmpleadosChart(data) {
    const ctx = document.getElementById('empleadosChart').getContext('2d');
    
    if (window.empleadosChartInstance) {
        window.empleadosChartInstance.destroy();
    }
    
    window.empleadosChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.slice(0, 10).map(d => d.nombre_mesero || 'N/A'),
            datasets: [{
                label: 'Total Ventas',
                data: data.slice(0, 10).map(d => d.total_ventas),
                backgroundColor: 'rgba(75, 192, 192, 0.6)'
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

function loadPlatillosVendidos() {
    const fecha_inicio = document.getElementById('fecha_inicio').value;
    const fecha_fin = document.getElementById('fecha_fin').value;
    
    fetch(`/reportes/api/platillos-mas-vendidos?fecha_inicio=${fecha_inicio}&fecha_fin=${fecha_fin}&limite=15`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                renderPlatillosVendidosTable(data.data);
                renderPlatillosChart(data.data);
            }
        });
}

function renderPlatillosVendidosTable(data) {
    const tbody = document.querySelector('#platillos-vendidos-table tbody');
    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4">No hay datos</td></tr>';
        return;
    }
    
    tbody.innerHTML = data.map(d => `
        <tr>
            <td>${d.nombre}</td>
            <td>${d.categoria || 'N/A'}</td>
            <td>${d.cantidad_vendida}</td>
            <td>${formatCurrency(d.ventas_totales)}</td>
        </tr>
    `).join('');
}

function renderPlatillosChart(data) {
    const ctx = document.getElementById('platillosChart').getContext('2d');
    
    if (window.platillosChartInstance) {
        window.platillosChartInstance.destroy();
    }
    
    window.platillosChartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: data.slice(0, 8).map(d => d.nombre),
            datasets: [{
                data: data.slice(0, 8).map(d => d.cantidad_vendida),
                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF', '#7BC225']
            }]
        },
        options: {
            responsive: true
        }
    });
}

function loadPlatillosRentables() {
    const fecha_inicio = document.getElementById('fecha_inicio').value;
    const fecha_fin = document.getElementById('fecha_fin').value;
    
    fetch(`/reportes/api/platillos-menos-rentables?fecha_inicio=${fecha_inicio}&fecha_fin=${fecha_fin}&limite=15`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                renderPlatillosRentablesTable(data.data);
            }
        });
}

function renderPlatillosRentablesTable(data) {
    const tbody = document.querySelector('#platillos-rentables-table tbody');
    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">No hay datos</td></tr>';
        return;
    }
    
    tbody.innerHTML = data.map(d => `
        <tr>
            <td>${d.nombre}</td>
            <td>${formatCurrency(d.ventas_totales)}</td>
            <td>${formatCurrency(d.costo_total)}</td>
            <td class="${d.utilidad >= 0 ? 'positive' : 'negative'}">${formatCurrency(d.utilidad)}</td>
            <td class="${d.margen < 20 ? 'warning' : ''}">${d.margen.toFixed(2)}%</td>
        </tr>
    `).join('');
}

function loadTiempoServicio() {
    const fecha_inicio = document.getElementById('fecha_inicio').value;
    const fecha_fin = document.getElementById('fecha_fin').value;
    
    fetch(`/reportes/api/tiempo-servicio?fecha_inicio=${fecha_inicio}&fecha_fin=${fecha_fin}`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                renderTiempoTable(data.data);
            }
        });
}

function renderTiempoTable(data) {
    const tbody = document.querySelector('#tiempo-table tbody');
    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3">No hay datos de tiempo de servicio</td></tr>';
        return;
    }
    
    tbody.innerHTML = data.map(d => `
        <tr>
            <td>${d._id}</td>
            <td>${(d.tiempo_promedio_minutos || 0).toFixed(1)} min</td>
            <td>${d.pedidos_totales}</td>
        </tr>
    `).join('');
}

function exportReport(format, type) {
    const fecha_inicio = document.getElementById('fecha_inicio').value;
    const fecha_fin = document.getElementByName('fecha_fin').value;
    
    let url = `/reportes/exportar/${format}?reporte=${type}&fecha_inicio=${fecha_inicio}&fecha_fin=${fecha_fin}`;
    window.open(url, '_blank');
}

function formatCurrency(value) {
    return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(value || 0);
}
</script>

<style>
.reports-container { padding: 20px; max-width: 1400px; margin: 0 auto; }
.page-header { margin-bottom: 30px; }
.back-link { color: #3498db; text-decoration: none; font-size: 0.9em; }
.page-header h1 { color: #2c3e50; margin: 10px 0; }
.subtitle { color: #7f8c8d; }

.filter-section {
    background: #fff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.filter-form { display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap; }
.filter-group { display: flex; flex-direction: column; }
.filter-group label { font-weight: 600; margin-bottom: 5px; color: #34495e; }
.filter-group input { padding: 10px; border: 1px solid #ddd; border-radius: 5px; }

.export-group { display: flex; gap: 10px; align-items: center; margin-left: auto; }

.btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; transition: background 0.3s; }
.btn-primary { background: #3498db; color: white; }
.btn-sm { padding: 8px 15px; background: #ecf0f1; color: #34495e; }
.btn:hover { opacity: 0.9; }

.kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 30px;
}

.kpi-card {
    background: #fff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 15px;
}

.kpi-card.success { border-left: 4px solid #27ae60; }
.kpi-card.info { border-left: 4px solid #3498db; }
.kpi-card.warning { border-left: 4px solid #f39c12; }
.kpi-card.danger { border-left: 4px solid #e74c3c; }

.kpi-icon { font-size: 2em; }
.kpi-content { display: flex; flex-direction: column; }
.kpi-label { font-size: 0.85em; color: #7f8c8d; }
.kpi-value { font-size: 1.2em; font-weight: bold; color: #2c3e50; }

.charts-row {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    margin-bottom: 30px;
}

.chart-card {
    background: #fff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.chart-card h3 { color: #2c3e50; margin-bottom: 15px; }

.tables-section {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
}

.table-card {
    background: #fff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.table-card.full-width { grid-column: span 2; }
.table-card h3 { color: #2c3e50; margin-bottom: 15px; }

.table-container { overflow-x: auto; }

.data-table { width: 100%; border-collapse: collapse; }
.data-table th, .data-table td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
.data-table th { background: #f8f9fa; font-weight: 600; color: #34495e; }

.positive { color: #27ae60; font-weight: 600; }
.negative { color: #e74c3c; font-weight: 600; }
.warning { color: #f39c12; font-weight: 600; }
.loading { text-align: center; color: #7f8c8d; }

@media (max-width: 1024px) {
    .charts-row, .tables-section { grid-template-columns: 1fr; }
    .table-card.full-width { grid-column: span 1; }
}
</style>
{% endblock %}
