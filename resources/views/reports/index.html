{% extends "layout/layout_base.html" %}

{% block title %}Reportes - Restaurante Callejón 9{% endblock %}

{% block content %}
<div class="reports-container">
    <!-- Header -->
    <div class="reports-header">
        <h1><i class="bi bi-clipboard-data"></i> Centro de Reportes</h1>
        <p class="subtitle">Análisis completo de tu restaurante</p>
    </div>

    <!-- Date Filter -->
    <div class="filter-section">
        <form id="dateFilterForm" class="filter-form">
            <div class="filter-group">
                <label for="fecha_inicio">Fecha Inicio:</label>
                <input type="date" id="fecha_inicio" name="fecha_inicio">
            </div>
            <div class="filter-group">
                <label for="fecha_fin">Fecha Fin:</label>
                <input type="date" id="fecha_fin" name="fecha_fin">
            </div>
            <div class="filter-group">
                <label for="preset">Preset:</label>
                <select id="preset" name="preset">
                    <option value="7">Últimos 7 días</option>
                    <option value="30" selected>Últimos 30 días</option>
                    <option value="90">Últimos 90 días</option>
                    <option value="365">Último año</option>
                </select>
            </div>
            <button type="button" onclick="applyFilter()" class="btn btn-primary">Aplicar Filtro</button>
        </form>
    </div>

    <!-- Report Categories -->
    <div class="reports-grid">
        <!-- Financial Reports -->
        <div class="report-card financial">
            <div class="card-icon"><i class="bi bi-currency-dollar"></i></div>
            <h3>Reportes Financieros</h3>
            <p>Análisis de ventas, ganancias y flujo de caja</p>
            <ul class="report-list">
                <li><a href="{{ url_for('reports.financieros') }}"><i class="bi bi-bar-chart-line"></i> Ventas por Período</a></li>
                <li><a href="{{ url_for('reports.financieros') }}"><i class="bi bi-graph-up-arrow"></i> Utilidad Bruta</a></li>
                <li><a href="{{ url_for('reports.financieros') }}"><i class="bi bi-pie-chart"></i> Margen por Producto</a></li>
                <li><a href="{{ url_for('reports.financieros') }}"><i class="bi bi-wallet2"></i> Ingresos vs Gastos</a></li>
                <li><a href="{{ url_for('reports.financieros') }}"><i class="bi bi-water"></i> Flujo de Caja</a></li>
            </ul>
        </div>

        <!-- Inventory Reports -->
        <div class="report-card inventory">
            <div class="card-icon"><i class="bi bi-box-seam"></i></div>
            <h3>Reportes de Inventario</h3>
            <p>Control de stock, mermas y rotación</p>
            <ul class="report-list">
                <li><a href="{{ url_for('reports.inventario') }}"><i class="bi bi-graph-down"></i> Consumo por Período</a></li>
                <li><a href="{{ url_for('reports.inventario') }}"><i class="bi bi-trash3"></i> Merma Acumulada</a></li>
                <li><a href="{{ url_for('reports.inventario') }}"><i class="bi bi-arrow-repeat"></i> Rotación de Inventario</a></li>
                <li><a href="{{ url_for('reports.inventario') }}"><i class="bi bi-currency-exchange"></i> Insumos Más Costosos</a></li>
            </ul>
        </div>

        <!-- Operational Reports -->
        <div class="report-card operational">
            <div class="card-icon"><i class="bi bi-gear"></i></div>
            <h3>Reportes Operativos</h3>
            <p>Rendimiento de empleados y platillos</p>
            <ul class="report-list">
                <li><a href="{{ url_for('reports.operativos') }}"><i class="bi bi-person-badge"></i> Rendimiento por Empleado</a></li>
                <li><a href="{{ url_for('reports.operativos') }}"><i class="bi bi-clock"></i> Tiempo Promedio de Servicio</a></li>
                <li><a href="{{ url_for('reports.operativos') }}"><i class="bi bi-fire"></i> Platillos Más Vendidos</a></li>
                <li><a href="{{ url_for('reports.operativos') }}"><i class="bi bi-arrow-down-circle"></i> Platillos Menos Rentables</a></li>
            </ul>
        </div>

        <!-- Executive Summary -->
        <div class="report-card summary">
            <div class="card-icon"><i class="bi bi-file-earmark-text"></i></div>
            <h3>Resumen Ejecutivo</h3>
            <p>Vista general de todas las métricas</p>
            <a href="{{ url_for('reports.resumen_ejecutivo') }}" class="btn btn-summary"><i class="bi bi-eye"></i> Ver Resumen</a>
        </div>
    </div>

    <!-- Quick Charts Section -->
    <div class="charts-section">
        <h2><i class="bi bi-bar-chart-line"></i> Vista Rápida</h2>
        <div class="charts-grid">
            <div class="chart-container">
                <h3>Ventas por Mes</h3>
                <canvas id="salesBarChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Métodos de Pago</h3>
                <canvas id="paymentPieChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Tendencia de Ingresos</h3>
                <canvas id="trendLineChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Export Section -->
    <div class="export-section">
        <h2><i class="bi bi-download"></i> Exportar Reportes</h2>
        <div class="export-buttons">
            <button onclick="exportReport('csv', 'ventas')" class="btn btn-export">
                <span class="icon"><i class="bi bi-filetype-csv"></i></span> Exportar CSV
            </button>
            <button onclick="exportReport('excel', 'ventas')" class="btn btn-export">
                <span class="icon"><i class="bi bi-filetype-xls"></i></span> Exportar Excel
            </button>
            <button onclick="exportReport('pdf', 'ventas')" class="btn btn-export">
                <span class="icon"><i class="bi bi-filetype-pdf"></i></span> Exportar PDF
            </button>
        </div>
    </div>
</div>

<script>
// Initialize dates
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const thirtyDaysAgo = new Date(today);
    thirtyDaysAgo.setDate(today.getDate() - 30);
    
    document.getElementById('fecha_inicio').value = thirtyDaysAgo.toISOString().split('T')[0];
    document.getElementById('fecha_fin').value = today.toISOString().split('T')[0];
    
    loadCharts();
});

function applyFilter() {
    loadCharts();
    showNotification('Filtro aplicado correctamente', 'success');
}

function loadCharts() {
    const fecha_inicio = document.getElementById('fecha_inicio').value;
    const fecha_fin = document.getElementById('fecha_fin').value;
    
    // Sales Bar Chart
    fetch(`/reportes/api/grafico-ventas-mensual?fecha_inicio=${fecha_inicio}&fecha_fin=${fecha_fin}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderBarChart('salesBarChart', data.data);
            }
        });
    
    // Payment Pie Chart
    fetch(`/reportes/api/grafico-metodos-pago?fecha_inicio=${fecha_inicio}&fecha_fin=${fecha_fin}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderPieChart('paymentPieChart', data.data);
            }
        });
    
    // Trend Line Chart
    fetch(`/reportes/api/grafico-tendencia-ingresos?fecha_inicio=${fecha_inicio}&fecha_fin=${fecha_fin}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderLineChart('trendLineChart', data.data);
            }
        });
}

function renderBarChart(canvasId, data) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.map(d => d._id),
            datasets: [{
                label: 'Ventas Totales',
                data: data.map(d => d.total_ventas),
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

function renderPieChart(canvasId, data) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'];
    
    new Chart(ctx, {
        type: 'pie',
        data: {
            labels: data.map(d => d._id),
            datasets: [{
                data: data.map(d => d.total),
                backgroundColor: colors.slice(0, data.length)
            }]
        },
        options: {
            responsive: true
        }
    });
}

function renderLineChart(canvasId, data) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.map(d => d._id),
            datasets: [{
                label: 'Ingresos',
                data: data.map(d => d.total_ingresos),
                borderColor: 'rgba(75, 192, 192, 1)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

function exportReport(format, type) {
    const fecha_inicio = document.getElementById('fecha_inicio').value;
    const fecha_fin = document.getElementById('fecha_fin').value;
    
    let url = `/reportes/exportar/${format}?reporte=${type}&fecha_inicio=${fecha_inicio}&fecha_fin=${fecha_fin}`;
    
    window.open(url, '_blank');
    showNotification(`Exportando reporte en formato ${format.toUpperCase()}`, 'success');
}
</script>

<style>
.reports-container {
    padding: 20px;
    max-width: 1400px;
    margin: 0 auto;
}

.reports-header {
    text-align: center;
    margin-bottom: 30px;
}

.reports-header h1 {
    color: #2c3e50;
    margin-bottom: 5px;
}

.reports-header .subtitle {
    color: #7f8c8d;
    font-size: 1.1em;
}

.filter-section {
    background: #fff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.filter-form {
    display: flex;
    gap: 20px;
    align-items: flex-end;
    flex-wrap: wrap;
}

.filter-group {
    display: flex;
    flex-direction: column;
}

.filter-group label {
    font-weight: 600;
    margin-bottom: 5px;
    color: #34495e;
}

.filter-group input,
.filter-group select {
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 1em;
}

.reports-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
}

.report-card {
    background: #fff;
    border-radius: 10px;
    padding: 25px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
}

.report-card:hover {
    transform: translateY(-5px);
}

.report-card.financial { border-top: 4px solid #27ae60; }
.report-card.inventory { border-top: 4px solid #3498db; }
.report-card.operational { border-top: 4px solid #f39c12; }
.report-card.summary { border-top: 4px solid #9b59b6; }

.card-icon {
    font-size: 2.5em;
    margin-bottom: 10px;
}

.report-card h3 {
    color: #2c3e50;
    margin-bottom: 10px;
}

.report-card p {
    color: #7f8c8d;
    margin-bottom: 15px;
}

.report-list {
    list-style: none;
    padding: 0;
}

.report-list li {
    padding: 8px 0;
    border-bottom: 1px solid #eee;
}

.report-list li:last-child {
    border-bottom: none;
}

.report-list a {
    color: #3498db;
    text-decoration: none;
}

.report-list a:hover {
    color: #2980b9;
}

.btn-summary {
    display: block;
    text-align: center;
    background: #9b59b6;
    color: white;
    padding: 10px 20px;
    border-radius: 5px;
    text-decoration: none;
    margin-top: 15px;
}

.btn-summary:hover {
    background: #8e44ad;
}

.charts-section {
    background: #fff;
    padding: 25px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.charts-section h2 {
    color: #2c3e50;
    margin-bottom: 20px;
}

.charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 20px;
}

.chart-container {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
}

.chart-container h3 {
    color: #34495e;
    margin-bottom: 15px;
    text-align: center;
}

.export-section {
    background: #fff;
    padding: 25px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.export-section h2 {
    color: #2c3e50;
    margin-bottom: 20px;
}

.export-buttons {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
}

.btn-export {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1em;
    transition: background 0.3s;
}

.btn-export .icon {
    font-size: 1.2em;
}

.btn-export:nth-child(1) { background: #27ae60; color: white; }
.btn-export:nth-child(2) { background: #3498db; color: white; }
.btn-export:nth-child(3) { background: #e74c3c; color: white; }

.btn-export:hover {
    opacity: 0.9;
}

.btn-primary {
    background: #3498db;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

@media (max-width: 768px) {
    .filter-form {
        flex-direction: column;
        align-items: stretch;
    }
    
    .charts-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}
