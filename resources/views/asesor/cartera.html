{% extends 'layout/layout_asesor.html' %}
{% block title %}Cartera del Asesor{% endblock %}

{% block content %}
<!-- Estadísticas Rápidas -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="stat-card bg-white shadow-xl rounded-2xl p-6 border border-gray-100 animate-fade-up" style="animation-delay: 0.1s">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500 uppercase tracking-wide">Total</p>
                        <p class="text-3xl font-bold text-blue-600" id="totalCreditos">0</p>
                    </div>
                    <div class="p-4 bg-blue-100 rounded-full">
                        <i class="bi bi-wallet2 text-blue-600 text-2xl"></i>
                    </div>
                </div>
            </div>

            <div class="stat-card bg-white shadow-xl rounded-2xl p-6 border border-gray-100 animate-fade-up" style="animation-delay: 0.2s">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500 uppercase tracking-wide">Activos</p>
                        <p class="text-3xl font-bold text-green-600" id="activosCount">0</p>
                    </div>
                    <div class="p-4 bg-green-100 rounded-full">
                        <i class="bi bi-check-circle text-green-600 text-2xl"></i>
                    </div>
                </div>
            </div>

            <div class="stat-card bg-white shadow-xl rounded-2xl p-6 border border-gray-100 animate-fade-up" style="animation-delay: 0.3s">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500 uppercase tracking-wide">En Mora</p>
                        <p class="text-3xl font-bold text-red-600" id="morososCount">0</p>
                    </div>
                    <div class="p-4 bg-red-100 rounded-full">
                        <i class="bi bi-exclamation-triangle text-red-600 text-2xl"></i>
                    </div>
                </div>
            </div>

            <div class="stat-card bg-white shadow-xl rounded-2xl p-6 border border-gray-100 animate-fade-up" style="animation-delay: 0.4s">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500 uppercase tracking-wide">Pendientes</p>
                        <p class="text-3xl font-bold text-yellow-600" id="pendientesCount">0</p>
                    </div>
                    <div class="p-4 bg-yellow-100 rounded-full">
                        <i class="bi bi-clock text-yellow-600 text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Barra de búsqueda y filtros -->
        <div class="bg-white shadow-lg rounded-2xl p-6 mb-8 animate-fade-up" style="animation-delay: 0.5s">
            <div class="flex flex-col md:flex-row gap-4">
                <!-- Búsqueda -->
                <div class="flex-1 search-box bg-gray-50 rounded-xl p-2">
                    <div class="flex items-center">
                        <i class="bi bi-search text-gray-400 ml-3"></i>
                        <input type="text" id="searchInput" placeholder="Buscar por nombre de cliente..." 
                               class="flex-1 bg-transparent px-4 py-2 outline-none text-gray-700">
                    </div>
                </div>

                <!-- Filtros -->
                <div class="flex gap-2 flex-wrap">
                    <button onclick="filtrarPor('todos')" class="filter-btn active px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl font-semibold shadow-md hover:shadow-lg transition-all">
                        <i class="bi bi-grid mr-2"></i> Todos
                    </button>
                    <button onclick="filtrarPor('activo')" class="filter-btn px-6 py-3 bg-green-100 text-green-700 rounded-xl font-semibold hover:bg-green-200 transition-all">
                        <i class="bi bi-check-circle mr-2"></i> Activos
                    </button>
                    <button onclick="filtrarPor('moroso')" class="filter-btn px-6 py-3 bg-red-100 text-red-700 rounded-xl font-semibold hover:bg-red-200 transition-all">
                        <i class="bi bi-exclamation-triangle mr-2"></i> Morosos
                    </button>
                    <button onclick="filtrarPor('pendiente')" class="filter-btn px-6 py-3 bg-yellow-100 text-yellow-700 rounded-xl font-semibold hover:bg-yellow-200 transition-all">
                        <i class="bi bi-clock mr-2"></i> Pendientes
                    </button>
                </div>
            </div>
        </div>

        <!-- Contenido principal - Tarjetas de créditos -->
        <div id="creditosContainer">
            {% if creditos %}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="creditosGrid">
                {% for c in creditos %}
                <div class="credit-card bg-white shadow-xl rounded-2xl border border-gray-100 p-6 hover:border-blue-300 transition" 
                     data-estado="{{ c.estado }}" 
                     data-nombre="{{ c.nombre_cliente | lower }}"
                     style="animation: fadeInUp 0.6s ease-out; animation-delay: {{ loop.index0 * 0.05 }}s; opacity: 0; animation-fill-mode: forwards;">
                    
                    <!-- Header de la tarjeta -->
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center shadow-lg">
                                <i class="bi bi-person-fill text-white text-xl"></i>
                            </div>
                            <div>
                                <p class="text-lg font-bold text-gray-800">
                                    {{ c.nombre_cliente or 'Cliente no disponible' }}
                                </p>
                                <p class="text-xs text-gray-500">ID: #{{ loop.index }}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Información del crédito -->
                    <div class="space-y-3 mb-4">
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <span class="text-sm text-gray-600 flex items-center">
                                <i class="bi bi-currency-dollar mr-2 text-green-600"></i>
                                Monto
                            </span>
                            <span class="font-bold text-gray-800">${{ c.monto | default('N/A') }}</span>
                        </div>

                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <span class="text-sm text-gray-600 flex items-center">
                                <i class="bi bi-activity mr-2 text-blue-600"></i>
                                Estado
                            </span>
                            <span class="px-3 py-1 text-xs font-bold rounded-full
                                {% if c.estado == 'activo' %} bg-green-100 text-green-800
                                {% elif c.estado == 'moroso' %} bg-red-100 text-red-800
                                {% elif c.estado == 'pendiente' %} bg-yellow-100 text-yellow-800
                                {% else %} bg-gray-100 text-gray-800 {% endif %}">
                                {{ c.estado | capitalize }}
                            </span>
                        </div>
                    </div>

                    <!-- Botón de acción -->
                    <button onclick="verDetalles('{{ c.nombre_cliente }}')" 
                            class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-semibold px-4 py-3 rounded-xl shadow-md hover:shadow-xl transition-all">
                        <i class="bi bi-eye mr-2"></i> Ver Detalles
                    </button>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="bg-white shadow-xl rounded-3xl border border-gray-100 p-16 text-center animate-fade-up">
                <div class="p-8 bg-gray-100 rounded-full w-32 h-32 mx-auto mb-6 flex items-center justify-center">
                    <i class="bi bi-wallet2 text-gray-400 text-6xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-800 mb-2">No hay créditos en tu cartera</h3>
                <p class="text-gray-500 mb-6">Comienza agregando créditos para gestionar tu cartera</p>
                <button class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-8 py-3 rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all">
                    <i class="bi bi-plus-circle mr-2"></i> Agregar Crédito
                </button>
            </div>
            {% endif %}
        </div>

        <!-- Mensaje cuando no hay resultados -->
        <div id="noResults" class="hidden bg-white shadow-xl rounded-3xl border border-gray-100 p-12 text-center animate-fade-up">
            <div class="p-6 bg-gray-100 rounded-full w-24 h-24 mx-auto mb-4 flex items-center justify-center">
                <i class="bi bi-search text-gray-400 text-4xl"></i>
            </div>
            <p class="text-xl text-gray-600 font-semibold">No se encontraron resultados</p>
            <p class="text-gray-500 mt-2">Intenta con otros términos de búsqueda</p>
        </div>

        <script>
        let filtroActual = 'todos';

        // Contar créditos por estado
        function contarCreditos() {
            const tarjetas = document.querySelectorAll('.credit-card');
            let total = tarjetas.length;
            let activos = 0;
            let morosos = 0;
            let pendientes = 0;

            tarjetas.forEach(tarjeta => {
                const estado = tarjeta.dataset.estado;
                if (estado === 'activo') activos++;
                else if (estado === 'moroso') morosos++;
                else if (estado === 'pendiente') pendientes++;
            });

            animateCounter(document.getElementById('totalCreditos'), total);
            animateCounter(document.getElementById('activosCount'), activos);
            animateCounter(document.getElementById('morososCount'), morosos);
            animateCounter(document.getElementById('pendientesCount'), pendientes);
        }

        // Animación de contador
        function animateCounter(element, target) {
            const duration = 1000;
            const start = 0;
            const increment = target / (duration / 16);
            let current = start;

            const timer = setInterval(() => {
                current += increment;
                if (current >= target) {
                    element.textContent = target;
                    clearInterval(timer);
                } else {
                    element.textContent = Math.floor(current);
                }
            }, 16);
        }

        // Filtrar por estado
        function filtrarPor(estado) {
            filtroActual = estado;
            
            // Actualizar botones activos
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active', 'from-blue-600', 'to-purple-600', 'text-white');
                btn.classList.add('bg-gray-100', 'text-gray-700');
            });
            
            event.target.classList.add('active', 'from-blue-600', 'to-purple-600', 'text-white');
            event.target.classList.remove('bg-gray-100', 'text-gray-700', 'bg-green-100', 'bg-red-100', 'bg-yellow-100');

            aplicarFiltros();
        }

        // Búsqueda en tiempo real
        document.getElementById('searchInput')?.addEventListener('input', function(e) {
            aplicarFiltros();
        });

        // Aplicar filtros combinados
        function aplicarFiltros() {
            const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
            const tarjetas = document.querySelectorAll('.credit-card');
            let visibles = 0;

            tarjetas.forEach(tarjeta => {
                const estado = tarjeta.dataset.estado;
                const nombre = tarjeta.dataset.nombre;
                
                const cumpleFiltroEstado = filtroActual === 'todos' || estado === filtroActual;
                const cumpleBusqueda = nombre.includes(searchTerm);

                if (cumpleFiltroEstado && cumpleBusqueda) {
                    tarjeta.style.display = 'block';
                    visibles++;
                } else {
                    tarjeta.style.display = 'none';
                }
            });

            // Mostrar mensaje si no hay resultados
            const noResults = document.getElementById('noResults');
            const creditosGrid = document.getElementById('creditosGrid');
            
            if (visibles === 0) {
                if (creditosGrid) creditosGrid.style.display = 'none';
                if (noResults) noResults.classList.remove('hidden');
            } else {
                if (creditosGrid) creditosGrid.style.display = 'grid';
                if (noResults) noResults.classList.add('hidden');
            }
        }

        // Ver detalles del crédito
        function verDetalles(nombreCliente) {
            showNotification(`Abriendo detalles de ${nombreCliente}`, 'info');
            // Aquí iría la lógica para mostrar el modal o redirigir
        }

        // Mostrar notificación
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-4 rounded-xl shadow-2xl text-white font-semibold animate-fade-up z-50 ${
                type === 'success' ? 'bg-gradient-to-r from-green-500 to-emerald-500' : 
                type === 'info' ? 'bg-gradient-to-r from-blue-500 to-cyan-500' : 
                'bg-gradient-to-r from-red-500 to-pink-500'
            }`;
            notification.innerHTML = `<i class="bi bi-check-circle mr-2"></i>${message}`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Inicializar al cargar
        window.addEventListener('load', () => {
            contarCreditos();
            
            // Animar tarjetas en secuencia
            const tarjetas = document.querySelectorAll('.credit-card');
            tarjetas.forEach((tarjeta, index) => {
                setTimeout(() => {
                    tarjeta.style.opacity = '1';
                }, index * 50);
            });

            // Efecto de estadísticas al hacer hover
            document.querySelectorAll('.stat-card').forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-8px) scale(1.02)';
                });
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0) scale(1)';
                });
            });
        });

        // Formato de moneda
        document.querySelectorAll('[class*="monto"]').forEach(el => {
            const valor = el.textContent.replace('$', '').trim();
            if (!isNaN(valor) && valor !== 'N/A') {
                el.textContent = '$' + parseFloat(valor).toLocaleString('es-MX', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            }
        });
    </script>
{% endblock %}
