{% extends 'layout/layout_asesor.html' %}
{% block title %}Expediente - {{ cliente.cliente_nombre }} {{ cliente.cliente_apellidos }}{% endblock %}

{% block content %}

<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">

<style>
    .fade-up { animation: fadeUp 0.5s ease-out forwards; opacity: 0; transform: translateY(15px); }
    @keyframes fadeUp { to { opacity: 1; transform: translateY(0); } }
    .modal-overlay { background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px); }
    
    /* Personalización DataTables */
    .dataTables_wrapper .dataTables_length select { padding-right: 30px; border-radius: 0.5rem; border: 1px solid #e2e8f0; }
    .dataTables_wrapper .dataTables_filter input { border-radius: 0.5rem; border: 1px solid #e2e8f0; padding: 5px 10px; margin-left: 10px; }
    table.dataTable.no-footer { border-bottom: 1px solid #e2e8f0; }
    table.dataTable thead th { background-color: #f8fafc; color: #64748b; font-weight: 700; text-transform: uppercase; font-size: 0.75rem; border-bottom: 1px solid #e2e8f0; }
</style>

<div class="max-w-7xl mx-auto p-6">

    <div class="flex flex-col md:flex-row justify-between items-center mb-8 fade-up">
        <div class="mb-4 md:mb-0">
            <a href="{{ url_for('routes.dashboard_asesor_ver_cliente', id_cliente=cliente._id) }}" 
               class="inline-flex items-center gap-2 text-sm font-medium text-gray-500 hover:text-indigo-600 transition mb-2">
                <i class="ri-arrow-left-line"></i> Volver al perfil
            </a>
            <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                <i class="ri-folder-shield-2-line text-indigo-600"></i> Expediente Digital
            </h1>
            <p class="text-sm text-gray-500 mt-1">Gestión documental de {{ cliente.cliente_nombre }} {{ cliente.cliente_apellidos }}</p>
        </div>

        {% if docs_fisica or docs_moral %}
        <button onclick="aprobarCliente('{{ cliente._id }}')" 
                class="px-5 py-2.5 bg-emerald-600 hover:bg-emerald-700 text-white font-medium rounded-xl shadow-lg shadow-emerald-200 transition flex items-center gap-2 transform hover:-translate-y-0.5">
            <i class="ri-checkbox-circle-line text-lg"></i> Validar Todo
        </button>
        {% endif %}
    </div>

    {% if not docs_fisica and not docs_moral %}
        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-16 text-center fade-up">
            <div class="w-24 h-24 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="ri-folder-unknow-line text-gray-300 text-5xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Expediente Vacío</h3>
            <p class="text-gray-500">El cliente aún no ha subido documentación.</p>
        </div>
    {% else %}
        
        <div class="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden p-4 fade-up" style="animation-delay: 0.1s;">
            <table id="tablaDocumentos" class="w-full text-left border-collapse display responsive nowrap" style="width:100%">
                <thead>
                    <tr class="text-gray-500">
                        <th class="py-4 px-4">Categoría</th>
                        <th class="py-4 px-4">Tipo Documento</th>
                        <th class="py-4 px-4">Detalle Archivo</th> <th class="py-4 px-4">Fecha Carga</th>
                        <th class="py-4 px-4 text-center">Estado IA</th>
                        <th class="py-4 px-4 text-right">Acciones</th>
                    </tr>
                </thead>
                <tbody class="text-sm text-gray-700">

                    {% if docs_fisica %}
                        {% for key, value in docs_fisica.items() %}
                            {% if key not in ['_id', 'cliente_id', 'analisis_financiero', 'datos_fiscales', 'fecha_analisis_sat'] and value %}
                                
                                {# --- CASO 1: LISTA (Estados de Cuenta) --- #}
                                {% if value is iterable and value is not string and value is not mapping %}
                                    {% for doc in value %}
                                        {% set nombre_doc = key.replace('_', ' ') ~ " (" ~ loop.index ~ ")" %}
                                        {% set ruta = doc.ruta.replace('static/', '') %}
                                        {% set enlace = url_for('static', filename=ruta) %}
                                        {% set analisis = docs_fisica.get('analisis_financiero') %}
                                        {% set nombre_interno = doc.ruta.split('/')[-1] %} <tr class="hover:bg-gray-50">
                                            <td class="px-4"><span class="text-xs font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded">P. FÍSICA</span></td>
                                            <td class="px-4">
                                                <div class="flex items-center gap-3">
                                                    <i class="ri-bank-card-line text-xl text-indigo-500"></i>
                                                    <p class="font-semibold text-gray-800 capitalize">{{ nombre_doc }}</p>
                                                </div>
                                            </td>
                                            
                                            <td class="px-4">
                                                <div class="flex flex-col">
                                                    <span class="text-gray-700 font-bold text-xs truncate max-w-[250px]" title="Original: {{ doc.nombre_original }}">
                                                        {{ doc.nombre_original }}
                                                    </span>
                                                    <span class="text-gray-400 font-mono text-[10px] truncate max-w-[250px] flex items-center gap-1" title="Almacenado: {{ nombre_interno }}">
                                                        <i class="ri-hard-drive-2-line text-[9px]"></i> {{ nombre_interno }}
                                                    </span>
                                                </div>
                                            </td>

                                            <td class="px-4 text-gray-600">{{ doc.fecha_subida.strftime('%d/%m/%Y') if doc.fecha_subida else '-' }}</td>
                                            <td class="px-4 text-center">
                                                {% if analisis %}
                                                    <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700"><i class="ri-check-double-line"></i> Procesado</span>
                                                {% else %}
                                                    <span class="text-xs text-gray-400">Pendiente</span>
                                                {% endif %}
                                            </td>
                                            <td class="px-4 text-right">
                                                <button onclick="openPdfModal('{{ enlace }}')" class="text-indigo-600 hover:bg-indigo-50 p-2 rounded"><i class="ri-eye-line"></i></button>
                                                <a href="{{ enlace }}" download class="text-gray-500 hover:bg-gray-50 p-2 rounded"><i class="ri-download-line"></i></a>
                                            </td>
                                        </tr>
                                    {% endfor %}

                                {# --- CASO 2: DOCUMENTO ÚNICO (INE, SAT, Domicilio) --- #}
                                {% elif value is mapping and value.ruta %}
                                    {% set ruta = value.ruta.replace('static/', '') %}
                                    {% set enlace = url_for('static', filename=ruta) %}
                                    {% set nombre_interno = value.ruta.split('/')[-1] %}
                                    
                                    {# Lógica de Análisis #}
                                    {% set analisis = value.get('analisis') or value.get('analisis_ine') %}
                                    {% if 'situacion_fiscal' in key or 'sat' in key %}
                                        {% set analisis = docs_fisica.get('datos_fiscales') %}
                                    {% endif %}
                                    
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-4"><span class="text-xs font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded">P. FÍSICA</span></td>
                                        <td class="px-4">
                                            <div class="flex items-center gap-3">
                                                <i class="ri-file-user-line text-xl text-red-500"></i>
                                                <p class="font-semibold text-gray-800 capitalize">{{ key.replace('_', ' ') }}</p>
                                            </div>
                                        </td>
                                        
                                        <td class="px-4">
                                            <div class="flex flex-col">
                                                <span class="text-gray-700 font-bold text-xs truncate max-w-[250px]" title="Original: {{ value.nombre_original }}">
                                                    {{ value.nombre_original }}
                                                </span>
                                                <span class="text-gray-400 font-mono text-[10px] truncate max-w-[250px] flex items-center gap-1" title="Almacenado: {{ nombre_interno }}">
                                                    <i class="ri-hard-drive-2-line text-[9px]"></i> {{ nombre_interno }}
                                                </span>
                                            </div>
                                        </td>

                                        <td class="px-4 text-gray-600">{{ value.fecha_subida.strftime('%d/%m/%Y') if value.fecha_subida else '-' }}</td>
                                        
                                        <td class="px-4 text-center">
                                            {% if analisis %}
                                                {% if analisis.get('vigente') == 'Vigente' or analisis.get('es_vigente') == true %}
                                                    <span class="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700">
                                                        <i class="ri-checkbox-circle-fill"></i> Vigente
                                                    </span>
                                                {% elif analisis.get('vigente') == 'No Vigente' or analisis.get('es_vigente') == false %}
                                                    <span class="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-700">
                                                        <i class="ri-error-warning-fill"></i> No Vigente
                                                    </span>
                                                {% else %}
                                                    <span class="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700">
                                                        <i class="ri-ai-generate"></i> Analizado
                                                    </span>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-xs text-gray-400">--</span>
                                            {% endif %}
                                        </td>

                                        <td class="px-4 text-right">
                                            <button onclick="openPdfModal('{{ enlace }}')" class="text-indigo-600 hover:bg-indigo-50 p-2 rounded"><i class="ri-eye-line"></i></button>
                                            <a href="{{ enlace }}" download class="text-gray-500 hover:bg-gray-50 p-2 rounded"><i class="ri-download-line"></i></a>
                                        </td>
                                    </tr>
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    {% endif %}

                    {% if docs_moral %}
                        {% for key, value in docs_moral.items() %}
                            {% if key not in ['_id', 'cliente_id', 'analisis_financiero', 'datos_fiscales'] and value %}
                                
                                {% if value is mapping and value.ruta %}
                                    {% set ruta = value.ruta.replace('static/', '') %}
                                    {% set enlace = url_for('static', filename=ruta) %}
                                    {% set nombre_interno = value.ruta.split('/')[-1] %}
                                    {% set analisis = value.get('analisis') %}
                                    {% if 'situacion_fiscal' in key or 'sat' in key %}
                                        {% set analisis = docs_moral.get('datos_fiscales') %}
                                    {% endif %}

                                    <tr class="hover:bg-gray-50">
                                        <td class="px-4"><span class="text-xs font-bold text-purple-600 bg-purple-50 px-2 py-1 rounded">P. MORAL</span></td>
                                        <td class="px-4">
                                            <div class="flex items-center gap-3">
                                                <i class="ri-building-line text-xl text-purple-500"></i>
                                                <p class="font-semibold text-gray-800 capitalize">{{ key.replace('_', ' ') }}</p>
                                            </div>
                                        </td>
                                        
                                        <td class="px-4">
                                            <div class="flex flex-col">
                                                <span class="text-gray-700 font-bold text-xs truncate max-w-[250px]">{{ value.nombre_original }}</span>
                                                <span class="text-gray-400 font-mono text-[10px] truncate max-w-[250px] flex items-center gap-1">
                                                    <i class="ri-hard-drive-2-line text-[9px]"></i> {{ nombre_interno }}
                                                </span>
                                            </div>
                                        </td>

                                        <td class="px-4 text-gray-600">{{ value.fecha_subida.strftime('%d/%m/%Y') if value.fecha_subida else '-' }}</td>
                                        
                                        <td class="px-4 text-center">
                                            {% if analisis and analisis.get('vigente') == 'Vigente' %}
                                                <span class="bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded-full text-xs font-bold">Vigente</span>
                                            {% elif analisis and analisis.get('vigente') == 'No Vigente' %}
                                                <span class="bg-red-100 text-red-700 px-2 py-0.5 rounded-full text-xs font-bold">Vencido</span>
                                            {% else %}
                                                <span class="text-xs text-gray-400">Manual</span>
                                            {% endif %}
                                        </td>

                                        <td class="px-4 text-right">
                                            <button onclick="openPdfModal('{{ enlace }}')" class="text-purple-600 hover:bg-purple-50 p-2 rounded"><i class="ri-eye-line"></i></button>
                                            <a href="{{ enlace }}" download class="text-gray-500 hover:bg-gray-50 p-2 rounded"><i class="ri-download-line"></i></a>
                                        </td>
                                    </tr>
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    {% endif %}

                </tbody>
            </table>
        </div>
    {% endif %}

</div>

<div id="pdfModal" class="fixed inset-0 modal-overlay hidden z-[60] flex flex-col transition-opacity duration-300 opacity-0">
    <div class="w-full bg-gray-900 text-white px-6 py-3 flex justify-between items-center shadow-2xl z-50 border-b border-gray-700">
        <h4 class="text-sm font-medium text-gray-300 flex items-center gap-2"><i class="ri-file-text-line text-indigo-400"></i> Visualizador</h4>
        <button onclick="closePdfModal()" class="text-gray-400 hover:text-white hover:bg-gray-800 p-2 rounded-lg transition"><i class="ri-close-line text-2xl"></i></button>
    </div>
    <div class="flex-1 w-full h-full flex justify-center items-center p-4 sm:p-8" onclick="closePdfModal()">
        <iframe id="pdfViewer" src="" class="w-full h-full max-w-6xl bg-white rounded-lg shadow-2xl border-0" onclick="event.stopPropagation()"></iframe>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    $(document).ready(function() {
        $('#tablaDocumentos').DataTable({
            responsive: true,
            pageLength: 10,
            language: {
                "sProcessing": "Procesando...",
                "sLengthMenu": "Mostrar _MENU_ documentos",
                "sZeroRecords": "No se encontraron documentos",
                "sEmptyTable": "Ningún documento disponible",
                "sInfo": "Mostrando _START_ a _END_ de _TOTAL_ documentos",
                "sInfoEmpty": "Mostrando 0 a 0 de 0 documentos",
                "sInfoFiltered": "(filtrado de _MAX_ total)",
                "sSearch": "Buscar:",
                "oPaginate": { "sFirst": "Primero", "sLast": "Último", "sNext": "Siguiente", "sPrevious": "Anterior" }
            },
            order: [[0, 'asc'], [1, 'asc']]
        });
    });

    const modal = document.getElementById("pdfModal");
    const viewer = document.getElementById("pdfViewer");

    function openPdfModal(pdfUrl) {
        if(!pdfUrl || pdfUrl === '#') { Swal.fire('Error', 'Archivo no disponible.', 'error'); return; }
        viewer.src = pdfUrl;
        modal.classList.remove("hidden");
        setTimeout(() => modal.classList.remove("opacity-0"), 10);
        document.body.style.overflow = 'hidden'; 
    }

    function closePdfModal() {
        modal.classList.add("opacity-0");
        setTimeout(() => {
            modal.classList.add("hidden");
            viewer.src = "";
            document.body.style.overflow = 'auto'; 
        }, 300);
    }

    function aprobarCliente(clienteId) {
        Swal.fire({
            title: '¿Validar expediente?',
            text: "Se marcarán los documentos como revisados.",
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#10b981',
            confirmButtonText: 'Sí, validar'
        }).then((result) => {
            if (result.isConfirmed) Swal.fire('Validado', '', 'success');
        });
    }

    document.addEventListener('keydown', (e) => { if (e.key === "Escape") closePdfModal(); });
</script>

{% endblock %}