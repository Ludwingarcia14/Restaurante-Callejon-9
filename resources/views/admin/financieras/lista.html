{% extends "layout/layout.html" %}
{% block title %}Listado de Financieras{% endblock %}

{% block content %}

<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

<style>
    /* Wrapper y Filtros */
    .dataTables_wrapper { padding: 0; width: 100%; }
    
    .dataTables_filter input {
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        outline: none;
        transition: all 0.2s;
        width: 250px;
    }
    .dataTables_filter input:focus {
        border-color: #4f46e5;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .dataTables_length select {
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        padding: 0.4rem 2rem 0.4rem 0.8rem;
        font-size: 0.875rem;
        background-color: white;
        cursor: pointer;
        margin-right: 0.5rem;
        background-position: right 0.5rem center;
    }

    /* Tabla */
    table.dataTable {
        width: 100% !important;
        border-collapse: collapse !important;
        margin-bottom: 0 !important;
    }
    table.dataTable thead th {
        background-color: #f8fafc;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        border-bottom: 1px solid #e2e8f0 !important;
        padding: 1rem 1.5rem !important;
        text-align: left;
    }
    table.dataTable tbody td {
        padding: 1rem 1.5rem !important;
        border-bottom: 1px solid #f1f5f9;
        color: #334155;
        font-size: 0.875rem;
        vertical-align: middle;
    }
    table.dataTable.no-footer { border-bottom: 1px solid #e2e8f0; }
    table.dataTable tbody tr:hover { background-color: #f8fafc; }

    /* Paginaci√≥n Bonita */
    .dataTables_paginate {
        display: flex;
        justify-content: flex-end;
        gap: 0.25rem;
        padding-top: 0;
    }
    .dataTables_paginate .paginate_button {
        padding: 0.375rem 0.75rem !important;
        border-radius: 0.375rem !important;
        border: 1px solid #e2e8f0 !important;
        background: white !important;
        color: #475569 !important;
        font-size: 0.875rem !important;
        cursor: pointer !important;
        transition: all 0.2s !important;
        margin-left: 0 !important;
        text-decoration: none !important;
    }
    .dataTables_paginate .paginate_button:hover:not(.disabled) {
        background: #f1f5f9 !important;
        color: #1e293b !important;
        border-color: #cbd5e1 !important;
    }
    .dataTables_paginate .paginate_button.current {
        background: #eff6ff !important;
        color: #4f46e5 !important;
        border-color: #e0e7ff !important;
        font-weight: 600 !important;
    }
    .dataTables_paginate .paginate_button.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .dataTables_info { color: #64748b; font-size: 0.875rem; padding-top: 0.5rem; }
    
    /* Checkbox Custom */
    .custom-checkbox {
        cursor: pointer;
        border-radius: 0.25rem;
        border: 1px solid #cbd5e1;
        width: 1rem; height: 1rem;
    }
</style>

<div class="max-w-7xl mx-auto p-6">

    <div class="bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden fade-up">
        
        <div class="p-6 border-b border-gray-100 bg-white flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                    <i class="ri-bank-line text-indigo-600"></i> Listado de Financieras
                </h1>
                <p class="text-sm text-gray-500 mt-1">Gesti√≥n de convenios y productos financieros activos.</p>
            </div>
            
            <div class="flex items-center gap-3">
                <button id="delete_selected" class="hidden px-4 py-2 bg-white border border-red-200 text-red-600 rounded-lg text-sm font-medium hover:bg-red-50 transition shadow-sm flex items-center gap-2">
                    <i class="ri-delete-bin-line"></i> Eliminar Selecci√≥n
                </button>

                <a href="/dashboard/financiera/create" class="px-5 py-2.5 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700 transition shadow-lg shadow-indigo-200 flex items-center gap-2">
                    <i class="ri-add-line"></i> Nueva Financiera
                </a>
            </div>
        </div>

        <div class="p-0">
            <table id="financieras_table" class="w-full text-left">
                <thead>
                    <tr>
                        <th class="w-10 text-center">
                            <input type="checkbox" id="select_all" class="custom-checkbox text-indigo-600 focus:ring-indigo-500">
                        </th>
                        <th>ID</th>
                        <th>Financiera</th>
                        <th>Contacto</th>
                        <th>Contrato</th>
                        <th>Producto</th>
                        <th class="text-right">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>

</div>

<div class="modal fade" id="viewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-2xl border-0 shadow-2xl overflow-hidden">
            <div class="modal-header bg-gray-50 border-b border-gray-100 p-6">
                <h5 class="modal-title text-lg font-bold text-gray-800 flex items-center gap-2">
                    <i class="ri-building-4-line text-indigo-500"></i> Detalles de Financiera
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-6" id="viewModalBody">
                </div>
            <div class="modal-footer bg-gray-50 border-t border-gray-100 p-4">
                <button type="button" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 font-medium text-sm transition" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <form id="editForm" class="modal-content rounded-2xl border-0 shadow-2xl overflow-hidden">
            <div class="modal-header bg-white border-b border-gray-100 p-6">
                <h5 class="modal-title text-lg font-bold text-gray-800">Editar Informaci√≥n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-6 space-y-4">
                <input type="hidden" id="edit_id">
                
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nombre Financiera</label>
                    <input type="text" id="edit_nombre" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-gray-900 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition">
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Correo de Contacto</label>
                    <input type="email" id="edit_correo" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-gray-900 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition">
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">N¬∞ Contrato</label>
                    <input type="text" id="edit_contrato" class="w-full rounded-lg border border-gray-300 bg-gray-50 text-gray-500 px-3 py-2 font-mono cursor-not-allowed" readonly>
                </div>
            </div>
            <div class="modal-footer bg-gray-50 border-t border-gray-100 p-4 flex gap-2">
                <button type="button" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium text-sm transition" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium text-sm shadow-md transition">Guardar Cambios</button>
            </div>
        </form>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
$(document).ready(function() {

    // Funci√≥n para acortar textos
    function truncate(str, length = 25) {
        if (!str) return '';
        return str.length > length ? str.substring(0, length) + '...' : str;
    }

    // Configuraci√≥n DataTable
    var table = $('#financieras_table').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: "/admin/financieras/data",
            dataSrc: json => json.data
        },
        language: {
            search: "", searchPlaceholder: "üîç Buscar...",
            lengthMenu: "Mostrar _MENU_",
            info: "Mostrando _START_ a _END_ de _TOTAL_",
            paginate: { first: "¬´", last: "¬ª", next: "‚Ä∫", previous: "‚Äπ" },
            emptyTable: "No hay financieras registradas"
        },
        // Layout Personalizado (Buscador arriba, Paginaci√≥n abajo)
        dom: '<"flex flex-col md:flex-row justify-between items-center p-5 border-b border-gray-100 gap-4"lf>rt<"flex flex-col md:flex-row justify-between items-center p-5 bg-gray-50 border-t border-gray-100 gap-4"ip>',
        columns: [
            { 
                data: "_id", 
                render: d => `<div class="text-center"><input type="checkbox" class="row_checkbox custom-checkbox" value="${d}"></div>`, 
                orderable: false, width: "5%" 
            },
            { 
                data: "_id", 
                render: d => `<span class="font-mono text-xs text-gray-400">#${d.slice(-6)}</span>`, 
                width: "10%" 
            },
            { 
                data: null, 
                render: row => `
                    <div class="flex items-center gap-3">
                        <div class="h-9 w-9 rounded-full bg-emerald-50 flex items-center justify-center text-emerald-600 font-bold border border-emerald-100 text-sm shadow-sm">
                            <i class="ri-bank-fill"></i>
                        </div>
                        <div class="font-medium text-gray-900 text-sm">${truncate(row.financiera_nombre, 10)}</div>
                    </div>
                `
            },
            { 
                data: "financiera_correo", 
                render: d => `<div class="text-xs text-gray-500 flex items-center gap-1"><i class="ri-mail-line text-gray-400"></i> ${truncate(d, 25)}</div>` 
            },
            { 
                data: "financiera_NContrato", 
                render: d => `<span class="bg-gray-100 text-gray-600 text-xs font-mono px-2 py-1 rounded border border-gray-200">${d}</span>` 
            },
            { 
                data: "financiera_ProductoOfrecido", 
                render: d => `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-50 text-blue-700 border border-blue-100">${truncate(d, 20)}</span>` 
            },
            { 
                data: "_id", 
                render: d => `
                    <div class="flex justify-end gap-2">
                        <button class="p-1.5 rounded-md text-gray-400 hover:text-blue-600 hover:bg-blue-50 transition view-btn" data-id="${d}" title="Ver">
                            <i class="ri-eye-line text-lg"></i>
                        </button>
                        <button class="p-1.5 rounded-md text-gray-400 hover:text-amber-600 hover:bg-amber-50 transition edit-btn" data-id="${d}" title="Editar">
                            <i class="ri-pencil-line text-lg"></i>
                        </button>
                        <button class="p-1.5 rounded-md text-gray-400 hover:text-red-600 hover:bg-red-50 transition delete-btn" data-id="${d}" title="Eliminar">
                            <i class="ri-delete-bin-line text-lg"></i>
                        </button>
                    </div>
                `, 
                orderable: false, className: "text-right" 
            }
        ],
        scrollX: true, pageLength: 10
    });

    // Checkboxes
    $('#select_all').click(function(){ $('.row_checkbox').prop('checked', this.checked).trigger('change'); });
    $(document).on('change', '.row_checkbox, #select_all', function() {
        let count = $('.row_checkbox:checked').length;
        if(count > 0) $('#delete_selected').removeClass('hidden').html(`<i class="ri-delete-bin-line"></i> Eliminar (${count})`);
        else $('#delete_selected').addClass('hidden');
    });

    // Eliminar selecci√≥n
    $('#delete_selected').click(() => {
        let ids = $('.row_checkbox:checked').map(function(){ return $(this).val(); }).get();
        Swal.fire({
            title: `¬øEliminar ${ids.length} financieras?`, text: "Esta acci√≥n no se puede deshacer.", icon: "warning",
            showCancelButton: true, confirmButtonColor: "#dc2626", confirmButtonText: "S√≠, eliminar", cancelButtonText: "Cancelar"
        }).then(result => {
            if (result.isConfirmed) {
                $.ajax({
                    url: `/admin/financieras/delete_batch`, method: 'POST', contentType: 'application/json',
                    data: JSON.stringify({ids: ids}),
                    success: () => {
                        table.ajax.reload();
                        $('#delete_selected').addClass('hidden'); $('#select_all').prop('checked', false);
                        Swal.fire({ icon: "success", title: "Eliminadas", showConfirmButton: false, timer: 1500 });
                    }
                });
            }
        });
    });

    // Ver Financiera (Modal)
    $('#financieras_table').on('click', '.view-btn', function(){
        let id = $(this).data('id');
        // Loader visual
        $('#viewModalBody').html('<div class="text-center py-8"><i class="ri-loader-4-line animate-spin text-3xl text-indigo-500"></i></div>');
        new bootstrap.Modal(document.getElementById('viewModal')).show();

        $.get(`/admin/financieras/view/${id}`, data => {
            let html = `
                <div class="flex items-start gap-4 mb-6">
                    <div class="h-16 w-16 rounded-2xl bg-emerald-50 text-emerald-600 flex items-center justify-center text-3xl border border-emerald-100 shadow-sm">
                        <i class="ri-bank-line"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-900">${data.financiera_nombre}</h3>
                        <div class="mt-1 flex items-center gap-2 text-sm text-gray-500">
                            <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Aliado:</span> 
                            ${data.financiera_nombreAliado || 'N/A'}
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                        <span class="block text-xs font-bold text-gray-400 uppercase mb-1">Producto</span>
                        <span class="font-medium text-indigo-600">${data.financiera_ProductoOfrecido}</span>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                        <span class="block text-xs font-bold text-gray-400 uppercase mb-1">Contrato</span>
                        <span class="font-mono text-gray-700">${data.financiera_NContrato}</span>
                    </div>
                    <div class="col-span-2 bg-gray-50 p-3 rounded-lg border border-gray-100">
                        <span class="block text-xs font-bold text-gray-400 uppercase mb-1">Correo Contacto</span>
                        <span class="text-gray-700 flex items-center gap-2"><i class="ri-mail-send-line"></i> ${data.financiera_correo}</span>
                    </div>
                </div>
            `;
            $('#viewModalBody').html(html);
        });
    });

    // Editar Financiera
    $('#financieras_table').on('click', '.edit-btn', function(){
        let id = $(this).data('id');
        $.get(`/admin/financieras/view/${id}`, data => {
            $('#edit_id').val(id);
            $('#edit_nombre').val(data.financiera_nombre);
            $('#edit_correo').val(data.financiera_correo);
            $('#edit_contrato').val(data.financiera_NContrato);
            new bootstrap.Modal(document.getElementById('editModal')).show();
        });
    });

    // Submit Editar
    $('#editForm').submit(function(e){
        e.preventDefault();
        let id = $('#edit_id').val();
        $.ajax({
            url: `/admin/financieras/edit/${id}`, method: 'POST', contentType: 'application/json',
            data: JSON.stringify({
                financiera_nombre: $('#edit_nombre').val(),
                financiera_correo: $('#edit_correo').val(),
                financiera_NContrato: $('#edit_contrato').val()
            }),
            success: () => {
                $('#editModal').modal('hide'); table.ajax.reload();
                Swal.fire({ icon: "success", title: "Actualizado", showConfirmButton: false, timer: 1500 });
            }
        });
    });

    // Eliminar Individual
    $('#financieras_table').on('click', '.delete-btn', function(){
        let id = $(this).data('id');
        Swal.fire({
            title: "¬øEliminar?", text: "No podr√°s revertir esto.", icon: "warning",
            showCancelButton: true, confirmButtonColor: "#dc2626", confirmButtonText: "Eliminar", cancelButtonText: "Cancelar"
        }).then(r => {
            if (r.isConfirmed) {
                $.post(`/admin/financieras/delete/${id}`, () => {
                    table.ajax.reload();
                    Swal.fire({ icon: "success", title: "Eliminado", showConfirmButton: false, timer: 1500 });
                });
            }
        });
    });

});
</script>
{% endblock %}