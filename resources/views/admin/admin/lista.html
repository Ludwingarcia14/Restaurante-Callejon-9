{% extends "layout/layout.html" %}
{% block title %}Listado Administraci贸n{% endblock %}

{% block content %}

<style>
    /* Wrapper de la tabla */
    .dataTables_wrapper { padding: 0; }
    
    /* Inputs de b煤squeda y select de longitud */
    .dataTables_filter input {
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        padding: 0.4rem 1rem;
        outline: none;
        font-size: 0.875rem;
        transition: all 0.2s;
    }
    .dataTables_filter input:focus {
        border-color: #4f46e5;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    .dataTables_length select {
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        padding: 0.3rem 2rem 0.3rem 0.8rem;
        font-size: 0.875rem;
        background-position: right 0.5rem center;
    }

    /* Encabezados de tabla */
    table.dataTable thead th {
        background-color: #f8fafc;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        border-bottom: 1px solid #e2e8f0 !important;
        padding: 1rem 1.5rem !important;
    }

    /* Celdas del cuerpo */
    table.dataTable tbody td {
        padding: 1rem 1.5rem !important;
        border-bottom: 1px solid #f1f5f9;
        vertical-align: middle;
        color: #334155;
        font-size: 0.875rem;
    }
    
    /* Fila hover */
    table.dataTable tbody tr:hover {
        background-color: #f8fafc;
    }

    /* Paginaci贸n */
    .dataTables_paginate .paginate_button {
        border-radius: 0.375rem !important;
        border: 1px solid transparent !important;
    }
    .dataTables_paginate .paginate_button.current {
        background: #eff6ff !important;
        color: #4f46e5 !important;
        border-color: #e0e7ff !important;
        font-weight: 600;
    }
    .dataTables_paginate .paginate_button:hover {
        background: #f1f5f9 !important;
        color: #1e293b !important;
        border-color: transparent !important;
    }
</style>

<div class="max-w-7xl mx-auto p-6">

    <div
        class="bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">

        <div
            class="p-6 border-b border-gray-100 bg-white flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1
                    class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                    <i class="bi bi-people-fill text-indigo-600"></i>
                    Administraci贸n de Usuarios
                </h1>
                <p class="text-sm text-gray-500 mt-1">Gestiona el acceso y los
                    roles del sistema.</p>
            </div>

            <div class="flex items-center gap-3">
                <button id="delete_selected"
                    class="hidden px-4 py-2 bg-white border border-red-200 text-red-600 rounded-lg text-sm font-medium hover:bg-red-50 transition shadow-sm flex items-center gap-2">
                    <i class="bi bi-trash3"></i> Eliminar Selecci贸n
                </button>

                <a href="/dashboard/admin/create"
                    class="px-5 py-2.5 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700 transition shadow-lg shadow-indigo-200 flex items-center gap-2">
                    <i class="bi bi-plus-lg"></i> Nuevo Usuario
                </a>
            </div>
        </div>

        <div class="p-0">
            <table id="usuarios_table" class="w-full text-left border-collapse"
                style="width:100%">
                <thead>
                    <tr>
                        <th class="w-10 text-center">
                            <input type="checkbox" id="select_all"
                                class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 h-4 w-4 cursor-pointer">
                        </th>
                        <th>ID</th>
                        <th>Usuario</th>
                        <th>Contacto</th>
                        <th>Rol</th>
                        <th>Estado</th>
                        <th class="text-right">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

</div>

<div class="modal fade" id="viewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div
            class="modal-content rounded-2xl border-0 shadow-2xl overflow-hidden">
            <div class="modal-header bg-gray-50 border-b border-gray-100 p-6">
                <h5
                    class="modal-title text-lg font-bold text-gray-800 flex items-center gap-2">
                    <i class="bi bi-person-vcard text-indigo-500"></i> Detalles
                    del Usuario
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                    aria-label="Cerrar"></button>
            </div>
            <div class="modal-body p-6" id="viewModalBody">
            </div>
            <div class="modal-footer bg-gray-50 border-t border-gray-100 p-4">
                <button type="button"
                    class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 font-medium text-sm"
                    data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <form id="editForm"
            class="modal-content rounded-2xl border-0 shadow-2xl overflow-hidden">
            <div class="modal-header bg-white border-b border-gray-100 p-6">
                <h5 class="modal-title text-lg font-bold text-gray-800">Editar
                    Informaci贸n</h5>
                <button type="button" class="btn-close"
                    data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-6 space-y-4">
                <input type="hidden" id="edit_id">

                <div>
                    <label
                        class="block text-xs font-bold text-gray-500 uppercase mb-1">Nombre</label>
                    <input type="text" id="edit_nombre"
                        class="w-full rounded-lg border border-gray-300 px-3 py-2 text-gray-900 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition">
                </div>

                <div>
                    <label
                        class="block text-xs font-bold text-gray-500 uppercase mb-1">Apellidos</label>
                    <input type="text" id="edit_apellidos"
                        class="w-full rounded-lg border border-gray-300 px-3 py-2 text-gray-900 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition">
                </div>
            </div>
            <div
                class="modal-footer bg-gray-50 border-t border-gray-100 p-4 flex gap-2">
                <button type="button"
                    class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium text-sm"
                    data-bs-dismiss="modal">Cancelar</button>
                <button type="submit"
                    class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium text-sm shadow-md">Guardar
                    Cambios</button>
            </div>
        </form>
    </div>
</div>

<link rel="stylesheet"
    href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script
    src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
<script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
$(document).ready(function () {

    // Funci贸n auxiliar para cortar textos largos
    function truncate(str, length = 25) {
        if (!str) return '';
        return str.length > length ? str.substring(0, length) + '...' : str;
    }

    // Mapa de Roles para mostrar Badges bonitos en el Modal/Tabla
    const rolMap = {
        1: '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 border border-purple-200">Super Admin</span>',
        2: '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 border border-blue-200">Admin</span>',
        3: '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 border border-yellow-200">Asesor</span>',
        4: '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 border border-green-200">Cliente</span>',
        5: '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-cyan-100 text-cyan-800 border border-cyan-200">Financiera</span>',
        6: '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 border border-gray-200">Soporte</span>'
    };

    // Configuraci贸n de DataTable
    var table = $('#usuarios_table').DataTable({
        processing: true,
        serverSide: true,
        ajax: "/dashboard/admin/data",
        // Personalizaci贸n de textos
        language: {
            search: "",
            searchPlaceholder: " Buscar...",
            lengthMenu: "Mostrar _MENU_",
            info: "Mostrando _START_ a _END_ de _TOTAL_ registros",
            paginate: { first: "芦", last: "禄", next: "Siguiente", previous: "Anterior" },
            zeroRecords: "No se encontraron resultados",
            emptyTable: "No hay datos disponibles"
        },
        // Definici贸n de columnas con HTML de Tailwind
        columns: [
            { 
                "data": "_id", 
                render: data => `<div class="text-center"><input type="checkbox" class="row_checkbox rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 h-4 w-4 cursor-pointer" value="${data}"></div>`, 
                orderable: false,
                width: "5%"
            },
            { 
                "data": "_id", 
                render: data => `<span class="font-mono text-xs text-gray-400">#${data.slice(-6)}</span>`,
                width: "10%"
            },
            { 
                "data": null, 
                render: row => `
                    <div class="flex items-center gap-3">
                        <div class="h-9 w-9 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-600 font-bold text-sm border border-indigo-100">
                            ${row.usuario_nombre ? row.usuario_nombre.charAt(0).toUpperCase() : 'U'}
                        </div>
                        <div>
                            <div class="font-medium text-gray-900 text-sm">${truncate((row.usuario_nombre || '') + " " + (row.usuario_apellidos || ''), 25)}</div>
                            <div class="text-xs text-gray-400">${truncate(row.usuario_email, 25)}</div>
                        </div>
                    </div>
                `
            },
            { 
                "data": "usuario_telefono", 
                render: d => `<div class="text-sm text-gray-600 flex items-center gap-1"><i class="bi bi-telephone text-gray-400"></i> ${d || '--'}</div>`
            },
            { 
                "data": "usuario_rol", 
                render: d => rolMap[d] || '<span class="text-xs text-gray-400">Desconocido</span>'
            },
            { 
                "data": "usuario_status", 
                render: d => d == 1 
                    ? '<span class="inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-50 text-emerald-700 border border-emerald-100"><span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span> Activo</span>'
                    : '<span class="inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-50 text-gray-600 border border-gray-200"><span class="w-1.5 h-1.5 rounded-full bg-gray-400"></span> Inactivo</span>'
            },
            { 
                "data": "_id", 
                render: d => `
                    <div class="flex justify-end gap-2">
                        <button class="p-1.5 rounded-md text-gray-400 hover:text-blue-600 hover:bg-blue-50 transition view-btn" data-id="${d}" title="Ver">
                            <i class="bi bi-eye-fill text-lg"></i>
                        </button>
                        <button class="p-1.5 rounded-md text-gray-400 hover:text-amber-600 hover:bg-amber-50 transition edit-btn" data-id="${d}" title="Editar">
                            <i class="bi bi-pencil-square text-lg"></i>
                        </button>
                        <button class="p-1.5 rounded-md text-gray-400 hover:text-red-600 hover:bg-red-50 transition delete-btn" data-id="${d}" title="Eliminar">
                            <i class="bi bi-trash3-fill text-lg"></i>
                        </button>
                    </div>
                `,
                orderable: false,
                className: "text-right"
            }
        ],
        scrollX: true,
        pageLength: 10,
        // DOM layout: Buscador arriba a la derecha, info abajo
        dom: '<"flex flex-col md:flex-row justify-between items-center p-5 gap-4"lf>rt<"flex flex-col md:flex-row justify-between items-center p-5 border-t border-gray-100 gap-4"ip>'
    });

    // --- L贸gica de Checkboxes ---
    $('#select_all').on('click', function () {
        $('.row_checkbox').prop('checked', this.checked).trigger('change');
    });

    $(document).on('change', '.row_checkbox, #select_all', function() {
        let count = $('.row_checkbox:checked').length;
        if (count > 0) {
            $('#delete_selected').removeClass('hidden').html(`<i class="bi bi-trash3 me-1"></i> Eliminar (${count})`);
        } else {
            $('#delete_selected').addClass('hidden');
        }
    });

    // --- Eliminar Seleccionados ---
    $('#delete_selected').on('click', function () {
        let ids = $('.row_checkbox:checked').map(function () { return $(this).val(); }).get();
        
        Swal.fire({
            title: `驴Eliminar ${ids.length} usuarios?`,
            text: "Esta acci贸n no se puede deshacer.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#dc2626",
            confirmButtonText: "S铆, eliminar",
            cancelButtonText: "Cancelar"
        }).then(result => {
            if (result.isConfirmed) {
                $.ajax({
                    url: `/admin/usuarios/delete_batch`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ ids }),
                    success: function () {
                        table.ajax.reload();
                        $('#delete_selected').addClass('hidden');
                        $('#select_all').prop('checked', false);
                        Swal.fire({ icon: "success", title: "Eliminados", text: "Usuarios eliminados correctamente.", timer: 1500, showConfirmButton: false });
                    }
                });
            }
        });
    });

    // --- Ver Usuario (Modal) ---
    $('#usuarios_table').on('click', '.view-btn', function () {
        let id = $(this).data('id');
        // Simulaci贸n de carga
        $('#viewModalBody').html('<div class="text-center py-8"><div class="spinner-border text-indigo-500" role="status"></div></div>');
        new bootstrap.Modal(document.getElementById('viewModal')).show();

        $.get(`/admin/usuarios/view/${id}`, function (data) {
            let roleBadge = rolMap[data.usuario_rol] || '<span class="badge bg-secondary">Desconocido</span>';
            let statusBadge = data.usuario_status == 1 
                ? '<span class="text-green-600 font-medium flex items-center gap-1"><i class="bi bi-check-circle-fill"></i> Activo</span>' 
                : '<span class="text-gray-500 font-medium flex items-center gap-1"><i class="bi bi-slash-circle-fill"></i> Inactivo</span>';

            let html = `
                <div class="flex items-start gap-4 mb-6">
                    <div class="h-16 w-16 rounded-2xl bg-indigo-100 text-indigo-600 flex items-center justify-center text-2xl font-bold shadow-inner">
                        ${data.usuario_nombre ? data.usuario_nombre.charAt(0).toUpperCase() : 'U'}
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-900">${data.usuario_nombre} ${data.usuario_apellidos}</h3>
                        <div class="flex gap-3 mt-1 text-sm">${statusBadge}</div>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                        <span class="block text-xs font-bold text-gray-400 uppercase mb-1">Rol</span>
                        ${roleBadge}
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                        <span class="block text-xs font-bold text-gray-400 uppercase mb-1">Tel茅fono</span>
                        <span class="text-gray-700 font-medium">${data.usuario_telefono || 'N/A'}</span>
                    </div>
                    <div class="col-span-2 bg-gray-50 p-3 rounded-lg border border-gray-100">
                        <span class="block text-xs font-bold text-gray-400 uppercase mb-1">Email</span>
                        <span class="text-gray-700 font-medium">${data.usuario_email}</span>
                    </div>
                    <div class="col-span-2">
                        <span class="block text-xs font-bold text-gray-400 uppercase mb-1">ID del Sistema</span>
                        <span class="font-mono text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">${data._id}</span>
                    </div>
                </div>
            `;
            $('#viewModalBody').html(html);
        });
    });

    // --- Editar Usuario ---
    $('#usuarios_table').on('click', '.edit-btn', function () {
        let id = $(this).data('id');
        $.get(`/admin/usuarios/view/${id}`, function (data) {
            $('#edit_id').val(id);
            $('#edit_nombre').val(data.usuario_nombre || '');
            $('#edit_apellidos').val(data.usuario_apellidos || '');
            new bootstrap.Modal(document.getElementById('editModal')).show();
        });
    });

    $('#editForm').on('submit', function (e) {
        e.preventDefault();
        let id = $('#edit_id').val();
        
        $.ajax({
            url: `/admin/usuarios/edit/${id}`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ 
                usuario_nombre: $('#edit_nombre').val(), 
                usuario_apellidos: $('#edit_apellidos').val() 
            }),
            success: function () {
                $('#editModal').modal('hide');
                table.ajax.reload();
                Swal.fire({ icon: "success", title: "Actualizado", text: "Datos del usuario guardados.", timer: 1500, showConfirmButton: false });
            }
        });
    });

    // --- Eliminar Individual ---
    $('#usuarios_table').on('click', '.delete-btn', function () {
        let id = $(this).data('id');
        Swal.fire({
            title: "驴Eliminar usuario?",
            text: "No podr谩s revertir esto.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#dc2626",
            confirmButtonText: "S铆, eliminar",
            cancelButtonText: "Cancelar"
        }).then(result => {
            if (result.isConfirmed) {
                $.post(`/admin/usuarios/delete/${id}`, function () { 
                    table.ajax.reload();
                    Swal.fire({ icon: "success", title: "Eliminado", showConfirmButton: false, timer: 1500 });
                });
            }
        });
    });

});
</script>
{% endblock %}