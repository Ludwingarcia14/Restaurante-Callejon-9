{% extends "layout/layout.html" %}
{% block title %}Configuraci√≥n de Perfil{% endblock %}

{% block content %}

<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

<style>
    /* Layout */
    .profile-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2rem;
    }
    
    @media (min-width: 992px) {
        .profile-container {
            grid-template-columns: 280px 1fr;
        }
    }

    /* Men√∫ Lateral */
    .nav-profile .nav-link {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem;
        color: #64748b;
        font-weight: 500;
        border-radius: 0.75rem;
        transition: all 0.2s;
        border: 1px solid transparent;
        text-decoration: none; /* Quitar subrayado */
    }
    
    .nav-profile .nav-link:hover {
        background-color: #f8fafc;
        color: #1e293b;
    }
    
    .nav-profile .nav-link.active {
        background-color: #eef2ff;
        color: #4f46e5;
        border-color: #e0e7ff;
        font-weight: 600;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }
    
    .nav-profile i {
        font-size: 1.25rem;
    }

    /* Avatar */
    .profile-avatar-container {
        width: 100px;
        height: 100px;
        background: #eef2ff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        color: #4f46e5;
        margin: 0 auto 1rem;
        border: 4px solid white;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        font-weight: bold;
    }

    /* Switch 2FA Moderno */
    .toggle-switch-lg {
        position: relative;
        display: inline-block;
        width: 52px;
        height: 28px;
    }
    .toggle-switch-lg input { opacity: 0; width: 0; height: 0; }
    .toggle-slider-lg {
        position: absolute;
        cursor: pointer;
        top: 0; left: 0; right: 0; bottom: 0;
        background-color: #cbd5e1;
        transition: .3s;
        border-radius: 34px;
    }
    .toggle-slider-lg:before {
        position: absolute;
        content: "";
        height: 20px; width: 20px;
        left: 4px; bottom: 4px;
        background-color: white;
        transition: .3s;
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    input:checked + .toggle-slider-lg { background-color: #10b981; }
    input:checked + .toggle-slider-lg:before { transform: translateX(24px); }

    /* Caja 2FA */
    .box-2fa {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 1rem;
        padding: 1.5rem;
        margin-top: 1.5rem;
        display: none;
        animation: fadeIn 0.3s ease-out;
    }
    .box-2fa.active { display: block; }
    
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>

<div class="max-w-6xl mx-auto p-6 fade-up">

    <div class="flex items-center gap-3 mb-8">
        <div class="w-12 h-12 rounded-xl bg-indigo-600 flex items-center justify-center text-white shadow-lg shadow-indigo-200">
            <i class="ri-user-settings-line text-2xl"></i>
        </div>
        <div>
            <h1 class="text-2xl font-bold text-gray-800">Configuraci√≥n de Cuenta</h1>
            <p class="text-sm text-gray-500">Gestiona tus datos personales y seguridad.</p>
        </div>
    </div>

    <div id="messageBox" class="d-none alert rounded-lg shadow-sm border-0 mb-6 flex items-center gap-3" role="alert"></div>

    <div class="profile-container">
        
        <div>
            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 mb-6 text-center">
                <div class="profile-avatar-container">
                    {{ session['usuario_nombre'][0].upper() }}
                </div>
                <h3 class="font-bold text-gray-800 text-lg">{{ session['usuario_nombre'] }}</h3>
                <p class="text-sm text-gray-500 badge bg-gray-100 text-gray-600 px-3 py-1 rounded-full mt-2 inline-block">
                    {{ session['usuario_rol'] }}
                </p>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-3 nav-profile" role="tablist">
                <a href="#profile" data-bs-toggle="tab" class="nav-link active" role="tab">
                    <i class="ri-id-card-line"></i> <span>Mi Perfil</span>
                </a>
                <a href="#security" data-bs-toggle="tab" class="nav-link" role="tab">
                    <i class="ri-shield-keyhole-line"></i> <span>Seguridad</span>
                </a>
                <a href="#account" data-bs-toggle="tab" class="nav-link text-red-500 hover:text-red-600 hover:bg-red-50" role="tab">
                    <i class="ri-delete-bin-line"></i> <span>Zona de Peligro</span>
                </a>
            </div>
        </div>

        <div class="tab-content">
            
            <div class="tab-pane fade show active" id="profile" role="tabpanel">
                <div class="card-modern bg-white p-8 rounded-2xl shadow-sm border border-gray-200">
                    <h3 class="text-lg font-bold text-gray-800 mb-6 border-b border-gray-100 pb-4 flex items-center gap-2">
                        <i class="ri-user-line text-indigo-500"></i> Informaci√≥n Personal
                    </h3>
                    
                    <form>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="form-label-modern font-semibold text-gray-700 mb-2 block">Nombre Completo</label>
                                <div class="relative">
                                    <input type="text" class="form-input-modern w-full border border-gray-300 rounded-lg p-2.5 pl-10 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none" value="{{ session['usuario_nombre'] }} {{ session.get('usuario_apellidos', '') }}">
                                    <i class="ri-user-smile-line absolute left-3 top-3 text-gray-400"></i>
                                </div>
                            </div>
                            
                            <div>
                                <label class="form-label-modern font-semibold text-gray-700 mb-2 block">Usuario (ID)</label>
                                <div class="relative">
                                    <input type="text" class="form-input-modern w-full border border-gray-300 rounded-lg p-2.5 pl-10 bg-gray-50 text-gray-500 cursor-not-allowed" value="@{{ session['usuario_nombre'].lower().replace(' ', '') }}" disabled>
                                    <i class="ri-at-line absolute left-3 top-3 text-gray-400"></i>
                                </div>
                            </div>

                            <div>
                                <label class="form-label-modern font-semibold text-gray-700 mb-2 block">Rol Asignado</label>
                                <input type="text" class="form-input-modern w-full border border-gray-300 rounded-lg p-2.5 bg-gray-50 text-gray-500 cursor-not-allowed" value="{{ session['usuario_rol'] }}" disabled>
                            </div>

                            <div>
                                <label class="form-label-modern font-semibold text-gray-700 mb-2 block">Sucursal</label>
                                <input type="text" class="form-input-modern w-full border border-gray-300 rounded-lg p-2.5 bg-gray-50 text-gray-500 cursor-not-allowed" value="Oficina Principal" disabled>
                            </div>
                        </div>

                        <div class="flex justify-end gap-3 pt-4 border-t border-gray-100">
                            <button type="reset" class="px-4 py-2 border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50 transition">Cancelar</button>
                            <button type="button" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow-md">Guardar Cambios</button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="tab-pane fade" id="security" role="tabpanel">
                <div class="card-modern bg-white p-8 rounded-2xl shadow-sm border border-gray-200">
                    <h3 class="text-lg font-bold text-gray-800 mb-6 border-b border-gray-100 pb-4 flex items-center gap-2">
                        <i class="ri-lock-password-line text-indigo-500"></i> Contrase√±a
                    </h3>
                    
                    <form class="mb-8">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <input type="password" class="w-full border border-gray-300 rounded-lg p-2.5 outline-none focus:border-indigo-500" placeholder="Contrase√±a Actual">
                            <input type="password" class="w-full border border-gray-300 rounded-lg p-2.5 outline-none focus:border-indigo-500" placeholder="Nueva Contrase√±a">
                            <input type="password" class="w-full border border-gray-300 rounded-lg p-2.5 outline-none focus:border-indigo-500" placeholder="Confirmar Nueva">
                        </div>
                        <div class="text-right">
                            <button type="button" class="px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-900 transition text-sm">Actualizar Password</button>
                        </div>
                    </form>

                    <h3 class="text-lg font-bold text-gray-800 mb-4 pt-6 border-t border-gray-100 flex items-center gap-2">
                        <i class="ri-shield-check-line text-emerald-500"></i> Autenticaci√≥n de Dos Pasos (2FA)
                    </h3>

                    <div id="status2FA" class="p-4 rounded-xl mb-6 text-sm font-medium border"></div>

                    <div id="2faActivationSection">
                        <div class="flex items-center justify-between bg-gray-50 p-4 rounded-xl border border-gray-200">
                            <div>
                                <h4 class="font-bold text-gray-800">Activar 2FA</h4>
                                <p class="text-xs text-gray-500 mt-1">A√±ade una capa extra de seguridad a tu cuenta.</p>
                            </div>
                            <label class="toggle-switch-lg">
                                <input type="checkbox" id="twoFactorToggle">
                                <span class="toggle-slider-lg"></span>
                            </label>
                        </div>

                        <div class="box-2fa" id="twoFactorBox">
                            <label class="font-semibold text-gray-700 mb-2 block">1. Elige m√©todo de verificaci√≥n:</label>
                            <select id="twoFactorMethod" class="w-full border border-gray-300 rounded-lg p-2.5 mb-6 bg-white outline-none">
                                <option value="">-- Seleccionar --</option>
                                <option value="app">üì≤ App Autenticadora (Google Auth, Authy)</option>
                                <option value="email">üìß Correo Electr√≥nico</option>
                            </select>

                            <div id="methodContent" style="display: none;">
                                <div id="appContent" style="display: none;" class="mb-6 text-center">
                                    <p class="text-sm text-gray-600 mb-4">Escanea el c√≥digo QR con tu aplicaci√≥n:</p>
                                    <div class="inline-block p-4 bg-white rounded-xl shadow-sm border border-gray-200">
                                        <div id="qrPlaceholder" class="w-40 h-40 bg-gray-100 flex items-center justify-center text-xs text-gray-400 rounded-lg">
                                            <i class="ri-qr-code-line text-4xl"></i>
                                        </div>
                                    </div>
                                    <p class="mt-3 text-xs text-gray-500">Clave manual: <strong id="setupKey" class="font-mono bg-gray-100 px-2 py-1 rounded">...</strong></p>
                                </div>

                                <div id="emailContent" style="display: none;" class="mb-6 p-4 bg-blue-50 text-blue-800 rounded-lg text-sm border border-blue-100 flex items-center gap-2">
                                    <i class="ri-mail-send-line text-lg"></i> Se enviar√° un c√≥digo de 6 d√≠gitos a tu correo registrado.
                                </div>

                                <div class="max-w-xs mx-auto text-center">
                                    <label class="font-semibold text-gray-700 mb-2 block">2. Ingresa el c√≥digo de 6 d√≠gitos</label>
                                    <input type="text" class="w-full text-center text-xl tracking-widest font-mono mb-4 border border-gray-300 rounded-lg p-2.5 outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100" id="otpCodeVerify" placeholder="000 000" maxlength="6">
                                    
                                    <button type="button" class="w-full py-3 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition shadow-lg shadow-indigo-200" id="verifyAndEnable">
                                        Verificar y Activar
                                    </button>
                                    <button type="button" class="w-full mt-2 py-2 text-gray-500 hover:text-gray-700 text-sm" id="cancel2FA">Cancelar</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="2faDeactivationSection" style="display: none;" class="text-center p-6 bg-emerald-50 rounded-xl border border-emerald-100">
                        <div class="w-16 h-16 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-3 text-2xl">
                            <i class="ri-shield-check-fill"></i>
                        </div>
                        <h4 class="font-bold text-emerald-800">Tu cuenta est√° protegida</h4>
                        <p class="text-sm text-emerald-600 mb-4">La autenticaci√≥n de dos pasos est√° activa.</p>
                        <button type="button" class="px-4 py-2 border border-red-200 text-red-600 bg-white hover:bg-red-50 rounded-lg text-sm transition" id="disable2FA">
                            Desactivar protecci√≥n
                        </button>
                    </div>

                </div>
            </div>

            <div class="tab-pane fade" id="account" role="tabpanel">
                <div class="card-modern bg-white p-8 rounded-2xl shadow-sm border border-red-100">
                    <h3 class="text-lg font-bold text-red-600 mb-4 flex items-center gap-2">
                        <i class="ri-alert-line"></i> Zona de Peligro
                    </h3>
                    <p class="text-gray-600 mb-6 text-sm">Estas acciones son irreversibles. Ten cuidado.</p>
                    
                    <div class="flex items-center justify-between p-4 bg-red-50 rounded-xl border border-red-100">
                        <div>
                            <h4 class="font-bold text-gray-800 text-sm">Eliminar Cuenta</h4>
                            <p class="text-xs text-gray-500">Se borrar√°n todos tus datos y accesos permanentemente.</p>
                        </div>
                        <button class="px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-medium hover:bg-red-700 shadow-md">Eliminar Definitivamente</button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
$(function(){
    // --- ESTADO 2FA ---
    let is2FAActive = {{ 'true' if session['2fa_enabled'] else 'false' }};

    function showMessage(message, type = 'info') {
        const box = $('#messageBox');
        let icon = 'ri-information-line';
        let colorClass = 'bg-blue-50 text-blue-700 border-blue-100';

        if(type === 'success') { colorClass = 'bg-emerald-50 text-emerald-700 border-emerald-100'; icon = 'ri-check-line'; }
        if(type === 'error') { colorClass = 'bg-red-50 text-red-700 border-red-100'; icon = 'ri-error-warning-line'; }
        if(type === 'warning') { colorClass = 'bg-amber-50 text-amber-700 border-amber-100'; icon = 'ri-alert-line'; }

        box.attr('class', `d-flex alert rounded-lg shadow-sm border mb-6 flex items-center gap-3 p-4 ${colorClass}`);
        box.html(`<i class="${icon} text-xl"></i> <span class="font-medium">${message}</span>`);
    }

    function updateSecurityStatusUI() {
        const statusDiv = $('#status2FA');
        if (is2FAActive) {
            statusDiv.attr('class', 'p-4 rounded-xl mb-6 text-sm font-medium border bg-emerald-50 border-emerald-200 text-emerald-700 flex items-center gap-2');
            statusDiv.html('<i class="ri-checkbox-circle-fill text-lg"></i> Estado: 2FA ACTIVADO');
            $('#2faActivationSection').hide();
            $('#2faDeactivationSection').show();
        } else {
            statusDiv.attr('class', 'p-4 rounded-xl mb-6 text-sm font-medium border bg-amber-50 border-amber-200 text-amber-700 flex items-center gap-2');
            statusDiv.html('<i class="ri-error-warning-fill text-lg"></i> Estado: 2FA DESACTIVADO');
            $('#2faActivationSection').show();
            $('#2faDeactivationSection').hide();
            $('#twoFactorToggle').prop('checked', false);
            resetTwoFactorBox();
        }
    }

    function resetTwoFactorBox() {
        $('#twoFactorMethod').val('');
        $('#methodContent, #appContent, #emailContent').hide();
        $('#twoFactorBox').removeClass('active');
        $('#otpCodeVerify').val('');
    }

    // --- L√≥gica Backend ---
    function generateReal2FAKey(method) {
        if(method === 'app') {
            $('#qrPlaceholder').html('<div class="spinner-border text-indigo-500 spinner-border-sm" role="status"></div>');
            $('#setupKey').text('Generando...');
        } else {
            showMessage("Enviando c√≥digo...", 'info');
        }

        $.ajax({
            url: "{{ url_for('routes.generate_2fa_setup') }}", 
            method: 'POST', contentType: "application/json", 
            data: JSON.stringify({ tipo: method }),
            success: function(response) {
                if (response.status === 'success') {
                    if (method === 'app') {
                        $('#qrPlaceholder').html(`<img src="${response.qr_image}" class="w-full h-full object-contain">`);
                        $('#setupKey').text(response.secret_key);
                        showMessage("Escanea el c√≥digo QR.", 'info');
                    } else {
                        showMessage(`‚úÖ C√≥digo enviado a tu correo.`, 'success');
                    }
                } else {
                    showMessage(`‚ùå Error: ${response.message}`, 'error');
                }
            },
            error: function() { showMessage("Error de conexi√≥n.", 'error'); }
        }); 
    }
  
    function verifyAndEnableReal2FA(code) { 
        const method = $('#twoFactorMethod').val();
        if (!method) { showMessage('Selecciona un m√©todo.', 'error'); return; }

        $.ajax({ 
            url: "{{ url_for('routes.verify_and_enable_2fa') }}",
            method: 'POST', contentType: "application/json",
            data: JSON.stringify({ code: code }),
            success: function(response) {
                if (response.status === 'success') { 
                    is2FAActive = true;
                    updateSecurityStatusUI();
                    showMessage(`‚úÖ 2FA activada con √©xito!`, 'success');
                } else {
                    showMessage(`‚ùå ${response.message}`, 'error'); 
                }
            },
            error: function() { showMessage("Error de servidor.", 'error'); }
        });
    }
  
    // --- EVENTOS ---
    $('#twoFactorToggle').on('change', function() {
        if ($(this).is(':checked')) {
            $('#twoFactorBox').addClass('active');
        } else {
            resetTwoFactorBox();
        }
    });

    $('#twoFactorMethod').on('change', function() {
        var method = $(this).val();
        $('#methodContent, #appContent, #emailContent').hide();
        $('#otpCodeVerify').val(''); 
        
        if (method) {
            $('#methodContent').show();
            if (method === 'app') $('#appContent').show();
            else if (method === 'email') $('#emailContent').show();
            generateReal2FAKey(method);
        }
    });

    $('#cancel2FA').on('click', function() {
        $('#twoFactorToggle').prop('checked', false).trigger('change');
    });

    $('#verifyAndEnable').on('click', function() {
        const code = $('#otpCodeVerify').val();
        if (code.length !== 6) { showMessage('C√≥digo inv√°lido (6 d√≠gitos).', 'error'); return; }
        verifyAndEnableReal2FA(code); 
    });
  
    $('#disable2FA').on('click', function() {
        if (confirm("¬øDesactivar 2FA?")) {
            is2FAActive = false;
            updateSecurityStatusUI();
            showMessage('2FA desactivada.', 'warning');
        }
    });
  
    updateSecurityStatusUI(); 
});
</script>
{% endblock %}