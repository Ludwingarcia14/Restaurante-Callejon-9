{% extends "layout/layout.html" %}
{% block title %}Crear Cliente{% endblock %}

{% block content %}
<style>
    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .animate-spin {
        animation: spin 1s linear infinite;
    }
</style>

<div class="bg-white max-w-5xl mx-auto p-8 rounded-xl shadow-xl">
    <h2 class="text-3xl font-bold mb-6">üë• Cliente <span class="text-sm text-gray-500">> Nuevo Cliente</span></h2>

    <!-- üîµ Overlay Preloader -->
    <div id="preloader" class="fixed inset-0 bg-black bg-opacity-60 flex flex-col items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow p-6 text-center w-80">
            <h2 class="text-lg font-bold mb-4">Procesando...</h2>
            <div class="w-full bg-gray-200 rounded-full h-4">
                <div id="progress-bar" class="bg-blue-600 h-4 rounded-full" style="width: 0%"></div>
            </div>
            <p id="progress-text" class="mt-2 text-sm font-semibold text-gray-700">0%</p>
        </div>
    </div>

    <!-- Tu formulario -->
    <form id="adminForm" method="POST" action="/dashboard/admin/create">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Nombres -->
            <div>
                <label class="block mb-1">Nombres</label>
                <input type="text" name="nombre" required class="w-full p-2 border rounded">
            </div>
            <!-- Apellidos -->
            <div>
                <label class="block mb-1">Apellidos</label>
                <input type="text" name="apellido" required class="w-full p-2 border rounded">
            </div>
            <!-- C.P. -->
            <div>
                <label class="block mb-1">C.P.</label>
                <input type="text" name="cp" id="cp_input" class="w-full p-2 border rounded" maxlength="5">
            </div>
            <!-- Estado -->
            <div>
                <label class="block mb-1">Estado</label>
                <select name="estado_id" id="estado_select" required class="w-full p-2 border rounded">
                    <option value>Seleccione un estado</option>
                </select>
            </div>
            <!-- Municipio -->
            <div>
                <label class="block mb-1">Municipio</label>
                <select name="municipio_id" id="municipio_select" required class="w-full p-2 border rounded" disabled>
                    <option value>Seleccione un municipio</option>
                </select>
            </div>
            <!-- Colonia -->
            <div>
                <label class="block mb-1">Colonia</label>
                <select name="colonia_id" id="colonia_select" required class="w-full p-2 border rounded" disabled>
                    <option value>Seleccione una colonia</option>
                </select>
            </div>
            <!-- Tel√©fono -->
            <div>
                <label class="block mb-1">Tel√©fono</label>
                <input type="text" name="telefono" class="w-full p-2 border rounded">
            </div>
            <!-- Email -->
            <div>
                <label class="block mb-1">Email</label>
                <input type="email" name="correo" required class="w-full p-2 border rounded">
            </div>
            <!-- Contrase√±a -->
            <div>
                <label class="block mb-1">Contrase√±a</label>
                <input type="password" name="contrasena" class="w-full p-2 border rounded">
            </div>
            <!-- Tipo de Administrador -->
            <div>
                <label class="block mb-1">Tipo de Administrador</label>
                <select name="tipo_persona" required class="w-full p-2 border rounded">
                    <option value="">Seleccione un rol</option>
                    {% for rol in roles %}
                    <option value="{{ rol.Rol_id }}">{{ rol.Rol_nombre }}</option>
                    {% endfor %}
                </select>

            </div>
            <!-- Fecha de Alta -->
            <div>
                <label class="block mb-1">Fecha de Alta</label>
                <input type="date" name="fecha_alta" class="w-full p-2 border rounded" value="{{ current_date }}"
                    readonly>
            </div>
        </div>

        <div class="flex justify-between mt-6">
            <button type="reset" class="px-6 py-2 bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200">üßπ
                Limpiar</button>
            <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">üíæ
                Guardar</button>
        </div>
    </form>

    <!-- Preloader -->
    <div id="preloader" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-blue-600 border-solid"></div>
    </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.querySelector('form');
        const preloader = document.getElementById('preloader');

        form.addEventListener('submit', () => preloader.classList.remove('hidden'));

        // Mensajes de sesi√≥n
        {% if session.get('success') %}
        Swal.fire({
            icon: 'success',
            title: '¬°√âxito!',
            text: "{{ session.get('success') }}",
            confirmButtonColor: '#3085d6'
        });
        {% endif %}
        {% if session.get('error') %}
        Swal.fire({
            icon: 'error',
            title: '¬°Error!',
            text: "{{ session.get('error') }}",
            confirmButtonColor: '#d33'
        });
        {% endif %}

        // Select dependientes
        const cpInput = document.getElementById('cp_input');
        const estadoSelect = document.getElementById('estado_select');
        const municipioSelect = document.getElementById('municipio_select');
        const coloniaSelect = document.getElementById('colonia_select');

        function populateSelect(selectEl, items, valueKey, textKey) {
            selectEl.innerHTML = `<option value="">Seleccione una opci√≥n</option>`;
            items.forEach(i => {
                const opt = document.createElement('option');
                opt.value = i[valueKey];
                opt.textContent = i[textKey];
                selectEl.appendChild(opt);
            });
        }

        // Cargar estados
        fetch('/api/sepomex/estados')
            .then(r => r.json())
            .then(data => populateSelect(estadoSelect, data, 'id', 'nombre'));

        estadoSelect.addEventListener('change', () => {
            const estadoId = estadoSelect.value;
            municipioSelect.disabled = true;
            coloniaSelect.disabled = true;
            municipioSelect.innerHTML = '<option>Cargando...</option>';
            coloniaSelect.innerHTML = '<option value="">Seleccione una colonia</option>';
            cpInput.value = '';

            if (estadoId) {
                fetch(`/api/sepomex/municipios/${estadoId}`)
                    .then(r => r.json())
                    .then(data => {
                        populateSelect(municipioSelect, data, 'id', 'nombre');
                        municipioSelect.disabled = false;
                    });
            }
        });

        municipioSelect.addEventListener('change', () => {
            const municipioId = municipioSelect.value;
            coloniaSelect.disabled = true;
            coloniaSelect.innerHTML = '<option>Cargando...</option>';
            cpInput.value = '';

            if (municipioId) {
                fetch(`/api/sepomex/colonias/${municipioId}`)
                    .then(r => r.json())
                    .then(data => {
                        populateSelect(coloniaSelect, data, 'id', 'nombre');
                        coloniaSelect.dataset.colonias = JSON.stringify(data);
                        coloniaSelect.disabled = false;
                    });
            }
        });

        coloniaSelect.addEventListener('change', () => {
            const colonias = JSON.parse(coloniaSelect.dataset.colonias || '[]');
            const selId = coloniaSelect.value;
            const colData = colonias.find(c => c.id == selId);
            if (colData) cpInput.value = colData.codigo_postal;
        });

        cpInput.addEventListener('input', () => {
            const cp = cpInput.value;
            if (cp.length === 5) {
                fetch(`/api/sepomex/cp/${cp}`)
                    .then(r => {
                        if (!r.ok) throw new Error('CP no encontrado');
                        return r.json();
                    })
                    .then(data => {
                        estadoSelect.value = data.estado.id;
                        const onMunicipiosLoaded = () => {
                            municipioSelect.value = data.municipio.id;
                            municipioSelect.dispatchEvent(new Event('change'));
                            municipioSelect.removeEventListener('DOMSubtreeModified', onMunicipiosLoaded);
                        };
                        municipioSelect.addEventListener('DOMSubtreeModified', onMunicipiosLoaded);
                        estadoSelect.dispatchEvent(new Event('change'));
                    })
                    .catch(err => console.error(err.message));
            }
        });
    });

    document.getElementById("adminForm").addEventListener("submit", async function (e) {
        e.preventDefault(); // Evitar recarga

        const preloader = document.getElementById("preloader");
        const progressBar = document.getElementById("progress-bar");
        const progressText = document.getElementById("progress-text");

        // Mostrar preloader
        preloader.classList.remove("hidden");

        // Obtener datos del formulario
        const formData = new FormData(this);

        // üöÄ Simulaci√≥n de progreso (0% ‚Üí 90%)
        let progress = 0;
        const interval = setInterval(() => {
            if (progress < 90) {
                progress += 10;
                progressBar.style.width = progress + "%";
                progressText.textContent = progress + "%";
            }
        }, 300);

        try {
            // üìå Hacer petici√≥n al backend
            const response = await fetch(this.action, {
                method: "POST",
                body: formData
            });

            const result = await response.json();

            // ‚úÖ Completar barra
            clearInterval(interval);
            progressBar.style.width = "100%";
            progressText.textContent = "100%";

            // Esperar un segundo para que el usuario vea el 100%
            setTimeout(() => {
                preloader.classList.add("hidden");
                alert(result.success ? "‚úÖ Guardado correctamente" : "‚ùå Error: " + result.error);
            }, 800);

        } catch (error) {
            clearInterval(interval);
            preloader.classList.add("hidden");
            alert("‚ùå Error en la petici√≥n: " + error);
        }
    });
</script>
{% endblock %}