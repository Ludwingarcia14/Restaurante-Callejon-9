{% extends "layout/layout.html" %}
{% block title %}Calendario de Actividades{% endblock %}

{% block content %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales/es.global.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/google-calendar@6.1.8/index.global.min.js'></script> 
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

<style>
    /* --- Personalización de FullCalendar (Moderno) --- */
    
    /* Botones de navegación (Hoy, Mes, Semana) */
    .fc .fc-button-primary {
        background-color: white;
        color: #475569;
        border-color: #e2e8f0;
        font-weight: 500;
        padding: 0.4rem 1rem;
        text-transform: capitalize;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        transition: all 0.2s;
    }
    .fc .fc-button-primary:hover {
        background-color: #f8fafc;
        color: #1e293b;
        border-color: #cbd5e1;
    }
    .fc .fc-button-primary:not(:disabled).fc-button-active, 
    .fc .fc-button-primary:not(:disabled):active {
        background-color: #4f46e5;
        border-color: #4f46e5;
        color: white;
    }
    .fc .fc-button-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    /* Título del calendario */
    .fc .fc-toolbar-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1e293b;
    }

    /* Días de la semana */
    .fc .fc-col-header-cell-cushion {
        padding: 10px 0;
        font-weight: 600;
        color: #64748b;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        text-decoration: none;
    }

    /* Eventos */
    .fc-event {
        border-radius: 4px;
        border: none;
        padding: 2px 4px;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: transform 0.1s;
    }
    .fc-event:hover {
        transform: scale(1.02);
    }
    
    /* Eventos Locales (Azules) */
    .fc-event:not(.google-event) {
        background-color: #e0e7ff;
        color: #4f46e5;
        border-left: 3px solid #4f46e5;
    }
    
    /* Eventos Google (Rojos - definidos en JS, pero ajustamos aquí si hace falta) */
    .google-event {
        box-shadow: 0 2px 4px rgba(219, 68, 55, 0.2);
    }

    /* Día actual */
    .fc .fc-day-today {
        background-color: #f8fafc !important;
    }
    
    /* Animación de entrada */
    .fade-up { animation: fadeUp 0.5s ease-out forwards; opacity: 0; transform: translateY(15px); }
    @keyframes fadeUp { to { opacity: 1; transform: translateY(0); } }
</style>

<div class="max-w-6xl mx-auto p-6">

    <div class="flex flex-col md:flex-row justify-between items-center mb-6 fade-up">
        <div class="mb-4 md:mb-0">
            <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                <div class="w-10 h-10 rounded-lg bg-indigo-100 flex items-center justify-center text-indigo-600">
                    <i class="ri-calendar-todo-fill text-xl"></i>
                </div>
                Mi Agenda de Obligaciones
            </h1>
            <p class="text-sm text-gray-500 mt-1 ml-12">Gestiona tus recordatorios y visualiza fechas importantes.</p>
        </div>
        
        <button onclick="history.back();" class="px-4 py-2 bg-white border border-gray-200 text-gray-600 rounded-lg hover:bg-gray-50 transition shadow-sm flex items-center gap-2 font-medium text-sm">
            <i class="ri-arrow-left-line"></i> Volver
        </button>
    </div>

    <div class="bg-white rounded-2xl shadow-xl border border-gray-200 p-6 fade-up" style="animation-delay: 0.1s;">
        
        <div class="flex items-center justify-end gap-4 mb-4 text-xs font-medium text-gray-500">
            <div class="flex items-center gap-1.5">
                <span class="w-3 h-3 rounded-full bg-indigo-500"></span> Mis Recordatorios
            </div>
            <div class="flex items-center gap-1.5">
                <span class="w-3 h-3 rounded-full bg-red-500"></span> Google Calendar
            </div>
        </div>

        <div id="calendar" class="min-h-[600px]"></div>

    </div>

    <div class="mt-4 text-center fade-up" style="animation-delay: 0.2s;">
        <p class="text-xs text-gray-400 flex items-center justify-center gap-1">
            <i class="ri-information-line"></i>
            Los eventos de Google Calendar son de solo lectura y no se pueden editar desde aquí.
        </p>
    </div>

</div>

<script>
    // ⚠️ Configuración
    const GOOGLE_API_KEY = 'AIzaSyAJaOJviCwNM7pvcOlPxxH6VC0bAXVh2Z0'; 
    const GOOGLE_CALENDAR_ID = 'abf138b81a1c6fb1c52832494ba0a5a1e50a23371c2f97de8facc2b5cef5d7a8@group.calendar.google.com'; 
    const CURRENT_USER_ID = 45; 
    const EVENTOS_URL = "{{ url_for('routes.eventos_calendario_get') }}";

    document.addEventListener('DOMContentLoaded', function () {
        const calendarEl = document.getElementById('calendar');

        const calendar = new FullCalendar.Calendar(calendarEl, {
            // --- Configuración Visual ---
            initialView: 'dayGridMonth',
            height: 'auto', // Altura automática para que no corte en móviles
            contentHeight: 650,
            locale: 'es',
            themeSystem: 'standard',
            
            // --- Barra de Herramientas ---
            headerToolbar: { 
                left: 'prev,next today', 
                center: 'title', 
                right: 'dayGridMonth,timeGridWeek,listWeek' 
            },
            buttonText: { 
                today: 'Hoy', 
                month: 'Mes', 
                week: 'Semana', 
                day: 'Día', 
                list: 'Agenda' 
            },

            // --- Comportamiento ---
            selectable: true,
            editable: true,
            dayMaxEvents: true, // Mostrar "ver más" si hay muchos eventos
            navLinks: true, // Click en día lleva a vista diaria
            eventTimeFormat: { hour: '2-digit', minute: '2-digit', hour12: true },

            // --- Fuente 1: Eventos Locales (Backend) ---
            events: function(fetchInfo, successCallback, failureCallback) {
                axios.get(EVENTOS_URL, { params: { userId: CURRENT_USER_ID } })
                    .then(res => {
                        if (Array.isArray(res.data)) successCallback(res.data);
                        else { console.error("Respuesta inválida:", res.data); successCallback([]); }
                    })
                    .catch(err => { console.error(err); failureCallback(err); });
            },

            // --- Fuente 2: Google Calendar ---
            googleCalendarApiKey: GOOGLE_API_KEY,
            eventSources: [
                {
                    googleCalendarId: GOOGLE_CALENDAR_ID,
                    className: 'google-event',
                    color: '#fee2e2', // Fondo rojo suave
                    textColor: '#b91c1c', // Texto rojo oscuro
                    borderColor: '#fca5a5' // Borde rojo medio
                }
            ],

            // --- ACCIONES (Crear) ---
            select: function(info) {
                Swal.fire({
                    title: 'Nuevo Evento',
                    input: 'text',
                    inputLabel: 'Título del recordatorio',
                    inputPlaceholder: 'Ej: Pagar nómina',
                    showCancelButton: true,
                    confirmButtonText: 'Guardar',
                    cancelButtonText: 'Cancelar',
                    confirmButtonColor: '#4f46e5'
                }).then((result) => {
                    if (result.isConfirmed && result.value) {
                        axios.post(EVENTOS_URL, { 
                            titulo: result.value,
                            fecha_inicio: info.startStr,
                            fecha_fin: info.endStr,
                            idUsuario: CURRENT_USER_ID
                        })
                        .then(() => {
                            calendar.refetchEvents();
                            const Toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false, timer: 3000});
                            Toast.fire({icon: 'success', title: 'Evento creado'});
                        })
                        .catch(err => Swal.fire('Error', 'No se pudo guardar.', 'error'));
                    }
                });
                calendar.unselect();
            },

            // --- ACCIONES (Click / Editar / Borrar) ---
            eventClick: function(info) {
                // Bloquear Google Events
                if (info.event.classNames.includes('google-event')) {
                    Swal.fire({
                        icon: 'info',
                        title: 'Evento de Google',
                        text: `"${info.event.title}" es de solo lectura.`,
                        confirmButtonColor: '#db4437'
                    });
                    return;
                }

                // Menú de opciones local
                Swal.fire({
                    title: info.event.title,
                    text: "¿Qué deseas hacer con este evento?",
                    icon: 'question',
                    showDenyButton: true,
                    showCancelButton: true,
                    confirmButtonText: 'Editar',
                    denyButtonText: 'Eliminar',
                    cancelButtonText: 'Cerrar',
                    confirmButtonColor: '#f59e0b', // Amber
                    denyButtonColor: '#ef4444'    // Red
                }).then((result) => {
                    if (result.isConfirmed) {
                        // EDITAR
                        Swal.fire({
                            title: 'Editar Título',
                            input: 'text',
                            inputValue: info.event.title,
                            showCancelButton: true,
                            confirmButtonText: 'Actualizar',
                            confirmButtonColor: '#4f46e5'
                        }).then((editResult) => {
                            if (editResult.isConfirmed && editResult.value) {
                                axios.put(EVENTOS_URL, { 
                                    id: info.event.id,
                                    titulo: editResult.value,
                                    fecha_inicio: info.event.startStr,
                                    fecha_fin: info.event.endStr
                                }).then(() => {
                                    calendar.refetchEvents();
                                    Swal.fire('Actualizado', '', 'success');
                                });
                            }
                        });

                    } else if (result.isDenied) {
                        // ELIMINAR
                        axios.delete(EVENTOS_URL, { data: { id: info.event.id } })
                            .then(() => {
                                calendar.refetchEvents();
                                Swal.fire('Eliminado', '', 'success');
                            })
                            .catch(err => Swal.fire('Error', 'No se pudo eliminar.', 'error'));
                    }
                });
            },

            // --- ACCIONES (Drag & Drop) ---
            eventDrop: function(info) {
                if (info.event.classNames.includes('google-event')) {
                    info.revert(); 
                    Swal.fire('Bloqueado', 'No puedes mover eventos de Google.', 'warning');
                    return;
                }
                
                axios.put(EVENTOS_URL, { 
                    id: info.event.id,
                    titulo: info.event.title,
                    fecha_inicio: info.event.startStr,
                    fecha_fin: info.event.endStr
                }).catch(err => {
                    info.revert();
                    Swal.fire('Error', 'No se pudo mover el evento.', 'error');
                });
            }
        });

        calendar.render();
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
{% endblock %}