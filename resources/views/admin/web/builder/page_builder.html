{% extends 'layout/layout.html' %}

{% block content %}
<link href="https://unpkg.com/grapesjs/dist/css/grapes.min.css" rel="stylesheet">
<script src="https://unpkg.com/grapesjs"></script>
<script src="https://unpkg.com/grapesjs-preset-webpage"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
/* =========================================
   CONTENEDOR CORRECTO
========================================= */
.editor-wrapper {
    height: calc(100vh - 100px); /* ajusta a tu header real */
    width: 100%;
    overflow: hidden;
}

/* Grapes ocupa todo */
#gjs {
    height: 100%;
    width: 100%;
}

/* NUNCA tocar posici√≥n de paneles */
.gjs-editor-cont {
    height: 100%;
}

/* Canvas con scroll */
.gjs-cv-canvas {
    height: 100%;
}

.gjs-cv-canvas__frames {
    height: 100%;
    overflow: auto;
}

/* Tema oscuro elegante */
.gjs-one-bg { background-color: #111827; }
.gjs-two-color { color: #e5e7eb; }
.gjs-three-bg { background-color: #1f2937; }
.gjs-four-color { color: #9ca3af; }

/* Bot√≥n guardar */
.fa-save {
    color: #22c55e !important;
}

/* Ocultar fullscreen (rompe dashboard) */
.gjs-pn-btn.fa-arrows-alt {
    display: none !important;
}
</style>

<div class="editor-wrapper">
    <div id="gjs"></div>
</div>

<script>
/* =========================================
   DATOS
========================================= */
const savedProjectData = {{ page.gjs_data | tojson | safe if page.gjs_data else 'null' }};

/* =========================================
   INIT GRAPESJS (SIN FORZAR POSICIONES)
========================================= */
const editor = grapesjs.init({
    container: '#gjs',
    height: '100%',
    width: 'auto',
    fromElement: false,

    storageManager: {
        type: 'remote',
        autosave: false,
        autoload: false
    },

    plugins: ['gjs-preset-webpage'],
    pluginsOpts: {
        'gjs-preset-webpage': {
            blocksBasicOpts: { flexGrid: true }
        }
    },

    canvas: {
        styles: [
            'https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css'
        ]
    }
});

/* =========================================
   ABRIR BLOQUES AL CARGAR
========================================= */
editor.on('load', () => {
    editor.Panels.getPanel('views')
        .getButton('open-blocks')
        .set('active', 1);
});

/* =========================================
   CARGAR PROYECTO
========================================= */
if (savedProjectData) {
    editor.loadProjectData(savedProjectData);
} else {
    editor.setComponents(`
        <div class="container text-center py-5">
            <h2 class="display-5">Bienvenido al Editor</h2>
            <p>Arrastra bloques desde la izquierda.</p>
        </div>
    `);
}

/* =========================================
   BOT√ìN GUARDAR
========================================= */
editor.Panels.addButton('options', {
    id: 'save-db',
    className: 'fa fa-save',
    command: 'save-database',
    attributes: { title: 'Guardar Cambios' }
});

editor.Commands.add('save-database', {
    run(editor, sender) {
        sender && sender.set('active', 0);

        const projectData = editor.getProjectData();
        const html = editor.getHtml();
        const css = editor.getCss();

        Swal.fire({ title: 'Guardando...', didOpen: () => Swal.showLoading() });

        fetch(`/admin/paginas/guardar/{{ page._id }}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ projectData, html, css })
        })
        .then(r => r.json())
        .then(d => {
            if (d.success) {
                Swal.fire('Guardado', 'Cambios publicados', 'success');
            } else {
                Swal.fire('Error', d.error, 'error');
            }
        });
    }
});

/* =========================================
   BLOQUE FORMULARIO
========================================= */
editor.BlockManager.add('lead-form-block', {
    label: 'üìù Formulario Leads',
    category: 'Extra',
    content: `
        <form action="/landing/registro" method="POST"
              style="padding:20px;background:#fff;border:1px solid #e5e7eb;border-radius:8px;">
            <input type="hidden" name="page_slug" value="{{ page.slug }}">
            <h3 class="text-center mb-3">Reg√≠strate</h3>
            <div class="mb-2">
                <label>Nombre</label>
                <input type="text" name="nombre" class="form-control" required>
            </div>
            <div class="mb-2">
                <label>Email</label>
                <input type="email" name="email" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Enviar</button>
        </form>
    `
});
</script>
{% endblock %}
