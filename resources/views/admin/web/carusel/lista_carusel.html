{% extends "layout/layout.html" %}

{% block title %}Listado de Carrusel{% endblock %}

{% block content %}

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">

<div class="max-w-7xl mx-auto p-6">

    <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-8">

        <div class="border-b border-gray-200 pb-6 mb-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
                <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                    <i class="bi bi-collection-fill text-indigo-600"></i>
                    Publicaciones del Carrusel
                </h2>
                <p class="text-sm text-gray-500 mt-1">
                    Administra las publicaciones visibles en el carrusel del sitio web.
                </p>
            </div>

            <a href="{{ url_for('routes.viewcarousel') }}"
               class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm font-medium flex items-center gap-2 shadow-sm">
                <i class="bi bi-plus-circle"></i> Nueva Publicación
            </a>
        </div>

        <div class="overflow-x-auto">
            <table id="tablaCarrusel" class="min-w-full border border-gray-200 rounded-lg overflow-hidden">
                <thead class="bg-gray-50">
                    <tr class="text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                        <th class="px-4 py-3">Imagen</th>
                        <th class="px-4 py-3">Título</th>
                        <th class="px-4 py-3">Tipo</th>
                        <th class="px-4 py-3">URL</th>
                        <th class="px-4 py-3 text-center">Estado</th>
                        <th class="px-4 py-3 text-center">Acciones</th>
                    </tr>
                </thead>

                <tbody class="divide-y divide-gray-100 text-sm">

                    {% for item in carouseles %}
                    <tr class="hover:bg-gray-50 transition">

                        <td class="px-4 py-3">
                            <img src="{{ item.imagen_url }}" 
                                 alt="Img"
                                 class="w-20 h-12 object-cover rounded-md shadow border">
                        </td>

                        <td class="px-4 py-3 font-semibold text-gray-800">
                            {{ item.titulo }}
                        </td>

                        <td class="px-4 py-3">
                            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold
                                {% if item.tipo == 'expo' %}
                                    bg-purple-100 text-purple-700
                                {% elif item.tipo == 'caravana' %}
                                    bg-blue-100 text-blue-700
                                {% else %}
                                    bg-gray-100 text-gray-700
                                {% endif %}">
                                <i class="bi bi-tag"></i> {{ item.tipo|capitalize }}
                            </span>
                        </td>

                        <td class="px-4 py-3">
                            <div class="max-w-[150px] truncate text-xs text-indigo-600 font-mono">
                                {{ item.btn_link }}
                            </div>
                        </td>

                        <td class="px-4 py-3 text-center">
                            {% if item.activo %}
                                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-700">
                                    Activo
                                </span>
                            {% else %}
                                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-700">
                                    Inactivo
                                </span>
                            {% endif %}
                        </td>

                        <td class="px-4 py-3 text-center">
                            <div class="flex justify-center gap-2">

                                <button onclick="verCarrusel('{{ item._id }}')"
                                   class="p-2 rounded-lg bg-blue-50 text-blue-600 hover:bg-blue-100 transition"
                                   title="Ver Detalle">
                                    <i class="bi bi-eye-fill"></i>
                                </button>

                                <a href="{{ url_for('routes.carousel_edit', id=item._id) }}"
                                   class="p-2 rounded-lg bg-yellow-50 text-yellow-600 hover:bg-yellow-100 transition"
                                   title="Editar">
                                    <i class="bi bi-pencil-fill"></i>
                                </a>

                                <button onclick="abrirEditorPro('{{ item.tipo }}', '{{ item.btn_link.split('/')[-1] if item.btn_link else '' }}')" 
                                        class="px-3 py-1.5 bg-emerald-50 text-emerald-600 rounded-lg hover:bg-emerald-100 transition flex items-center gap-1 text-sm font-medium border border-emerald-200"
                                        title="Diseñar Página Landing">
                                    <i class="bi bi-palette-fill"></i>
                                </button>

                                <button onclick="eliminarCarrusel('{{ item._id }}')"
                                        class="p-2 rounded-lg bg-red-50 text-red-600 hover:bg-red-100 transition"
                                        title="Eliminar">
                                    <i class="bi bi-trash-fill"></i>
                                </button>

                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-gray-400">
                            <i class="bi bi-info-circle me-1"></i>
                            No hay publicaciones registradas.
                        </td>
                    </tr>
                    {% endfor %}

                </tbody>
            </table>
        </div>

    </div>
</div>

<div id="viewModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity backdrop-blur-sm" onclick="cerrarModal()"></div>

        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl w-full">
            
            <div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                <h3 class="text-lg leading-6 font-bold text-gray-800 flex items-center gap-2">
                    <i class="bi bi-file-earmark-richtext text-indigo-600"></i> Detalle de Publicación
                </h3>
                <button type="button" onclick="cerrarModal()" class="text-gray-400 hover:text-gray-500 focus:outline-none">
                    <i class="bi bi-x-lg text-lg"></i>
                </button>
            </div>

            <div class="px-6 py-6" id="modalContent">
                <div class="flex flex-col md:flex-row gap-6">
                    
                    <div class="w-full md:w-1/2">
                        <div class="aspect-video bg-gray-100 rounded-lg overflow-hidden border border-gray-200 relative group">
                            <img id="modal_img" src="" class="w-full h-full object-cover">
                            <div class="absolute top-2 right-2">
                                <span id="modal_estado" class="px-2 py-1 rounded text-[10px] font-bold uppercase shadow-sm"></span>
                            </div>
                        </div>
                        <div class="mt-4 p-3 bg-gray-50 rounded-lg border border-gray-100 text-center">
                            <span class="text-xs text-gray-400 uppercase font-bold block mb-1">Tipo de Evento</span>
                            <span id="modal_tipo" class="text-sm font-bold text-gray-700 uppercase tracking-wide"></span>
                        </div>
                    </div>

                    <div class="w-full md:w-1/2 space-y-4">
                        <div>
                            <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Título Principal</h4>
                            <p id="modal_titulo" class="text-xl font-bold text-gray-800 leading-tight"></p>
                        </div>

                        <div>
                            <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Descripción</h4>
                            <p id="modal_descripcion" class="text-sm text-gray-600 leading-relaxed"></p>
                        </div>

                        <div class="pt-4 border-t border-gray-100">
                            <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Botón de Acción</h4>
                            <div class="bg-indigo-50 rounded-lg p-4 text-center border border-indigo-100 border-dashed">
                                <a id="modal_btn" href="#" target="_blank" class="inline-block px-4 py-2 bg-indigo-600 text-white rounded-md text-sm font-medium hover:bg-indigo-700 transition shadow-sm">
                                    Ver más
                                </a>
                                <div class="mt-2 text-[10px] text-indigo-400 truncate" id="modal_link_text"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-gray-50 px-6 py-3 border-t border-gray-100 flex justify-end gap-2">
                <button type="button" onclick="cerrarModal()" 
                    class="px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm font-medium transition shadow-sm">
                    Cerrar
                </button>
            </div>
            
            <div id="modalLoader" class="absolute inset-0 bg-white flex flex-col items-center justify-center z-10 hidden">
                <div class="w-10 h-10 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin mb-3"></div>
                <p class="text-sm text-gray-500 font-medium">Cargando detalles...</p>
            </div>

        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
$(document).ready(function () {
    $('#tablaCarrusel').DataTable({
        responsive: true,
        pageLength: 10,
        lengthMenu: [5, 10, 25, 50],
        order: [[1, 'asc']],
        language: {
            url: "//cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json"
        },
        columnDefs: [ { orderable: false, targets: [0, 5] } ]
    });
});
</script>

<style>
.dataTables_wrapper select, .dataTables_wrapper input {
    border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 0.25rem 0.5rem; margin: 0 0.25rem;
}
.dataTables_wrapper .dataTables_paginate .paginate_button {
    padding: 0.25rem 0.75rem; margin: 0 0.125rem; border-radius: 0.5rem; cursor: pointer;
}
.dataTables_wrapper .dataTables_paginate .paginate_button.current {
    background: #4f46e5; color: white !important; border: 1px solid #4f46e5;
}
</style>

<script>
// --- Lógica del Modal ---
function verCarrusel(id) {
    const modal = document.getElementById('viewModal');
    const loader = document.getElementById('modalLoader');
    
    // Mostrar modal y loader
    modal.classList.remove('hidden');
    loader.classList.remove('hidden');

    // Petición AJAX
    fetch(`/admin/carousel/show/${id}`)
        .then(response => response.json())
        .then(res => {
            if(res.success) {
                const data = res.data;
                
                // Llenar datos
                document.getElementById('modal_titulo').textContent = data.titulo;
                document.getElementById('modal_descripcion').textContent = data.descripcion || "Sin descripción";
                document.getElementById('modal_tipo').textContent = data.tipo;
                
                // Imagen
                console.log(data);
                const imgPath = data.imagen; 
                document.getElementById('modal_img').src = imgPath;
                
                // Estado badge
                const badge = document.getElementById('modal_estado');
                if(data.activo) {
                    badge.className = "px-2 py-1 rounded text-[10px] font-bold uppercase shadow-sm bg-green-100 text-green-700";
                    badge.textContent = "Visible";
                } else {
                    badge.className = "px-2 py-1 rounded text-[10px] font-bold uppercase shadow-sm bg-gray-100 text-gray-600";
                    badge.textContent = "Oculto";
                }

                // Botón
                const btn = document.getElementById('modal_btn');
                const linkText = document.getElementById('modal_link_text');
                btn.textContent = data.btn_texto || "Ver más";
                btn.href = data.btn_link || "#";
                linkText.textContent = data.btn_link || "Sin enlace configurado";

                // Ocultar loader
                loader.classList.add('hidden');
            } else {
                Swal.fire('Error', 'No se pudieron cargar los datos', 'error');
                cerrarModal();
            }
        })
        .catch(err => {
            console.error(err);
            Swal.fire('Error', 'Error de conexión', 'error');
            cerrarModal();
        });
}

function cerrarModal() {
    document.getElementById('viewModal').classList.add('hidden');
    // Limpiar imagen para que no parpadee la anterior al reabrir
    document.getElementById('modal_img').src = "";
}

// --- Lógica de Eliminación ---
function eliminarCarrusel(id) {
    Swal.fire({
        title: '¿Eliminar publicación?',
        text: 'Esta acción no se puede deshacer.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc2626',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            // Usando fetch para hacer la eliminación más suave (sin redirección brusca si prefieres, o manteniendo la redirección actual)
            fetch(`/admin/carousel/delete/${id}`, { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if(data.success) {
                        Swal.fire('Eliminado', 'Registro eliminado correctamente', 'success')
                        .then(() => location.reload());
                    } else {
                        Swal.fire('Error', data.error || 'No se pudo eliminar', 'error');
                    }
                });
        }
    });
}

function abrirEditorPro(tipo, slug) {
    const url = `/admin/disenador?tipo=${tipo}&slug=${slug}`;
    const width = window.screen.width * 0.9;
    const height = window.screen.height * 0.85;
    const left = (window.screen.width - width) / 2;
    const top = (window.screen.height - height) / 2;

    window.open(url, 'EditorPyme', `width=${width},height=${height},top=${top},left=${left},scrollbars=yes,resizable=yes`);
}
</script>

{% endblock %}