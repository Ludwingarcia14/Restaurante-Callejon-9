{% extends "layout/layout_cliente.html" %}
{% block title %}Historial de Créditos{% endblock %}

{% block content %}

<!-- CONTENIDO -->
  <div class="max-w-6xl mx-auto mt-10 p-6 bg-white rounded-3xl shadow-xl">

    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">


      <!-- FILTROS -->
      <div class="flex flex-wrap gap-4 items-center">
        <select id="filtro-fecha" class="p-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
          <option value="todo">Todos</option>
          <option value="semana">Última semana</option>
          <option value="mes">Último mes</option>
          <option value="año">Último año</option>
        </select>

        <select id="filtro-estado" class="p-2 border rounded-lg focus:ring-2 focus:ring-green-500">
          <option value="todo">Todos los estados</option>
          <option value="Pendiente">Pendiente</option>
          <option value="Aprobado">Aprobado</option>
          <option value="Rechazado">Rechazado</option>
        </select>

        <input type="text" id="buscar-asesor" placeholder="Buscar por asesor..." 
               class="p-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
      </div>
    </div>

    <!-- TABLA DE SOLICITUDES -->
    <div class="overflow-x-auto">
      <table class="w-full table-auto border-collapse shadow-md rounded-lg overflow-hidden bg-white">
        <thead>
          <tr class="bg-gradient-to-r from-blue-600 to-green-600 text-white">
            <th class="border p-3">Monto</th>
            <th class="border p-3">Plazo</th>
            <th class="border p-3">Interés</th>
            <th class="border p-3">Nombre Asesor</th>
            <th class="border p-3">Teléfono Asesor</th>
            <th class="border p-3">Correo Asesor</th>
            <th class="border p-3">Estado</th>
          </tr>
        </thead>
        <tbody id="tabla-body">
          {% for s in solicitudes %}
          <tr class="text-center hover:bg-blue-50 transition" 
              data-fecha="{{ s.fecha }}" 
              data-asesor="{{ s.nombre_asesor | lower }}" 
              data-estado="{{ s.estado }}">
            <td class="border p-2">{{ s.monto }}</td>
            <td class="border p-2">{{ s.plazo }}</td>
            <td class="border p-2">{{ s.interes }}</td>
            <td class="border p-2">{{ s.nombre_asesor }}</td>
            <td class="border p-2">{{ s.telefono_asesor }}</td>
            <td class="border p-2">{{ s.correo_asesor }}</td>
            <td class="border p-2">{{ s.estado }}</td>
          </tr>
          {% else %}
          <tr>
            <td colspan="8" class="border p-2 text-center text-gray-500">No tienes solicitudes aún.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const filtroFecha = document.getElementById('filtro-fecha');
    const filtroEstado = document.getElementById('filtro-estado');
    const buscador = document.getElementById('buscar-asesor');
    const tablaBody = document.getElementById('tabla-body');

    function filtrarTabla() {
      const fechaFiltro = filtroFecha.value;
      const estadoFiltro = filtroEstado.value;
      const busqueda = buscador.value.toLowerCase();
      const filas = tablaBody.querySelectorAll('tr');

      const ahora = new Date();

      filas.forEach(fila => {
        const fechaStr = fila.getAttribute('data-fecha');
        const asesor = fila.getAttribute('data-asesor');
        const estado = fila.getAttribute('data-estado');
        let mostrar = true;

        // FILTRAR POR FECHA
        if (fechaFiltro !== 'todo' && fechaStr) {
          const fecha = new Date(fechaStr);
          let limite;
          if (fechaFiltro === 'semana') limite = new Date(ahora.getTime() - 7*24*60*60*1000);
          if (fechaFiltro === 'mes') limite = new Date(ahora.getTime() - 30*24*60*60*1000);
          if (fechaFiltro === 'año') limite = new Date(ahora.getTime() - 365*24*60*60*1000);
          if (fecha < limite) mostrar = false;
        }

        // FILTRAR POR ESTADO
        if (estadoFiltro !== 'todo' && estado !== estadoFiltro) mostrar = false;

        // FILTRAR POR ASESOR
        if (busqueda && !asesor.includes(busqueda)) mostrar = false;

        fila.style.display = mostrar ? '' : 'none';
      });
    }

    filtroFecha.addEventListener('change', filtrarTabla);
    filtroEstado.addEventListener('change', filtrarTabla);
    buscador.addEventListener('input', filtrarTabla);
  </script>

{% endblock %}