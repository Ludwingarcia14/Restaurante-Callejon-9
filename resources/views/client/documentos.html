{% extends "layout/layout_cliente.html" %}
{% block title %}Gestión de Documentos{% endblock %}

{% block content %}

<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

<style>
    /* --- Estilos Modernos Base --- */
    :root {
        --corp-blue: #4f46e5;
        --corp-bg-success: #f0fdf4;
        --corp-text-success: #15803d;
        --corp-border-success: #10b981;
    }

    .card-modern {
        background: white;
        border-radius: 1rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        border: 1px solid #e2e8f0;
        overflow: hidden;
    }

    /* Dropzone (IA) */
    .dropzone-modern {
        border: 2px dashed #cbd5e1;
        border-radius: 1rem;
        background-color: #f8fafc;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }
    .dropzone-modern:hover { border-color: var(--corp-blue); background-color: #eef2ff; }
    .dropzone-modern.dragover { border-color: var(--corp-blue); background-color: #eef2ff; transform: scale(1.01); }

    /* Inputs de Archivo */
    .file-card-input {
        border: 1px solid #e2e8f0;
        border-radius: 0.75rem;
        padding: 1rem;
        transition: all 0.2s;
        cursor: pointer;
        background: #fff;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        position: relative;
    }
    .file-card-input:hover {
        border-color: var(--corp-blue);
        box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.1);
        transform: translateY(-2px);
    }
    
    /* Estado: Ya Subido (Persistencia Visual) */
    .file-card-input.already-uploaded {
        border-color: var(--corp-border-success);
        background-color: var(--corp-bg-success);
    }
    .file-card-input.already-uploaded .file-icon-box {
        background-color: #dcfce7;
        color: var(--corp-text-success);
    }
    .file-card-input.already-uploaded .nombre-archivo {
        color: var(--corp-text-success);
        font-weight: 600;
    }

    /* Header del Input */
    .file-card-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        width: 100%;
    }

    .file-icon-box {
        width: 40px; height: 40px;
        border-radius: 0.5rem;
        background: #f1f5f9;
        color: #64748b;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.25rem;
        transition: all 0.2s;
        flex-shrink: 0;
    }
    .file-card-input:hover .file-icon-box {
        background: #e0e7ff; color: var(--corp-blue);
    }
    /* Estado local (recién seleccionado) */
    .file-uploaded .file-icon-box {
        background: #dcfce7; color: var(--corp-text-success);
    }

    /* Lista de Archivos Seleccionados */
    .file-list-display {
        width: 100%;
        margin-top: 0.5rem;
        border-top: 1px solid #f1f5f9;
        padding-top: 0.5rem;
    }
    .file-item-mini {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        font-size: 0.75rem;
        color: #475569;
        background: #f8fafc;
        padding: 0.35rem 0.5rem;
        border-radius: 0.35rem;
        margin-bottom: 0.25rem;
        border: 1px solid #e2e8f0;
        transition: all 0.2s;
    }
    .file-item-mini:hover { background: #fff; border-color: #cbd5e1; }
    
    .btn-delete-file {
        color: #ef4444; cursor: pointer; padding: 4px; border-radius: 4px; transition: background 0.2s;
    }
    .btn-delete-file:hover { background-color: #fee2e2; }

    /* Checklist */
    .checklist-item { transition: all 0.3s ease; }
    .checklist-item.completed .icon-check {
        color: #10b981; background-color: #d1fae5; border-color: #10b981;
    }
    .checklist-item.completed span {
        color: #064e3b; font-weight: 600; text-decoration: line-through; text-decoration-color: #10b981;
    }

    /* Tabs */
    .tab-btn { border-bottom: 2px solid transparent; color: #64748b; font-weight: 500; transition: all 0.2s; }
    .tab-btn:hover { color: var(--corp-blue); }
    .tab-btn.active { border-color: var(--corp-blue); color: var(--corp-blue); font-weight: 600; }

    /* Animaciones */
    .fade-up { animation: fadeUp 0.5s ease-out forwards; opacity: 0; transform: translateY(15px); }
    @keyframes fadeUp { to { opacity: 1; transform: translateY(0); } }
    .hidden { display: none !important; }
</style>

<div class="max-w-6xl mx-auto p-6 fade-up">

    <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                <i class="ri-folder-shield-2-line" style="color: var(--corp-blue);"></i> Expediente Digital
            </h1>
            <p class="text-sm text-gray-500 mt-1">Sube y gestiona tu documentación para trámites.</p>
        </div>
        <button type="button" onclick="abrirModal()" 
                class="px-5 py-2.5 bg-white border border-gray-200 text-gray-700 rounded-xl shadow-sm hover:bg-gray-50 hover:text-indigo-600 transition font-medium flex items-center gap-2">
            <i class="ri-history-line"></i> Ver Historial Completo
        </button>
    </div>

    <div id="ventana-mensaje" class="fixed bottom-5 right-5 p-4 rounded-xl shadow-lg text-white z-50 text-sm transform scale-0 transition-transform duration-300 flex items-center gap-2"></div>

    <div class="card-modern p-8 mb-8">
        <div class="flex items-start gap-4 mb-6">
            <div class="w-10 h-10 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center flex-shrink-0 font-bold" style="background-color: #e0e7ff; color: var(--corp-blue);">1</div>
            <div>
                <h2 class="text-lg font-bold text-gray-800">Análisis Inteligente</h2>
                <p class="text-sm text-gray-500">Sube tu Constancia de Situación Fiscal (PDF) para detectar automáticamente qué documentos necesitas.</p>
            </div>
        </div>

        <form id="iaForm" enctype="multipart/form-data">
            <div id="dropzone" class="dropzone-modern p-10 flex flex-col items-center justify-center text-center group"
                 ondragover="event.preventDefault(); this.classList.add('dragover');" 
                 ondragleave="event.preventDefault(); this.classList.remove('dragover');" 
                 onclick="document.getElementById('pdfFile').click();">
                <div class="mb-3 text-gray-400 group-hover:text-indigo-500 transition-colors duration-300 group-hover:scale-110 transform">
                    <i class="ri-file-pdf-line text-5xl"></i>
                </div>
                <h3 class="text-sm font-semibold text-gray-700 group-hover:text-indigo-600">Arrastra tu Constancia aquí</h3>
                <p class="text-xs text-gray-400 mt-1" id="dropzoneText">o haz clic para seleccionar</p>
            </div>
            <input type="file" id="pdfFile" name="pdf_file" accept=".pdf" class="hidden" required>
            <div class="mt-4 text-right">
                <button type="submit" class="px-6 py-2.5 text-white rounded-lg hover:bg-indigo-700 transition shadow-lg shadow-indigo-200 font-medium disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 ml-auto" style="background-color: var(--corp-blue);">
                    <i class="ri-magic-line"></i> Analizar Documento
                </button>
            </div>
        </form>
        <div id="resultado" class="mt-6"></div>
    </div>

    <div id="document-upload-section" class="card-modern p-8 hidden fade-up">
        <div class="flex items-start gap-4 mb-6 border-b border-gray-100 pb-4">
            <div class="w-10 h-10 rounded-full bg-emerald-50 text-emerald-600 flex items-center justify-center flex-shrink-0 font-bold">2</div>
            <div>
                <h2 class="text-lg font-bold text-gray-800">Carga de Expediente</h2>
                <p class="text-sm text-gray-500">Sube los archivos correspondientes. Los marcados en verde ya están en sistema.</p>
            </div>
        </div>

        <form id="documentUploadForm" method="POST" enctype="multipart/form-data" class="lg:grid lg:grid-cols-3 lg:gap-8" action="{{ url_for('routes.subir_documentos') }}">
            
            <div class="lg:col-span-2">
                
                {% set docs_fisica = {
                    "INE Representante Legal": "ine_fisica",
                    "Comprobante de Domicilio": "domicilio_fisica",
                    "Constancia de Situación Fiscal": "situacion_fiscal_fisica",
                    "Buró de Crédito": "buro_credito_fisica",
                    "6 Últimos Estados de Cuenta": "estados_cuenta_fisica",
                    "Declaración Anual 2023 y 2024": "declaracion_anual_fisica",
                    "Estados Financieros 2023/2024": "estados_financieros_fisica"
                } %}

                {% set docs_moral = {
                    "INE Representante Legal": "ine_moral",
                    "Comprobante de Domicilio": "domicilio_moral",
                    "Constancia de Situación Fiscal": "situacion_fiscal_moral",
                    "Buró de Crédito": "buro_credito_moral",
                    "Acta Constitutiva": "acta_constitutiva_moral",
                    "Poderes Notariales": "poderes_notariales_moral",
                    "Declaración Anual 2023 y 2024": "declaracion_anual_moral",
                    "Estados Financieros 2023/2024": "estados_financieros_moral",
                    "6 Últimos Estados de Cuenta": "estados_cuenta_moral"
                } %}

                <div id="fisica-form" class="hidden space-y-4">
                    <div class="bg-blue-50 text-blue-800 px-4 py-2 rounded-lg text-sm font-medium mb-4 inline-flex items-center gap-2">
                        <i class="ri-user-line"></i> Régimen: Persona Física
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {% for nombre, field in docs_fisica.items() %}
                            
                            {% set field_clean = field.replace('_fisica', '') %}
                            
                            {% set real_exists = false %}
                            {% if doc_fisica and doc_fisica|attr(field_clean) %}
                                {% set real_exists = true %}
                            {% endif %}

                            {% set show_input_success = real_exists %}
                            {% if 'estados_cuenta' in field %}
                                {% set show_input_success = false %}
                            {% endif %}

                            <label class="file-card-input group {% if show_input_success %}already-uploaded{% endif %}" id="label-{{ field }}">
                                <div class="file-card-header">
                                    <div class="file-icon-box">
                                        {% if show_input_success %} <i class="ri-check-double-line"></i> {% else %} <i class="ri-upload-cloud-line"></i> {% endif %}
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-semibold text-gray-700 truncate">{{ nombre }}</p>
                                        <p class="text-xs text-gray-400 nombre-archivo truncate">
                                            {% if show_input_success %}
                                                Archivo cargado previamente
                                            {% else %}
                                                {% if 'estados_cuenta' in field %}
                                                    Seleccionar hasta 6 archivos...
                                                {% else %}
                                                    Seleccionar archivo...
                                                {% endif %}
                                            {% endif %}
                                        </p>
                                    </div>
                                </div>
                                <div class="file-list-display hidden" id="list-{{ field }}"></div>

                                <input type="file" name="{{ field }}" id="input-{{ field }}" class="hidden" 
                                       onchange="actualizarArchivo(this, '{{ field }}')"
                                       {% if 'estados_cuenta' in field %} multiple {% endif %}
                                       onclick="this.value=null;">
                            </label>
                        {% endfor %}
                    </div>
                </div>

                <div id="moral-form" class="hidden space-y-4">
                    <div class="bg-purple-50 text-purple-800 px-4 py-2 rounded-lg text-sm font-medium mb-4 inline-flex items-center gap-2">
                        <i class="ri-building-line"></i> Régimen: Persona Moral
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {% for nombre, field in docs_moral.items() %}
                            
                            {% set field_clean = field.replace('_moral', '') %}
                            
                            {% set real_exists = false %}
                            {% if doc_moral and doc_moral|attr(field_clean) %}
                                {% set real_exists = true %}
                            {% endif %}

                            {% set show_input_success = real_exists %}
                            {% if 'estados_cuenta' in field %}
                                {% set show_input_success = false %}
                            {% endif %}

                            <label class="file-card-input group {% if show_input_success %}already-uploaded{% endif %}" id="label-{{ field }}">
                                <div class="file-card-header">
                                    <div class="file-icon-box">
                                        {% if show_input_success %} <i class="ri-check-double-line"></i> {% else %} <i class="ri-upload-cloud-line"></i> {% endif %}
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-semibold text-gray-700 truncate">{{ nombre }}</p>
                                        <p class="text-xs text-gray-400 nombre-archivo truncate">
                                            {% if show_input_success %}
                                                Archivo cargado previamente
                                            {% else %}
                                                {% if 'estados_cuenta' in field %}
                                                    Seleccionar hasta 6 archivos...
                                                {% else %}
                                                    Seleccionar archivo...
                                                {% endif %}
                                            {% endif %}
                                        </p>
                                    </div>
                                </div>
                                <div class="file-list-display hidden" id="list-{{ field }}"></div>

                                <input type="file" name="{{ field }}" id="input-{{ field }}" class="hidden" 
                                       onchange="actualizarArchivo(this, '{{ field }}')"
                                       {% if 'estados_cuenta' in field %} multiple {% endif %}
                                       onclick="this.value=null;">
                            </label>
                        {% endfor %}
                    </div>
                </div>

                <div class="mt-8 pt-4 border-t border-gray-100 flex justify-end">
                    <button type="submit" class="px-8 py-3 bg-emerald-600 text-white rounded-xl shadow-lg shadow-emerald-200 hover:bg-emerald-700 transition font-bold flex items-center gap-2 w-full md:w-auto justify-center">
                        <i class="ri-upload-2-line"></i> Actualizar Expediente
                    </button>
                </div>
            </div>

            <div class="mt-6 lg:mt-0">
                <div class="bg-gray-50 border border-gray-200 rounded-xl p-5 sticky top-5 shadow-sm">
                    <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2 text-lg">
                        <i class="ri-list-check" style="color: var(--corp-blue);"></i> Checklist
                    </h3>
                    
                    <ul id="checklist-fisica" class="hidden space-y-3">
                        {% for nombre, field in docs_fisica.items() %}
                            {% set field_clean = field.replace('_fisica', '') %}
                            
                            {% set real_exists = false %}
                            {% if doc_fisica and doc_fisica|attr(field_clean) %}
                                {% set real_exists = true %}
                            {% endif %}
                            
                            <li id="check-{{ field }}" class="checklist-item flex items-center gap-3 p-2 rounded-lg hover:bg-white transition-colors {% if real_exists %}completed bg-emerald-50{% endif %}">
                                <div class="icon-check w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center text-transparent transition-all">
                                    <i class="ri-check-line text-sm"></i>
                                </div>
                                <span class="text-sm text-gray-600">{{ nombre }}</span>
                            </li>
                        {% endfor %}
                    </ul>

                    <ul id="checklist-moral" class="hidden space-y-3">
                        {% for nombre, field in docs_moral.items() %}
                            {% set field_clean = field.replace('_moral', '') %}
                            
                            {% set real_exists = false %}
                            {% if doc_moral and doc_moral|attr(field_clean) %}
                                {% set real_exists = true %}
                            {% endif %}

                            <li id="check-{{ field }}" class="checklist-item flex items-center gap-3 p-2 rounded-lg hover:bg-white transition-colors {% if real_exists %}completed bg-emerald-50{% endif %}">
                                <div class="icon-check w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center text-transparent transition-all">
                                    <i class="ri-check-line text-sm"></i>
                                </div>
                                <span class="text-sm text-gray-600">{{ nombre }}</span>
                            </li>
                        {% endfor %}
                    </ul>

                    <div class="mt-6">
                        <div class="flex justify-between text-xs font-semibold text-gray-600 mb-1">
                            <span>Progreso</span>
                            <span id="progress-text">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div id="progress-bar" class="h-2.5 rounded-full transition-all duration-500" style="width: 0%; background-color: var(--corp-blue);"></div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<div id="modal-historial" class="hidden fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex justify-center items-center z-50 transition-opacity">
    <div class="bg-white w-11/12 max-w-4xl rounded-2xl shadow-2xl overflow-hidden animate-fadeIn">
        <div class="flex justify-between items-center px-6 py-4 border-b border-gray-100">
            <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                <i class="ri-archive-line" style="color: var(--corp-blue);"></i> Historial de Documentos
            </h2>
            <button onclick="cerrarModal()" class="text-gray-400 hover:text-red-500 transition p-1 rounded-full hover:bg-red-50"><i class="ri-close-line text-2xl"></i></button>
        </div>
        <div class="flex border-b border-gray-100">
            <button id="btn-fisica" onclick="cambiarTab('fisica')" class="flex-1 py-3 text-sm font-medium text-center tab-btn active">Persona Física</button>
            <button id="btn-moral" onclick="cambiarTab('moral')" class="flex-1 py-3 text-sm font-medium text-center tab-btn">Persona Moral</button>
        </div>
        <div class="p-6 max-h-[60vh] overflow-y-auto bg-gray-50">
            <div id="tab-fisica">
                {% if doc_fisica and doc_fisica.docs %}
                    <div class="grid gap-3">
                        {% for key, doc_info in doc_fisica.docs.items() %}
                        {% if doc_info.ruta %}
                        <div class="bg-white p-4 rounded-xl border border-gray-200 flex justify-between items-center shadow-sm hover:shadow-md transition">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-lg bg-red-50 text-red-500 flex items-center justify-center"><i class="ri-file-pdf-2-fill text-xl"></i></div>
                                <div><p class="text-sm font-bold text-gray-700">{{ key.replace('_fisica', '').replace('_', ' ')|capitalize }}</p><p class="text-xs text-gray-400">{{ doc_info.fecha_subida.strftime('%d/%m/%Y %H:%M') }}</p></div>
                            </div>
                            <div class="flex gap-2">
                                <a href="{{ url_for('static', filename=doc_info.ruta.split('static/')[-1]) }}" target="_blank" class="p-2 text-gray-500 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition"><i class="ri-eye-line"></i></a>
                                <a href="{{ url_for('static', filename=doc_info.ruta.split('static/')[-1]) }}" download class="p-2 text-gray-500 hover:text-emerald-600 hover:bg-emerald-50 rounded-lg transition"><i class="ri-download-line"></i></a>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                {% else %}<div class="text-center py-10 text-gray-400"><i class="ri-folder-open-line text-4xl mb-2 block"></i> Sin documentos físicos.</div>{% endif %}
            </div>
            <div id="tab-moral" class="hidden">
                {% if doc_moral and doc_moral.docs %}
                    <div class="grid gap-3">
                        {% for key, doc_info in doc_moral.docs.items() %}
                        {% if doc_info.ruta %}
                        <div class="bg-white p-4 rounded-xl border border-gray-200 flex justify-between items-center shadow-sm hover:shadow-md transition">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-lg bg-red-50 text-red-500 flex items-center justify-center"><i class="ri-file-pdf-2-fill text-xl"></i></div>
                                <div><p class="text-sm font-bold text-gray-700">{{ key.replace('_moral', '').replace('_', ' ')|capitalize }}</p><p class="text-xs text-gray-400">{{ doc_info.fecha_subida.strftime('%d/%m/%Y %H:%M') }}</p></div>
                            </div>
                            <div class="flex gap-2">
                                <a href="{{ url_for('static', filename=doc_info.ruta.split('static/')[-1]) }}" target="_blank" class="p-2 text-gray-500 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition"><i class="ri-eye-line"></i></a>
                                <a href="{{ url_for('static', filename=doc_info.ruta.split('static/')[-1]) }}" download class="p-2 text-gray-500 hover:text-emerald-600 hover:bg-emerald-50 rounded-lg transition"><i class="ri-download-line"></i></a>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                {% else %}<div class="text-center py-10 text-gray-400"><i class="ri-folder-open-line text-4xl mb-2 block"></i> Sin documentos morales.</div>{% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    // --- UI Logic ---
    function abrirModal() { document.getElementById("modal-historial").classList.remove("hidden"); cambiarTab("fisica"); }
    function cerrarModal() { document.getElementById("modal-historial").classList.add("hidden"); }

    function cambiarTab(tab) {
        document.getElementById("tab-fisica").classList.toggle("hidden", tab !== "fisica");
        document.getElementById("tab-moral").classList.toggle("hidden", tab !== "moral");
        document.getElementById("checklist-fisica").classList.toggle("hidden", tab !== "fisica");
        document.getElementById("checklist-moral").classList.toggle("hidden", tab !== "moral");
        
        const btnF = document.getElementById("btn-fisica");
        const btnM = document.getElementById("btn-moral");
        
        if(tab === 'fisica') {
            btnF.classList.add('active', 'border-indigo-600', 'text-indigo-600'); btnF.classList.remove('border-transparent', 'text-gray-500');
            btnM.classList.remove('active', 'border-indigo-600', 'text-indigo-600'); btnM.classList.add('border-transparent', 'text-gray-500');
        } else {
            btnM.classList.add('active', 'border-indigo-600', 'text-indigo-600'); btnM.classList.remove('border-transparent', 'text-gray-500');
            btnF.classList.remove('active', 'border-indigo-600', 'text-indigo-600'); btnF.classList.add('border-transparent', 'text-gray-500');
        }
        calcularProgreso(); 
    }

    // --- MANEJO DE ARCHIVOS CON ELIMINACIÓN ---
    function actualizarArchivo(input, fieldName) {
        const label = document.getElementById('label-' + fieldName);
        const texto = label.querySelector(".nombre-archivo");
        const iconBox = label.querySelector(".file-icon-box");
        const listDisplay = document.getElementById('list-' + fieldName);
        const checkItem = document.getElementById('check-' + fieldName);
        
        // 1. Validaciones
        if (fieldName.includes('estados_cuenta') && input.files.length > 6) {
            mostrarMensaje('error', 'Máximo 6 estados de cuenta permitidos.');
            input.value = ''; 
            texto.textContent = "Seleccionar hasta 6 archivos...";
            listDisplay.classList.add('hidden'); listDisplay.innerHTML = '';
            label.classList.remove("already-uploaded", "bg-emerald-50", "border-emerald-200");
            iconBox.innerHTML = '<i class="ri-upload-cloud-line"></i>';
            if(checkItem) checkItem.classList.remove('completed', 'bg-emerald-50');
            calcularProgreso();
            return;
        }

        // 2. Renderizado
        if (input.files.length > 0) {
            label.classList.remove("already-uploaded"); // Quitamos estilo antiguo si existe
            label.classList.add("file-uploaded", "border-emerald-200", "bg-emerald-50");
            iconBox.innerHTML = '<i class="ri-checkbox-circle-line"></i>';
            texto.classList.add("text-emerald-600", "font-medium");
            
            if (input.files.length === 1) {
                texto.textContent = input.files[0].name;
            } else {
                texto.textContent = `${input.files.length} archivos seleccionados`;
            }

            listDisplay.innerHTML = '';
            listDisplay.classList.remove('hidden');
            
            Array.from(input.files).forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'file-item-mini';
                item.innerHTML = `
                    <div class="flex items-center gap-2 truncate">
                        <i class="ri-file-pdf-line text-red-500"></i> 
                        <span class="truncate" title="${file.name}">${file.name}</span>
                    </div>
                    <button type="button" class="btn-delete-file" onclick="borrarArchivo('${fieldName}', ${index}, event)">
                        <i class="ri-delete-bin-line"></i>
                    </button>
                `;
                listDisplay.appendChild(item);
            });

            if(checkItem) checkItem.classList.add('completed', 'bg-emerald-50');

        } else {
            // Reset
            texto.textContent = fieldName.includes('estados_cuenta') ? "Seleccionar hasta 6 archivos..." : "Seleccionar archivo...";
            texto.classList.remove("text-emerald-600", "font-medium");
            label.classList.remove("file-uploaded", "border-emerald-200", "bg-emerald-50");
            
            // Si NO tenía clase already-uploaded antes, reseteamos icono
            if (!label.classList.contains('already-uploaded')) {
                iconBox.innerHTML = '<i class="ri-upload-cloud-line"></i>';
                if(checkItem) checkItem.classList.remove('completed', 'bg-emerald-50');
            } else {
                // Si ya estaba subido, restauramos mensaje
                texto.textContent = "Archivo cargado previamente";
                texto.classList.add("text-emerald-600", "font-medium");
            }
            
            listDisplay.classList.add('hidden');
            listDisplay.innerHTML = '';
        }
        calcularProgreso();
    }

    function borrarArchivo(fieldName, fileIndex, event) {
        if(event) event.stopPropagation(); 
        if(event) event.preventDefault();
        const input = document.getElementById('input-' + fieldName);
        const dt = new DataTransfer();
        Array.from(input.files).forEach((file, i) => { if (i !== fileIndex) dt.items.add(file); });
        input.files = dt.files;
        actualizarArchivo(input, fieldName);
    }

    function calcularProgreso() {
        const fisicaVisible = !document.getElementById('checklist-fisica').classList.contains('hidden');
        const listaId = fisicaVisible ? 'checklist-fisica' : 'checklist-moral';
        const items = document.querySelectorAll(`#${listaId} .checklist-item`);
        
        let completados = 0;
        items.forEach(item => {
            if(item.classList.contains('completed')) completados++;
        });

        const porcentaje = items.length > 0 ? Math.round((completados / items.length) * 100) : 0;
        
        document.getElementById('progress-bar').style.width = porcentaje + '%';
        document.getElementById('progress-text').textContent = porcentaje + '%';
        
        const bar = document.getElementById('progress-bar');
        if(porcentaje === 100) {
            bar.classList.remove('bg-indigo-600');
            bar.classList.add('bg-emerald-500');
        } else {
            bar.classList.add('bg-indigo-600');
            bar.classList.remove('bg-emerald-500');
        }
    }

    function mostrarMensaje(tipo, texto) {
        const ventana = document.getElementById("ventana-mensaje");
        const icon = tipo === 'error' ? '<i class="ri-error-warning-fill text-lg"></i>' : '<i class="ri-checkbox-circle-fill text-lg"></i>';
        ventana.innerHTML = `${icon} ${texto}`;
        ventana.className = `fixed bottom-5 right-5 p-4 rounded-xl shadow-lg text-white z-50 text-sm transform scale-0 transition-transform duration-300 flex items-center gap-3 ${tipo === 'error' ? 'bg-red-500' : 'bg-emerald-600'}`;
        setTimeout(() => ventana.classList.add("scale-100"), 10);
        setTimeout(() => ventana.classList.remove("scale-100"), 4000);
    }

    function resetFileNames() {
        // Reset visual parcial (mantiene lo persistente)
        document.querySelectorAll('.file-card-input').forEach(label => {
            if (!label.classList.contains('already-uploaded')) {
                label.querySelector('.nombre-archivo').textContent = "Seleccionar archivo...";
                label.classList.remove("file-uploaded", "border-emerald-200", "bg-emerald-50");
                label.querySelector('.file-icon-box').innerHTML = '<i class="ri-upload-cloud-line"></i>';
                const list = label.querySelector('.file-list-display');
                if(list) { list.innerHTML = ''; list.classList.add('hidden'); }
            }
        });
        calcularProgreso();
    }

    function mostrarResultadoAnalisis(analysis) {
        const { vigente, regimen_fiscal, regimenes, regimenes_fiscales, giro, actividades_economicas } = analysis;
        const formatearDato = (dato) => {
            if (!dato) return null;
            if (Array.isArray(dato)) return `<ul class="list-disc list-inside text-left mt-1 space-y-1 text-xs md:text-sm text-gray-700">${dato.map(item => `<li>${item}</li>`).join('')}</ul>`;
            return `<span class="text-sm font-medium text-gray-800">${dato}</span>`;
        };
        const rawRegimenes = regimenes_fiscales || regimenes || regimen_fiscal;
        const rawActividades = actividades_economicas || giro;
        const regimenDisplay = formatearDato(rawRegimenes) || 'No detectado';
        const actividadDisplay = formatearDato(rawActividades) || 'No detectada';

        const html = `
            <div class="bg-gray-50 rounded-xl p-6 border border-gray-200 mt-6 animate-fadeIn">
                <div class="flex items-center gap-3 mb-4 pb-4 border-b border-gray-200">
                    <i class="ri-file-search-fill text-2xl text-indigo-500"></i>
                    <h4 class="font-bold text-gray-800">Resultado del Análisis</h4>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div><p class="text-xs text-gray-500 uppercase font-bold mb-1">Vigencia</p><span class="px-2 py-1 rounded text-xs font-bold ${vigente === 'No' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">${vigente || 'Desconocido'}</span></div>
                    <div class="md:col-span-2"><p class="text-xs text-gray-500 uppercase font-bold mb-1">Régimen(es) Detectado(s)</p><div class="bg-white p-2 rounded border border-gray-100">${regimenDisplay}</div></div>
                    <div class="md:col-span-3"><p class="text-xs text-gray-500 uppercase font-bold mb-1">Actividades Económicas</p><div class="bg-white p-3 rounded border border-gray-200 max-h-40 overflow-y-auto">${actividadDisplay}</div></div>
                </div>
            </div>
        `;
        document.getElementById('resultado').innerHTML = html;
        const textoAnalisis = JSON.stringify(rawRegimenes || '').toLowerCase();
        if (textoAnalisis.includes('moral')) { 
            mostrarFormularioDocumentos('moral'); 
            mostrarMensaje('success', 'Régimen Moral detectado.'); 
        } else if (textoAnalisis.length > 5) { 
            mostrarFormularioDocumentos('fisica'); 
            mostrarMensaje('success', 'Régimen Físico detectado.'); 
        } else { 
            document.getElementById("document-upload-section").classList.add("hidden"); 
            mostrarMensaje('error', 'No se detectó el régimen claramente.'); 
        }
    }

    function mostrarFormularioDocumentos(tipo) {
        document.getElementById("fisica-form").classList.toggle("hidden", tipo !== "fisica");
        document.getElementById("moral-form").classList.toggle("hidden", tipo !== "moral");
        cambiarTab(tipo); // Esto actualiza checklist y progreso
        const section = document.getElementById("document-upload-section");
        section.classList.remove("hidden");
        section.scrollIntoView({ behavior: 'smooth' });
    }

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        const formIa = document.getElementById('iaForm');
        const docForm = document.getElementById('documentUploadForm');
        const fileInput = document.getElementById('pdfFile');
        const dropzone = document.getElementById('dropzone');
        const dropText = document.getElementById('dropzoneText');

        function updateDropzoneUI(filename) {
            dropText.innerHTML = `<span class="text-emerald-600 font-semibold"><i class="ri-check-line"></i> ${filename}</span>`;
            dropzone.classList.add('border-emerald-400', 'bg-emerald-50');
        }

        fileInput.addEventListener('change', () => { if(fileInput.files.length) updateDropzoneUI(fileInput.files[0].name); });
        dropzone.addEventListener('drop', (e) => {
            e.preventDefault(); dropzone.classList.remove('dragover', 'border-blue-500');
            if(e.dataTransfer.files.length) { fileInput.files = e.dataTransfer.files; updateDropzoneUI(e.dataTransfer.files[0].name); }
        });

        formIa.addEventListener('submit', async e => {
            e.preventDefault(); if (!fileInput.files[0]) return mostrarMensaje('error', 'Selecciona un archivo PDF.');
            const btn = formIa.querySelector('button'); const oldHtml = btn.innerHTML; btn.disabled = true; btn.innerHTML = '<i class="ri-loader-4-line animate-spin"></i> Analizando...';
            try {
                const res = await fetch('{{ url_for("routes.ia_analize") }}', { method: 'POST', body: new FormData(formIa) });
                const json = await res.json();
                console.log(json);
                if (res.ok && json.analysis) mostrarResultadoAnalisis(json.analysis); else mostrarMensaje('error', json.error || 'Error al procesar.');
            } catch (error) { mostrarMensaje('error', 'Error de conexión.'); } finally { btn.disabled = false; btn.innerHTML = oldHtml; }
        });

        docForm.addEventListener('submit', async e => {
            e.preventDefault(); const btn = docForm.querySelector('button[type="submit"]'); const oldHtml = btn.innerHTML; btn.disabled = true; btn.innerHTML = '<i class="ri-loader-4-line animate-spin"></i> Subiendo...';
            try {
                const res = await fetch('{{ url_for("routes.subir_documentos") }}', { method: 'POST', body: new FormData(docForm) });
                const json = await res.json();
                if (res.ok && json.success) { mostrarMensaje('success', '¡Expediente actualizado!'); docForm.reset(); resetFileNames(); } else mostrarMensaje('error', json.error || 'Error al subir.');
            } catch { mostrarMensaje('error', 'Error de conexión.'); } finally { btn.disabled = false; btn.innerHTML = oldHtml; }
        });
        
        // Calcular progreso inicial (para mostrar archivos ya subidos)
        calcularProgreso();
    });
</script>

{% endblock %}