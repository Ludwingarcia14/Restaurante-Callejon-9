{% extends "layout/layout_cliente.html" %}
{% block title %}Panel de Solicitudes de Crédito{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto mt-6 space-y-6">

    {% if solicitudes %}
    {% set reciente = solicitudes[-1] %}
    <div class="bg-white p-6 rounded shadow border-l-4 border-blue-700">
        <h2 class="text-xl font-bold text-blue-700 mb-2">Tu solicitud más reciente</h2>
        <p><strong>Monto:</strong> {{ reciente.monto }}</p>
        <p><strong>Plazo:</strong> {{ reciente.plazo }} meses</p>
        <p><strong>Interés:</strong> {{ reciente.interes }}%</p>
        <p><strong>Asesor:</strong> {{ reciente.nombre_asesor }} ({{ reciente.telefono_asesor }}) correo: {{ reciente.correo_asesor }}</p>
        <p><strong>Estado:</strong> {{ reciente.estado }}</p>
        <button onclick="abrirModal('{{ reciente._id }}', '{{ reciente.monto }}', '{{ reciente.plazo }}', '{{ reciente.interes }}')"
                class="mt-3 px-4 py-2 rounded bg-blue-700 text-white hover:bg-blue-800 transition">Editar Solicitud</button>
    </div>
    {% endif %}

    <div class="flex gap-4 justify-center">
        <button onclick="document.getElementById('crearForm').classList.toggle('hidden')"
                class="px-6 py-4 rounded bg-blue-700 text-white font-bold hover:bg-blue-800 transition">Crear Nueva Solicitud</button>
        <button onclick="document.getElementById('tablaSolicitudes').classList.toggle('hidden')"
                class="px-6 py-4 rounded bg-blue-600 text-white font-bold hover:bg-blue-700 transition">Ver Todas las Solicitudes</button>
    </div>

    <form id="crearForm" method="POST" action="{{ url_for('routes.crear_credito') }}" class="hidden mt-6 space-y-4 bg-white p-6 rounded shadow">
        <h2 class="text-xl font-semibold mb-2 text-blue-700">Crear Nueva Solicitud</h2>
        <div>
            <label class="block font-semibold">Monto:</label>
            <input type="number" name="monto" class="w-full border rounded p-2 focus:ring-2 focus:ring-blue-500" required>
        </div>
        <div>
            <label class="block font-semibold">Plazo (meses):</label>
            <select name="plazo" class="w-full border rounded p-2 focus:ring-2 focus:ring-blue-500" required>
                <option value="" disabled selected>Selecciona un Plazo</option>
                <option value="6">6</option>
                <option value="12">12</option>
                <option value="24">24</option>
                <option value="36">36</option>
            </select>
        </div>
        <div>
            <label class="block font-semibold">Interés (%):</label>
            <select name="interes" class="w-full border rounded p-2 focus:ring-2 focus:ring-blue-500" required>
                <option value="" disabled selected>Selecciona el interes</option>
                <option value="5">5%</option>
                <option value="7.5">7.5%</option>
                <option value="10">10%</option>
            </select>
        </div>
        <button type="submit" class="bg-blue-700 text-white px-4 py-2 rounded hover:bg-blue-800 transition">Crear Solicitud</button>
    </form>

    <div id="tablaSolicitudes" class="hidden mt-6 overflow-x-auto">
        <table class="w-full table-auto border-collapse shadow-md rounded-lg overflow-hidden bg-white">
            <thead>
                <tr class="bg-blue-700 text-white">
                    <th class="border p-3">Monto</th>
                    <th class="border p-3">Plazo</th>
                    <th class="border p-3">Interés</th>
                    <th class="border p-3">Nombre Asesor</th>
                    <th class="border p-3">Teléfono Asesor</th>
                    <th class="border p-3">Correo Asesor</th>
                    <th class="border p-3">Estado</th>
                    <th class="border p-3">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for s in solicitudes %}
                <tr class="text-center hover:bg-blue-50 transition">
                    <td class="border p-2">{{ s.monto }}</td>
                    <td class="border p-2">{{ s.plazo }}</td>
                    <td class="border p-2">{{ s.interes }}</td>
                    <td class="border p-2">{{ s.nombre_asesor }}</td>
                    <td class="border p-2">{{ s.telefono_asesor }}</td>
                    <td class="border p-2">{{ s.correo_asesor }}</td>
                    <td class="border p-2">{{ s.estado }}</td>
                    <td class="border p-2 space-x-2">
                        <button type="button"
                                onclick="abrirModal('{{ s._id }}', '{{ s.monto }}', '{{ s.plazo }}', '{{ s.interes }}')"
                                class="text-blue-700 hover:underline">Editar</button>
                        <a href="{{ url_for('routes.eliminar_credito', solicitud_id=s._id) }}"
                                onclick="return confirm('¿Deseas eliminar esta solicitud?');"
                                class="text-red-700 hover:underline">Eliminar</a>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" class="border p-2 text-center text-gray-500">No tienes solicitudes aún.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

</div>

<div id="modalEditar" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded shadow-lg w-96 p-6 relative">
        <h2 class="text-xl font-semibold mb-4 text-blue-700">Editar Solicitud</h2>
        <form id="formEditar" method="POST">
            <div class="mb-3">
                <label class="block font-semibold">Monto:</label>
                <input type="number" id="modalMonto" name="monto" class="w-full border rounded p-2 focus:ring-2 focus:ring-blue-500" required>
            </div>
            <div class="mb-3">
                <label class="block font-semibold">Plazo (meses):</label>
                <select id="modalPlazo" name="plazo" class="w-full border rounded p-2 focus:ring-2 focus:ring-blue-500" required>
                    <option value="6">6</option>
                    <option value="12">12</option>
                    <option value="24">24</option>
                    <option value="36">36</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="block font-semibold">Interés (%):</label>
                <select id="modalInteres" name="interes" class="w-full border rounded p-2 focus:ring-2 focus:ring-blue-500" required>
                    <option value="5">5%</option>
                    <option value="7.5">7.5%</option>
                    <option value="10">10%</option>
                </select>
            </div>
            <div class="flex justify-end space-x-2 mt-4">
                <button type="button" onclick="cerrarModal()" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Cancelar</button>
                <button type="submit" class="px-4 py-2 rounded bg-blue-700 text-white hover:bg-blue-800">Guardar Cambios</button>
            </div>
        </form>
        <button onclick="cerrarModal()" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800 text-xl">&times;</button>
    </div>
</div>

<script>
const editarBaseUrl = "{{ url_for('routes.editar_credito', solicitud_id='__ID__') }}";

function abrirModal(id, monto, plazo, interes) {
    document.getElementById("modalEditar").classList.remove("hidden");
    document.getElementById("modalMonto").value = monto;
    document.getElementById("modalPlazo").value = plazo;
    document.getElementById("modalInteres").value = interes;
    document.getElementById("formEditar").action = editarBaseUrl.replace("__ID__", id);
}

function cerrarModal() {
    document.getElementById("modalEditar").classList.add("hidden");
}
</script>

{% endblock %}