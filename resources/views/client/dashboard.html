{% extends "layout/layout_cliente.html" %}
{% block title %}Resumen{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

<style>
    /* --- Enterprise Base Styles --- */
    :root {
        --primary-slate: #0f172a;
        --secondary-slate: #64748b;
        --border-color: #e2e8f0;
        --corp-blue: #4f46e5;      /* Indigo 600 */
        --corp-dark-blue: #3730a3; 
        --corp-light-blue: #e0e7ff;
    }

    body {
        background-color: #f8fafc;
        color: var(--primary-slate);
    }

    /* Card Standard */
    .ent-card {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        overflow: hidden;
        height: 100%; /* Para igualar alturas en grid */
    }

    /* --- TIMELINE STYLES --- */
    .timeline-container {
        position: relative;
        height: 12px;
        background-color: #f1f5f9;
        border-radius: 9999px;
        margin-top: 2rem;
        margin-bottom: 1rem;
    }
    .timeline-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--corp-blue) 0%, #6366f1 100%);
        border-radius: 9999px;
        position: relative;
        transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1);
        width: 0%;
        box-shadow: 0 2px 4px rgba(79, 70, 229, 0.3);
    }
    .timeline-marker {
        position: absolute;
        top: -40px;
        right: 0;
        background-color: var(--corp-blue);
        color: white;
        padding: 4px 12px;
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 700;
        transform: translateX(50%);
        box-shadow: 0 4px 10px rgba(79, 70, 229, 0.4);
    }
    .timeline-marker::after {
        content: '';
        position: absolute;
        bottom: -5px;
        left: 50%;
        transform: translateX(-50%);
        border-left: 6px solid transparent;
        border-right: 6px solid transparent;
        border-top: 6px solid var(--corp-blue);
    }

    /* Badges & Indicators */
    .badge { display: inline-flex; align-items: center; padding: 0.125rem 0.625rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
    .badge-success { background: #f0fdf4; color: #15803d; border: 1px solid #bbf7d0; }
    .badge-warning { background: #fffbeb; color: #b45309; border: 1px solid #fde68a; }
    .badge-danger  { background: #fef2f2; color: #b91c1c; border: 1px solid #fecaca; }

    .mop-indicator { width: 24px; height: 24px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; }
    .bg-mop-ok { background-color: #dcfce7; color: #166534; }
    .bg-mop-mid { background-color: #ffedd5; color: #9a3412; }
    .bg-mop-bad { background-color: #fee2e2; color: #991b1b; }

    /* Tables */
    .ent-table th { background-color: #f8fafc; color: #64748b; font-size: 0.75rem; text-transform: uppercase; font-weight: 600; padding: 0.75rem 1.5rem; text-align: left; border-bottom: 1px solid var(--border-color); }
    .ent-table td { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); font-size: 0.875rem; color: #334155; }
    .ent-table tr:hover { background-color: #f8fafc; }
</style>

<div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-8">
        <div>
            <nav class="flex text-sm text-gray-500 mb-1">
                <span class="hover:text-gray-900 cursor-pointer">Inicio</span>
                <span class="mx-2">/</span>
                <span class="font-semibold text-gray-900">Dashboard Financiero</span>
            </nav>
            <h1 class="text-2xl font-bold text-slate-900">
                {{ session.get("usuario_nombre", "Cliente") }} {{ session.get("usuario_apellidos", "") }}
            </h1>
            <p class="text-sm text-slate-500">ID Cliente: #{{ session.get("usuario_id", "MX-0000") }} • Último acceso: <span id="current-date"></span></p>
        </div>
        <div class="flex gap-3">
            <a href="{{ url_for('routes.documentos_view') }}" class="px-4 py-2 bg-slate-900 text-white rounded-md text-sm font-medium hover:bg-slate-800 shadow-sm transition flex items-center">
                <i class="ri-upload-cloud-2-line mr-2"></i> Subir Documentos
            </a>
        </div>
    </div>

    <div class="ent-card p-8 mb-8">
        <div class="flex flex-col md:flex-row md:items-end justify-between mb-2 gap-4">
            <div>
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                    <i class="ri-flag-2-fill" style="color: var(--corp-blue);"></i> Estatus del Expediente
                </h3>
                <p class="text-sm text-gray-500 mt-1">
                    {% if progreso < 100 %}
                        Faltan <span class="font-bold text-slate-700">{{ docs_totales - docs_subidos }}</span> documentos obligatorios para avanzar.
                    {% else %}
                        ¡Expediente completo al 100%! Tu solicitud está lista para revisión.
                    {% endif %}
                </p>
            </div>
            <div class="text-right">
                <span class="text-4xl font-bold" style="color: var(--corp-blue);">{{ progreso }}%</span>
                <span class="text-gray-400 text-sm font-medium block">Completado</span>
            </div>
        </div>

        <div class="timeline-container">
            <div class="timeline-bar" style="width: {{ progreso }}%;">
                <div class="timeline-marker">{{ progreso }}%</div>
            </div>
        </div>

        <div class="flex justify-between text-xs text-gray-400 mt-4 font-bold uppercase tracking-wider">
            <span>Registro</span>
            <span>Documentación</span>
            <span>Validación</span>
            <span>Aprobado</span>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        
        <div class="ent-card p-6 flex flex-col justify-between relative overflow-hidden">
            {% if financial_score %}
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Viabilidad Financiera</h3>
                    <span class="bg-indigo-50 text-indigo-600 text-[10px] font-bold px-2 py-1 rounded border border-indigo-100">IA ANALYZED</span>
                </div>

                <div class="flex flex-col items-center flex-1 justify-center">
                    <div class="relative w-32 h-32 mb-2">
                        <svg class="w-full h-full transform -rotate-90" viewBox="0 0 36 36">
                            <path class="text-slate-100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="3" />
                            <path class="{{ 'text-green-500' if financial_score.color == 'green' else ('text-yellow-500' if financial_score.color == 'orange' else 'text-red-500') }} transition-all duration-1000 ease-out" 
                                  stroke-dasharray="{{ financial_score.score }}, 100" 
                                  d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" 
                                  fill="none" stroke="currentColor" stroke-width="3" />
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center text-slate-700">
                            <span class="text-3xl font-bold">{{ financial_score.score }}</span>
                            <span class="text-[0.6rem] uppercase font-bold text-gray-400">Puntos</span>
                        </div>
                    </div>
                    
                    <p class="font-bold text-slate-800">{{ financial_score.nivel }}</p>
                    <p class="text-xs text-center text-gray-400 px-2">{{ financial_score.mensaje }}</p>
                </div>

                <div class="mt-4 bg-slate-50 rounded-lg p-3 border border-slate-100">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs text-gray-500 font-medium">Capacidad Pago</span>
                        <span class="text-sm font-bold text-indigo-600">${{ "{:,.2f}".format(financial_score.capacidad_pago_mensual) }}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-1 mt-1">
                        <div class="bg-indigo-500 h-1 rounded-full" style="width: {{ financial_score.score }}%"></div>
                    </div>
                </div>

            {% else %}
                <div class="h-full flex flex-col items-center justify-center text-center py-6">
                    <div class="bg-indigo-50 p-4 rounded-full mb-4 text-indigo-500 shadow-sm">
                        <i class="ri-bank-card-line text-2xl"></i>
                    </div>
                    <h3 class="font-bold text-slate-700">Sin Análisis Financiero</h3>
                    <p class="text-xs text-gray-500 mt-2 mb-4 px-4">Sube tus <b>Estados de Cuenta</b> para que la IA calcule tu capacidad de pago y probabilidad de aprobación.</p>
                    <a href="{{ url_for('routes.documentos_view') }}" class="px-4 py-2 bg-white border border-indigo-200 text-indigo-600 text-xs font-bold rounded-lg hover:bg-indigo-50 transition">
                        Subir Documentos
                    </a>
                </div>
            {% endif %}
        </div>

        {% if analisis_mop %}
            {% set peor_mop = analisis_mop.peor_mop_historico|default('1')|string %}
            {% set is_risk = peor_mop in ['3','4','5','6','7','9','96','97'] %}
            
            <div class="ent-card p-6 flex flex-col justify-between">
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Salud Crediticia</h3>
                        <div class="flex items-center gap-2 mt-2">
                            {% if analisis_mop.estado_resumen == 'success' %}
                                <i class="ri-checkbox-circle-fill text-green-600 text-xl"></i>
                            {% elif analisis_mop.estado_resumen == 'warning' %}
                                <i class="ri-alert-fill text-yellow-600 text-xl"></i>
                            {% else %}
                                <i class="ri-close-circle-fill text-red-600 text-xl"></i>
                            {% endif %}
                            <h3 class="font-bold text-gray-800 text-lg leading-tight">
                                {{ analisis_mop.resumen_mop_titulo }}
                            </h3>
                        </div>
                    </div>
                    <span class="p-2 rounded-lg {{ 'bg-red-50 text-red-600' if is_risk else 'bg-green-50 text-green-600' }}">
                        <i class="{{ 'ri-alarm-warning-line' if is_risk else 'ri-shield-check-line' }} text-2xl"></i>
                    </span>
                </div>

                <div class="text-sm text-gray-500 mt-2 mb-4">
                    {{ analisis_mop.resumen_mop_descripcion }}
                </div>

                <div class="grid grid-cols-2 gap-4 mt-auto pt-4 border-t border-gray-100">
                    <div>
                        <p class="text-[10px] text-gray-400 uppercase font-bold mb-1">Peor MOP Histórico</p>
                        <span class="badge {{ 'badge-danger' if is_risk else 'badge-success' }}">MOP-{{ peor_mop }}</span>
                    </div>
                    <div>
                        <p class="text-[10px] text-gray-400 uppercase font-bold mb-1">Cuentas Activas</p>
                        <span class="text-sm font-bold text-slate-700">5</span>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="ent-card p-6 flex flex-col justify-center items-center text-center">
                <div class="bg-gray-50 p-4 rounded-full mb-3 text-gray-300">
                    <i class="ri-file-shred-line text-3xl"></i>
                </div>
                <h3 class="text-slate-800 font-bold">Sin Análisis de Buró</h3>
                <p class="text-xs text-gray-500 mt-1 max-w-[200px]">Sube tu reporte de Buró de Crédito para ver este análisis.</p>
                <a href="{{ url_for('routes.documentos_view') }}" class="mt-4 text-xs font-bold text-indigo-600 hover:underline">Subir ahora</a>
            </div>
        {% endif %}

        <div class="ent-card p-0 overflow-hidden flex flex-col">
            <div class="p-6 pb-4 flex-1">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">Checklist Documental</h3>
                
                <div class="space-y-4">
                    <div class="flex items-start">
                        {% if progreso >= 100 %}
                            <div class="flex-shrink-0 h-6 w-6 rounded-full bg-green-100 text-green-600 flex items-center justify-center">
                                <i class="ri-check-line text-xs font-bold"></i>
                            </div>
                            <div class="ml-3 w-full">
                                <p class="text-sm font-medium text-gray-900">Expediente Completo</p>
                                <p class="text-xs text-green-600">Listo para validación</p>
                            </div>
                        {% else %}
                            <div class="flex-shrink-0 h-6 w-6 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center">
                                <i class="ri-time-line text-xs font-bold"></i>
                            </div>
                            <div class="ml-3 w-full">
                                <p class="text-sm font-medium text-gray-900">En proceso de carga</p>
                                <div class="w-full bg-gray-100 rounded-full h-1.5 mt-2 overflow-hidden">
                                    <div class="h-1.5 rounded-full" style="width: {{ progreso }}%; background-color: var(--corp-blue);"></div>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">{{ docs_subidos }}/{{ docs_totales }} Archivos subidos</p>
                            </div>
                        {% endif %}
                    </div>

                    <div class="flex items-start {{ 'opacity-50' if not financial_score else '' }}">
                        <div class="flex-shrink-0 h-6 w-6 rounded-full {{ 'bg-indigo-100 text-indigo-600' if financial_score else 'bg-gray-100 text-gray-400' }} flex items-center justify-center">
                            <i class="ri-bar-chart-box-line text-xs"></i>
                        </div>
                        <div class="ml-3 w-full">
                            <p class="text-sm font-medium {{ 'text-gray-900' if financial_score else 'text-gray-500' }}">Análisis Financiero</p>
                            <p class="text-xs text-gray-400">
                                {{ "Completado por IA" if financial_score else "Pendiente de estados de cuenta" }}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-3 border-t border-gray-100">
                <a href="{{ url_for('routes.documentos_view') }}" class="text-xs font-bold hover:underline flex items-center" style="color: var(--corp-blue);">
                    Gestionar documentos <i class="ri-arrow-right-line ml-1"></i>
                </a>
            </div>
        </div>
    </div>

    {% if analisis_mop and analisis_mop.detalle_creditos_mop %}
    <div class="ent-card overflow-hidden">
        <div class="px-6 py-5 border-b border-gray-200 bg-white flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <h2 class="text-lg font-bold text-slate-800">Detalle de Créditos</h2>
                <p class="text-sm text-gray-500">Historial de comportamiento reportado en Buró.</p>
            </div>
            <div class="flex gap-2 w-full md:w-auto">
                <div class="relative w-full md:w-64">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
                        <i class="ri-search-line"></i>
                    </div>
                    <input type="text" id="tableSearch" 
                           class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 sm:text-sm transition" 
                           placeholder="Buscar banco...">
                </div>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full ent-table w-full">
                <thead>
                    <tr>
                        <th>Otorgante</th>
                        <th>Actualización</th>
                        <th>MOP Actual</th>
                        <th>Peor Histórico</th>
                        <th>Estado</th>
                        <th class="text-right">Acciones</th>
                    </tr>
                </thead>
                <tbody id="mopTableBody" class="bg-white">
                    {% for c in analisis_mop.detalle_creditos_mop %}
                        {% set p_mop = c.peor_mop_historico | string %}
                        {% set r_mop = c.mop_reciente | string %}
                        {% set color_actual = 'bg-mop-ok' if r_mop in ['0','1','U'] else ('bg-mop-mid' if r_mop in ['2','3'] else 'bg-mop-bad') %}
                        {% set color_hist = 'bg-mop-ok' if p_mop in ['0','1','U'] else ('bg-mop-mid' if p_mop in ['2','3'] else 'bg-mop-bad') %}
                        
                        <tr class="search-item group hover:bg-slate-50 transition-colors">
                            <td>
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 h-8 w-8 rounded bg-slate-100 flex items-center justify-center text-xs font-bold text-slate-600 uppercase">
                                        {{ c.otorgante[:2] }}
                                    </div>
                                    <div class="ml-4">
                                        <div class="text-sm font-medium text-slate-900 otor-name">{{ c.otorgante }}</div>
                                        <div class="text-xs text-gray-500">Crédito Revolvente</div>
                                    </div>
                                </div>
                            </td>
                            <td><div class="text-sm text-gray-500">{{ c.fecha_actualizacion | default('---') }}</div></td>
                            <td><span class="mop-indicator {{ color_actual }}">{{ r_mop }}</span></td>
                            <td><span class="mop-indicator {{ color_hist }}">{{ p_mop }}</span></td>
                            <td>
                                {% if p_mop in ['5','6','7','9','96','97'] %}
                                    <span class="badge badge-danger">Riesgo Alto</span>
                                {% elif p_mop in ['2','3','4'] %}
                                    <span class="badge badge-warning">Regular</span>
                                {% else %}
                                    <span class="badge badge-success">Al Corriente</span>
                                {% endif %}
                            </td>
                            <td class="text-right whitespace-nowrap text-sm font-medium">
                                <a href="#" class="text-indigo-600 hover:text-indigo-900 font-bold hover:underline">Ver detalle</a>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="bg-white px-4 py-3 border-t border-gray-200 sm:px-6 flex items-center justify-between">
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <p class="text-sm text-gray-700">
                    Mostrando <span class="font-medium" id="pageStart">1</span> a <span class="font-medium" id="pageEnd">5</span> de <span class="font-medium" id="totalItems">12</span> resultados
                </p>
                <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination" id="paginationControls"></nav>
            </div>
        </div>
        
        <div id="noResults" class="hidden py-12 flex flex-col items-center justify-center text-center">
            <div class="h-12 w-12 text-gray-300 mb-3"><i class="ri-file-search-line text-4xl"></i></div>
            <h3 class="text-sm font-medium text-gray-900">No hay coincidencias</h3>
        </div>
    </div>
    {% endif %}

</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Fecha Actual
    document.getElementById('current-date').textContent = new Date().toLocaleDateString('es-MX', { 
        year: 'numeric', month: 'short', day: 'numeric' 
    });

    // --- Lógica de Tabla Enterprise (Búsqueda + Paginación) ---
    const tableBody = document.getElementById('mopTableBody');
    if(tableBody) {
        const rows = Array.from(tableBody.querySelectorAll('tr.search-item'));
        const searchInput = document.getElementById('tableSearch');
        const noResults = document.getElementById('noResults');
        const paginationControls = document.getElementById('paginationControls');
        
        const rowsPerPage = 5;
        let currentPage = 1;
        let filteredRows = rows;

        function updateTable() {
            const totalRows = filteredRows.length;
            const totalPages = Math.ceil(totalRows / rowsPerPage);
            
            if(currentPage > totalPages) currentPage = 1;
            if(currentPage < 1) currentPage = 1;

            rows.forEach(r => r.style.display = 'none');
            
            if(totalRows === 0) {
                noResults.classList.remove('hidden');
                document.querySelector('.ent-table').classList.add('hidden');
            } else {
                noResults.classList.add('hidden');
                document.querySelector('.ent-table').classList.remove('hidden');
                
                const start = (currentPage - 1) * rowsPerPage;
                const end = start + rowsPerPage;
                const pageRows = filteredRows.slice(start, end);

                pageRows.forEach(r => r.style.display = 'table-row');

                document.getElementById('pageStart').textContent = totalRows > 0 ? start + 1 : 0;
                document.getElementById('pageEnd').textContent = Math.min(end, totalRows);
                document.getElementById('totalItems').textContent = totalRows;
            }
            renderPagination(totalPages);
        }

        function renderPagination(totalPages) {
            paginationControls.innerHTML = '';
            if(totalPages <= 1) return;

            const prevBtn = createPageBtn('Anterior', () => { if(currentPage > 1) { currentPage--; updateTable(); } });
            prevBtn.classList.add('rounded-l-md');
            paginationControls.appendChild(prevBtn);

            for(let i=1; i<=totalPages; i++) {
                const btn = createPageBtn(i, () => { currentPage = i; updateTable(); });
                if(i === currentPage) {
                    btn.className = 'z-10 bg-indigo-50 border-indigo-500 text-indigo-600 relative inline-flex items-center px-4 py-2 border text-sm font-medium';
                }
                paginationControls.appendChild(btn);
            }

            const nextBtn = createPageBtn('Siguiente', () => { if(currentPage < totalPages) { currentPage++; updateTable(); } });
            nextBtn.classList.add('rounded-r-md');
            paginationControls.appendChild(nextBtn);
        }

        function createPageBtn(text, onClick) {
            const btn = document.createElement('button');
            btn.textContent = text;
            btn.onclick = onClick;
            btn.className = 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50 relative inline-flex items-center px-4 py-2 border text-sm font-medium';
            return btn;
        }

        if(searchInput) {
            searchInput.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                filteredRows = rows.filter(row => {
                    const name = row.querySelector('.otor-name').textContent.toLowerCase();
                    return name.includes(term);
                });
                currentPage = 1;
                updateTable();
            });
        }
        updateTable();
    }
});
</script>
{% endblock %}