{% extends "layout/layout_base.html" %}

{% block title %}Menú - Mesero{% endblock %}
{% block page_title %}Menú{% endblock %}
{% block page_subtitle %}Selecciona productos para la comanda{% endblock %}
{% block navigation %}
<a href="{{ url_for('routes.dashboard_mesero') }}" class="nav-link active">
    <i class="bi bi-house-door"></i>
    <span>Inicio</span>
</a>

<a href="{{ url_for('routes.mesero_mesas') }}" class="nav-link">
    <i class="bi bi-grid-3x3"></i>
    <span>Mis Mesas</span>
</a>

<a href="{{ url_for('routes.mesero_comandas') }}" class="nav-link">
    <i class="bi bi-receipt"></i>
    <span>Comandas Activas</span>
</a>

<a href="{{ url_for('routes.mesero_menu') }}" class="nav-link">
    <i class="bi bi-journal-text"></i>
    <span>Menú</span>
</a>

<a href="{{ url_for('routes.mesero_propinas') }}" class="nav-link">
    <i class="bi bi-cash-coin"></i>
    <span>Propinas del Día</span>
</a>

<a href="{{ url_for('routes.mesero_historial') }}" class="nav-link">
    <i class="bi bi-clock-history"></i>
    <span>Historial</span>
</a>
{% endblock %}


{% block content %}

<!-- CONTROLES -->
<div class="flex flex-col md:flex-row gap-4 mb-6">
    <input
        id="busqueda"
        type="text"
        class="input input-bordered w-full md:flex-1"
        placeholder="Buscar producto..."
        oninput="renderProductos()"
    >
</div>

<!-- CATEGORÍAS -->
<div id="categorias" class="flex flex-wrap gap-2 mb-6"></div>

<!-- GRID PRODUCTOS -->
<div id="productos-grid"
     class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
</div>

{% endblock %}

{% block extra_js %}
<script>
let productos = [];
let categoriaActiva = 'all';

/* =========================
   CARGAR MENÚ DESDE BD
========================= */
document.addEventListener('DOMContentLoaded', cargarMenu);

async function cargarMenu() {
    const res = await fetch('/api/menu');
    const data = await res.json();

    if (!data.success) return;

    productos = data.menu;
    renderCategorias();
    renderProductos();
}

/* =========================
   CATEGORÍAS
========================= */
function renderCategorias() {
    const cont = document.getElementById('categorias');
    const categorias = [...new Set(productos.map(p => p.categoria))];

    cont.innerHTML = `
        <button class="btn btn-sm ${categoriaActiva==='all'?'btn-primary':'btn-outline'}"
            onclick="setCategoria('all')">
            Todos
        </button>
    `;

    categorias.forEach(cat => {
        cont.innerHTML += `
            <button class="btn btn-sm ${categoriaActiva===cat?'btn-primary':'btn-outline'}"
                onclick="setCategoria('${cat}')">
                ${cat}
            </button>
        `;
    });
}

function setCategoria(cat) {
    categoriaActiva = cat;
    renderCategorias();
    renderProductos();
}

/* =========================
   PRODUCTOS
========================= */
function renderProductos() {
    const grid = document.getElementById('productos-grid');
    const q = document.getElementById('busqueda').value.toLowerCase();

    const filtrados = productos.filter(p =>
        (categoriaActiva === 'all' || p.categoria === categoriaActiva) &&
        p.nombre.toLowerCase().includes(q)
    );

    if (filtrados.length === 0) {
        grid.innerHTML = `
            <div class="col-span-full text-center text-gray-500 py-10">
                No hay productos
            </div>`;
        return;
    }

    grid.innerHTML = filtrados.map(p => `
        <div class="card hover:shadow-lg transition">
            <div class="card-body">
                <h3 class="font-bold">${p.nombre}</h3>
                <p class="text-sm text-gray-600">
                    ${p.descripcion || '—'}
                </p>

                <div class="flex justify-between items-center mt-4">
                    <span class="font-bold text-green-600">
                        $${Number(p.precio).toFixed(2)}
                    </span>
                    <button class="btn btn-sm btn-primary">
                        Agregar
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}
</script>
{% endblock %}
