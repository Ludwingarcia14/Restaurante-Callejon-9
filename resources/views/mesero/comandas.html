{% extends "layout/layout_base.html" %}

{% block title %}Mis Comandas - Mesero{% endblock %}
{% block page_title %}Gesti√≥n de Comandas{% endblock %}
{% block page_subtitle %}Comandas activas y cuentas cerradas{% endblock %}


{% block navigation %}
<a href="{{ url_for('routes.dashboard_mesero') }}" class="nav-link active">
    <i class="bi bi-house-door"></i>
    <span>Inicio</span>
</a>

<a href="{{ url_for('routes.mesero_mesas') }}" class="nav-link">
    <i class="bi bi-grid-3x3"></i>
    <span>Mis Mesas</span>
</a>

<a href="{{ url_for('routes.mesero_comandas') }}" class="nav-link">
    <i class="bi bi-receipt"></i>
    <span>Comandas Activas</span>
</a>

<a href="{{ url_for('routes.mesero_menu') }}" class="nav-link">
    <i class="bi bi-journal-text"></i>
    <span>Men√∫</span>
</a>

<a href="{{ url_for('routes.mesero_propinas') }}" class="nav-link">
    <i class="bi bi-cash-coin"></i>
    <span>Propinas del D√≠a</span>
</a>

<a href="{{ url_for('routes.mesero_historial') }}" class="nav-link">
    <i class="bi bi-clock-history"></i>
    <span>Historial</span>
</a>
{% endblock %}

{% block content %}

<!-- ================= COMANDAS ACTIVAS ================= -->
<div class="flex flex-col md:flex-row md:justify-between md:items-center gap-4 mb-6">
    <div>
        <h2 class="text-2xl font-bold text-gray-800">Comandas Activas</h2>
        <p class="text-gray-500">Pedidos en proceso</p>
    </div>
    <button onclick="cargarComandas()" class="btn btn-primary">
        <i class="bi bi-arrow-clockwise"></i> Actualizar
    </button>
</div>

<div id="comandas-grid"
     class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6 mb-12"></div>

<!-- ================= HISTORIAL ================= -->
<h3 class="text-xl font-bold text-gray-800 mb-4">
    Historial de Cuentas Cerradas
</h3>

<!-- FILTROS -->
<div class="card mb-6 border border-gray-100">
    <div class="card-body">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="text-sm font-semibold text-gray-600">Desde</label>
                <input id="filtro-desde" type="date"
                       class="input input-bordered w-full">
            </div>
            <div>
                <label class="text-sm font-semibold text-gray-600">Hasta</label>
                <input id="filtro-hasta" type="date"
                       class="input input-bordered w-full">
            </div>
            <div>
                <label class="text-sm font-semibold text-gray-600">Mesa</label>
                <input id="filtro-mesa" type="number" min="1"
                       placeholder="Ej. 3"
                       class="input input-bordered w-full">
            </div>
            <div class="flex items-end gap-2">
                <button onclick="aplicarFiltros()"
                        class="btn btn-success w-full">
                    <i class="bi bi-funnel"></i> Filtrar
                </button>
                <button onclick="limpiarFiltros()"
                        class="btn btn-outline w-full">
                    Limpiar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ======= HISTORIAL MOBILE (CARDS) ======= -->
<div id="historial-cards"
     class="grid grid-cols-1 sm:grid-cols-2 gap-4 md:hidden"></div>

<!-- ======= HISTORIAL DESKTOP (TABLA) ======= -->
<div class="card hidden md:block">
    <div class="card-body overflow-x-auto">
        <table class="table w-full">
            <thead class="bg-gray-50">
                <tr>
                    <th>Folio</th>
                    <th>Mesa</th>
                    <th>Total</th>
                    <th>Fecha</th>
                </tr>
            </thead>
            <tbody id="historial-tabla"></tbody>
        </table>
    </div>
</div>

<!-- ================= MODAL ================= -->
<div id="modalComanda"
     class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl
                max-w-3xl w-full max-h-[90vh] overflow-y-auto">
        <div class="bg-green-600 text-white p-4 flex justify-between">
            <div>
                <h3 class="text-xl font-bold" id="modal-folio"></h3>
                <p>Mesa <span id="modal-mesa"></span></p>
            </div>
            <button onclick="cerrarModal()" class="text-xl">‚úï</button>
        </div>
        <div class="p-6" id="modal-content"></div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let comandas = [];
let historialOriginal = [];

document.addEventListener('DOMContentLoaded', () => {
    cargarComandas();
    cargarHistorial();
});

/* ================= COMANDAS ACTIVAS ================= */
async function cargarComandas() {
    const grid = document.getElementById('comandas-grid');
    grid.innerHTML = '';

    const res = await fetch('/api/mesero/comandas/activas');
    const data = await res.json();

    if (!data.success || data.comandas.length === 0) {
        grid.innerHTML = `
            <div class="col-span-full text-center text-gray-500 py-16">
                No hay comandas activas
            </div>`;
        return;
    }

    comandas = data.comandas;

    grid.innerHTML = comandas.map(c => `
        <div class="card border border-gray-100 hover:shadow-lg cursor-pointer
                    transition active:scale-[0.98]"
             onclick="verComanda('${c.id}')">
            <div class="card-body">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-bold">${c.folio}</span>
                    <span class="badge badge-info">${c.estado}</span>
                </div>
                <p class="text-sm text-gray-500">Mesa ${c.mesa_numero}</p>
                <p class="text-sm">${(c.items || []).length} items</p>
                <p class="font-bold text-green-600 mt-2">
                    $${c.total.toFixed(2)}
                </p>
            </div>
        </div>
    `).join('');
}

function verComanda(id) {
    const c = comandas.find(x => x.id === id);
    if (!c) return;

    document.getElementById('modal-folio').textContent = c.folio;
    document.getElementById('modal-mesa').textContent = c.mesa_numero;

    document.getElementById('modal-content').innerHTML = `
        ${c.items.map(i => `
            <div class="flex justify-between border-b py-2 text-sm">
                <span>${i.cantidad}x ${i.nombre}</span>
                <span>$${(i.precio * i.cantidad).toFixed(2)}</span>
            </div>
        `).join('')}
        <div class="flex justify-between mt-4 font-bold text-lg">
            <span>Total</span>
            <span class="text-green-600">$${c.total.toFixed(2)}</span>
        </div>
    `;

    document.getElementById('modalComanda').classList.remove('hidden');
}

function cerrarModal() {
    document.getElementById('modalComanda').classList.add('hidden');
}

/* ================= HISTORIAL ================= */
async function cargarHistorial() {
    const res = await fetch('/api/mesero/comandas/cerradas');
    const data = await res.json();
    historialOriginal = data.comandas || [];
    renderHistorial(historialOriginal);
}

function aplicarFiltros() {
    const desdeVal = document.getElementById('filtro-desde').value;
    const hastaVal = document.getElementById('filtro-hasta').value;
    const mesaVal  = document.getElementById('filtro-mesa').value;

    let filtrado = [...historialOriginal];

    // üîπ Filtro por mesa
    if (mesaVal) {
        filtrado = filtrado.filter(c =>
            String(c.mesa) === String(mesaVal)
        );
    }

    // üîπ Filtro fecha desde
    if (desdeVal) {
        const desde = new Date(desdeVal);
        desde.setHours(0, 0, 0, 0);

        filtrado = filtrado.filter(c =>
            new Date(c.fecha) >= desde
        );
    }

    // üîπ Filtro fecha hasta (d√≠a completo)
    if (hastaVal) {
        const hasta = new Date(hastaVal);
        hasta.setHours(23, 59, 59, 999);

        filtrado = filtrado.filter(c =>
            new Date(c.fecha) <= hasta
        );
    }

    renderHistorial(filtrado);
}

function limpiarFiltros() {
    document.getElementById('filtro-desde').value = '';
    document.getElementById('filtro-hasta').value = '';
    document.getElementById('filtro-mesa').value = '';
    renderHistorial(historialOriginal);
}

function renderHistorial(lista) {
    const cards = document.getElementById('historial-cards');
    const tabla = document.getElementById('historial-tabla');

    if (!lista.length) {
        cards.innerHTML = tabla.innerHTML = `
            <tr>
                <td colspan="4" class="text-center text-gray-500 py-6">
                    Sin resultados
                </td>
            </tr>`;
        return;
    }

    // Cards (mobile)
    cards.innerHTML = lista.map(c => `
        <div class="card border border-gray-100">
            <div class="card-body">
                <div class="flex justify-between">
                    <span class="font-bold">${c.folio}</span>
                    <span class="text-sm text-gray-500">Mesa ${c.mesa}</span>
                </div>
                <p class="text-green-600 font-bold mt-2">
                    $${c.total.toFixed(2)}
                </p>
                <p class="text-xs text-gray-500 mt-1">
                    ${new Date(c.fecha).toLocaleString('es-MX')}
                </p>
            </div>
        </div>
    `).join('');

    // Tabla (desktop)
    tabla.innerHTML = lista.map(c => `
        <tr>
            <td>${c.folio}</td>
            <td>Mesa ${c.mesa}</td>
            <td class="font-bold text-green-600">$${c.total.toFixed(2)}</td>
            <td>${new Date(c.fecha).toLocaleString('es-MX')}</td>
        </tr>
    `).join('');
}
</script>
{% endblock %}
