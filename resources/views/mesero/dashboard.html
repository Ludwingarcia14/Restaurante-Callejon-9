{% extends "layout/layout_base.html" %}

{% block title %}Panel de Mesero{% endblock %}
{% block page_title %}Dashboard de Mesero{% endblock %}
{% block page_subtitle %}Gesti√≥n de mesas y atenci√≥n al cliente{% endblock %}

{% block navigation %}
<a href="{{ url_for('routes.dashboard_mesero') }}" class="nav-link active">
    <i class="bi bi-house-door"></i>
    <span>Inicio</span>
</a>

<a href="{{ url_for('routes.mesero_mesas') }}" class="nav-link">
    <i class="bi bi-grid-3x3"></i>
    <span>Mis Mesas</span>
</a>

<a href="{{ url_for('routes.mesero_comandas') }}" class="nav-link">
    <i class="bi bi-receipt"></i>
    <span>Comandas Activas</span>
</a>

<a href="{{ url_for('routes.mesero_menu') }}" class="nav-link">
    <i class="bi bi-journal-text"></i>
    <span>Men√∫</span>
</a>

<a href="{{ url_for('routes.mesero_propinas') }}" class="nav-link">
    <i class="bi bi-cash-coin"></i>
    <span>Propinas del D√≠a</span>
</a>

<a href="{{ url_for('routes.mesero_historial') }}" class="nav-link">
    <i class="bi bi-clock-history"></i>
    <span>Historial</span>
</a>
{% endblock %}

{% block content %}

<div class="p-6 rounded-xl shadow-lg text-white mb-6" style="background: linear-gradient(135deg, #F2913D 0%, #F2A339 100%);">
    <div class="flex items-center justify-between">
        <div>
            <h2 class="text-2xl font-bold mb-2">¬°Hola, {{ session.usuario_nombre }}! üëã</h2>
            <div class="flex items-center gap-4 text-sm opacity-90">
                <div class="flex items-center gap-2">
                    <i class="bi bi-clock"></i>
                    <span>Turno: {{ perfil.turno|title if perfil.turno else 'No asignado' }}</span>
                </div>
                <div class="flex items-center gap-2">
                    <i class="bi bi-person-badge"></i>
                    <span>ID: {{ perfil.numero_empleado if perfil.numero_empleado else 'N/A' }}</span>
                </div>
            </div>
        </div>
        <div class="text-right bg-white bg-opacity-20 p-3 rounded-lg backdrop-blur-sm">
            <div class="text-3xl font-bold">{{ stats.mesas_asignadas|length }}</div>
            <div class="text-xs uppercase tracking-wider opacity-90">Mesas Asignadas</div>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    
    <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-[#F2913D] hover:shadow-lg transition">
        <div class="flex items-center justify-between mb-2">
            <i class="bi bi-receipt text-4xl text-[#F2913D]"></i>
            <span class="text-3xl font-bold text-[#0D0D0D]" id="stat-comandas">{{ stats.comandas_activas }}</span>
        </div>
        <p class="text-sm text-gray-600 font-medium">Comandas Activas</p>
        <p class="text-xs text-[#F2913D] mt-1 font-semibold">
            <i class="bi bi-clock"></i> En proceso
        </p>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-[#F2A339] hover:shadow-lg transition">
        <div class="flex items-center justify-between mb-2">
            <i class="bi bi-grid-3x3 text-4xl text-[#F2A339]"></i>
            <span class="text-3xl font-bold text-[#0D0D0D]" id="mesas-ocupadas">0</span>
        </div>
        <p class="text-sm text-gray-600 font-medium">Mesas Ocupadas</p>
        <p class="text-xs text-amber-600 mt-1">
            <i class="bi bi-check-circle"></i> <span id="mesas-libres">{{ stats.mesas_asignadas|length }}</span> disponibles
        </p>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-green-500 hover:shadow-lg transition">
        <div class="flex items-center justify-between mb-2">
            <i class="bi bi-cash-coin text-4xl text-green-500"></i>
            <span class="text-3xl font-bold text-[#0D0D0D]" id="stat-propinas">${{ "%.2f"|format(stats.propinas_dia) }}</span>
        </div>
        <p class="text-sm text-gray-600 font-medium">Propinas Hoy</p>
        <p class="text-xs text-green-600 mt-1">
            <i class="bi bi-arrow-up"></i> {{ perfil.propinas.sugerida if perfil.propinas else 10 }}% sugerido
        </p>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-[#0D0D0D] hover:shadow-lg transition">
        <div class="flex items-center justify-between mb-2">
            <i class="bi bi-graph-up text-4xl text-[#0D0D0D]"></i>
            <span class="text-3xl font-bold text-[#0D0D0D]" id="venta-dia">$0.00</span>
        </div>
        <p class="text-sm text-gray-600 font-medium">Venta del D√≠a</p>
        <p class="text-xs text-gray-500 mt-1">
            <i class="bi bi-star"></i> <span id="num-ordenes">0</span> √≥rdenes
        </p>
    </div>
    
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
    
    <div class="lg:col-span-2">
        <div class="card bg-white rounded-xl shadow-md overflow-hidden border-t-4 border-[#F2913D]">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h2 class="text-lg font-bold text-[#0D0D0D] flex items-center gap-2">
                    <i class="bi bi-grid-3x3 text-[#F2913D]"></i>
                    Mis Mesas
                </h2>
                <div class="flex items-center gap-2">
                    <span class="px-3 py-1 bg-[#F2CA99] bg-opacity-30 text-[#F2913D] rounded-full text-xs font-bold">
                        {{ stats.mesas_asignadas|length }} ASIGNADAS
                    </span>
                    <button onclick="cargarEstadoMesas()" class="p-2 hover:bg-gray-200 rounded-full transition text-gray-600">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-6">
                {% if stats.mesas_asignadas %}
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="mesas-grid">
                    {% for mesa in stats.mesas_asignadas %}
                    <div class="mesa-card border-2 border-gray-100 rounded-xl p-4 hover:border-[#F2A339] hover:bg-[#F2CA99] hover:bg-opacity-10 transition cursor-pointer text-center group"
                         data-mesa="{{ mesa }}"
                         onclick="verMesa('{{ mesa }}')">
                        <div class="w-12 h-12 bg-gray-100 group-hover:bg-[#F2A339] group-hover:text-white rounded-full flex items-center justify-center mx-auto mb-3 transition">
                            <i class="bi bi-table text-xl"></i>
                        </div>
                        <p class="font-bold text-[#0D0D0D]">Mesa {{ mesa }}</p>
                        <p class="mesa-comensales text-[10px] uppercase tracking-tighter text-gray-400 mt-1 font-bold">- comensales</p>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-12 text-gray-400">
                    <i class="bi bi-inbox text-5xl mb-3 opacity-20"></i>
                    <p>No tienes mesas asignadas</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="lg:col-span-1">
        <div class="card bg-white rounded-xl shadow-md border-t-4 border-[#0D0D0D]">
            <div class="p-4 border-b bg-gray-50">
                <h2 class="font-bold text-[#0D0D0D] flex items-center gap-2">
                    <i class="bi bi-lightning-charge-fill text-[#F2A339]"></i>
                    Acciones R√°pidas
                </h2>
            </div>
            <div class="card-body p-4 space-y-3">
                
                <button onclick="mostrarSeleccionMesa()" 
                        class="w-full p-4 bg-[#F2913D] text-white rounded-lg hover:bg-[#F2A339] shadow-md transition flex items-center justify-between group">
                    <div class="flex items-center gap-3">
                        <i class="bi bi-plus-circle-fill text-xl"></i>
                        <span class="font-bold">NUEVA CUENTA</span>
                    </div>
                    <i class="bi bi-chevron-right group-hover:translate-x-1 transition"></i>
                </button>

                <button onclick="verMenu()" 
                        class="w-full p-4 bg-white border-2 border-[#F2CA99] text-[#F2913D] rounded-lg hover:bg-[#F2CA99] hover:bg-opacity-20 transition flex items-center justify-between group">
                    <div class="flex items-center gap-3">
                        <i class="bi bi-journal-text text-xl"></i>
                        <span class="font-bold">VER MEN√ö</span>
                    </div>
                    <i class="bi bi-chevron-right group-hover:translate-x-1 transition"></i>
                </button>

                <button onclick="verComandas()" 
                        class="w-full p-4 bg-white border-2 border-gray-800 text-gray-800 rounded-lg hover:bg-gray-800 hover:text-white transition flex items-center justify-between group">
                    <div class="flex items-center gap-3">
                        <i class="bi bi-receipt text-xl"></i>
                        <span class="font-bold">MIS COMANDAS</span>
                    </div>
                    <span class="bg-[#F2913D] text-white px-2 py-0.5 rounded text-xs font-bold">{{ stats.comandas_activas }}</span>
                </button>

            </div>
        </div>
    </div>
</div>

<div class="card bg-white rounded-xl shadow-md overflow-hidden border-t-4 border-[#F2A339]">
    <div class="card-header p-4 bg-gray-50 flex justify-between items-center border-b">
        <h2 class="font-bold text-[#0D0D0D] flex items-center gap-2">
            <i class="bi bi-list-stars text-[#F2913D]"></i>
            Detalle de Comandas Activas
        </h2>
        <button onclick="actualizarComandas()" class="text-sm font-bold text-[#F2913D] hover:underline">
            Refrescar lista
        </button>
    </div>
    <div class="card-body p-6">
        <div id="comandas-container">
            <div class="text-center py-10">
                <div class="animate-spin inline-block w-8 h-8 border-4 border-[#F2CA99] border-t-[#F2913D] rounded-full mb-4"></div>
                <p class="text-gray-500 font-medium">Sincronizando cocina...</p>
            </div>
        </div>
    </div>
</div>

<div id="modalMesa" class="hidden fixed inset-0 bg-[#0D0D0D] bg-opacity-80 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden">
        <div class="bg-[#F2913D] text-white p-5 flex items-center justify-between">
            <h3 class="text-xl font-bold flex items-center gap-2 uppercase">
                <i class="bi bi-house-door-fill"></i>
                Detalle Mesa <span id="modal-mesa-numero"></span>
            </h3>
            <button onclick="cerrarModalMesa()" class="hover:bg-black hover:bg-opacity-10 p-1 rounded transition">
                <i class="bi bi-x-lg text-xl"></i>
            </button>
        </div>
        <div class="p-6 overflow-y-auto" id="modal-mesa-content" style="max-height: calc(90vh - 70px);">
            </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// ===================================
// VARIABLES GLOBALES
// ===================================
let mesasData = {};
let comandasActivas = [];
const API_BASE = '/api/mesero';

// ===================================
// INICIALIZACI√ìN
// ===================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('Dashboard Mesero inicializado');
    
    // Cargar datos iniciales
    cargarEstadoMesas();
    actualizarComandas();
    cargarEstadisticasDia();
    
    // Actualizar cada 30 segundos
    setInterval(() => {
        cargarEstadoMesas();
        actualizarComandas();
        cargarEstadisticasDia();
    }, 30000);
});

// ===================================
// CARGA DE DATOS DESDE LA API
// ===================================
async function cargarEstadoMesas() {
    try {
        const response = await fetch(`${API_BASE}/mesas/estado`);
        const data = await response.json();
        
        if (data.success) {
            mesasData = data.mesas;
            actualizarVisualizacionMesas();
        } else {
            console.error('Error al cargar mesas:', data.error);
        }
    } catch (error) {
        console.error('Error en la petici√≥n:', error);
    }
}

async function cargarEstadisticasDia() {
    try {
        const response = await fetch(`${API_BASE}/estadisticas/dia`);
        const data = await response.json();
        
        if (data.success && data.estadisticas) {
            const stats = data.estadisticas;
            // Usamos || 0 para que si el dato no existe, ponga un cero y no rompa el .toFixed
            const venta = stats.venta_dia || 0;
            const propinas = stats.propinas || 0;
            
            document.getElementById('venta-dia').textContent = `$${Number(venta).toFixed(2)}`;
            document.getElementById('num-ordenes').textContent = stats.num_ordenes || 0;
            document.getElementById('stat-propinas').textContent = `$${Number(propinas).toFixed(2)}`;
        }
    } catch (error) {
        console.error('Error al cargar estad√≠sticas:', error);
    }
}

async function actualizarComandas() {
    try {
        const response = await fetch(`${API_BASE}/comandas/activas`);
        const data = await response.json();
        
        if (data.success) {
            comandasActivas = data.comandas;
            renderizarComandas();
            
            // Actualizar badges
            document.getElementById('stat-comandas').textContent = data.total;
            document.getElementById('badge-comandas').textContent = data.total;
        } else {
            console.error('Error al cargar comandas:', data.error);
        }
    } catch (error) {
        console.error('Error en la petici√≥n:', error);
    }
}

// ===================================
// RENDERIZADO DE MESAS
// ===================================
function actualizarVisualizacionMesas() {
    const mesasCards = document.querySelectorAll('.mesa-card');
    let ocupadas = 0;
    
    mesasCards.forEach(card => {
        const numeroMesa = card.dataset.mesa;
        const mesaInfo = mesasData[numeroMesa];
        
        if (mesaInfo) {
    const statusSpan = card.querySelector('.mesa-status');
    const comensalesP = card.querySelector('.mesa-comensales');
    const iconContainer = card.querySelector('.w-16'); // El c√≠rculo del icono

    if (mesaInfo.estado === 'ocupada') {
        statusSpan.className = 'mesa-status px-2 py-1 text-xs rounded-full bg-red-100 text-red-700';
        statusSpan.textContent = 'Ocupada';
        comensalesP.textContent = `${mesaInfo.comensales} comensales`;
        
        // Cambio de color al borde y al icono para que sea obvio
        card.classList.replace('border-gray-200', 'border-red-500');
        iconContainer.classList.replace('bg-green-100', 'bg-red-100');
        iconContainer.querySelector('i').classList.replace('text-green-600', 'text-red-600');
        ocupadas++;
    } else {
        // Estado Disponible (Resetear a verde)
        statusSpan.className = 'mesa-status px-2 py-1 text-xs rounded-full bg-green-100 text-green-700';
        statusSpan.textContent = 'Disponible';
        comensalesP.textContent = 'Mesa Libre';
        card.className = 'mesa-card border-2 border-gray-200 rounded-xl p-6 hover:border-green-500 hover:shadow-md transition cursor-pointer text-center';
    }
        }
    });
    
    // Actualizar contadores
    const total = mesasCards.length;
    document.getElementById('mesas-ocupadas').textContent = ocupadas;
    document.getElementById('mesas-libres').textContent = total - ocupadas;
}

// ===================================
// RENDERIZADO DE COMANDAS
// ===================================
function renderizarComandas() {
    const container = document.getElementById('comandas-container');
    
    if (comandasActivas.length === 0) {
        container.innerHTML = `
            <div class="text-center py-12 text-gray-500">
                <i class="bi bi-cart-check text-6xl mb-4 block opacity-30"></i>
                <p class="text-lg">No hay comandas activas</p>
                <p class="text-sm mt-2">Las comandas aparecer√°n aqu√≠ cuando tomes pedidos</p>
                <button onclick="mostrarSeleccionMesa()" class="btn btn-primary mt-4">
                    <i class="bi bi-plus-circle"></i>
                    Crear Nueva Cuenta
                </button>
            </div>
        `;
        return;
    }
    
    let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
    
    comandasActivas.forEach(comanda => {
        const tiempoTranscurrido = calcularTiempoTranscurrido(comanda.fecha_apertura);
        
        html += `
            <div class="border-2 border-gray-200 rounded-xl p-4 hover:border-orange-400 hover:shadow-md transition">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                        <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
                            <i class="bi bi-receipt text-orange-600"></i>
                        </div>
                        <div>
                            <p class="font-bold text-gray-800">${comanda.folio}</p>
                            <p class="text-xs text-gray-500">Mesa ${comanda.mesa_numero}</p>
                        </div>
                    </div>
                    <span class="badge badge-warning">${tiempoTranscurrido}</span>
                </div>
                
                <div class="space-y-2 text-sm mb-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Comensales:</span>
                        <span class="font-semibold">${comanda.num_comensales}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Items:</span>
                        <span class="font-semibold">${comanda.items.length}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Total:</span>
                        <span class="font-bold text-lg text-green-600">$${comanda.total.toFixed(2)}</span>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="verDetalleComanda(${comanda.id})" class="btn btn-sm btn-secondary">
                        <i class="bi bi-eye"></i> Ver
                    </button>
                    <button onclick="agregarItemsComanda(${comanda.id})" class="btn btn-sm btn-primary">
                        <i class="bi bi-plus"></i> Agregar
                    </button>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// ===================================
// GESTI√ìN DE MESAS
// ===================================
async function verMesa(numeroMesa) {
    try {
        const response = await fetch(`${API_BASE}/mesa/${numeroMesa}`);
        const data = await response.json();
        
        if (!data.success) {
            Swal.fire('Error', data.error || 'No se pudo cargar la mesa', 'error');
            return;
        }
        
        const mesa = data.mesa;
        const modal = document.getElementById('modalMesa');
        const content = document.getElementById('modal-mesa-content');
        document.getElementById('modal-mesa-numero').textContent = numeroMesa;
        
        if (mesa.estado === 'disponible') {
            content.innerHTML = `
                <div class="text-center py-8">
                    <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="bi bi-check-circle text-5xl text-green-600"></i>
                    </div>
                    <h4 class="text-xl font-bold text-gray-800 mb-2">Mesa Disponible</h4>
                    <p class="text-sm text-gray-500 mb-6">Capacidad: ${mesa.capacidad || 4} personas</p>
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="abrirCuenta('${numeroMesa}')" class="btn btn-primary">Abrir Cuenta</button>
                        <button onclick="cerrarModalMesa()" class="btn btn-secondary">Cancelar</button>
                    </div>
                </div>`;
        } else {
            // --- AQU√ç ESTABA EL ERROR: USAMOS VALORES POR DEFECTO ---
            const total = mesa.total_cuenta ? Number(mesa.total_cuenta).toFixed(2) : "0.00";
            const comensales = mesa.comensales || 0;
            const folio = (mesa.cuenta && mesa.cuenta.folio) ? mesa.cuenta.folio : 'Sin folio';

            content.innerHTML = `
                <div class="space-y-4">
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                        <p class="font-semibold text-blue-900">Mesa Ocupada - ${comensales} personas</p>
                        <p class="text-sm text-blue-700">Folio: ${folio}</p>
                        <p class="text-lg font-bold text-blue-800">Total: $${total}</p>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="agregarItemsComanda(${mesa.cuenta_activa_id})" class="btn btn-primary">Agregar Pedido</button>
                        <button onclick="verDetalleComanda(${mesa.cuenta_activa_id})" class="btn btn-secondary">Ver Cuenta</button>
                    </div>
                </div>`;
        }
        modal.classList.remove('hidden');
    } catch (error) {
        console.error('Error al cargar mesa:', error);
    }
}

function cerrarModalMesa() {
    document.getElementById('modalMesa').classList.add('hidden');
}

// ===================================
// GESTI√ìN DE CUENTAS
// ===================================
async function abrirCuenta(numeroMesa) {
    const { value: numComensales } = await Swal.fire({
        title: `Abrir cuenta - Mesa ${numeroMesa}`,
        input: 'number',
        inputLabel: '¬øCu√°ntos comensales?',
        inputPlaceholder: 'N√∫mero de personas',
        inputAttributes: {
            min: 1,
            max: 20,
            step: 1
        },
        showCancelButton: true,
        confirmButtonText: 'Continuar',
        cancelButtonText: 'Cancelar',
        inputValidator: (value) => {
            if (!value || value < 1) {
                return '¬°Debes ingresar al menos 1 comensal!';
            }
        }
    });
    
    if (numComensales) {
        try {
            showLoading('Abriendo cuenta...');
            
            const response = await fetch(`${API_BASE}/cuenta/abrir`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    numero_mesa: numeroMesa,
                    num_comensales: parseInt(numComensales)
                })
            });
            
            const data = await response.json();
            hideLoading();
            
            if (data.success) {
                showSuccess(data.message);
                cerrarModalMesa();
                
                // Actualizar datos
                await cargarEstadoMesas();
                await actualizarComandas();
            } else {
                showError(data.error);
            }
            
        } catch (error) {
            hideLoading();
            console.error('Error al abrir cuenta:', error);
            showError('Error al abrir la cuenta');
        }
    }
}

function mostrarSeleccionMesa() {
    // Filtrar mesas disponibles
    const mesasDisponibles = Object.values(mesasData).filter(m => m.estado === 'disponible');
    
    if (mesasDisponibles.length === 0) {
        Swal.fire({
            title: 'No hay mesas disponibles',
            text: 'Todas tus mesas est√°n ocupadas o en limpieza',
            icon: 'info'
        });
        return;
    }
    
    // Crear opciones para el select
    const opciones = {};
    mesasDisponibles.forEach(mesa => {
        opciones[mesa.numero] = `Mesa ${mesa.numero} (${mesa.capacidad} personas)`;
    });
    
    Swal.fire({
        title: 'Selecciona una mesa',
        input: 'select',
        inputOptions: opciones,
        inputPlaceholder: 'Elige una mesa',
        showCancelButton: true,
        confirmButtonText: 'Abrir cuenta',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed && result.value) {
            abrirCuenta(result.value);
        }
    });
}

// ===================================
// ACCIONES R√ÅPIDAS
// ===================================
function verMenu() {
    window.location.href = "{{ url_for('routes.mesero_menu') }}";
}

function verComandas() {
    window.location.href = "{{ url_for('routes.mesero_comandas') }}";
}

function verDetalleComanda(cuentaId) {
    // Redirigir a la vista de detalle de comanda
    window.location.href = `/mesero/comanda/${cuentaId}`;
}

function agregarItemsComanda(cuentaId) {
    // Redirigir al men√∫ para agregar items
    window.location.href = `/mesero/comanda/${cuentaId}/agregar`;
}

function solicitarCuentaMesa(numeroMesa, cuentaId) {
    Swal.fire({
        title: '¬øSolicitar la cuenta?',
        text: `Se generar√° la cuenta para la Mesa ${numeroMesa}`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'S√≠, generar cuenta',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            // Redirigir a la vista de cierre de cuenta
            window.location.href = `/mesero/cuenta/${cuentaId}/cerrar`;
        }
    });
}

function solicitarAyuda() {
    Swal.fire({
        title: '¬øNecesitas ayuda?',
        text: 'Se notificar√° al supervisor',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'S√≠, solicitar ayuda',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            // Aqu√≠ implementar√≠as la notificaci√≥n real
            showSuccess('¬°Ayuda solicitada! Un supervisor se acercar√° pronto');
        }
    });
}

// ===================================
// UTILIDADES
// ===================================
function calcularTiempoTranscurrido(fechaInicio) {
    if (!fechaInicio) return 'N/A';
    
    const inicio = new Date(fechaInicio);
    const ahora = new Date();
    const diff = Math.floor((ahora - inicio) / 60000); // minutos
    
    if (diff < 60) {
        return `${diff} min`;
    } else {
        const horas = Math.floor(diff / 60);
        const mins = diff % 60;
        return `${horas}h ${mins}m`;
    }
}

// Funciones de UI (aseg√∫rate de tener SweetAlert2 incluido)
function showLoading(message = 'Cargando...') {
    Swal.fire({
        title: message,
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });
}

function hideLoading() {
    Swal.close();
}

function showSuccess(message) {
    Swal.fire({
        icon: 'success',
        title: '¬°√âxito!',
        text: message,
        timer: 2000,
        showConfirmButton: false
    });
}

function showError(message) {
    Swal.fire({
        icon: 'error',
        title: 'Error',
        text: message
    });
}
</script>
{% endblock %}