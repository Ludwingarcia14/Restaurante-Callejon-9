{% extends "layout/layout_base.html" %}

{% block title %}Panel de Mesero{% endblock %}
{% block page_title %}Dashboard de Mesero{% endblock %}
{% block page_subtitle %}Gesti√≥n de mesas y atenci√≥n al cliente{% endblock %}

{% block navigation %}
<a href="{{ url_for('routes.dashboard_mesero') }}" class="nav-link active">
    <i class="bi bi-house-door"></i>
    <span>Inicio</span>
</a>

<a href="{{ url_for('routes.mesero_mesas') }}" class="nav-link">
    <i class="bi bi-grid-3x3"></i>
    <span>Mis Mesas</span>
</a>

<a href="{{ url_for('routes.mesero_comandas') }}" class="nav-link">
    <i class="bi bi-receipt"></i>
    <span>Comandas Activas</span>
</a>

<a href="{{ url_for('routes.mesero_menu') }}" class="nav-link">
    <i class="bi bi-journal-text"></i>
    <span>Men√∫</span>
</a>

<a href="{{ url_for('routes.mesero_propinas') }}" class="nav-link">
    <i class="bi bi-cash-coin"></i>
    <span>Propinas del D√≠a</span>
</a>

<a href="{{ url_for('routes.mesero_historial') }}" class="nav-link">
    <i class="bi bi-clock-history"></i>
    <span>Historial</span>
</a>
{% endblock %}

{% block content %}

<div class="p-6 rounded-xl shadow-lg text-white mb-6"
    style="background: linear-gradient(135deg, #F2913D 0%, #F2A339 100%);">
    <div class="flex items-center justify-between">
        <div>
            <h2 class="text-2xl font-bold mb-2">¬°Hola, {{ session.usuario_nombre }}! üëã</h2>
            <div class="flex items-center gap-4 text-sm opacity-90">
                <div class="flex items-center gap-2">
                    <i class="bi bi-clock"></i>
                    <span>Turno: {{ perfil.turno|title if perfil.turno else 'No asignado' }}</span>
                </div>
                <div class="flex items-center gap-2">
                    <i class="bi bi-person-badge"></i>
                    <span>ID: {{ perfil.numero_empleado if perfil.numero_empleado else 'N/A' }}</span>
                </div>
            </div>
        </div>
        <div class="text-right bg-white bg-opacity-20 p-3 rounded-lg backdrop-blur-sm">
            <div class="text-3xl font-bold">{{ stats.mesas_asignadas|length }}</div>
            <div class="text-xs uppercase tracking-wider opacity-90">Mesas Asignadas</div>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">

    <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-[#F2913D] hover:shadow-lg transition">
        <div class="flex items-center justify-between mb-2">
            <i class="bi bi-receipt text-4xl text-[#F2913D]"></i>
            <span class="text-3xl font-bold text-[#0D0D0D]" id="stat-comandas">{{ stats.comandas_activas }}</span>
        </div>
        <p class="text-sm text-gray-600 font-medium">Comandas Activas</p>
        <p class="text-xs text-[#F2913D] mt-1 font-semibold">
            <i class="bi bi-clock"></i> En proceso
        </p>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-[#F2A339] hover:shadow-lg transition">
        <div class="flex items-center justify-between mb-2">
            <i class="bi bi-grid-3x3 text-4xl text-[#F2A339]"></i>
            <span class="text-3xl font-bold text-[#0D0D0D]" id="mesas-ocupadas">0</span>
        </div>
        <p class="text-sm text-gray-600 font-medium">Mesas Ocupadas</p>
        <p class="text-xs text-amber-600 mt-1">
            <i class="bi bi-check-circle"></i> <span id="mesas-libres">{{ stats.mesas_asignadas|length }}</span>
            disponibles
        </p>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-green-500 hover:shadow-lg transition">
        <div class="flex items-center justify-between mb-2">
            <i class="bi bi-cash-coin text-4xl text-green-500"></i>
            <span class="text-3xl font-bold text-[#0D0D0D]" id="stat-propinas">${{ "%.2f"|format(stats.propinas_dia)
                }}</span>
        </div>
        <p class="text-sm text-gray-600 font-medium">Propinas Hoy</p>
        <p class="text-xs text-green-600 mt-1">
            <i class="bi bi-arrow-up"></i> {{ perfil.propinas.sugerida if perfil.propinas else 10 }}% sugerido
        </p>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-[#0D0D0D] hover:shadow-lg transition">
        <div class="flex items-center justify-between mb-2">
            <i class="bi bi-graph-up text-4xl text-[#0D0D0D]"></i>
            <span class="text-3xl font-bold text-[#0D0D0D]" id="venta-dia">$0.00</span>
        </div>
        <p class="text-sm text-gray-600 font-medium">Venta del D√≠a</p>
        <p class="text-xs text-gray-500 mt-1">
            <i class="bi bi-star"></i> <span id="num-ordenes">0</span> √≥rdenes
        </p>
    </div>

</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">

    <div class="lg:col-span-2">
        <div class="card bg-white rounded-xl shadow-md overflow-hidden border-t-4 border-[#F2913D]">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h2 class="text-lg font-bold text-[#0D0D0D] flex items-center gap-2">
                    <i class="bi bi-grid-3x3 text-[#F2913D]"></i>
                    Mis Mesas
                </h2>
                <div class="flex items-center gap-2">
                    <span class="px-3 py-1 bg-[#F2CA99] bg-opacity-30 text-[#F2913D] rounded-full text-xs font-bold">
                        {{ stats.mesas_asignadas|length }} ASIGNADAS
                    </span>
                    <button onclick="cargarEstadoMesas()"
                        class="p-2 hover:bg-gray-200 rounded-full transition text-gray-600">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-6">
                {% if stats.mesas_asignadas %}
                <div id="mesas-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    {% for mesa_num in stats.mesas_asignadas %}
                    <div class="mesa-card border-2 border-gray-200 rounded-xl p-4 transition cursor-pointer text-center group"
                        data-mesa="{{ mesa_num }}" onclick="verMesa('{{ mesa_num }}')">

                        <div
                            class="icon-container w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3 transition">
                            <i class="bi bi-table text-xl"></i>
                        </div>

                        <p class="font-bold text-[#0D0D0D]">Mesa {{ mesa_num }}</p>

                        <span class="mesa-status px-2 py-1 text-[10px] rounded-full"></span>

                        <p class="mesa-comensales text-[10px] uppercase tracking-tighter text-gray-400 mt-1 font-bold">
                            Cargando...
                        </p>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-12 text-gray-400">
                    <i class="bi bi-inbox text-5xl mb-3 opacity-20"></i>
                    <p>No tienes mesas asignadas</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="lg:col-span-1">
        <div class="card bg-white rounded-xl shadow-md border-t-4 border-[#0D0D0D]">
            <div class="p-4 border-b bg-gray-50">
                <h2 class="font-bold text-[#0D0D0D] flex items-center gap-2">
                    <i class="bi bi-lightning-charge-fill text-[#F2A339]"></i>
                    Acciones R√°pidas
                </h2>
            </div>
            <div class="card-body p-4 space-y-3">

                <button onclick="mostrarSeleccionMesa()"
                    class="w-full p-4 bg-[#F2913D] text-white rounded-lg hover:bg-[#F2A339] shadow-md transition flex items-center justify-between group">
                    <div class="flex items-center gap-3">
                        <i class="bi bi-plus-circle-fill text-xl"></i>
                        <span class="font-bold">NUEVA CUENTA</span>
                    </div>
                    <i class="bi bi-chevron-right group-hover:translate-x-1 transition"></i>
                </button>

                <button onclick="verMenu()"
                    class="w-full p-4 bg-white border-2 border-[#F2CA99] text-[#F2913D] rounded-lg hover:bg-[#F2CA99] hover:bg-opacity-20 transition flex items-center justify-between group">
                    <div class="flex items-center gap-3">
                        <i class="bi bi-journal-text text-xl"></i>
                        <span class="font-bold">VER MEN√ö</span>
                    </div>
                    <i class="bi bi-chevron-right group-hover:translate-x-1 transition"></i>
                </button>

                <button onclick="verComandas()"
                    class="w-full p-4 bg-white border-2 border-gray-800 text-gray-800 rounded-lg hover:bg-gray-800 hover:text-white transition flex items-center justify-between group">
                    <div class="flex items-center gap-3">
                        <i class="bi bi-receipt text-xl"></i>
                        <span class="font-bold">MIS COMANDAS</span>
                    </div>
                    <span id="badge-comandas" class="bg-[#F2913D] text-white px-2 py-0.5 rounded text-xs font-bold">
                        {{ stats.comandas_activas }}
                    </span>
                </button>

            </div>
        </div>
    </div>
</div>

<div class="card bg-white rounded-xl shadow-md overflow-hidden border-t-4 border-[#F2A339]">
    <div class="card-header p-4 bg-gray-50 flex justify-between items-center border-b">
        <h2 class="font-bold text-[#0D0D0D] flex items-center gap-2">
            <i class="bi bi-list-stars text-[#F2913D]"></i>
            Detalle de Comandas Activas
        </h2>
        <button onclick="actualizarComandas()" class="text-sm font-bold text-[#F2913D] hover:underline">
            Refrescar lista
        </button>
    </div>
    <div class="card-body p-6">
        <div id="comandas-container">
            <div class="text-center py-10">
                <div
                    class="animate-spin inline-block w-8 h-8 border-4 border-[#F2CA99] border-t-[#F2913D] rounded-full mb-4">
                </div>
                <p class="text-gray-500 font-medium">Sincronizando cocina...</p>
            </div>
        </div>
    </div>
</div>

<div id="modalMesa"
    class="hidden fixed inset-0 bg-[#0D0D0D] bg-opacity-80 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden">
        <div class="bg-[#F2913D] text-white p-5 flex items-center justify-between">
            <h3 class="text-xl font-bold flex items-center gap-2 uppercase">
                <i class="bi bi-house-door-fill"></i>
                Detalle Mesa <span id="modal-mesa-numero"></span>
            </h3>
            <button onclick="cerrarModalMesa()" class="hover:bg-black hover:bg-opacity-10 p-1 rounded transition">
                <i class="bi bi-x-lg text-xl"></i>
            </button>
        </div>
        <div class="p-6 overflow-y-auto" id="modal-mesa-content" style="max-height: calc(90vh - 70px);">
        </div>
    </div>
</div>
<div id="modalMenu"
    class="hidden fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-2 md:p-4 backdrop-blur-sm">
    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-5xl h-[95vh] md:h-[85vh] flex flex-col overflow-hidden">

        <div class="p-5 border-b flex justify-between items-center bg-orange-50">
            <div>
                <h3 class="text-2xl font-black text-orange-800">Mesa #<span id="menu-mesa-num">--</span></h3>
                <p class="text-sm text-orange-600/70 font-medium">Selecciona los productos para la comanda</p>
            </div>
            <button onclick="cerrarModalMenu()"
                class="w-10 h-10 flex items-center justify-center rounded-full bg-white text-gray-400 hover:text-red-500 shadow-sm transition-all text-2xl">&times;</button>
        </div>

        <div class="flex flex-1 overflow-hidden flex-col md:flex-row">

            <div class="flex-1 p-4 overflow-y-auto bg-gray-50/50">
                <div class="mb-4 flex gap-2 overflow-x-auto pb-2">
                    <button
                        class="px-4 py-2 bg-orange-500 text-white rounded-full text-xs font-bold whitespace-nowrap">Todos</button>
                    <button
                        class="px-4 py-2 bg-white border text-gray-600 rounded-full text-xs font-bold whitespace-nowrap">Platillos</button>
                    <button
                        class="px-4 py-2 bg-white border text-gray-600 rounded-full text-xs font-bold whitespace-nowrap">Bebidas</button>
                </div>

                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4" id="lista-productos-grid">
                    <div class="animate-pulse flex flex-col items-center p-4 bg-white rounded-xl shadow-sm">
                        <div class="w-12 h-12 bg-gray-200 rounded-full mb-2"></div>
                        <div class="h-4 bg-gray-200 w-full rounded"></div>
                    </div>
                </div>
            </div>

            <div class="w-full md:w-80 bg-white border-t md:border-t-0 md:border-l flex flex-col shadow-inner">
                <div class="p-4 border-b bg-gray-50/50 flex items-center gap-2">
                    <i class="bi bi-cart3 text-orange-600"></i>
                    <h4 class="font-bold text-gray-700 uppercase tracking-wider text-sm">Resumen de Pedido</h4>
                </div>

                <div id="carrito-items" class="flex-1 overflow-y-auto p-4 space-y-3">
                    <div class="text-center text-gray-400 py-10">
                        <i class="bi bi-plus-circle text-4xl block mb-2 opacity-20"></i>
                        <p class="text-xs">Selecciona un producto <br> de la izquierda</p>
                    </div>
                </div>

                <div class="p-5 border-t bg-gray-50">
                    <div class="flex justify-between items-end mb-4">
                        <span class="text-gray-500 text-sm font-medium">TOTAL A PAGAR</span>
                        <span id="carrito-total" class="text-3xl font-black text-green-600">$0.00</span>
                    </div>

                    <button onclick="confirmarPedidoCocina()"
                        class="w-full bg-orange-600 hover:bg-orange-700 text-white py-4 rounded-2xl font-bold shadow-lg shadow-orange-200 transition-all flex items-center justify-center gap-2 active:scale-95">
                        <i class="bi bi-send-check-fill"></i>
                        ENVIAR A COCINA
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ===================================
    // VARIABLES GLOBALES
    // ===================================
    let mesasData = {};
    let comandasActivas = [];
    const API_BASE = '/api/mesero';

    // üî• CACHE Y OPTIMIZACI√ìN
    let menuCache = null;
    let menuCargando = false;
    let carrito = [];
    let cuentaActivaId = null;

    // ===================================
    // INICIALIZACI√ìN
    // ===================================
    document.addEventListener('DOMContentLoaded', function () {
        console.log('Dashboard Mesero inicializado');

  // üî• DETECTAR SI VIENE DE UN PAGO EXITOSO
    const urlParams = new URLSearchParams(window.location.search);
    const pagoStatus = urlParams.get('pago');
    const pagoError = urlParams.get('error');
    const total = urlParams.get('total');

    if (pagoStatus === 'exitoso') {
        Swal.fire({
            icon: 'success',
            title: '¬°Pago Exitoso!',
            html: `
                <div class="text-center">
                    <i class="bi bi-check-circle text-6xl text-green-500 mb-4"></i>
                    <p class="text-lg">Cuenta cerrada correctamente</p>
                    ${total ? `<p class="text-2xl font-bold text-green-600 mt-2">Total: $${total}</p>` : ''}
                </div>
            `,
            timer: 3000,
            showConfirmButton: false
        });
        
        // Limpiar URL
        window.history.replaceState({}, document.title, window.location.pathname);
    } else if (pagoStatus === 'fallido') {
        Swal.fire({
            icon: 'error',
            title: 'Pago Rechazado',
            text: 'El pago fue rechazado. Por favor intenta nuevamente.',
            confirmButtonColor: '#F2913D'
        });
        window.history.replaceState({}, document.title, window.location.pathname);
    } else if (pagoStatus === 'pendiente') {
        Swal.fire({
            icon: 'info',
            title: 'Pago Pendiente',
            text: 'El pago est√° siendo procesado. Te notificaremos cuando se complete.',
            confirmButtonColor: '#F2913D'
        });
        window.history.replaceState({}, document.title, window.location.pathname);
    } else if (pagoError) {
        let errorMsg = 'Ocurri√≥ un error al procesar el pago';
        
        if (pagoError === 'cuenta_no_encontrada') {
            errorMsg = 'No se encontr√≥ la cuenta';
        } else if (pagoError === 'pago_rejected') {
            errorMsg = 'El pago fue rechazado';
        } else if (pagoError === 'pago_pending') {
            errorMsg = 'El pago est√° pendiente de confirmaci√≥n';
        }
        
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: errorMsg,
            confirmButtonColor: '#F2913D'
        });
        window.history.replaceState({}, document.title, window.location.pathname);
    }

    // üî• PRECARGAR MEN√ö EN SEGUNDO PLANO
    precargarMenu();

    // Cargar datos iniciales
    cargarEstadoMesas();
    actualizarComandas();
    cargarEstadisticasDia();

    // Actualizar cada 30 segundos
    setInterval(() => {
        cargarEstadoMesas();
        actualizarComandas();
        cargarEstadisticasDia();
    }, 30000);
});


    // ===================================
    // üî• PRECARGA DE MEN√ö
    // ===================================
    async function precargarMenu() {
        if (menuCache || menuCargando) return;
        menuCargando = true;

        try {
            const res = await fetch('/api/menu');
            const data = await res.json();
            if (data.success && data.menu) {
                menuCache = data.menu;
                console.log('‚úÖ Men√∫ precargado:', menuCache.length, 'productos');
            }
        } catch (e) {
            console.error('‚ö†Ô∏è Error al precargar men√∫:', e);
        } finally {
            menuCargando = false;
        }
    }

    // ===================================
    // CARGA DE DATOS DESDE LA API
    // ===================================
    async function cargarEstadoMesas() {
        try {
            const response = await fetch(`${API_BASE}/mesas/estado`);
            const data = await response.json();

            if (data.success) {
                mesasData = data.mesas;
                actualizarVisualizacionMesas();
            } else {
                console.error('Error al cargar mesas:', data.error);
            }
        } catch (error) {
            console.error('Error en la petici√≥n:', error);
        }
    }

async function cargarEstadisticasDia() {
    try {
        console.log('üîÑ Cargando estad√≠sticas del d√≠a...');
        
        const response = await fetch(`${API_BASE}/estadisticas/dia`);
        const data = await response.json();

        console.log('üìä Respuesta de estad√≠sticas:', data);

        if (data.success && data.estadisticas) {
            const stats = data.estadisticas;

            const venta = stats.venta_dia ?? 0;
            const propinas = stats.propinas_dia ?? 0;
            const ordenes = stats.num_ordenes ?? 0;

            console.log('üí∞ Venta del d√≠a:', venta);
            console.log('üíµ Propinas del d√≠a:', propinas);
            console.log('üìù N√∫mero de √≥rdenes:', ordenes);

            // Actualizar elementos en el DOM
            const ventaElement = document.getElementById('venta-dia');
            const propinasElement = document.getElementById('stat-propinas');
            const ordenesElement = document.getElementById('num-ordenes');

            if (ventaElement) {
                ventaElement.textContent = `$${Number(venta).toFixed(2)}`;
                console.log('‚úÖ Venta actualizada en DOM');
            } else {
                console.error('‚ùå No se encontr√≥ elemento venta-dia');
            }

            if (propinasElement) {
                propinasElement.textContent = `$${Number(propinas).toFixed(2)}`;
                console.log('‚úÖ Propinas actualizadas en DOM');
            } else {
                console.error('‚ùå No se encontr√≥ elemento stat-propinas');
            }

            if (ordenesElement) {
                ordenesElement.textContent = ordenes;
                console.log('‚úÖ √ìrdenes actualizadas en DOM');
            } else {
                console.error('‚ùå No se encontr√≥ elemento num-ordenes');
            }
        } else {
            console.error('‚ùå Error en la respuesta:', data.error || 'Sin datos');
        }
    } catch (error) {
        console.error('‚ùå Error al cargar estad√≠sticas:', error);
    }
}

    async function actualizarComandas() {
        try {
            const response = await fetch(`${API_BASE}/comandas/activas`);
            const data = await response.json();

            if (data.success) {
                comandasActivas = data.comandas;
                renderizarComandas();

                // Actualizar n√∫mero en el card superior
                const statComandas = document.getElementById('stat-comandas');
                if (statComandas) statComandas.textContent = data.total;

                // Actualizar badge en el bot√≥n lateral
                const badgeComandas = document.getElementById('badge-comandas');
                if (badgeComandas) badgeComandas.textContent = data.total;

            } else {
                console.error('Error al cargar comandas:', data.error);
            }
        } catch (error) {
            console.error('Error en la petici√≥n:', error);
        }
    }

    // ===================================
    // RENDERIZADO DE MESAS
    // ===================================
    function actualizarVisualizacionMesas() {
        const mesasCards = document.querySelectorAll('.mesa-card');
        let ocupadas = 0;

        mesasCards.forEach(card => {
            const numeroMesa = card.dataset.mesa;
            const mesaInfo = mesasData[numeroMesa] || mesasData[parseInt(numeroMesa)];
            const statusSpan = card.querySelector('.mesa-status');
            const comensalesP = card.querySelector('.mesa-comensales');
            const iconContainer = card.querySelector('.icon-container');
            const icon = iconContainer.querySelector('i');

            // Reset de clases b√°sicas
            card.classList.remove('border-red-500', 'border-gray-200', 'bg-red-50', 'border-blue-400');
            iconContainer.classList.remove('bg-green-100', 'bg-red-100', 'bg-gray-100', 'bg-blue-100');
            icon.classList.remove('text-red-600', 'text-green-600', 'text-gray-600', 'text-blue-600');

            if (mesaInfo) {
                const estado = (mesaInfo.estado || "").toLowerCase().trim();

                if (estado === 'ocupada') {
                    ocupadas++;
                    statusSpan.className = 'mesa-status px-2 py-0.5 text-[10px] font-bold rounded-full bg-red-100 text-red-700';
                    statusSpan.textContent = 'OCUPADA';
                    comensalesP.textContent = `${mesaInfo.comensales || 0} PERSONAS`;
                    comensalesP.classList.remove('text-gray-400');
                    comensalesP.classList.add('text-red-500');
                    card.classList.add('border-red-500', 'bg-red-50');
                    iconContainer.classList.add('bg-red-100');
                    icon.classList.add('text-red-600');

                } else if (estado === 'reservada') {
                    statusSpan.className = 'mesa-status px-2 py-0.5 text-[10px] font-bold rounded-full bg-blue-100 text-blue-700';
                    statusSpan.textContent = 'RESERVADA';
                    comensalesP.textContent = mesaInfo.reserva_hora || 'RESERVA';
                    card.classList.add('border-blue-400');
                    iconContainer.classList.add('bg-blue-100');
                    icon.classList.add('text-blue-600');

                } else {
                    statusSpan.className = 'mesa-status px-2 py-0.5 text-[10px] font-bold rounded-full bg-green-100 text-green-700';
                    statusSpan.textContent = 'LIBRE';
                    comensalesP.textContent = 'SIN CLIENTES';
                    comensalesP.classList.remove('text-red-500');
                    comensalesP.classList.add('text-gray-400');
                    card.classList.add('border-gray-200');
                    iconContainer.classList.add('bg-green-100');
                    icon.classList.add('text-green-600');
                }
            } else {
                console.error(`Error: No hay data para la mesa ${numeroMesa}`, mesasData);
                statusSpan.textContent = 'N/A';
                comensalesP.textContent = 'SIN DATOS';
            }
        });

        // Actualizar contadores
        const totalMesas = mesasCards.length;
        const mesasOcupadasElement = document.getElementById('mesas-ocupadas');
        const mesasLibresElement = document.getElementById('mesas-libres');

        if (mesasOcupadasElement) mesasOcupadasElement.textContent = ocupadas;
        if (mesasLibresElement) mesasLibresElement.textContent = totalMesas - ocupadas;
    }

    // ===================================
    // RENDERIZADO DE COMANDAS
    // ===================================
    function renderizarComandas() {
        const container = document.getElementById('comandas-container');

        if (comandasActivas.length === 0) {
            container.innerHTML = `
            <div class="text-center py-12 text-gray-500">
                <i class="bi bi-cart-check text-6xl mb-4 block opacity-30"></i>
                <p class="text-lg">No hay comandas activas</p>
                <p class="text-sm mt-2">Las comandas aparecer√°n aqu√≠ cuando tomes pedidos</p>
                <button onclick="mostrarSeleccionMesa()" class="btn btn-primary mt-4">
                    <i class="bi bi-plus-circle"></i>
                    Crear Nueva Cuenta
                </button>
            </div>
        `;
            return;
        }

        let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';

        comandasActivas.forEach(comanda => {
            const tiempoTranscurrido = calcularTiempoTranscurrido(comanda.fecha_apertura);
            html += `
            <div class="border-2 border-gray-200 rounded-xl p-4 hover:border-orange-400 hover:shadow-md transition">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                        <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
                            <i class="bi bi-receipt text-orange-600"></i>
                        </div>
                        <div>
                            <p class="font-bold text-gray-800">${comanda.folio}</p>
                            <p class="text-xs text-gray-500">Mesa ${comanda.mesa_numero}</p>
                        </div>
                    </div>
                    <span class="badge badge-warning">${tiempoTranscurrido}</span>
                </div>
                
                <div class="space-y-2 text-sm mb-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Comensales:</span>
                        <span class="font-semibold">${comanda.num_comensales ?? comanda.comensales ?? 0}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Items:</span>
                        <span class="font-semibold">${comanda.items.length}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Total:</span>
                        <span class="font-bold text-lg text-green-600">$${comanda.total.toFixed(2)}</span>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="verDetalleComanda('${comanda.id}')" class="btn btn-sm btn-secondary">
                    <i class="bi bi-eye"></i> Ver
                    </button>
                    <button onclick="agregarItemsComanda('${comanda.id}')" class="btn btn-sm btn-primary">
                    <i class="bi bi-plus"></i> Agregar
                    </button>
                </div>
            </div>
        `;
        });

        html += '</div>';
        container.innerHTML = html;
    }

    // ===================================
    // üî• GESTI√ìN DE MESAS (OPTIMIZADO)
    // ===================================
    async function verMesa(numeroMesa) {
        const modal = document.getElementById('modalMesa');
        const content = document.getElementById('modal-mesa-content');

        // üî• MOSTRAR MODAL INMEDIATAMENTE CON LOADING
        document.getElementById('modal-mesa-numero').textContent = numeroMesa;
        content.innerHTML = `
        <div class="text-center py-12">
            <div class="animate-spin inline-block w-12 h-12 border-4 border-orange-200 border-t-orange-600 rounded-full mb-4"></div>
            <p class="text-gray-500 font-medium">Cargando informaci√≥n...</p>
        </div>
    `;
        modal.classList.remove('hidden');

        // üî• CARGAR DATOS EN SEGUNDO PLANO
        try {
            const response = await fetch(`${API_BASE}/mesa/${numeroMesa}`);
            const data = await response.json();

            if (!data.success) {
                content.innerHTML = `
                <div class="text-center py-8 text-red-500">
                    <i class="bi bi-exclamation-triangle text-5xl mb-3"></i>
                    <p>${data.error || 'Error al cargar mesa'}</p>
                </div>
            `;
                return;
            }

            const mesa = data.mesa;
            const comanda = data.comanda;

            if (mesa.estado === 'libre' || mesa.estado === 'disponible') {
                content.innerHTML = `
                <div class="text-center py-8">
                    <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="bi bi-check-circle text-5xl text-green-600"></i>
                    </div>
                    <h4 class="text-xl font-bold text-gray-800 mb-2">Mesa Disponible</h4>
                    <p class="text-sm text-gray-500 mb-6">Capacidad: ${mesa.capacidad || 4} personas</p>
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="abrirCuenta('${numeroMesa}')" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold">Abrir Cuenta</button>
                        <button onclick="cerrarModalMesa()" class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-bold">Cancelar</button>
                    </div>
                </div>`;
            } else {
                const total = comanda ? Number(comanda.total).toFixed(2) : "0.00";
                const folio = comanda ? comanda.folio : 'Generando...';
                const personas = comanda?.num_comensales ?? comanda?.comensales ?? mesa?.num_comensales ?? 0;

                content.innerHTML = `
                <div class="space-y-4">
                    <div class="bg-orange-50 border-l-4 border-orange-500 p-5 rounded-xl">
                        <p class="font-black text-orange-900 text-lg uppercase">Mesa Ocupada</p>
                        <div class="flex justify-between items-center mt-2">
                            <div>
                                <p class="text-xs text-orange-700 font-bold uppercase tracking-widest">Folio</p>
                                <p class="text-gray-800 font-mono">${folio}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-orange-700 font-bold uppercase tracking-widest">Comensales</p>
                                <p class="text-gray-800">${personas} personas</p>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-orange-200">
                            <p class="text-xs text-orange-700 font-bold uppercase tracking-widest">Total Acumulado</p>
                            <p class="text-4xl font-black text-gray-900">$${total}</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 gap-3">
                        <button onclick="abrirModalMenu('${numeroMesa}', '${mesa.cuenta_activa_id}', true)" 
                                class="w-full bg-[#F2913D] hover:bg-[#F2A339] text-white py-4 rounded-xl font-black shadow-lg transition flex items-center justify-center gap-2">
                            <i class="bi bi-plus-circle-fill text-xl"></i>
                            AGREGAR PRODUCTOS AL PEDIDO
                        </button>
                        <button onclick="cerrarCuenta('${mesa.cuenta_activa_id}', '${numeroMesa}')"
                                class="w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-black shadow-lg transition flex items-center justify-center gap-2">
                            <i class="bi bi-cash-coin"></i>
                            CERRAR CUENTA
                        </button>
                        <button onclick="cerrarModalMesa()" 
                                class="w-full bg-gray-100 text-gray-500 py-3 rounded-xl font-bold hover:bg-gray-200 transition">
                            Cerrar Detalle
                        </button>
                    </div>
                </div>`;
            }
        } catch (error) {
            console.error('Error al cargar mesa:', error);
            content.innerHTML = `
            <div class="text-center py-8 text-red-500">
                <i class="bi bi-wifi-off text-5xl mb-3"></i>
                <p>Error de conexi√≥n</p>
            </div>
        `;
        }
    }

    function cerrarModalMesa() {
        document.getElementById('modalMesa').classList.add('hidden');
    }

    // ===================================
    // üî• MODAL DE MEN√ö (OPTIMIZADO)
    // ===================================
    async function abrirModalMenu(numMesa, idCuenta, cargarItemsExistentes = false) {
        const modal = document.getElementById('modalMenu');
        const labelMesa = document.getElementById('menu-mesa-num');
        const grid = document.getElementById('lista-productos-grid');

        if (!modal || !grid) {
            console.error("No se encontr√≥ el modal de men√∫");
            return;
        }

        // üî• MOSTRAR MODAL INMEDIATAMENTE
        labelMesa.textContent = numMesa;
        modal.classList.remove('hidden');

        // Configurar carrito
        cuentaActivaId = idCuenta;

        if (cargarItemsExistentes && cuentaActivaId) {
            await cargarItemsExistentesEnCarrito(cuentaActivaId);
        } else {
            carrito = [];
        }
        renderizarCarrito();

        // üî• USAR CACHE O CARGAR
        if (menuCache && menuCache.length > 0) {
            console.log('‚úÖ Usando men√∫ en cache');
            renderizarProductos(menuCache, grid);
        } else {
            console.log('‚è≥ Cargando men√∫ desde servidor...');
            grid.innerHTML = `
            <div class="col-span-full text-center py-12">
                <div class="animate-spin inline-block w-12 h-12 border-4 border-orange-200 border-t-orange-600 rounded-full mb-4"></div>
                <p class="text-gray-500 font-medium">Cargando productos...</p>
            </div>
        `;

            try {
                const res = await fetch('/api/menu');
                const data = await res.json();

                if (data.success && data.menu) {
                    menuCache = data.menu;
                    renderizarProductos(menuCache, grid);
                } else {
                    grid.innerHTML = '<p class="text-red-500 col-span-full text-center py-8">Error al cargar el men√∫</p>';
                }
            } catch (e) {
                console.error('Error al cargar men√∫:', e);
                grid.innerHTML = '<p class="text-red-500 col-span-full text-center py-8">Error de conexi√≥n</p>';
            }
        }
    }

    // üî• RENDERIZADO OPTIMIZADO CON DOCUMENTFRAGMENT
    function renderizarProductos(productos, grid) {
        const fragment = document.createDocumentFragment();

        productos.forEach(p => {
            const div = document.createElement('div');
            div.className = 'p-4 border rounded-xl hover:bg-orange-50 cursor-pointer transition flex justify-between items-center';
            div.onclick = () => agregarAlCarrito(p._id, p.nombre, p.precio);
            div.innerHTML = `
            <div>
                <p class="font-bold text-gray-800">${p.nombre}</p>
                <p class="text-sm text-orange-600 font-bold">$${p.precio.toFixed(2)}</p>
            </div>
            <i class="bi bi-plus-circle-fill text-orange-400 text-xl"></i>
        `;
            fragment.appendChild(div);
        });

        grid.innerHTML = '';
        grid.appendChild(fragment);
    }

    async function cargarItemsExistentesEnCarrito(cuentaId) {
        const comanda = comandasActivas.find(c => c.id == cuentaId || c._id == cuentaId);

        if (!comanda || !comanda.items) {
            carrito = [];
            return;
        }

        carrito = comanda.items.map(item => ({
            id: item.producto_id || item.id || item._id,
            nombre: item.nombre,
            precio: item.precio,
            cantidad: item.cantidad
        }));

        console.log('‚úÖ Items existentes cargados:', carrito);
    }

    function agregarAlCarrito(id, nombre, precio) {
        const itemExistente = carrito.find(i => i.id === id);
        if (itemExistente) {
            itemExistente.cantidad++;
        } else {
            carrito.push({ id, nombre, precio, cantidad: 1 });
        }
        renderizarCarrito();
    }

    function renderizarCarrito() {
        const container = document.getElementById('carrito-items');
        const totalElement = document.getElementById('carrito-total');
        let total = 0;

        if (carrito.length === 0) {
            container.innerHTML = `
            <div class="text-center text-gray-400 py-10">
                <i class="bi bi-plus-circle text-4xl block mb-2 opacity-20"></i>
                <p class="text-xs">Selecciona un producto <br> de la izquierda</p>
            </div>
        `;
            totalElement.textContent = '$0.00';
            return;
        }

        // üî• USAR FRAGMENT PARA MEJOR PERFORMANCE
        const fragment = document.createDocumentFragment();

        carrito.forEach((item, index) => {
            const subtotal = item.precio * item.cantidad;
            total += subtotal;

            const div = document.createElement('div');
            div.className = 'flex justify-between items-center p-2 bg-white rounded-lg shadow-sm border border-gray-100';
            div.innerHTML = `
            <div class="flex-1">
                <p class="font-bold text-xs">${item.nombre}</p>
                <p class="text-[10px] text-gray-500">$${item.precio.toFixed(2)} x ${item.cantidad}</p>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="modificarCantidad(${index}, -1)" class="w-6 h-6 bg-gray-100 rounded text-gray-600">-</button>
                <span class="text-xs font-bold">${item.cantidad}</span>
                <button onclick="modificarCantidad(${index}, 1)" class="w-6 h-6 bg-gray-100 rounded text-gray-600">+</button>
            </div>
        `;
            fragment.appendChild(div);
        });

        container.innerHTML = '';
        container.appendChild(fragment);
        totalElement.textContent = `$${total.toFixed(2)}`;
    }

    function modificarCantidad(index, cambio) {
        carrito[index].cantidad += cambio;
        if (carrito[index].cantidad <= 0) {
            carrito.splice(index, 1);
        }
        renderizarCarrito();
    }

    async function confirmarPedidoCocina() {
        if (carrito.length === 0) {
            return Swal.fire("Carrito vac√≠o", "Agrega al menos un producto", "warning");
        }

        showLoading("Enviando a cocina...");

        try {
            const res = await fetch(`${API_BASE}/comanda/${cuentaActivaId}/items`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ items: carrito })
            });

            const data = await res.json();

            if (data.success) {
                showSuccess("¬°Pedido enviado correctamente!");
                cerrarModalMenu();
                actualizarComandas();
                cargarEstadisticasDia();
            } else {
                showError(data.error || 'Error al enviar pedido');
            }
        } catch (e) {
            console.error('Error:', e);
            showError("Error de conexi√≥n");
        }
    }

    function cerrarModalMenu() {
        document.getElementById('modalMenu').classList.add('hidden');
        cuentaActivaId = null;
    }

    // ===================================
    // GESTI√ìN DE CUENTAS
    // ===================================
    async function abrirCuenta(numeroMesa) {
        const { value: numComensales } = await Swal.fire({
            title: `Mesa ${numeroMesa}`,
            input: 'number',
            inputLabel: '¬øCu√°ntos comensales?',
            inputAttributes: { min: 1, max: 20, step: 1 },
            showCancelButton: true,
            confirmButtonText: 'Abrir y Tomar Pedido',
            cancelButtonText: 'Solo Abrir',
            confirmButtonColor: '#F2913D',
        });

        if (numComensales) {
            try {
                showLoading('Iniciando comanda...');

                const response = await fetch(`${API_BASE}/cuenta/abrir`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        numero_mesa: numeroMesa,
                        num_comensales: parseInt(numComensales)
                    })
                });

                const data = await response.json();
                hideLoading();

                if (data.success) {
                    cuentaActivaId = data.cuenta_id;

                    Swal.fire({
                        title: '¬°√âxito!',
                        text: 'Cuenta abierta correctamente',
                        icon: 'success',
                        timer: 1500,
                        showConfirmButton: false
                    });

                    cerrarModalMesa();
                    await cargarEstadoMesas();
                    actualizarComandas();
                    cargarEstadisticasDia();

                    abrirModalMenu(numeroMesa, data.cuenta_id);

                } else {
                    showError(data.error || 'Error al abrir cuenta');
                }
            } catch (error) {
                hideLoading();
                showError('Error de conexi√≥n');
                console.error(error);
            }
        }
    }

    function mostrarSeleccionMesa() {
        const mesasDisponibles = Object.values(mesasData).filter(m => m.estado === 'disponible');

        if (mesasDisponibles.length === 0) {
            Swal.fire({
                title: 'No hay mesas disponibles',
                text: 'Todas tus mesas est√°n ocupadas o en limpieza',
                icon: 'info'
            });
            return;
        }

        const opciones = {};
        mesasDisponibles.forEach(mesa => {
            opciones[mesa.numero] = `Mesa ${mesa.numero} (${mesa.capacidad} personas)`;
        });

        Swal.fire({
            title: 'Selecciona una mesa',
            input: 'select',
            inputOptions: opciones,
            inputPlaceholder: 'Elige una mesa',
            showCancelButton: true,
            confirmButtonText: 'Abrir cuenta',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed && result.value) {
                abrirCuenta(result.value);
            }
        });
    }

    // ===================================
    // ACCIONES R√ÅPIDAS
    // ===================================
    function verMenu() {
        window.location.href = "{{ url_for('routes.mesero_menu') }}";
    }

    function verComandas() {
        window.location.href = "{{ url_for('routes.mesero_comandas') }}";
    }

    async function verDetalleComanda(cuentaId) {
        const comanda = comandasActivas.find(c => c.id == cuentaId || c._id == cuentaId);

        if (!comanda) {
            showError('No se encontr√≥ la comanda');
            return;
        }

        let itemsHtml = '';
        if (comanda.items && comanda.items.length > 0) {
            itemsHtml = comanda.items.map(item => `
            <div class="flex justify-between items-center p-4 bg-white rounded-2xl shadow-sm border">
                <div>
                    <p class="font-bold text-gray-800 text-sm">${item.nombre}</p>
                    <p class="text-xs text-gray-500">
                        $${item.precio.toFixed(2)} √ó ${item.cantidad}
                    </p>
                </div>
                <p class="font-black text-green-600 text-lg">
                    $${(item.precio * item.cantidad).toFixed(2)}
                </p>
            </div>
        `).join('');
        } else {
            itemsHtml = `
            <div class="text-center text-gray-400 py-12">
                <i class="bi bi-cart-x text-5xl block mb-3 opacity-30"></i>
                <p class="text-sm">Sin productos a√∫n</p>
            </div>
        `;
        }

        Swal.fire({
            width: 720,
            showConfirmButton: false,
            showCancelButton: false,
            backdrop: 'rgba(0,0,0,.6)',
            customClass: {
                popup: 'rounded-[28px] overflow-hidden relative'
            },
            html: `
            <button 
                onclick="Swal.close()"
                class="absolute top-4 right-4 w-10 h-10 rounded-full bg-white shadow-md text-gray-400 hover:text-red-500 transition flex items-center justify-center text-2xl z-50">
                &times;
            </button>

            <div class="bg-orange-600 text-white px-6 pt-8 pb-6 rounded-t-[28px]">
                <h3 class="text-2xl font-black">${comanda.folio}</h3>
                <p class="text-sm opacity-90">
                    Mesa ${comanda.mesa_numero} ¬∑ 
                    ${comanda.num_comensales ?? comanda.comensales ?? 0} personas
                </p>
            </div>

            <div class="p-6 bg-gray-50 max-h-[55vh] overflow-y-auto space-y-3">
                ${itemsHtml}
            </div>

            <div class="p-6 bg-white border-t flex justify-between items-center">
                <div>
                    <p class="text-xs font-bold text-gray-500 uppercase">Total</p>
                    <p class="text-4xl font-black text-green-600">
                        $${comanda.total.toFixed(2)}
                    </p>
                </div>

                <button 
                    onclick="agregarItemsComanda('${cuentaId}')"
                    class="px-6 py-4 rounded-2xl bg-orange-600 hover:bg-orange-700 text-white font-black shadow-lg transition flex items-center gap-2">
                    <i class="bi bi-plus-circle-fill text-xl"></i>
                    Agregar productos
                </button>
            </div>
        `
        });
    }

    function agregarItemsComanda(cuentaId) {
        const comanda = comandasActivas.find(c => c.id == cuentaId || c._id == cuentaId);

        if (!comanda) {
            showError('No se encontr√≥ la comanda');
            return;
        }

        abrirModalMenu(comanda.mesa_numero, cuentaId, true);
    }

async function cerrarCuenta(cuentaId, numeroMesa) {
    
    // üî• Obtener datos de la comanda para mostrar el total
    const comanda = comandasActivas.find(c => c.id == cuentaId || c._id == cuentaId);
    const totalCuenta = comanda ? comanda.total : 0;
    
    Swal.fire({
        title: false,
        html: `
            <!-- HEADER -->
            <div class="bg-gradient-to-r from-green-600 to-green-700 text-white px-6 py-5 -mt-6 -mx-6 mb-6 rounded-t-xl">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                            <i class="bi bi-cash-coin text-2xl"></i>
                        </div>
                        <div class="text-left">
                            <h3 class="text-xl font-black">Cerrar Cuenta</h3>
                            <p class="text-sm opacity-90">Mesa ${numeroMesa}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-xs opacity-75 uppercase tracking-wider">Total</p>
                        <p class="text-3xl font-black">$${totalCuenta.toFixed(2)}</p>
                    </div>
                </div>
            </div>

            <!-- PROPINA SECTION -->
            <div class="mb-6">
                <label class="block text-left text-sm font-bold text-gray-700 mb-3">
                    <i class="bi bi-piggy-bank text-green-600"></i>
                    Propina del Cliente
                </label>
                
                <!-- Botones de propina r√°pida -->
                <div class="grid grid-cols-4 gap-2 mb-3">
                    <button type="button" onclick="seleccionarPropina('sin', this)" 
                            class="propina-btn p-3 border-2 border-gray-200 rounded-lg hover:border-green-500 hover:bg-green-50 transition text-center">
                        <p class="text-xs font-bold text-gray-500">Sin</p>
                        <p class="text-lg font-black text-gray-700">0%</p>
                    </button>
                    <button type="button" onclick="seleccionarPropina('10', this)" 
                            class="propina-btn p-3 border-2 border-gray-200 rounded-lg hover:border-green-500 hover:bg-green-50 transition text-center">
                        <p class="text-xs font-bold text-gray-500">Bueno</p>
                        <p class="text-lg font-black text-gray-700">10%</p>
                    </button>
                    <button type="button" onclick="seleccionarPropina('15', this)" 
                            class="propina-btn p-3 border-2 border-green-500 bg-green-50 rounded-lg transition text-center propina-seleccionada">
                        <p class="text-xs font-bold text-green-600">Excelente</p>
                        <p class="text-lg font-black text-green-700">15%</p>
                    </button>
                    <button type="button" onclick="seleccionarPropina('20', this)" 
                            class="propina-btn p-3 border-2 border-gray-200 rounded-lg hover:border-green-500 hover:bg-green-50 transition text-center">
                        <p class="text-xs font-bold text-gray-500">Incre√≠ble</p>
                        <p class="text-lg font-black text-gray-700">20%</p>
                    </button>
                </div>
                
                <!-- Propina personalizada -->
                <button type="button" onclick="togglePropinaCustom()" 
                        class="w-full p-2 border border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-green-500 hover:text-green-600 transition text-sm font-medium">
                    <i class="bi bi-pencil"></i> Otra cantidad
                </button>
                
                <div id="custom-propina-container" class="hidden mt-3">
                    <div class="relative">
                        <input type="number" id="custom_propina" 
                               class="w-full pl-10 pr-12 py-3 border-2 border-gray-200 rounded-lg focus:border-green-500 focus:outline-none text-lg font-bold text-center"
                               placeholder="0" min="0" max="30" step="0.5">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                            <i class="bi bi-percent"></i>
                        </span>
                        <span class="absolute right-3 top-1/2 -translate-y-1/2 text-xs font-bold text-gray-400">
                            PERSONALIZADO
                        </span>
                    </div>
                </div>
                
                <input type="hidden" id="tipo_propina" value="15">
                
                <!-- Preview de propina -->
                <div id="propina-preview" class="mt-3 p-3 bg-green-50 rounded-lg border border-green-200">
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-gray-600">Propina calculada:</span>
                        <span class="font-black text-green-700 text-lg">+$${(totalCuenta * 0.15).toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between items-center text-xs mt-1 pt-2 border-t border-green-200">
                        <span class="text-gray-500">Total a cobrar:</span>
                        <span class="font-black text-gray-800 text-base">$${(totalCuenta * 1.15).toFixed(2)}</span>
                    </div>
                </div>
            </div>

            <!-- M√âTODO DE PAGO -->
            <div class="mb-6">
                <label class="block text-left text-sm font-bold text-gray-700 mb-3">
                    <i class="bi bi-credit-card text-blue-600"></i>
                    M√©todo de Pago
                </label>
                
                <div class="grid grid-cols-3 gap-2">
                    <button type="button" onclick="seleccionarMetodo('efectivo', this)" 
                            class="metodo-btn p-4 border-2 border-orange-500 bg-orange-50 rounded-lg transition text-center metodo-seleccionado">
                        <i class="bi bi-cash-stack text-2xl text-orange-600 block mb-1"></i>
                        <p class="text-xs font-bold text-orange-700">Efectivo</p>
                    </button>
                    <button type="button" onclick="seleccionarMetodo('tarjeta', this)" 
                            class="metodo-btn p-4 border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition text-center">
                        <i class="bi bi-credit-card text-2xl text-gray-400 block mb-1"></i>
                        <p class="text-xs font-bold text-gray-600">Tarjeta MP</p>
                    </button>
                    <button type="button" onclick="seleccionarMetodo('transferencia', this)" 
                            class="metodo-btn p-4 border-2 border-gray-200 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition text-center">
                        <i class="bi bi-phone text-2xl text-gray-400 block mb-1"></i>
                        <p class="text-xs font-bold text-gray-600">Transfer</p>
                    </button>
                </div>
                
                <input type="hidden" id="metodo_pago" value="efectivo">
            </div>

            <!-- NOTA INFO -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-left">
                <div class="flex gap-2">
                    <i class="bi bi-info-circle text-blue-600 mt-0.5"></i>
                    <div class="text-xs text-blue-800">
                        <p class="font-bold mb-1">üí° Recordatorio</p>
                        <p>Al cerrar esta cuenta, la mesa quedar√° disponible autom√°ticamente.</p>
                    </div>
                </div>
            </div>
        `,
        width: 600,
        showCancelButton: true,
        confirmButtonText: '<i class="bi bi-check-circle-fill mr-2"></i>Confirmar y Cerrar',
        cancelButtonText: '<i class="bi bi-x-circle mr-2"></i>Cancelar',
        confirmButtonColor: '#16a34a',
        cancelButtonColor: '#6b7280',
        customClass: {
            popup: 'rounded-2xl',
            confirmButton: 'px-6 py-3 rounded-xl font-bold shadow-lg',
            cancelButton: 'px-6 py-3 rounded-xl font-bold'
        },
        didOpen: () => {
            // Configurar el total para los c√°lculos
            window.totalCuentaActual = totalCuenta;
            
            // Actualizar preview inicial
            actualizarPropinaPreview();
        },
        preConfirm: () => {
            const tipo = document.getElementById('tipo_propina').value;
            const custom = document.getElementById('custom_propina').value;
            const metodo = document.getElementById('metodo_pago').value;

            if (tipo === 'custom' && (!custom || custom < 0 || custom > 30)) {
                Swal.showValidationMessage('El porcentaje debe estar entre 0 y 30');
                return false;
            }

            return {
                tipo_propina: tipo,
                custom_porcentaje: tipo === 'custom' ? Number(custom) : null,
                metodo_pago: metodo
            };
        }
    }).then(async (result) => {
        
        if (!result.isConfirmed) return;

        const { tipo_propina, custom_porcentaje, metodo_pago } = result.value;

        // üî• SI ES TARJETA ‚Üí MERCADO PAGO CON POLLING
        if (metodo_pago === "tarjeta") {
            
            showLoading("Generando link de pago...");

            const res = await fetch(`/api/pago/crear/${cuentaId}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ tipo_propina, custom_porcentaje })
            });

            const data = await res.json();
            hideLoading();

            if (data.success) {
                const ventanaPago = window.open(data.init_point, '_blank', 'width=600,height=800');
                await esperarConfirmacionPago(cuentaId, ventanaPago);
            } else {
                showError(data.error || "Error al iniciar pago");
            }
            return;
        }

        // üî• EFECTIVO / TRANSFERENCIA ‚Üí CIERRE NORMAL
        showLoading("Cerrando cuenta...");

        const res = await fetch(`/api/mesero/cuenta/${cuentaId}/cerrar`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ tipo_propina, custom_porcentaje, metodo_pago })
        });

        const data = await res.json();
        hideLoading();

        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: '¬°Cuenta Cerrada!',
                html: `
                    <div class="text-center py-4">
                        <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="bi bi-check-circle-fill text-5xl text-green-600"></i>
                        </div>
                        <p class="text-gray-600 mb-4">Transacci√≥n completada exitosamente</p>
                        <div class="bg-gray-50 rounded-xl p-4 space-y-2">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Consumo:</span>
                                <span class="font-bold">$${data.total.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Propina (${data.porcentaje_propina}%):</span>
                                <span class="font-bold text-green-600">+$${data.propina.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between text-lg pt-2 border-t border-gray-200">
                                <span class="font-black text-gray-800">TOTAL:</span>
                                <span class="font-black text-green-600">$${data.total_final.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                `,
                timer: 3000,
                showConfirmButton: false,
                customClass: {
                    popup: 'rounded-2xl'
                }
            });

            cerrarModalMesa();
            await cargarEstadoMesas();
            await actualizarComandas();
            await cargarEstadisticasDia();
        } else {
            showError(data.error || 'Error al cerrar cuenta');
        }
    });
}

// üî• FUNCIONES AUXILIARES PARA EL MODAL

function seleccionarPropina(valor, boton) {
    // Remover selecci√≥n previa
    document.querySelectorAll('.propina-btn').forEach(btn => {
        btn.classList.remove('propina-seleccionada', 'border-green-500', 'bg-green-50');
        btn.classList.add('border-gray-200');
    });
    
    // Marcar el bot√≥n seleccionado
    boton.classList.add('propina-seleccionada', 'border-green-500', 'bg-green-50');
    boton.classList.remove('border-gray-200');
    
    // Actualizar campo oculto
    document.getElementById('tipo_propina').value = valor;
    
    // Ocultar custom si no es necesario
    if (valor !== 'custom') {
        document.getElementById('custom-propina-container').classList.add('hidden');
        document.getElementById('custom_propina').value = '';
    }
    
    // Actualizar preview
    actualizarPropinaPreview();
}

function togglePropinaCustom() {
    const container = document.getElementById('custom-propina-container');
    const isHidden = container.classList.contains('hidden');
    
    if (isHidden) {
        container.classList.remove('hidden');
        document.getElementById('tipo_propina').value = 'custom';
        
        // Remover selecci√≥n de botones
        document.querySelectorAll('.propina-btn').forEach(btn => {
            btn.classList.remove('propina-seleccionada', 'border-green-500', 'bg-green-50');
            btn.classList.add('border-gray-200');
        });
        
        // Focus en el input
        setTimeout(() => {
            document.getElementById('custom_propina').focus();
        }, 100);
    } else {
        container.classList.add('hidden');
        seleccionarPropina('15', document.querySelectorAll('.propina-btn')[2]);
    }
}

function seleccionarMetodo(metodo, boton) {
    // Remover selecci√≥n previa
    document.querySelectorAll('.metodo-btn').forEach(btn => {
        btn.classList.remove('metodo-seleccionado');
        btn.classList.add('border-gray-200');
        
        // Resetear iconos
        const icon = btn.querySelector('i');
        const text = btn.querySelector('p');
        icon.classList.remove('text-orange-600', 'text-blue-600', 'text-purple-600');
        icon.classList.add('text-gray-400');
        text.classList.remove('text-orange-700', 'text-blue-700', 'text-purple-700');
        text.classList.add('text-gray-600');
    });
    
    // Marcar el bot√≥n seleccionado
    boton.classList.add('metodo-seleccionado');
    boton.classList.remove('border-gray-200');
    
    const icon = boton.querySelector('i');
    const text = boton.querySelector('p');
    
    if (metodo === 'efectivo') {
        boton.classList.add('border-orange-500', 'bg-orange-50');
        icon.classList.add('text-orange-600');
        text.classList.add('text-orange-700');
    } else if (metodo === 'tarjeta') {
        boton.classList.add('border-blue-500', 'bg-blue-50');
        icon.classList.add('text-blue-600');
        text.classList.add('text-blue-700');
    } else if (metodo === 'transferencia') {
        boton.classList.add('border-purple-500', 'bg-purple-50');
        icon.classList.add('text-purple-600');
        text.classList.add('text-purple-700');
    }
    
    // Actualizar campo oculto
    document.getElementById('metodo_pago').value = metodo;
}

function actualizarPropinaPreview() {
    const tipo = document.getElementById('tipo_propina').value;
    const customInput = document.getElementById('custom_propina');
    const total = window.totalCuentaActual || 0;
    
    let porcentaje = 0;
    
    if (tipo === 'custom') {
        porcentaje = parseFloat(customInput.value) || 0;
    } else if (tipo === 'sin') {
        porcentaje = 0;
    } else {
        porcentaje = parseFloat(tipo);
    }
    
    const propina = total * (porcentaje / 100);
    const totalFinal = total + propina;
    
    // Actualizar preview
    const preview = document.getElementById('propina-preview');
    if (preview) {
        preview.innerHTML = `
            <div class="flex justify-between items-center text-sm">
                <span class="text-gray-600">Propina calculada (${porcentaje}%):</span>
                <span class="font-black text-green-700 text-lg">+$${propina.toFixed(2)}</span>
            </div>
            <div class="flex justify-between items-center text-xs mt-1 pt-2 border-t border-green-200">
                <span class="text-gray-500">Total a cobrar:</span>
                <span class="font-black text-gray-800 text-base">$${totalFinal.toFixed(2)}</span>
            </div>
        `;
    }
}

// Event listener para actualizar preview cuando cambia el custom
document.addEventListener('input', function(e) {
    if (e.target && e.target.id === 'custom_propina') {
        actualizarPropinaPreview();
    }
});
// üî• FUNCI√ìN PARA HACER POLLING Y ESPERAR CONFIRMACI√ìN
async function esperarConfirmacionPago(cuentaId, ventanaPago) {
    let intentos = 0;
    const MAX_INTENTOS = 60; // 2 minutos (60 * 2 segundos)
    let pagoEncontrado = false; // üî• BANDERA PARA EVITAR M√öLTIPLES ALERTAS
    
    return new Promise((resolve, reject) => {
        
        Swal.fire({
            title: 'Esperando confirmaci√≥n del pago',
            html: `
                <div class="text-center py-4">
                    <div class="animate-spin inline-block w-16 h-16 border-4 border-orange-200 border-t-orange-600 rounded-full mb-4"></div>
                    <p class="text-gray-600 mb-2">El cliente est√° completando el pago en Mercado Pago</p>
                    <p class="text-sm text-gray-500">Esta ventana se cerrar√° autom√°ticamente cuando el pago sea confirmado</p>
                    <p class="text-xs text-gray-400 mt-4">Intentos: <span id="polling-contador">0</span> / ${MAX_INTENTOS}</p>
                </div>
            `,
            allowOutsideClick: false,
            showConfirmButton: false,
            showCancelButton: true,
            cancelButtonText: 'Cancelar verificaci√≥n'
        });

        const intervalo = setInterval(async () => {
            
            // üî• SI YA ENCONTRAMOS EL PAGO, NO HACER M√ÅS VERIFICACIONES
            if (pagoEncontrado) {
                clearInterval(intervalo);
                return;
            }
            
            intentos++;
            
            // Actualizar contador
            const contador = document.getElementById('polling-contador');
            if (contador) contador.textContent = intentos;

            try {
                // üî• VERIFICAR ESTADO DEL PAGO
                const res = await fetch(`/api/pago/verificar?cuenta_id=${cuentaId}`);
                const data = await res.json();

                console.log(`üîç Intento ${intentos}:`, data);

                if (data.success && data.status === 'approved') {
                    // üî• MARCAR COMO ENCONTRADO INMEDIATAMENTE
                    pagoEncontrado = true;
                    clearInterval(intervalo);
                    
                    // Cerrar ventana de pago
                    if (ventanaPago && !ventanaPago.closed) {
                        ventanaPago.close();
                    }

                    // üî• CERRAR EL SWAL DE LOADING
                    Swal.close();

                    // üî• MOSTRAR √âXITO UNA SOLA VEZ
                    await Swal.fire({
                        icon: 'success',
                        title: '¬°Pago Confirmado!',
                        html: `
                            <div class="text-center">
                                <i class="bi bi-check-circle text-6xl text-green-500 mb-4"></i>
                                <p class="text-lg">Cuenta cerrada correctamente</p>
                                <p class="text-2xl font-bold text-green-600 mt-2">Total: $${data.total.toFixed(2)}</p>
                            </div>
                        `,
                        timer: 3000,
                        showConfirmButton: false,
                        allowOutsideClick: false
                    });
                    
                    // Actualizar todo
                    cerrarModalMesa();
                    await cargarEstadoMesas();
                    await actualizarComandas();
                    await cargarEstadisticasDia();
                    
                    resolve(data);
                    
                } else if (data.success && data.status === 'rejected') {
                    pagoEncontrado = true;
                    clearInterval(intervalo);
                    
                    if (ventanaPago && !ventanaPago.closed) {
                        ventanaPago.close();
                    }
                    
                    Swal.fire({
                        icon: 'error',
                        title: 'Pago Rechazado',
                        text: 'El pago fue rechazado. Por favor intenta con otro m√©todo.',
                        confirmButtonColor: '#F2913D'
                    });
                    
                    reject(new Error('Pago rechazado'));
                    
                } else if (intentos >= MAX_INTENTOS) {
                    // üî• TIMEOUT
                    pagoEncontrado = true;
                    clearInterval(intervalo);
                    
                    Swal.fire({
                        icon: 'warning',
                        title: 'Tiempo de espera agotado',
                        text: 'No se pudo confirmar el pago. Verifica manualmente el estado de la cuenta.',
                        confirmButtonColor: '#F2913D'
                    });
                    
                    reject(new Error('Timeout'));
                }
                
            } catch (error) {
                console.error('Error en polling:', error);
            }
            
        }, 2000); // Verificar cada 2 segundos

        // üî• SI EL USUARIO CANCELA MANUALMENTE
        const cancelButton = Swal.getCancelButton();
        if (cancelButton) {
            cancelButton.addEventListener('click', () => {
                pagoEncontrado = true;
                clearInterval(intervalo);
                if (ventanaPago && !ventanaPago.closed) {
                    ventanaPago.close();
                }
                reject(new Error('Cancelado por usuario'));
            });
        }
    });
}
    // ===================================
    // UTILIDADES
    // ===================================
    function calcularTiempoTranscurrido(fechaInicio) {
        if (!fechaInicio) return 'N/A';

        const inicio = new Date(fechaInicio);
        const ahora = new Date();
        const diff = Math.floor((ahora - inicio) / 60000);

        if (diff < 60) {
            return `${diff} min`;
        } else {
            const horas = Math.floor(diff / 60);
            const mins = diff % 60;
            return `${horas}h ${mins}m`;
        }
    }

    function showLoading(message = 'Cargando...') {
        Swal.fire({
            title: message,
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
    }

    function hideLoading() {
        Swal.close();
    }

    function showSuccess(message) {
        Swal.fire({
            icon: 'success',
            title: '¬°√âxito!',
            text: message,
            timer: 2000,
            showConfirmButton: false
        });
    }

    function showError(message) {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: message
        });
    }
</script>
{% endblock %}