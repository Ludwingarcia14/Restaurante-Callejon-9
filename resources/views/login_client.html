<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Acceso Clientes - Potencial PyME</title>

        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script
            src="https://www.google.com/recaptcha/api.js?render=6LdN3eQrAAAAAMUaNDJkiYIOxX5ObS6be1J94wjm&badge=bottomright"></script>

        <style> @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap'); * { box-sizing: border-box; } /* Fondo y Contenedor Principal (Cambio de diseño) */ body { margin: 0; padding: 0; height: 100vh; /* Fondo elegante y oscuro */ background: linear-gradient(135deg, #0b1a3d 0%, #1e3a6c 100%); font-family: 'Inter', sans-serif; color: #f0f0f0; display: flex; justify-content: center; align-items: center; position: relative; } .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; /* Patrón sutil para dar textura */ background-image: radial-gradient(rgba(255,255,255,0.08) 1px, transparent 1px); background-size: 20px 20px; z-index: 0; } /* Tarjeta de Login (Efecto 'Frosted Glass') */ .login-card { background-color: rgba(255, 255, 255, 0.1); /* Fondo semi-transparente */ backdrop-filter: blur(15px); /* Efecto de vidrio esmerilado */ border-radius: 25px; border: 1px solid rgba(255, 255, 255, 0.2); overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.4), 0 0 0 8px rgba(255, 255, 255, 0.05); /* Sombra elegante */ padding: 40px; max-width: 400px; width: 90%; animation: fadeIn 1.2s ease-out; z-index: 1; color: #e0e0e0; } @keyframes fadeIn { from { opacity: 0; transform: scale(0.9) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } } .logo { width: 160px; margin: 0 auto 30px; display: block; filter: brightness(1.2); } h2 { text-align: center; margin-bottom: 35px; font-weight: 700; font-size: 28px; color: #fff; /* Título blanco */ letter-spacing: 1px; } form { display: flex; flex-direction: column; gap: 20px; } .input-group { position: relative; display: flex; align-items: center; } .input-group svg { position: absolute; left: 14px; width: 20px; height: 20px; fill: #b8c3d7; pointer-events: none; } input { width: 100%; padding: 16px 16px 16px 48px; border: none; border-radius: 12px; background-color: rgba(255, 255, 255, 0.1); /* Fondo de input semi-transparente */ color: #fff; /* Texto blanco en el input */ font-size: 16px; transition: all 0.3s ease; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3); } input::placeholder { color: #b8c3d7; opacity: 0.8; } input:focus { background-color: rgba(255, 255, 255, 0.2); outline: none; box-shadow: 0 0 0 3px #5ea9ff; /* Brillo azul al enfocar */ } /* Estilo del botón (Azul degradado) */ button { position: relative; display: flex; justify-content: center; align-items: center; padding: 16px 0; background: linear-gradient(90deg, #007aff, #005cc9); color: #fff; font-weight: 700; border: none; border-radius: 12px; font-size: 17px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 10px 25px rgba(0, 122, 255, 0.3); } button:disabled { background: #4f5b72; cursor: not-allowed; box-shadow: none; } button:hover:enabled { background: linear-gradient(90deg, #005cc9, #007aff); transform: translateY(-2px); box-shadow: 0 12px 30px rgba(0, 122, 255, 0.4); } .btn-text { display: inline-block; } .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #fff; border-radius: 50%; width: 18px; height: 18px; margin-left: 10px; display: none; animation: spin 0.8s linear infinite; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } .footer-text { margin-top: 25px; text-align: center; font-size: 13px; color: #a3b0c8; } /* Alerta de error (Estilo del login de cliente) */ .alert-error { background-color: rgba(220, 53, 69, 0.2); color: #ff9999; border: 1px solid #dc3545; padding: 14px 18px; border-radius: 10px; margin-bottom: 20px; font-size: 15px; display: none; align-items: center; gap: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); opacity: 0; transform: translateY(-10px); transition: all 0.5s ease; } .alert-error.show { display: flex; opacity: 1; transform: translateY(0); } .alert-error svg { fill: #dc3545 !important; } .forgot-password { text-align: right; font-size: 13px; margin-top: -10px; } .forgot-password a { color: #007aff; text-decoration: none; font-weight: 600; transition: color 0.2s; } .forgot-password a:hover { color: #5ea9ff; text-decoration: underline; } .footer-text a { position: relative; color: #ffffff; font-size: 15px; text-decoration: none; font-weight: 500; } .footer-text a::after { content: ""; position: absolute; left: 0; bottom: -4px; width: 100%; height: 2px; color: #0044ff; background: linear-gradient(90deg, #007aff, #7928ca); transform: scaleX(0); transform-origin: right; transition: transform 0.3s ease; } .footer-text a:hover::after { color: #0044ff; transform: scaleX(1); transform-origin: left; } /* Estilos de SweetAlert (Copiados del login de admin) */ .swal2-container { z-index: 99999 !important; } .swal2-popup-custom { border-radius: 15px; font-family: 'Inter', sans-serif; box-shadow: 0 20px 40px rgba(0,0,0,0.2); } .swal2-input-otp { letter-spacing: 15px; text-align: center; font-size: 24px !important; padding: 10px 15px !important; width: 200px !important; margin: 20px auto !important; border: 2px solid #ddd; border-radius: 10px; } .swal2-input-otp:focus { border-color: #007aff; box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2); } </style>
    </head>
    <body>
        <div class="overlay"></div>
        <div class="login-card">
            <img src="{{ url_for('static', filename='img/logopyme.png') }}"
                alt="Logo" class="logo" />
            <h2>Acceso Clientes</h2>

            <div id="error-msg" class="alert-error"></div>

            <form id="loginForm" action="#" method="post" novalidate>
                <input type="hidden" name="g-recaptcha-response"
                    id="g-recaptcha-response">
                <div class="input-group">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 24 24"><path
                            d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" /></svg>
                    <input type="email" name="email"
                        placeholder="Correo del cliente" required
                        id="emailInput" />
                </div>
                <div class="input-group">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 24 24"><path
                            d="M17 8V7a5 5 0 0 0-10 0v1H6a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-7a2 2 0 0 0-2-2h-1zm-6-1a3 3 0 0 1 6 0v1H11V7zm6 10H7v-5h10v5z" /></svg>
                    <input type="password" name="password"
                        placeholder="Contraseña" required id="passwordInput" />
                </div>
                <div class="forgot-password"> 
                    <a style="color: white;" href="{{ url_for('routes.retrieve_password') }}">¿Olvidaste tu contraseña?</a> 
                    <br> 
                    <a style="color: white;" href="{{ url_for('routes.registerClient') }}">Registrame como Cliente</a> 
                </div>
                <button type="submit" id="loginButton">
                    <span class="btn-text">Entrar</span>
                    <span class="spinner"></span>
                </button>
            </form>
            <div class="footer-text"><a
                    href="{{ url_for('routes.login2') }}">Iniciar sesión como
                    administrador</a></div>
            <div class="footer-text">Portal de Clientes - Potencial PyME</div>
        </div>

        <script>
    const form = document.getElementById("loginForm");
    const button = document.getElementById("loginButton");
    const btnText = button.querySelector(".btn-text");
    const spinner = button.querySelector(".spinner");
    const errorMsgDiv = document.getElementById("error-msg");

    // ✅ URLs específicas para clientes
    const LOGIN_CHECK_URL = "{{ url_for('routes.login') }}";
    const VERIFY_2FA_URL = "{{ url_for('routes.verify_and_enable_2fa') }}";
    const SUCCESS_REDIRECT_URL = "/clientes/dashboard";

    function showErrorMessage(message) {
      errorMsgDiv.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"><path d="M12 2a10 10 0 100 20 10 10 0 000-20zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg> <div>${message}</div>`;
      errorMsgDiv.classList.add('show');
      setTimeout(() => { errorMsgDiv.classList.remove('show'); }, 5000);
    }

    function setFormLoading(isLoading) {
      if (isLoading) {
        btnText.textContent = "Verificando...";
        spinner.style.display = "inline-block";
        button.disabled = true;
      } else {
        btnText.textContent = "Entrar";
        spinner.style.display = "none";
        button.disabled = false;
      }
    }

    async function verifyTwoFactorCode(otpCode, secret, tipo, dashboardUrl) {
      try {
        const response = await fetch(VERIFY_2FA_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ otp_code: otpCode, temp_2fa_secret: secret, temp_2fa_tipo: tipo })
        });
        const data = await response.json();

        if (response.ok && data.status === 'success') {
          Swal.fire({ icon: "success", title: "Inicio exitoso", timer: 1000, showConfirmButton: false });
          window.location.href = dashboardUrl || SUCCESS_REDIRECT_URL;
        } else {
          Swal.fire({ icon: "error", title: "Código inválido", text: data.message || "Intenta nuevamente." });
          setFormLoading(false);
        }
      } catch {
        Swal.fire({ icon: "error", title: "Error de conexión", text: "No se pudo verificar el código 2FA." });
        setFormLoading(false);
      }
    }

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      setFormLoading(true);

      grecaptcha.ready(() => {
        grecaptcha.execute("6LdN3eQrAAAAAMUaNDJkiYIOxX5ObS6be1J94wjm", { action: "login" })
        .then(token => {
          const data = {
            email: document.getElementById("emailInput").value,
            password: document.getElementById("passwordInput").value,
            g_recaptcha_response: token
          };

          fetch(LOGIN_CHECK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          })
          .then(res => res.json())
          .then(response => {
            if (response.status === 'success') {
              if (response.user.requires_2fa === true) {
                setFormLoading(false);
                Swal.fire({
                  title: "Verificación 2FA",
                  input: "text",
                  inputPlaceholder: "Código de 6 dígitos",
                  confirmButtonText: "Verificar",
                  showCancelButton: true,
                  preConfirm: (code) => {
                    if (!code || code.length !== 6) {
                      Swal.showValidationMessage("Código inválido");
                    } else {
                      verifyTwoFactorCode(code, response.user.secret, response.user.tipo, response.dashboard);
                    }
                  }
                });
              } else {
                Swal.fire({ icon: "success", title: "Bienvenido", timer: 1000, showConfirmButton: false });
                window.location.href = response.dashboard;
              }
            } else {
              showErrorMessage(response.message || "Credenciales inválidas.");
              setFormLoading(false);
            }
          })
          .catch(() => {
            showErrorMessage("Error al conectar con el servidor.");
            setFormLoading(false);
          });
        });
      });
    });
  </script>
    </body>
</html>
